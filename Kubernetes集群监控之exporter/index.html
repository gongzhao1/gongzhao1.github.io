<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="exporter,">





  <link rel="alternate" href="/atom.xml" title="GZ" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="[TOC] 参考https://prometheus.io/docs/instrumenting/exporters/ blackbox_exporter:  https://github.com/prometheus/blackbox_exporter https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/">
<meta name="keywords" content="exporter">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes集群监控之exporter">
<meta property="og:url" content="https://gongzhao1.coding.me/Kubernetes集群监控之exporter/index.html">
<meta property="og:site_name" content="GZ">
<meta property="og:description" content="[TOC] 参考https://prometheus.io/docs/instrumenting/exporters/ blackbox_exporter:  https://github.com/prometheus/blackbox_exporter https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-04-08T14:20:25.845Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes集群监控之exporter">
<meta name="twitter:description" content="[TOC] 参考https://prometheus.io/docs/instrumenting/exporters/ blackbox_exporter:  https://github.com/prometheus/blackbox_exporter https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://gongzhao1.coding.me/Kubernetes集群监控之exporter/">





  <title>Kubernetes集群监控之exporter | GZ</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GZ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">痛苦是财富，这话是扯淡。少年，痛苦就是痛苦，对痛苦的思考才是财富</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gongzhao1.coding.me/Kubernetes集群监控之exporter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="弓昭">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/panda.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GZ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kubernetes集群监控之exporter</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-19T18:57:27+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/监控/" itemprop="url" rel="index">
                    <span itemprop="name">监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次阅读
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>[TOC]</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/exporters/</a></p>
<p>blackbox_exporter:</p>
<ul>
<li><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">https://github.com/prometheus/blackbox_exporter</a></li>
<li><a href="https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter" target="_blank" rel="noopener">https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter</a></li>
<li><a href="https://blog.csdn.net/qq_25934401/article/details/84325356" target="_blank" rel="noopener">https://blog.csdn.net/qq_25934401/article/details/84325356</a></li>
</ul>
<p>node_exporter</p>
<ul>
<li><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter</a></li>
<li><a href="https://www.cnblogs.com/bigberg/p/10118137.html" target="_blank" rel="noopener">https://www.cnblogs.com/bigberg/p/10118137.html</a></li>
</ul>
<p>mysql_exporter:</p>
<ul>
<li><a href="https://github.com/prometheus/mysqld_exporter" target="_blank" rel="noopener">https://github.com/prometheus/mysqld_exporter</a></li>
</ul>
<p>jmx_exporter:</p>
<ul>
<li><a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">https://github.com/prometheus/jmx_exporter</a></li>
<li><a href="https://www.cnblogs.com/caizhenghui/p/9132414.html" target="_blank" rel="noopener">https://www.cnblogs.com/caizhenghui/p/9132414.html</a></li>
</ul>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>大部分exporter都可以在<a href="https://github.com/prometheus中搜到" target="_blank" rel="noopener">https://github.com/prometheus中搜到</a></p>
<p>以及可以使用<code>helm search node-exporter</code>来进行搜索</p>
<a id="more"></a>

<h1 id="blackbox-exporter黑盒监测"><a href="#blackbox-exporter黑盒监测" class="headerlink" title="blackbox_exporter黑盒监测"></a>blackbox_exporter黑盒监测</h1><p>Prometheus 官方提供的 exporter 之一，可以提供 http、dns、tcp、icmp 的监控数据采集</p>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p><strong>安装包部署</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[sss@prometheus01 ]$ cd /usr/local/blackbox_exporter/</span><br><span class="line">[sss@prometheus01 ]$ wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.12.0/blackbox_exporter-0.12.0.linux-amd64.tar.gz </span><br><span class="line">[sss@prometheus01 ]$ tar zxvf blackbox_exporter-0.12.0.linux-amd64.tar.gz</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ cd blackbox_exporter-0.12.0.linux-amd64</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ ll</span><br><span class="line">total 15720</span><br><span class="line">-rwxr-xr-x. 1 1000 1000 16074005 Feb 27  2018 blackbox_exporter</span><br><span class="line">-rw-rw-r--. 1 1000 1000      932 Nov 21 16:05 blackbox.yml</span><br><span class="line">-rw-rw-r--. 1 1000 1000    11357 Feb 27  2018 LICENSE</span><br><span class="line">-rw-rw-r--. 1 1000 1000       94 Feb 27  2018 NOTICE</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$cp -r blackbox_exporter /usr/local/bin</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ cat /etc/supervisord.conf|grep blackbox -A 20</span><br><span class="line">[program:blackbox_exporter]</span><br><span class="line">command=/usr/local/bin/blackbox_exporter   --config.file=/usr/local/prometheus/blackbox_exporter/blackbox_exporter-0.12.0.linux-amd64/blackbox.yml </span><br><span class="line">stdout_logfile=/tmp/prometheus/blackbox_exporter.log</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=5</span><br><span class="line">priority=1</span><br><span class="line">user=root</span><br><span class="line">stopasgroup=true</span><br><span class="line">killasgroup=true</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ supervisorctl  status |grep blackbox</span><br><span class="line">blackbox_exporter                RUNNING   pid 25343, uptime 0:19:25</span><br></pre></td></tr></table></figure>

<p>blackbox的配置文件</p>
<ul>
<li>通过 blackbox.yml 定义模块详细信息</li>
<li>在 Prometheus 配置文件中引用该模块以及配置被监控目标主机</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">modules:</span><br><span class="line">  http_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 10s</span><br><span class="line">    http:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot; ##如果http监测是使用ipv4 就要写上，目前国内使用ipv6很少。</span><br><span class="line">  http_post_2xx_query: ##用于post请求使用的模块）由于每个接口传参不同 可以定义多个module 用于不同接口（例如此命名为http_post_2xx_query 用于监测query.action接口 </span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 15s</span><br><span class="line">    http:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot; ##使用ipv4</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Content-Type: application/json ##header头</span><br><span class="line">      body: &apos;&#123;&quot;hmac&quot;:&quot;&quot;,&quot;params&quot;:&#123;&quot;publicFundsKeyWords&quot;:&quot;xxx&quot;&#125;&#125;&apos; ##传参</span><br><span class="line">  tcp_connect:</span><br><span class="line">    prober: tcp</span><br><span class="line">  pop3s_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^+OK&quot;</span><br><span class="line">      tls: true</span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line">  ssh_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^SSH-2.0-&quot;</span><br><span class="line">  irc_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - send: &quot;NICK prober&quot;</span><br><span class="line">      - send: &quot;USER prober prober prober :prober&quot;</span><br><span class="line">      - expect: &quot;PING :([^ ]+)&quot;</span><br><span class="line">        send: &quot;PONG $&#123;1&#125;&quot;</span><br><span class="line">      - expect: &quot;^:[^ ]+ 001&quot;</span><br><span class="line">  icmp:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br></pre></td></tr></table></figure>

<p><strong>在kubernetes集群中部署</strong></p>
<p>blackbox_exporter-deploy.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus-blackbox-exporter</span><br><span class="line">        image: prom/blackbox-exporter:v0.16.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: 50Mi</span><br><span class="line">            cpu: 50m</span><br><span class="line">          limits:</span><br><span class="line">            memory: 60Mi</span><br><span class="line">            cpu: 100m</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /etc/blackbox_exporter</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/etc/blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --web.listen-address=:9115</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-blackbox-exporter</span><br><span class="line">          </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">  - name: blackbox</span><br><span class="line">    port: 9115</span><br><span class="line">    targetPort: 9115</span><br><span class="line">    protocol: TCP</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          valid_status_codes: []</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      http_post_2xx: # http post 监测模块</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          method: POST</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 10s</span><br><span class="line">      icmp:</span><br><span class="line">        prober: icmp</span><br><span class="line">        timeout: 10s</span><br><span class="line">        icmp:</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br></pre></td></tr></table></figure>

<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li><p>HTTP 测试</p>
<p>定义 Request Header 信息<br>判断 Http status / Http Respones Header / Http Body 内容</p>
</li>
<li><p>TCP 测试</p>
<p>业务组件端口状态监听</p>
<p>应用层协议定义与监听</p>
</li>
<li><p>ICMP 测试</p>
<p>主机探活机制</p>
</li>
<li><p>POST 测试</p>
<p>接口联通性</p>
</li>
<li><p>SSL 证书过期时间</p>
</li>
</ul>
<h3 id="http测试"><a href="#http测试" class="headerlink" title="http测试"></a>http测试</h3><ul>
<li>相关代码块添加到 Prometheus 文件内</li>
<li>对应 blackbox.yml文件的 http_2xx 模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox_http_2xx&apos;</span><br><span class="line">  scrape_interval: 45s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - https://www.baidu.com/</span><br><span class="line">        - 172.0.0.1:9090</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 10.XXX.XX.XX:9115  # The blackbox exporter&apos;s real hostname:port.</span><br></pre></td></tr></table></figure>

<h3 id="TCP-测试"><a href="#TCP-测试" class="headerlink" title="TCP 测试"></a>TCP 测试</h3><ul>
<li>监听 业务端口地址，用来判断服务是否在线，我觉的和telnet 差不多</li>
<li>相关代码块添加到 Prometheus 文件内</li>
<li>对应 blackbox.yml文件的 tcp_connect 模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;blackbox_telnet_port]&quot;</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets: [ &apos;1x3.x1.xx.xx4:443&apos; ]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;xxxidc机房ip监控&apos;</span><br><span class="line">      - targets: [&apos;10.xx.xx.xxx:443&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;Process status of nginx(main) server&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 10.xxx.xx.xx:9115</span><br></pre></td></tr></table></figure>

<h3 id="ICMP-测试"><a href="#ICMP-测试" class="headerlink" title="ICMP 测试"></a>ICMP 测试</h3><ul>
<li>相关代码块添加到 Prometheus 配置文件内</li>
<li>对应 blackbox.yml文件的 icmp 模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox00_ping_idc_ip&apos;</span><br><span class="line">  scrape_interval: 10s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [icmp]  #ping</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets: [ &apos;1x.xx.xx.xx&apos; ]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;xxnginx 虚拟IP&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        regex: (.*)(:80)?</span><br><span class="line">        target_label: __param_target</span><br><span class="line">        replacement: $&#123;1&#125;</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        regex: (.*)</span><br><span class="line">        target_label: ping</span><br><span class="line">        replacement: $&#123;1&#125;</span><br><span class="line">      - source_labels: []</span><br><span class="line">        regex: .*</span><br><span class="line">        target_label: __address__</span><br><span class="line">        replacement: 1x.xxx.xx.xx:9115</span><br></pre></td></tr></table></figure>

<h3 id="POST-测试"><a href="#POST-测试" class="headerlink" title="POST 测试"></a>POST 测试</h3><ul>
<li>监听业务接口地址，用来判断接口是否在线</li>
<li>相关代码块添加到 Prometheus 文件内</li>
<li>对应 blackbox.yml文件的 http_post_2xx_query 模块（监听query.action这个接口）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox_http_2xx_post&apos;</span><br><span class="line">  scrape_interval: 10s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_post_2xx_query]</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - https://xx.xxx.com/api/xx/xx/fund/query.action</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;Interface monitoring&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 1x.xx.xx.xx:9115  # The blackbox exporter&apos;s real hostname:port.</span><br></pre></td></tr></table></figure>

<h2 id="查看监听过程"><a href="#查看监听过程" class="headerlink" title="查看监听过程"></a>查看监听过程</h2><p>类似于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.10.65:9115/probe?target=prometheus.io&amp;module=http_2xx&amp;debug=true</span><br></pre></td></tr></table></figure>

<h2 id="告警应用测试"><a href="#告警应用测试" class="headerlink" title="告警应用测试"></a>告警应用测试</h2><p>icmp、tcp、http、post 监测是否正常可以观察probe_success 这一指标<br>probe_success == 0 ##联通性异常<br>probe_success == 1 ##联通性正常<br>告警也是判断这个指标是否等于0，如等于0 则触发异常报警</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[sss@prometheus01 prometheus]$ cat rules/blackbox-alert.rules </span><br><span class="line">groups:</span><br><span class="line">- name: blackbox_network_stats</span><br><span class="line">  rules:</span><br><span class="line">  - alert: blackbox_network_stats</span><br><span class="line">    expr: probe_success == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125;  is down&quot;</span><br><span class="line">      description: &quot;This requires immediate action!&quot;</span><br></pre></td></tr></table></figure>

<h3 id="SSL-证书过期时间监测"><a href="#SSL-证书过期时间监测" class="headerlink" title="SSL 证书过期时间监测"></a>SSL 证书过期时间监测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &apos;EOF&apos; &gt; prometheus.yml</span><br><span class="line">rule_files:</span><br><span class="line">  - ssl_expiry.rules</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;blackbox&apos;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - example.com  # Target to probe</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 127.0.0.1:9115  # Blackbox exporter.</span><br><span class="line">        EOF </span><br><span class="line">cat &lt;&lt; &apos;EOF&apos; &gt; ssl_expiry.rules </span><br><span class="line">groups: </span><br><span class="line">  - name: ssl_expiry.rules </span><br><span class="line">    rules: </span><br><span class="line">      - alert: SSLCertExpiringSoon </span><br><span class="line">        expr: probe_ssl_earliest_cert_expiry&#123;job=&quot;blackbox&quot;&#125; - time() &lt; 86400 * 30 </span><br><span class="line">        for: 10m</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="自定义探针测试"><a href="#自定义探针测试" class="headerlink" title="自定义探针测试"></a>自定义探针测试</h3><p>HTTP服务通常会以不同的形式对外展现，有些可能就是一些简单的网页，而有些则可能是一些基于REST的API服务。 对于不同类型的HTTP的探测需要管理员能够对HTTP探针的行为进行更多的自定义设置，包括：HTTP请求方法、HTTP头信息、请求参数等。对于某些启用了安全认证的服务还需要能够对HTTP探测设置相应的Auth支持。对于HTTPS类型的服务还需要能够对证书进行自定义设置。</p>
<p>如下所示，这里通过method定义了探测时使用的请求方法，对于一些需要请求参数的服务，还可以通过headers定义相关的请求头信息，使用body定义请求内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http_post_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Content-Type: application/json</span><br><span class="line">      body: &apos;&#123;&#125;&apos;</span><br></pre></td></tr></table></figure>

<p>如果HTTP服务启用了安全认证，Blockbox Exporter内置了对basic_auth的支持，可以直接设置相关的认证信息即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http_basic_auth_example:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Host: &quot;login.example.com&quot;</span><br><span class="line">      basic_auth:</span><br><span class="line">        username: &quot;username&quot;</span><br><span class="line">        password: &quot;mysecret&quot;</span><br></pre></td></tr></table></figure>

<p> 对于使用了Bear Token的服务也可以通过bearer_token配置项直接指定令牌字符串，或者通过bearer_token_file指定令牌文件。</p>
<p>对于一些启用了HTTPS的服务，但是需要自定义证书的服务，可以通过tls_config指定相关的证书信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_custom_ca_example:</span><br><span class="line">   prober: http</span><br><span class="line">   http:</span><br><span class="line">     method: GET</span><br><span class="line">     tls_config:</span><br><span class="line">       ca_file: &quot;/certs/my_cert.crt&quot;</span><br></pre></td></tr></table></figure>

<h3 id="自定义探针行为"><a href="#自定义探针行为" class="headerlink" title="自定义探针行为"></a>自定义探针行为</h3><p>在默认情况下HTTP探针只会对HTTP返回状态码进行校验，如果状态码为2XX（200 &lt;= StatusCode &lt; 300）则表示探测成功，并且探针返回的指标probe_success值为1。</p>
<p>如果用户需要指定HTTP返回状态码，或者对HTTP版本有特殊要求，如下所示，可以使用valid_http_versions和valid_status_codes进行定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">    valid_status_codes: []</span><br></pre></td></tr></table></figure>

<p>默认情况下，Blockbox返回的样本数据中也会包含指标probe_http_ssl，用于表明当前探针是否使用了SSL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP probe_http_ssl Indicates if SSL was used for the final redirect</span><br><span class="line"># TYPE probe_http_ssl gauge</span><br><span class="line">probe_http_ssl 0</span><br></pre></td></tr></table></figure>

<p>而如果用户对于HTTP服务是否启用SSL有强制的标准。则可以使用fail_if_ssl和fail_if_not_ssl进行配置。fail_if_ssl为true时，表示如果站点启用了SSL则探针失败，反之成功。fail_if_not_ssl刚好相反。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    valid_status_codes: []</span><br><span class="line">    method: GET</span><br><span class="line">    no_follow_redirects: false</span><br><span class="line">    fail_if_ssl: false</span><br><span class="line">    fail_if_not_ssl: false</span><br></pre></td></tr></table></figure>

<p>除了基于HTTP状态码，HTTP协议版本以及是否启用SSL作为控制探针探测行为成功与否的标准以外，还可以匹配HTTP服务的响应内容。使用fail_if_matches_regexp和fail_if_not_matches_regexp用户可以定义一组正则表达式，用于验证HTTP返回内容是否符合或者不符合正则表达式的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    method: GET</span><br><span class="line">    fail_if_matches_regexp:</span><br><span class="line">      - &quot;Could not connect to database&quot;</span><br><span class="line">    fail_if_not_matches_regexp:</span><br><span class="line">      - &quot;Download the latest version here&quot;</span><br></pre></td></tr></table></figure>

<p>最后需要提醒的时，默认情况下HTTP探针会走IPV6的协议。 在大多数情况下，可以使用preferred_ip_protocol=ip4强制通过IPV4的方式进行探测。在Bloackbox响应的监控样本中，也会通过指标probe_ip_protocol，表明当前的协议使用情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6</span><br><span class="line"># TYPE probe_ip_protocol gauge</span><br><span class="line">probe_ip_protocol 6</span><br></pre></td></tr></table></figure>

<p>除了支持对HTTP协议进行网络探测以外，Blackbox还支持对TCP、DNS、ICMP等其他网络协议，感兴趣的读者可以从Blackbox的Github项目中获取更多使用信息.</p>
<h1 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h1><h2 id="功能对照表"><a href="#功能对照表" class="headerlink" title="功能对照表"></a>功能对照表</h2><p>默认开启的功能</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td>arp</td>
<td>从 <code>/proc/net/arp</code> 中收集 ARP 统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>conntrack</td>
<td>从 <code>/proc/sys/net/netfilter/</code> 中收集 conntrack 统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>cpu</td>
<td>收集 cpu 统计信息</td>
<td>Darwin, Dragonfly,FreeBSD, Linux</td>
</tr>
<tr>
<td>diskstats</td>
<td>从 <code>/proc/diskstats</code> 中收集磁盘 I/O 统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>edac</td>
<td>错误检测与纠正统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>entropy</td>
<td>可用内核熵信息</td>
<td>Linux</td>
</tr>
<tr>
<td>exec</td>
<td>execution 统计信息</td>
<td>Dragonfly, FreeBSD</td>
</tr>
<tr>
<td>filefd</td>
<td>从 <code>/proc/sys/fs/file-nr</code> 中收集文件描述符统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>filesystem</td>
<td>文件系统统计信息，例如磁盘已使用空间</td>
<td>Darwin, Dragonfly,FreeBSD, Linux, OpenBSD</td>
</tr>
<tr>
<td>hwmon</td>
<td>从 <code>/sys/class/hwmon/</code> 中收集监控器或传感器数据信息</td>
<td>Linux</td>
</tr>
<tr>
<td>infiniband</td>
<td>从 InfiniBand 配置中收集网络统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>loadavg</td>
<td>收集系统负载信息</td>
<td>Darwin, Dragonfly, FreeBSD,Linux, NetBSD, OpenBSD, Solaris</td>
</tr>
<tr>
<td>mdadm</td>
<td>从 <code>/proc/mdstat</code> 中获取设备统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>meminfo</td>
<td>内存统计信息</td>
<td>Darwin, Dragonfly,FreeBSD, Linux</td>
</tr>
<tr>
<td>netdev</td>
<td>网口流量统计信息，单位 bytes</td>
<td>Darwin, Dragonfly,FreeBSD, Linux, OpenBSD</td>
</tr>
<tr>
<td>netstat</td>
<td>从 <code>/proc/net/netstat</code> 收集网络统计数据，等同于 <code>netstat -s</code></td>
<td>Linux</td>
</tr>
<tr>
<td>sockstat</td>
<td>从 <code>/proc/net/sockstat</code> 中收集 socket 统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>stat</td>
<td>从 <code>/proc/stat</code> 中收集各种统计信息，包含系统启动时间，forks, 中断等</td>
<td>Linux</td>
</tr>
<tr>
<td>textfile</td>
<td>通过 <code>--collector.textfile.directory</code>参数指定本地文本收集路径，收集文本信息</td>
<td>any</td>
</tr>
<tr>
<td>time</td>
<td>系统当前时间</td>
<td>any</td>
</tr>
<tr>
<td>uname</td>
<td>通过 <code>uname</code> 系统调用, 获取系统信息</td>
<td>any</td>
</tr>
<tr>
<td>vmstat</td>
<td>从 <code>/proc/vmstat</code> 中收集统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>wifi</td>
<td>收集 wifi 设备相关统计数据</td>
<td>Linux</td>
</tr>
<tr>
<td>xfs</td>
<td>收集 xfs 运行时统计信息</td>
<td>Linux (kernel 4.4+)</td>
</tr>
<tr>
<td>zfs</td>
<td>收集 zfs 性能统计信息</td>
<td>Linux</td>
</tr>
</tbody></table>
<p>默认关闭的功能</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td>bonding</td>
<td>收集系统配置以及激活的绑定网卡数量</td>
<td>Linux</td>
</tr>
<tr>
<td>buddyinfo</td>
<td>从 <code>/proc/buddyinfo</code> 中收集内存碎片统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>devstat</td>
<td>收集设备统计信息</td>
<td>Dragonfly, FreeBSD</td>
</tr>
<tr>
<td>drbd</td>
<td>收集远程镜像块设备（DRBD）统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>interrupts</td>
<td>收集更具体的中断统计信息</td>
<td>Linux，OpenBSD</td>
</tr>
<tr>
<td>ipvs</td>
<td>从 <code>/proc/net/ip_vs</code> 中收集 IPVS 状态信息，从 <code>/proc/net/ip_vs_stats</code> 获取统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>ksmd</td>
<td>从 <code>/sys/kernel/mm/ksm</code> 中获取内核和系统统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>logind</td>
<td>从 <code>logind</code> 中收集会话统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>meminfo_numa</td>
<td>从 <code>/proc/meminfo_numa</code> 中收集内存统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>mountstats</td>
<td>从 <code>/proc/self/mountstat</code> 中收集文件系统统计信息，包括 NFS 客户端统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>nfs</td>
<td>从 <code>/proc/net/rpc/nfs</code> 中收集 NFS 统计信息，等同于 <code>nfsstat -c</code></td>
<td>Linux</td>
</tr>
<tr>
<td>qdisc</td>
<td>收集队列推定统计信息</td>
<td>Linux</td>
</tr>
<tr>
<td>runit</td>
<td>收集 runit 状态信息</td>
<td>any</td>
</tr>
<tr>
<td>supervisord</td>
<td>收集 supervisord 状态信息</td>
<td>any</td>
</tr>
<tr>
<td>systemd</td>
<td>从 <code>systemd</code> 中收集设备系统状态信息</td>
<td>Linux</td>
</tr>
<tr>
<td>tcpstat</td>
<td>从 <code>/proc/net/tcp</code> 和 <code>/proc/net/tcp6</code> 收集 TCP 连接状态信息</td>
<td>Linux</td>
</tr>
</tbody></table>
<p>注意：我们可以使用 <code>--collectors.enabled</code> 运行参数指定 node_exporter 收集的功能模块, 如果不指定，将使用默认模块。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>下载地址：<a href="https://prometheus.io/download/#node_exporter" target="_blank" rel="noopener">https://prometheus.io/download/#node_exporter</a></p>
<h3 id="安装包安装"><a href="#安装包安装" class="headerlink" title="安装包安装"></a>安装包安装</h3><p><strong>安装node exporter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf node_exporter-0.16.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv node_exporter-0.16.0.linux-amd64 /usr/local/node_exporter</span><br></pre></td></tr></table></figure>

<p><strong>创建systemd服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/node_exporter.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/node_exporter/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>启动node_exporter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl status node_exporter</span><br><span class="line">systemctl enable node_exporter</span><br></pre></td></tr></table></figure>

<p><strong>验证启动成功</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1:9100/metrics</span><br></pre></td></tr></table></figure>

<h3 id="kubernetes安装"><a href="#kubernetes安装" class="headerlink" title="kubernetes安装"></a>kubernetes安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: prometheus-node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-node-exporter</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/node-exporter:v0.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: prometheus-node-exporter</span><br><span class="line">        ports:</span><br><span class="line">        - name: prom-node-exp</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          hostPort: 9100</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 20m</span><br><span class="line">            memory: 2Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      hostPID: true</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics-path: &apos;/metrics&apos;</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: prometheus-node-exporter</span><br><span class="line">      port: 9100</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>可以利用 Prometheus 的 static_configs 来拉取 node_exporter 的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;node&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9100&apos;]</span><br></pre></td></tr></table></figure>

<p>重启prometheus，然后在Prometheus页面中的Targets中就能看到新加入的node</p>
<h2 id="常用查询语句"><a href="#常用查询语句" class="headerlink" title="常用查询语句"></a>常用查询语句</h2><p>收集到 node_exporter 的数据后，我们可以使用 PromQL 进行一些业务查询和监控，下面是一些比较常见的查询</p>
<p>以下查询均以单个节点作为例子，如果大家想查看所有节点，将 <code>instance=&quot;xxx&quot;</code> 去掉即可。</p>
<h3 id="cpu使用率"><a href="#cpu使用率" class="headerlink" title="cpu使用率"></a>cpu使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - (avg by (instance) (irate(node_cpu&#123;instance=&quot;172.16.8.153:9100&quot;, mode=&quot;idle&quot;&#125;[5m])) * 100)</span><br></pre></td></tr></table></figure>

<h3 id="CPU各个mode使用率"><a href="#CPU各个mode使用率" class="headerlink" title="CPU各个mode使用率"></a>CPU各个mode使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg by (instance, mode) (irate(node_cpu&#123;instance=&quot;172.16.8.153:9100&quot;&#125;[5m])) * 100</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>User</strong>：CPU一共花了多少比例的时间运行在用户态空间或者说是用户进程(running user space processes)。典型的用户态空间程序有：Shells、数据库、web服务器等</li>
<li><strong>Nice</strong>：可理解为，<strong>用户空间进程</strong>的CPU的调度优先级，范围为[-20,19]</li>
<li><strong>System</strong>：System的含义与User相似。System表示：CPU花了多少比例的时间在内核空间运行。分配内存、IO操作、创建子进程……都是内核操作。这也表明，当IO操作频繁时，System参数会很高</li>
<li><strong>ioWait</strong>：在计算机中，读写磁盘的操作远比CPU运行的速度要慢，CPU负载处理数据，而数据一般在磁盘上需要读到内存中才能处理。当CPU发起读写操作后，需要等着磁盘驱动器将数据读入内存,从而导致CPU 在等待的这一段时间内无事可做。CPU处于这种等待状态的时间由Wait参数来衡量</li>
<li><strong>Idle</strong>：CPU处于空闲状态时间比例。一般而言，idel + user + nice 约等于100%</li>
</ul>
<h3 id="机器平均负载"><a href="#机器平均负载" class="headerlink" title="机器平均负载"></a>机器平均负载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance=&quot;172.16.8.153:9100&quot;&#125;   // 1分钟负载</span><br><span class="line">node_load5&#123;instance=&quot;172.16.8.153:9100&quot;&#125;   // 5分钟负载</span><br><span class="line">node_load15&#123;instance=&quot;172.16.8.153:9100&quot;&#125;  // 15分钟负载</span><br></pre></td></tr></table></figure>

<h3 id="内存使用率"><a href="#内存使用率" class="headerlink" title="内存使用率"></a>内存使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100-(node_memory_MemFree&#123;instance=&quot;172.16.8.172:9100&quot;&#125;+node_memory_Cached&#123;instance=&quot;172.16.8.172:9100&quot;&#125;+node_memory_Buffers&#123;instance=&quot;172.16.8.172:9100&quot;&#125;)/node_memory_MemTotal&#123;instance=&quot;172.16.8.172:9100&quot;&#125; * 100</span><br></pre></td></tr></table></figure>

<h3 id="磁盘使用率"><a href="#磁盘使用率" class="headerlink" title="磁盘使用率"></a>磁盘使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - node_filesystem_free&#123;instance=&quot;172.16.8.153:9100&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; / node_filesystem_size&#123;instance=&quot;172.16.8.153:9100&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; * 100</span><br></pre></td></tr></table></figure>

<h3 id="网卡出入包"><a href="#网卡出入包" class="headerlink" title="网卡出入包"></a>网卡出入包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 入包量</span><br><span class="line">sum by (instance) (rate(node_network_receive_bytes&#123;instance=&quot;172.16.8.153:9100&quot;,device!=&quot;lo&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">// 出包量</span><br><span class="line">sum by (instance) (rate(node_network_transmit_bytes&#123;instance=&quot;172.16.8.153:9100&quot;,device!=&quot;lo&quot;&#125;[5m]))</span><br></pre></td></tr></table></figure>

<h2 id="dashboard模板"><a href="#dashboard模板" class="headerlink" title="dashboard模板"></a>dashboard模板</h2><p>可以在grafana官网中搜索对应模板</p>
<h1 id="Mysql-exporter"><a href="#Mysql-exporter" class="headerlink" title="Mysql exporter"></a>Mysql exporter</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>使用helm安装部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm --fetch mysql_exporter</span><br></pre></td></tr></table></figure>

<p>拉取下来之后修改values文件</p>
<h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>mysqld_exporter需要连接Mysql，首先为它创建用户并赋予所需要的权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;exporter&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos; WITH MAX_USER_CONNECTIONS 3;</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &apos;exporter&apos;@&apos;%&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<h2 id="prometheus配置"><a href="#prometheus配置" class="headerlink" title="prometheus配置"></a>prometheus配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;mysql&apos;</span><br><span class="line">        static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">            - localhost:9104</span><br></pre></td></tr></table></figure>

<h2 id="验证状态"><a href="#验证状态" class="headerlink" title="验证状态"></a>验证状态</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9104/metrics</span><br></pre></td></tr></table></figure>

<h1 id="jmx-exporter"><a href="#jmx-exporter" class="headerlink" title="jmx_exporter"></a>jmx_exporter</h1><h2 id="举例监控kafka"><a href="#举例监控kafka" class="headerlink" title="举例监控kafka"></a>举例监控kafka</h2><p>jmx_prometheus_javaagent 方式收集kafka指标</p>
<p>下载jmx_prometheus_javaagent和kafka.yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/prometheus/jmx_exporter/master/example_configs/kafka-0-8-2.yml</span><br><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.6/jmx_prometheus_javaagent-0.6.jar</span><br></pre></td></tr></table></figure>

<p>编辑kafka的启动文件  <a href="http://kafka-server-start.sh/" target="_blank" rel="noopener">kafka-server-start.sh</a></p>
<p>添加几行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JMX_PORT=&quot;9999&quot;</span><br><span class="line">export KAFKA_OPTS=&quot;-javaagent:/path/jmx_prometheus_javaagent-0.6.jar=9991:/path/kafka-0-8-2.yml&quot;</span><br></pre></td></tr></table></figure>

<p>然后重启kafka。<br>访问 <a href="http://localhost:9991/metrics" target="_blank" rel="noopener">http://localhost:9991/metrics</a> 可以看到各种指标了。</p>
<h2 id="举例监控hadoop"><a href="#举例监控hadoop" class="headerlink" title="举例监控hadoop"></a>举例监控hadoop</h2><p>下载jar包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure>

<p>创建配置文件</p>
<p>创建namenode.yaml(datanode.yaml)放在任意位置，内容为你想要的metrics</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">startDelaySeconds: 0</span><br><span class="line">hostPort: master:1234 #master为本机IP（一般可设置为localhost）；1234为想设置的jmx端口（可设置为未被占用的端口）</span><br><span class="line">#jmxUrl: service:jmx:rmi:///jndi/rmi://127.0.0.1:1234/jmxrmi</span><br><span class="line">ssl: false</span><br><span class="line">lowercaseOutputName: false</span><br><span class="line">lowercaseOutputLabelNames: false</span><br></pre></td></tr></table></figure>

<p>参数说明</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>startDelaySeconds</td>
<td>start delay before serving requests. Any requests within the delay period will result in an empty metrics set.</td>
</tr>
<tr>
<td>hostPort</td>
<td>The host and port to connect to via remote JMX. If neither this nor jmxUrl is specified, will talk to the local JVM.</td>
</tr>
<tr>
<td>username</td>
<td>The username to be used in remote JMX password authentication.</td>
</tr>
<tr>
<td>password</td>
<td>The password to be used in remote JMX password authentication.</td>
</tr>
<tr>
<td>jmxUrl</td>
<td>A full JMX URL to connect to. Should not be specified if hostPort is.</td>
</tr>
<tr>
<td>ssl</td>
<td>Whether JMX connection should be done over SSL. To configure certificates you have to set following system properties: <code>-Djavax.net.ssl.keyStore=/home/user/.keystore</code> <code>-Djavax.net.ssl.keyStorePassword=changeit</code> <code>-Djavax.net.ssl.trustStore=/home/user/.truststore</code> <code>-Djavax.net.ssl.trustStorePassword=changeit</code></td>
</tr>
<tr>
<td>lowercaseOutputName</td>
<td>Lowercase the output metric name. Applies to default format and <code>name</code>. Defaults to false.</td>
</tr>
<tr>
<td>lowercaseOutputLabelNames</td>
<td>Lowercase the output metric label names. Applies to default format and <code>labels</code>. Defaults to false.</td>
</tr>
<tr>
<td>whitelistObjectNames</td>
<td>A list of <a href="http://docs.oracle.com/javase/6/docs/api/javax/management/ObjectName.html" target="_blank" rel="noopener">ObjectNames</a> to query. Defaults to all mBeans.</td>
</tr>
<tr>
<td>blacklistObjectNames</td>
<td>A list of <a href="http://docs.oracle.com/javase/6/docs/api/javax/management/ObjectName.html" target="_blank" rel="noopener">ObjectNames</a> to not query. Takes precedence over <code>whitelistObjectNames</code>. Defaults to none.</td>
</tr>
<tr>
<td>rules</td>
<td>A list of rules to apply in order, processing stops at the first matching rule. Attributes that aren’t matched aren’t collected. If not specified, defaults to collecting everything in the default format.</td>
</tr>
<tr>
<td>pattern</td>
<td>Regex pattern to match against each bean attribute. The pattern is not anchored. Capture groups can be used in other options. Defaults to matching everything.</td>
</tr>
<tr>
<td>attrNameSnakeCase</td>
<td>Converts the attribute name to snake case. This is seen in the names matched by the pattern and the default format. For example, anAttrName to an_attr_name. Defaults to false.</td>
</tr>
<tr>
<td>name</td>
<td>The metric name to set. Capture groups from the <code>pattern</code> can be used. If not specified, the default format will be used. If it evaluates to empty, processing of this attribute stops with no output.</td>
</tr>
<tr>
<td>value</td>
<td>Value for the metric. Static values and capture groups from the <code>pattern</code> can be used. If not specified the scraped mBean value will be used.</td>
</tr>
<tr>
<td>valueFactor</td>
<td>Optional number that <code>value</code> (or the scraped mBean value if <code>value</code> is not specified) is multiplied by, mainly used to convert mBean values from milliseconds to seconds.</td>
</tr>
<tr>
<td>labels</td>
<td>A map of label name to label value pairs. Capture groups from <code>pattern</code> can be used in each. <code>name</code> must be set to use this. Empty names and values are ignored. If not specified and the default format is not being used, no labels are set.</td>
</tr>
<tr>
<td>help</td>
<td>Help text for the metric. Capture groups from <code>pattern</code> can be used. <code>name</code> must be set to use this. Defaults to the mBean attribute decription and the full name of the attribute.</td>
</tr>
<tr>
<td>type</td>
<td>The type of the metric, can be <code>GAUGE</code>, <code>COUNTER</code> or <code>UNTYPED</code>. <code>name</code> must be set to use this. Defaults to <code>UNTYPED</code>.</td>
</tr>
</tbody></table>
<p>修改$HADOOP_HOME/etc/hadoop/hadoop-env.sh </p>
<p>NameNode节点添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_NAMENODE_OPTS=&quot;-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false   -Dcom.sun.management.jmxremote.port=1234 $HADOOP_NAMENODE_OPTS &quot;</span><br></pre></td></tr></table></figure>

<p>DataNode节点添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_DATANODE_OPTS=&quot;-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false   -Dcom.sun.management.jmxremote.port=1235 $HADOOP_DATANODE_OPTS &quot;</span><br></pre></td></tr></table></figure>

<p>ps:</p>
<blockquote>
<p>端口1234（1235）要与之前设置的jmx端口保持一致</p>
</blockquote>
<p>修改$HADOOP_HOME/bin/hdfs</p>
<p>NameNode:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_NAMENODE_OPTS=&quot;$HADOOP_NAMENODE_OPTS -javaagent:/home/hadoop/jmx_prometheus_javaagent-0.3.1.jar=9200:/home/hadoop/namenode.yaml&quot;</span><br></pre></td></tr></table></figure>

<p>DataNode:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_DATANODE_OPTS=&quot;$HADOOP_DATANODE_OPTS -javaagent:/home/hadoop/jmx_prometheus_javaagent-0.3.1.jar=9300:/home/hadoop/datanode.yaml&quot;</span><br></pre></td></tr></table></figure>

<p>提示：9200（9300）为jmx_exporter提供metrics数据端口，后续Prometheus从此端口获取数据</p>
<p>访问<code>http://master:9200/metrics</code>就能获得需要的<code>metrics</code>数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.</span><br><span class="line"># TYPE jvm_buffer_pool_used_bytes gauge</span><br><span class="line">jvm_buffer_pool_used_bytes&#123;pool=&quot;direct&quot;,&#125; 1181032.0</span><br><span class="line">jvm_buffer_pool_used_bytes&#123;pool=&quot;mapped&quot;,&#125; 0.0</span><br><span class="line"># HELP jvm_buffer_pool_capacity_bytes Bytes capacity of a given JVM buffer pool.</span><br><span class="line"># TYPE jvm_buffer_pool_capacity_bytes gauge</span><br><span class="line">jvm_buffer_pool_capacity_bytes&#123;pool=&quot;direct&quot;,&#125; 1181032.0</span><br><span class="line">jvm_buffer_pool_capacity_bytes&#123;pool=&quot;mapped&quot;,&#125; 0.0</span><br><span class="line"># HELP jvm_buffer_pool_used_buffers Used buffers of a given JVM buffer pool.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    
	
	<div>
	  
		<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">--------------------本文结束，感谢您的阅读--------------------</div>
    
</div>
	  
	</div>
	
	<div>
      
        
      
	</div>
	


    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.jpg" alt="弓昭 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/ali.jpg" alt="弓昭 Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/exporter/" rel="tag"><i class="fa fa-tag"></i>exporter</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Kubernetes集群监控之grafana/" rel="next" title="Kubernetes集群监控之grafana">
                <i class="fa fa-chevron-left"></i> Kubernetes集群监控之grafana
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Kubernetes集群监控之pushgateway/" rel="prev" title="Kubernetes集群监控之pushgateway">
                Kubernetes集群监控之pushgateway <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTcyNy8xODI3Mw=="></div>
    
  </div>



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/panda.jpg" alt="弓昭">
          <p class="site-author-name" itemprop="name">弓昭</p>
           
              <p class="site-description motion-element" itemprop="description">弓昭的个人主页，主要涉及网络、运维、前端、Python等等知识</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">85</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">74</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gongzhao1" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://blog.csdn.net/zhao12795969" target="_blank" title="csdn">
                  
                    <i class="fa fa-fw fa-crosshairs"></i>
                  
                    
                      csdn
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.jianshu.com/u/1dbca13c6043" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-heartbeat"></i>
                  
                    
                      简书
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://ccieh3c.com/" title="网络之路" target="_blank">网络之路</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://jm.taobao.org/" title="阿里云中间件" target="_blank">阿里云中间件</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">1.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">2.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#blackbox-exporter黑盒监测"><span class="nav-number">3.</span> <span class="nav-text">blackbox_exporter黑盒监测</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署"><span class="nav-number">3.1.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用场景"><span class="nav-number">3.2.</span> <span class="nav-text">应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http测试"><span class="nav-number">3.2.1.</span> <span class="nav-text">http测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-测试"><span class="nav-number">3.2.2.</span> <span class="nav-text">TCP 测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICMP-测试"><span class="nav-number">3.2.3.</span> <span class="nav-text">ICMP 测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POST-测试"><span class="nav-number">3.2.4.</span> <span class="nav-text">POST 测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看监听过程"><span class="nav-number">3.3.</span> <span class="nav-text">查看监听过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#告警应用测试"><span class="nav-number">3.4.</span> <span class="nav-text">告警应用测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SSL-证书过期时间监测"><span class="nav-number">3.4.1.</span> <span class="nav-text">SSL 证书过期时间监测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义探针测试"><span class="nav-number">3.4.2.</span> <span class="nav-text">自定义探针测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义探针行为"><span class="nav-number">3.4.3.</span> <span class="nav-text">自定义探针行为</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#node-exporter"><span class="nav-number">4.</span> <span class="nav-text">node_exporter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#功能对照表"><span class="nav-number">4.1.</span> <span class="nav-text">功能对照表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">4.2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装包安装"><span class="nav-number">4.2.1.</span> <span class="nav-text">安装包安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes安装"><span class="nav-number">4.2.2.</span> <span class="nav-text">kubernetes安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">4.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用查询语句"><span class="nav-number">4.4.</span> <span class="nav-text">常用查询语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cpu使用率"><span class="nav-number">4.4.1.</span> <span class="nav-text">cpu使用率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU各个mode使用率"><span class="nav-number">4.4.2.</span> <span class="nav-text">CPU各个mode使用率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#机器平均负载"><span class="nav-number">4.4.3.</span> <span class="nav-text">机器平均负载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存使用率"><span class="nav-number">4.4.4.</span> <span class="nav-text">内存使用率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#磁盘使用率"><span class="nav-number">4.4.5.</span> <span class="nav-text">磁盘使用率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网卡出入包"><span class="nav-number">4.4.6.</span> <span class="nav-text">网卡出入包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dashboard模板"><span class="nav-number">4.5.</span> <span class="nav-text">dashboard模板</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mysql-exporter"><span class="nav-number">5.</span> <span class="nav-text">Mysql exporter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-1"><span class="nav-number">5.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权"><span class="nav-number">5.2.</span> <span class="nav-text">授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prometheus配置"><span class="nav-number">5.3.</span> <span class="nav-text">prometheus配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#验证状态"><span class="nav-number">5.4.</span> <span class="nav-text">验证状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jmx-exporter"><span class="nav-number">6.</span> <span class="nav-text">jmx_exporter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#举例监控kafka"><span class="nav-number">6.1.</span> <span class="nav-text">举例监控kafka</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#举例监控hadoop"><span class="nav-number">6.2.</span> <span class="nav-text">举例监控hadoop</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy;  2018 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">弓昭</span>
</div>


<div class="powered-by">
	<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
	  本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
</div>


<div class="theme-info">

  <span class="post-count">博客全站共258.5k字</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
