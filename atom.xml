<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GZ</title>
  
  <subtitle>痛苦是财富，这话是扯淡。少年，痛苦就是痛苦，对痛苦的思考才是财富</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://gongzhao1.coding.me/"/>
  <updated>2020-05-24T09:14:52.726Z</updated>
  <id>https://gongzhao1.coding.me/</id>
  
  <author>
    <name>弓昭</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes之StorageClassss——nfs-client</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E4%B9%8BStorageClassss%E2%80%94%E2%80%94nfs-client/"/>
    <id>https://gongzhao1.coding.me/Kubernetes之StorageClassss——nfs-client/</id>
    <published>2020-05-24T09:04:47.000Z</published>
    <updated>2020-05-24T09:14:52.726Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="0-参考"><a href="#0-参考" class="headerlink" title="0 参考"></a>0 参考</h1><ul><li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></li><li><a href="http://tingcream.com/blogArticle/detail/28acd1174a49432ba733cf6bbfa077a5" target="_blank" rel="noopener">http://tingcream.com/blogArticle/detail/28acd1174a49432ba733cf6bbfa077a5</a></li></ul><h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h1><p> Kubernetes集群管理员通过提供不同的存储类，可以满足用户不同的服务质量级别、备份策略和任意策略要求的存储需求。动态存储卷供应使用StorageClass进行实现，其允许存储卷按需被创建。如果没有动态存储供应，Kubernetes集群的管理员将不得不通过手工的方式类创建新的存储卷。通过动态存储卷，Kubernetes将能够按照用户的需要，自动创建其需要的存储。</p><p>比如，我们可能会在kubernetes集群中安装一些带持久化数据功能的服务，例如redis、mysql、mq、es等。因此，当有这类需求时，我们必须给整个集群给定一个特定的存储方案。本章我们是NFS的网络存储方案</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/kubernetes/storageclass.png" alt="image"></p><h2 id="2-部署"><a href="#2-部署" class="headerlink" title="2 部署"></a>2 部署</h2><h2 id="2-1-NFS服务器"><a href="#2-1-NFS服务器" class="headerlink" title="2.1 NFS服务器"></a>2.1 NFS服务器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install rpcbind  nfs-utils</span><br><span class="line"></span><br><span class="line">mkdir /nfs_data</span><br><span class="line"></span><br><span class="line">chmod +w /nfs_data</span><br><span class="line"></span><br><span class="line">chmod +x /nfs_data</span><br></pre></td></tr></table></figure><p>编辑/etc/exports,内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/nfs_data 192.168.11.0/24(rw,no_root_squash)</span><br></pre></td></tr></table></figure><p>启动nfs服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service nfs start #启动nfs服务</span><br><span class="line">service rpcbind start  #启动rpc服务</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.11.24 #查看共享盘 ok</span><br></pre></td></tr></table></figure><h2 id="2-2-使用helm部署nfs-client"><a href="#2-2-使用helm部署nfs-client" class="headerlink" title="2.2 使用helm部署nfs-client"></a>2.2 使用helm部署nfs-client</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm search nfs-client</span><br><span class="line">helm fetch nfs-client</span><br></pre></td></tr></table></figure><p>编辑helm的values文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nfs.server=192.168.11.24</span><br><span class="line">nfs.path=/nfs_data</span><br><span class="line">storageClass.defaultClass=true</span><br></pre></td></tr></table></figure><p>安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install ....</span><br></pre></td></tr></table></figure><h1 id="3-测试"><a href="#3-测试" class="headerlink" title="3 测试"></a>3 测试</h1><p>创建一个pvc使用默认的storageclass，查看pv是否自动创建成功</p><p>如果没有将nfs-client设为默认的storageclass，可使用以下命令进行操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里的 `&lt;your-class-name&gt;` 是您选择的 StorageClass 的名字。</span></span><br><span class="line">kubectl patch storageclass &lt;your-class-name&gt; -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;0-参考&quot;&gt;&lt;a href=&quot;#0-参考&quot; class=&quot;headerlink&quot; title=&quot;0 参考&quot;&gt;&lt;/a&gt;0 参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/concept
      
    
    </summary>
    
      <category term="kubernetes" scheme="https://gongzhao1.coding.me/categories/kubernetes/"/>
    
    
      <category term="storageclass" scheme="https://gongzhao1.coding.me/tags/storageclass/"/>
    
  </entry>
  
  <entry>
    <title>跨域资源共享 CORS 详解</title>
    <link href="https://gongzhao1.coding.me/%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB-CORS-%E8%AF%A6%E8%A7%A3/"/>
    <id>https://gongzhao1.coding.me/跨域资源共享-CORS-详解/</id>
    <published>2020-05-24T08:53:05.000Z</published>
    <updated>2020-05-24T09:03:25.504Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="0-转载"><a href="#0-转载" class="headerlink" title="0 转载"></a>0 转载</h1><ul><li><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></li></ul><h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h1><p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。</p><p>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。</p><p>因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p><h1 id="2-两种请求"><a href="#2-两种请求" class="headerlink" title="2 两种请求"></a>2 两种请求</h1><p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p><p>只要同时满足以下两大条件，就属于简单请求。</p><blockquote><p>（1) 请求方法是以下三种方法之一：</p><ul><li>HEAD</li><li>GET</li><li>POST</li></ul><p>（2）HTTP的头信息不超出以下几种字段：</p><ul><li>Accept</li><li>Accept-Language</li><li>Content-Language</li><li>Last-Event-ID</li><li>Content-Type：只限于三个值<code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code></li></ul></blockquote><p>这是为了兼容表单（form），因为历史上表单一直可以发出跨域请求。AJAX 的跨域设计就是，只要表单可以发，AJAX 就可以直接发。</p><p>凡是不同时满足上面两个条件，就属于非简单请求。</p><p>浏览器对这两种请求的处理，是不一样的。</p><h1 id="3-简单请求"><a href="#3-简单请求" class="headerlink" title="3 简单请求"></a>3 简单请求</h1><h2 id="3-1-基本流程"><a href="#3-1-基本流程" class="headerlink" title="3.1 基本流程"></a>3.1 基本流程</h2><p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个<code>Origin</code>字段。</p><p>下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个<code>Origin</code>字段。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; GET /cors HTTP/1.1</span><br><span class="line">&gt; Origin: http://api.bob.com</span><br><span class="line">&gt; Host: api.alice.com</span><br><span class="line">&gt; Accept-Language: en-US</span><br><span class="line">&gt; Connection: keep-alive</span><br><span class="line">&gt; User-Agent: Mozilla/5.0...</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面的头信息中，<code>Origin</code>字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p><p>如果<code>Origin</code>指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头信息没有包含<code>Access-Control-Allow-Origin</code>字段（详见下文），就知道出错了，从而抛出一个错误，被<code>XMLHttpRequest</code>的<code>onerror</code>回调函数捕获。注意，这种错误无法通过状态码识别，因为HTTP回应的状态码有可能是200。</p><p>如果<code>Origin</code>指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">&gt; Access-Control-Allow-Credentials: true</span><br><span class="line">&gt; Access-Control-Expose-Headers: FooBar</span><br><span class="line">&gt; Content-Type: text/html; charset=utf-8</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面的头信息之中，有三个与CORS请求相关的字段，都以<code>Access-Control-</code>开头。</p><p><strong>（1）Access-Control-Allow-Origin</strong></p><p>该字段是必须的。它的值要么是请求时<code>Origin</code>字段的值，要么是一个<code>*</code>，表示接受任意域名的请求。</p><p><strong>（2）Access-Control-Allow-Credentials</strong></p><p>该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为<code>true</code>，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为<code>true</code>，如果服务器不要浏览器发送Cookie，删除该字段即可。</p><p><strong>（3）Access-Control-Expose-Headers</strong></p><p>该字段可选。CORS请求时，<code>XMLHttpRequest</code>对象的<code>getResponseHeader()</code>方法只能拿到6个基本字段：<code>Cache-Control</code>、<code>Content-Language</code>、<code>Content-Type</code>、<code>Expires</code>、<code>Last-Modified</code>、<code>Pragma</code>。如果想拿到其他字段，就必须在<code>Access-Control-Expose-Headers</code>里面指定。上面的例子指定，<code>getResponseHeader(&#39;FooBar&#39;)</code>可以返回<code>FooBar</code>字段的值。</p><h2 id="3-2-withCredentials-属性"><a href="#3-2-withCredentials-属性" class="headerlink" title="3.2 withCredentials 属性"></a>3.2 withCredentials 属性</h2><p>上面说到，CORS请求默认不发送Cookie和HTTP认证信息。如果要把Cookie发到服务器，一方面要服务器同意，指定<code>Access-Control-Allow-Credentials</code>字段。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Access-Control-Allow-Credentials: true</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>另一方面，开发者必须在AJAX请求中打开<code>withCredentials</code>属性。</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&gt; xhr.withCredentials = <span class="literal">true</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>否则，即使服务器同意发送Cookie，浏览器也不会发送。或者，服务器要求设置Cookie，浏览器也不会处理。</p><p>但是，如果省略<code>withCredentials</code>设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭<code>withCredentials</code>。</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; xhr.withCredentials = <span class="literal">false</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>需要注意的是，如果要发送Cookie，<code>Access-Control-Allow-Origin</code>就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的<code>document.cookie</code>也无法读取服务器域名下的Cookie。</p><h1 id="4-非简单请求"><a href="#4-非简单请求" class="headerlink" title="4 非简单请求"></a>4 非简单请求</h1><h2 id="4-1-预检请求"><a href="#4-1-预检请求" class="headerlink" title="4.1 预检请求"></a>4.1 预检请求</h2><p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法是<code>PUT</code>或<code>DELETE</code>，或者<code>Content-Type</code>字段的类型是<code>application/json</code>。</p><p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为”预检”请求（preflight）。</p><p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的<code>XMLHttpRequest</code>请求，否则就报错。</p><p>下面是一段浏览器的JavaScript脚本。</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> url = <span class="string">'http://api.alice.com/cors'</span>;</span><br><span class="line">&gt; <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&gt; xhr.open(<span class="string">'PUT'</span>, url, <span class="literal">true</span>);</span><br><span class="line">&gt; xhr.setRequestHeader(<span class="string">'X-Custom-Header'</span>, <span class="string">'value'</span>);</span><br><span class="line">&gt; xhr.send();</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面代码中，HTTP请求的方法是<code>PUT</code>，并且发送一个自定义头信息<code>X-Custom-Header</code>。</p><p>浏览器发现，这是一个非简单请求，就自动发出一个”预检”请求，要求服务器确认可以这样请求。下面是这个”预检”请求的HTTP头信息。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; OPTIONS /cors HTTP/1.1</span><br><span class="line">&gt; Origin: http://api.bob.com</span><br><span class="line">&gt; Access-Control-Request-Method: PUT</span><br><span class="line">&gt; Access-Control-Request-Headers: X-Custom-Header</span><br><span class="line">&gt; Host: api.alice.com</span><br><span class="line">&gt; Accept-Language: en-US</span><br><span class="line">&gt; Connection: keep-alive</span><br><span class="line">&gt; User-Agent: Mozilla/5.0...</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>“预检”请求用的请求方法是<code>OPTIONS</code>，表示这个请求是用来询问的。头信息里面，关键字段是<code>Origin</code>，表示请求来自哪个源。</p><p>除了<code>Origin</code>字段，”预检”请求的头信息包括两个特殊字段。</p><p><strong>（1）Access-Control-Request-Method</strong></p><p>该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是<code>PUT</code>。</p><p><strong>（2）Access-Control-Request-Headers</strong></p><p>该字段是一个逗号分隔的字符串，指定浏览器CORS请求会额外发送的头信息字段，上例是<code>X-Custom-Header</code>。</p><h2 id="4-2-预检请求的回应"><a href="#4-2-预检请求的回应" class="headerlink" title="4.2 预检请求的回应"></a>4.2 预检请求的回应</h2><p>服务器收到”预检”请求以后，检查了<code>Origin</code>、<code>Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>字段以后，确认允许跨源请求，就可以做出回应。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; HTTP/1.1 200 OK</span><br><span class="line">&gt; Date: Mon, 01 Dec 2008 01:15:39 GMT</span><br><span class="line">&gt; Server: Apache/2.0.61 (Unix)</span><br><span class="line">&gt; Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">&gt; Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">&gt; Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">&gt; Content-Type: text/html; charset=utf-8</span><br><span class="line">&gt; Content-Encoding: gzip</span><br><span class="line">&gt; Content-Length: 0</span><br><span class="line">&gt; Keep-Alive: timeout=2, max=100</span><br><span class="line">&gt; Connection: Keep-Alive</span><br><span class="line">&gt; Content-Type: text/plain</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面的HTTP回应中，关键的是<code>Access-Control-Allow-Origin</code>字段，表示<code>http://api.bob.com</code>可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Access-Control-Allow-Origin: *</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>如果服务器否定了”预检”请求，会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段。这时，浏览器就会认定，服务器不同意预检请求，因此触发一个错误，被<code>XMLHttpRequest</code>对象的<code>onerror</code>回调函数捕获。控制台会打印出如下的报错信息。</p><blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; XMLHttpRequest cannot load http://api.alice.com.</span><br><span class="line">&gt; Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>服务器回应的其他CORS相关字段如下。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">&gt; Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">&gt; Access-Control-Allow-Credentials: true</span><br><span class="line">&gt; Access-Control-Max-Age: 1728000</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p><strong>（1）Access-Control-Allow-Methods</strong></p><p>该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次”预检”请求。</p><p><strong>（2）Access-Control-Allow-Headers</strong></p><p>如果浏览器请求包括<code>Access-Control-Request-Headers</code>字段，则<code>Access-Control-Allow-Headers</code>字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在”预检”中请求的字段。</p><p><strong>（3）Access-Control-Allow-Credentials</strong></p><p>该字段与简单请求时的含义相同。</p><p><strong>（4）Access-Control-Max-Age</strong></p><p>该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</p><h2 id="4-3-浏览器的正常请求和回应"><a href="#4-3-浏览器的正常请求和回应" class="headerlink" title="4.3 浏览器的正常请求和回应"></a>4.3 浏览器的正常请求和回应</h2><p>一旦服务器通过了”预检”请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个<code>Origin</code>头信息字段。服务器的回应，也都会有一个<code>Access-Control-Allow-Origin</code>头信息字段。</p><p>下面是”预检”请求之后，浏览器的正常CORS请求。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; PUT /cors HTTP/1.1</span><br><span class="line">&gt; Origin: http://api.bob.com</span><br><span class="line">&gt; Host: api.alice.com</span><br><span class="line">&gt; X-Custom-Header: value</span><br><span class="line">&gt; Accept-Language: en-US</span><br><span class="line">&gt; Connection: keep-alive</span><br><span class="line">&gt; User-Agent: Mozilla/5.0...</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面头信息的<code>Origin</code>字段是浏览器自动添加的。</p><p>下面是服务器正常的回应。</p><blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">&gt; Content-Type: text/html; charset=utf-8</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>上面头信息中，<code>Access-Control-Allow-Origin</code>字段是每次回应都必定包含的。</p><h1 id="5-与JSONP的比较"><a href="#5-与JSONP的比较" class="headerlink" title="5 与JSONP的比较"></a>5 与JSONP的比较</h1><p>CORS与JSONP的使用目的相同，但是比JSONP更强大。</p><p>JSONP只支持<code>GET</code>请求，CORS支持所有类型的HTTP请求。JSONP的优势在于支持老式浏览器，以及可以向不支持CORS的网站请求数据。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;0-转载&quot;&gt;&lt;a href=&quot;#0-转载&quot; class=&quot;headerlink&quot; title=&quot;0 转载&quot;&gt;&lt;/a&gt;0 转载&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ruanyifeng.com/blog/201
      
    
    </summary>
    
    
      <category term="cors" scheme="https://gongzhao1.coding.me/tags/cors/"/>
    
  </entry>
  
  <entry>
    <title>OAuth详解</title>
    <link href="https://gongzhao1.coding.me/OAuth%E8%AF%A6%E8%A7%A3/"/>
    <id>https://gongzhao1.coding.me/OAuth详解/</id>
    <published>2020-05-24T08:08:24.000Z</published>
    <updated>2020-05-24T08:39:09.707Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="0-参考文章"><a href="#0-参考文章" class="headerlink" title="0 参考文章"></a>0 参考文章</h1><ul><li><a href="https://www.jianshu.com/p/b06944c92228" target="_blank" rel="noopener">https://www.jianshu.com/p/b06944c92228</a></li><li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a></li></ul><h1 id="1-什么是OAuth"><a href="#1-什么是OAuth" class="headerlink" title="1 什么是OAuth"></a>1 什么是OAuth</h1><p>官网这样说…</p><blockquote><p>An <strong>open protocol</strong> to allow <strong>secure authorization</strong> in a <strong>simple</strong> and <strong>standard</strong> method from web, mobile and desktop applications.</p></blockquote><ul><li>OAuth 即 <strong>O</strong>pen standard for <strong>Auth</strong>orization</li><li>OAuth就是一个网络开放协议。为保证用户资源的安全授权提供了简易的标准</li><li>在知乎上看到了一个比较直观的比喻，有助于初学者理解。<a href="https://link.jianshu.com?t=http://www.zhihu.com/question/19781476" target="_blank" rel="noopener">知乎话题链接</a></li></ul><h1 id="2-OAuth历史版本"><a href="#2-OAuth历史版本" class="headerlink" title="2 OAuth历史版本"></a>2 OAuth历史版本</h1><p><strong>2007-12</strong> OAuth 1.0发布并迅速成为工业标准。</p><p><strong>2008-06</strong> OAuth 1.0 Revision A发布，这是个稍作修改的修订版本，主要修正一个安全方面的漏洞。</p><p><strong>2010-04</strong>，OAuth 1.0 协议发布为 <a href="https://link.jianshu.com?t=http://www.rfcreader.com/#rfc5849" target="_blank" rel="noopener">RFC 5849</a></p><p><strong>2011-05</strong> OAuth 2.0 草案发布</p><p><strong>2012-10</strong> OAuth 2.0 协议发布为 <a href="https://link.jianshu.com?t=http://www.rfcreader.com/#rfc6749" target="_blank" rel="noopener">RFC 6749</a></p><h1 id="3-OAuth-1-0"><a href="#3-OAuth-1-0" class="headerlink" title="3 OAuth 1.0"></a>3 OAuth 1.0</h1><p>OAuth 1.0 协议过于复杂，易用性差，所以并没有得到普及，下文中给出了授权的流程图，可以简单了解了解，现在很少有用的了。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/1.webp" alt="image"></p><p>关于OAuth 1.0， 想了解的可以看看这些：</p><ul><li><a href="https://link.jianshu.com/?t=http://www.rfcreader.com/#rfc5849" target="_blank" rel="noopener">RFC 5849</a></li><li><a href="https://link.jianshu.com/?t=http://blog.csdn.net/hereweare2009/article/details/3968582" target="_blank" rel="noopener">OAUTH协议简介</a></li></ul><h1 id="4-OAuth-2-0"><a href="#4-OAuth-2-0" class="headerlink" title="4 OAuth 2.0"></a>4 OAuth 2.0</h1><p>OAuth 2.0是目前的最新版本，OAuth 2.0不兼容OAuth 1.0。这篇文章主要讲讲OAuth 2.0，并以此展开。</p><p><strong>先来说一个场景：</strong>比如你第一次打开简书官网，想要注册一个账号。你会看到简书允许你通过新浪微博账号登陆。当你点击之后，需要你登陆微博。之后会出现“是否同意简书获取你的个人信息”等等，如果你选择授权，之后会跳转回简书。你会发现你在简书的用户名就是你微博的用户名。然后，你会发出一条新的微博比如“我加入了简书，一个基于内容分享的社区！”(这只是举个例子，不知道简书有没有这样做)。</p><p>好了，这回开始进入正题</p><h2 id="4-1-角色（roles）"><a href="#4-1-角色（roles）" class="headerlink" title="4.1 角色（roles）"></a>4.1 角色（roles）</h2><p>OAuth 2.0 定义了<strong>四个角色</strong>：</p><ul><li><strong>资源拥有者(Resource Owner)</strong><br> 资源拥有者其实就是用户(user)，用户将会授权一个第三方应用可以获取他们的账户资源。当然第三方应用程序对于用户账户的操作是有限制的(比如，read access, read and write access)！这个限制就是用户授权时给予的权限范围(<strong>scope</strong>)<br> 上面场景中，微博账户就是资源拥有者。read access就比如读取微博用户名，write access就比如以你的名义发了一个微博。</li><li><strong>客户端(Client)</strong><br> 客户端就是前面说的第三方应用程序，他们想要获取用户的账户资源，但在这么做之前必须经过授权<br> 上面场景中，简书就是客户端</li><li><strong>资源服务器(Resource Server)</strong><br> 资源服务器存放用户账户以及账户信息和资源<br> 上面场景中，新浪微博就是资源服务器，同时也是授权服务器</li><li><strong>授权服务器(Authorization Server)</strong><br> 授权服务器验证用户身份，并为第三方应用程序颁发授权令牌(access token)</li></ul><p>资源服务器与授权服务器可以是同一台服务器，这里分开主要是便于解释清楚OAuth协议。从程序开发者的角度，这两个都是service’s API会执行的事情。</p><p>在了解完OAuth中的四个角色之后，我们看看这四个角色之间是如何互动的。下面是基本运行流程。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/2.webp" alt="image"></p><ol><li>应用程序向用户请求给予授权，以便获取服务器资源</li></ol><ul><li>如果用户同意授权，应用程序将获得相应授权</li><li>应用程序向授权服务器提供自己的身份证明(app key和app secret)和已被授权的证明(authorization grant)，并请求访问令牌(access token)</li><li>如果应用程序的身份被核实，并且授权是有效地，那么授权服务器将会发放访问令牌给应用程序。<strong>此时，授权完成</strong></li><li>应用程序向资源服务器出示访问令牌，并请求资源</li><li>如果访问令牌是有效的(比如：是否伪造，是否越权，是否过期)，资源服务器将会为应用程序提供资源</li></ul><h2 id="4-2-应用程序注册-Application-Registration"><a href="#4-2-应用程序注册-Application-Registration" class="headerlink" title="4.2 应用程序注册(Application Registration)"></a>4.2 应用程序注册(Application Registration)</h2><p>对于一个应用程序来说，如果它想要使用OAuth，那么首先它要在服务提供商那里注册。一般出现在网站的“developer”或者“API”部分。</p><p>应用程序要提供：</p><ul><li>应用程序名称(Application Name)</li><li>应用程序网站(Application Website)</li><li>回调URL(Redirect URI or Callback URL)</li></ul><p>在用户同意授权(或者拒绝)之后，服务提供商会将用户重新导向这个Callback URL，这个Callback URL要来负责处理授权码或者访问令牌。</p><p>应用程序注册完成之后，服务提供商会颁发给应用程序一个“客户端认证信息(client credentials)”。Client Credential包括：</p><ul><li><p>Client Identifier</p><p>(client ID/API key/consumer key)</p><ul><li>提供给服务提供商，用于<strong>识别</strong>(identify)应用程序</li><li>用于构建提供给用户请求授权的URLs</li></ul></li><li><p>Client Secret</p><p>(secret key/API secret/consumer secret)</p><ul><li>提供给服务提供商，用于<strong>验证</strong>(authenticate)应用程序</li><li>只有应用程序和服务提供商两者可知</li></ul></li></ul><h2 id="4-3-授权许可类型-Authorization-grant-types"><a href="#4-3-授权许可类型-Authorization-grant-types" class="headerlink" title="4.3 授权许可类型(Authorization grant types)"></a>4.3 授权许可类型(Authorization grant types)</h2><p><strong>OAuth 2.0 定义了四种授权模式：</strong></p><ul><li><strong>授权码模式</strong>(Authorization Code)<br> used with server-side Applications</li><li><strong>隐式授权模式</strong>(Implicit)<br> used with Mobile Apps or Web Applications (applications that run on the user’s device)</li><li><strong>资源拥有者密码凭证模式</strong>(Resource Owner Password Credentials)<br> used with trusted Applications, such as those owned by the service itself</li><li><strong>客户端模式</strong>(Client Credentials)<br> used with Applications API access</li></ul><h2 id="4-4-授权码模式-Authorization-Code"><a href="#4-4-授权码模式-Authorization-Code" class="headerlink" title="4.4 授权码模式(Authorization Code)"></a>4.4 授权码模式(Authorization Code)</h2><ul><li>授权码模式是最常见的一种授权模式，最为安全和完善。</li><li>对于服务器端应用程序(server-side application)来说，可以保证Client Secret的安全性。应用程序必须能够和用户代理(user agent)进行交互，获取API授权码。</li></ul><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/3.webp" alt="image"></p><p><strong>第一步：客户端把用户代理定向到授权终端(Authorizaiton Endpoint)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.example.com/v1/oauth/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;redirect_uri=CALLBACK_URL&amp;scope=<span class="built_in">read</span></span><br></pre></td></tr></table></figure><ul><li><strong><a href="https://link.jianshu.com?t=http://www.example.com/v1/oauth/authorize" target="_blank" rel="noopener">www.example.com/v1/oauth/authorize</a></strong>: API授权的终端(Authorization Endpoint)</li><li><strong>client_id</strong>: 应用程序的client ID，用于API识别应用程序</li><li><strong>redirect_uri</strong>：获得授权码之后，服务提供商重定向用户代理(比如浏览器)的地址</li><li><strong>response_type</strong>：表明授权类型，默认值是code，即授权码模式(Authorization Code Grant)</li><li><strong>scope</strong>: 即应用程序可以获得的授权级别(access level)，默认值为read</li><li><strong>state</strong>: 表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值，用于抵制CSRF攻击。</li></ul><p><strong>第二步：用户授权应用程序</strong></p><p>用户点击上述URI之后，用户首先要登陆，证明其身份。然后选择同意授权应用程序可以访问他们的账户或者拒绝。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/4.webp" alt="image"></p><p><strong>第三步：应用程序获取授权码</strong></p><p>如果用户同意授权，服务提供商会将用户代理重定向到第一步中的redirect_uri，并且会包含<strong>授权码</strong>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.jianshu.com/callback?code=AUTHORIZATION_CODE</span></span><br></pre></td></tr></table></figure><p><strong>第四步：应用程序请求授权令牌</strong></p><p>应用程序向API token终端发送刚刚获得的授权码，以及认证信息。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.example.com/v1/oauth/token?client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET&amp;grant_type=authorization_code&amp;code=AUTHORIZATION_CODE&amp;redirect_uri=CALLBACK_URL</span></span><br></pre></td></tr></table></figure><p>URI中包括：</p><ul><li><strong><a href="https://link.jianshu.com?t=http://www.example.com/v1/oauth/token" target="_blank" rel="noopener">www.example.com/v1/oauth/token</a></strong>： API token的终端</li><li><strong>client_id</strong>：即app key/consumer key，用于验证应用程序</li><li><strong>client_secret</strong>： 即app secret/consumer secret，用于验证应用程序</li><li><strong>grant_type</strong>：刚刚获得的授权码</li><li><strong>redirect_uri</strong>: 重定向URI，与第一步一致</li></ul><p><strong>第五步：应用程序获得授权令牌</strong></p><p>如果上一步验证有效，API将返回一个HTTP回复。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"access_token"</span>:<span class="string">"ACCESS_TOKEN"</span>,<span class="attr">"token_type"</span>:<span class="string">"bearer"</span>,<span class="attr">"expires_in"</span>:<span class="number">2592000</span>,<span class="attr">"refresh_token"</span>:<span class="string">"REFRESH_TOKEN"</span>,<span class="attr">"scope"</span>:<span class="string">"read"</span>&#125;</span><br></pre></td></tr></table></figure><p>HTTP回复中包含：</p><ul><li><strong>access_token</strong>：访问令牌</li><li><strong>token_type</strong>：令牌类型，bearer类型或mac类型。<a href="https://link.jianshu.com?t=http://oauth2.thephpleague.com/token-types/" target="_blank" rel="noopener">详细</a></li><li><strong>expires_in</strong>：过期时间，单位为秒。</li><li><strong>refresh_token</strong>：更新令牌，用来获取下一次的访问令牌，可选项。</li><li><strong>scope</strong>：权限范围，如果与客户端申请的范围一致，此项可省略。</li></ul><h2 id="4-5-隐式授权模式-Implicit"><a href="#4-5-隐式授权模式-Implicit" class="headerlink" title="4.5 隐式授权模式(Implicit)"></a>4.5 隐式授权模式(Implicit)</h2><ul><li>隐式授权模式主要用于客户端应用程序(client-side application)，比如手机应用、桌面客户端应用程序和运行于浏览器上的web应用程序。</li><li>因为没有server端，client secret的保密性不能得到保证。授权令牌给予用户代理(比如，浏览器)，再由用户代理交给应用程序。所以用户设备上的其他应用程序同样可以得到授权令牌。</li><li>隐式授权模式中，应用程序不需要认证。</li><li>隐式授权模式不支持refresh token。</li></ul><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/5.webp" alt="image"></p><p><strong>第一步：客户端把用户代理定向到授权终端(Authorizaiton Endpoint)</strong></p><ul><li>授权终端是<code>https://www.example.com/authorize</code></li><li>与授权码链接类似，只不过response_type=<code>token</code>而不是<code>code</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.example.com/authorize?response_type=token&amp;client_id=CLIENT_ID&amp;redirect_uri=CALLBACK_URL&amp;scope=<span class="built_in">read</span></span><br></pre></td></tr></table></figure><p><strong>第二步：用户授权应用程序</strong></p><p>用户点击上述URI之后，用户首先要登陆，证明其身份。然后选择同意授权应用程序可访问他们的账户或者拒绝。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/6.webp" alt="image"></p><p><strong>第三步：用户代理收到授权令牌</strong></p><p>假设用户同意授权，授权服务器重定向用户代理到第一步提到的redirect_uri。并在URI fragment中包含授权令牌(但不能查看)。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span>/<span class="regexp">/www.example.com/callback</span><span class="comment">#token=ACCESS_TOKEN</span></span><br></pre></td></tr></table></figure><p><strong>第四步：用户代理向资源服务器发出请求</strong></p><p>用户代理依照重定向的指令，向资源服务器发出请求，但并不包含上一步中得到的授权令牌(#后面的部分)。用户代理将完整的重定向URI保存在本地。</p><p><strong>第五步：资源服务器返回一个网页</strong></p><p>资源服务器会返回一个网页(通常是一个HTML文件内嵌一段脚本)。这段内嵌的脚本(script)可以访问第三步中用户代理保存在本地的完整的重定向URI，并从中提取授权令牌。</p><p><strong>第六步：用户代理提取授权令牌</strong></p><p>用户代理执行上面提到的脚本，提取出授权令牌。然后将授权令牌传递给应用程序。</p><h2 id="4-6-资源拥有者密码凭证模式-Resource-Owner-Password-Credentials"><a href="#4-6-资源拥有者密码凭证模式-Resource-Owner-Password-Credentials" class="headerlink" title="4.6 资源拥有者密码凭证模式(Resource Owner Password Credentials)"></a>4.6 资源拥有者密码凭证模式(Resource Owner Password Credentials)</h2><ul><li>在资源拥有者密码凭证模式中，用户直接向应用程序提供其认证信息(即用户名和密码)。应用程序依此向授权服务器获取授权令牌。</li><li>这种模式适用于用户对应用程序高度信任的情况。比如是用户操作系统的一部分。</li><li>认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</li></ul><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/7.webp" alt="image"></p><p><strong>第一步：用户传递认证信息</strong></p><p>用户将用户名和密码交给应用程序。</p><p><strong>第二步：应用程序请求授权令牌</strong></p><ul><li>应用程序得到用户认证信息后，向授权服务器请求授权令牌。</li><li>请求授权令牌终端<code>https://www.example.com/token</code></li><li>response_type=<code>password</code>，前面提到的两种分别是<code>code</code>和<code>token</code>。</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.example.com/token?grant_type=password&amp;username=USERNAME&amp;password=PASSWORD&amp;client_id=CLIENT_ID</span></span><br></pre></td></tr></table></figure><p><strong>第三步：授权服务器返回授权令牌</strong></p><p>如果用户的认证信息得到验证，授权服务器将向应用程序返回授权令牌。</p><h2 id="4-7-客户端模式-Client-Credentials"><a href="#4-7-客户端模式-Client-Credentials" class="headerlink" title="4.7 客户端模式(Client Credentials)"></a>4.7 客户端模式(Client Credentials)</h2><ul><li>客户端模式应用于应用程序想要以自己的名义与授权服务器以及资源服务器进行互动。</li><li>比如应用程序想要修改自身注册信息或者redirect URI。又或者想要获取资源服务器中不与具体用户相关的信息。比如一个应用程序想要获取新浪微博中含有#happy的微博。</li><li>严格意义上说，客户端模式并不是OAuth协议要解决的问题，因为并未涉及授权。</li></ul><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/OAuth/8.webp" alt="image"></p><p><strong>第一步：应用程序请求授权令牌</strong></p><ul><li>应用程序向授权服务器提供自身认证信息(client ID和client secret)，并请求授权令牌。</li><li>请求授权令牌终端<code>https://www.example.com/token</code></li><li>response_type=<code>client_credentials</code>，前面提到的两种分别是<code>code</code>、<code>token</code>和<code>password</code>。</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.example.com/token?grant_type=client_credentials&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET</span></span><br></pre></td></tr></table></figure><p><strong>第二步：授权服务器返回授权令牌</strong></p><p>授权服务器验证认证信息，向应用程序返回授权令牌。</p><h2 id="4-8-更新令牌-Refresh-Token"><a href="#4-8-更新令牌-Refresh-Token" class="headerlink" title="4.8 更新令牌(Refresh Token)"></a>4.8 更新令牌(Refresh Token)</h2><ul><li>如果授权令牌过期，在进行API请求时会报错<code>Invalid Token Error</code></li><li>如果在获取授权令牌时，同时获得了refresh token，那么我们可以向授权服务器申请更新令牌。</li><li>grant_type = <code>refresh_token</code></li><li>scope：表示申请的授权范围，不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致。</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.example.com/v1/oauth/token?grant_type=refresh_token&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET&amp;refresh_token=REFRESH_TOKEN</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;0-参考文章&quot;&gt;&lt;a href=&quot;#0-参考文章&quot; class=&quot;headerlink&quot; title=&quot;0 参考文章&quot;&gt;&lt;/a&gt;0 参考文章&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/
      
    
    </summary>
    
    
      <category term="OAuth" scheme="https://gongzhao1.coding.me/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes之Ingress</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E4%B9%8BIngress/"/>
    <id>https://gongzhao1.coding.me/Kubernetes之Ingress/</id>
    <published>2020-04-08T14:50:08.000Z</published>
    <updated>2020-05-24T08:41:54.770Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://blog.csdn.net/qianghaohao/article/details/99354304" target="_blank" rel="noopener">https://blog.csdn.net/qianghaohao/article/details/99354304</a></li><li><a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></li><li><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/</a></li></ul><h1 id="1-k8s-对外暴露服务的方法"><a href="#1-k8s-对外暴露服务的方法" class="headerlink" title="1 k8s 对外暴露服务的方法"></a>1 k8s 对外暴露服务的方法</h1><p>向 k8s 集群外部暴露服务的方式有三种： nodePort，LoadBalancer 和本文要介绍的 Ingress。每种方式都有各自的优缺点，nodePort 方式在服务变多的情况下会导致节点要开的端口越来越多，不好管理。而 LoadBalancer 更适合结合云提供商的 LB 来使用，但是在 LB 越来越多的情况下对成本的花费也是不可小觑。Ingress 是 k8s 官方提供的用于对外暴露服务的方式，也是在生产环境用的比较多的方式，一般在云环境下是 LB + Ingress Ctroller 方式对外提供服务，这样就可以在一个 LB 的情况下根据域名路由到对应后端的 Service，有点类似于 Nginx 反向代理，只不过在 k8s 集群中，这个反向代理是集群外部流量的统一入口。</p><h1 id="2-Ingress-及-Ingress-Controller-简介"><a href="#2-Ingress-及-Ingress-Controller-简介" class="headerlink" title="2 Ingress 及 Ingress Controller 简介"></a>2 Ingress 及 Ingress Controller 简介</h1><p>Ingress 是 k8s 资源对象，用于对外暴露服务，该资源对象定义了不同主机名（域名）及 URL 和对应后端 Service（k8s Service）的绑定，根据不同的路径路由 http 和 https 流量。而 Ingress Contoller 是一个 pod 服务，封装了一个 web 前端负载均衡器，同时在其基础上实现了动态感知 Ingress 并根据 Ingress 的定义动态生成 前端 web 负载均衡器的配置文件，比如 Nginx Ingress Controller 本质上就是一个 Nginx，只不过它能根据 Ingress 资源的定义动态生成 Nginx 的配置文件，然后动态 Reload。个人觉得 Ingress Controller 的重大作用是将前端负载均衡器和 Kubernetes 完美地结合了起来，一方面在云、容器平台下方便配置的管理，另一方面实现了集群统一的流量入口，而不是像 nodePort 那样给集群打多个孔。<br><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/ingress/1.png" alt="image"></p><p>所以，总的来说要使用 Ingress，得先部署 Ingress Controller 实体（相当于前端 Nginx），然后再创建 Ingress （相当于 Nginx 配置的 k8s 资源体现），Ingress Controller 部署好后会动态检测 Ingress 的创建情况生成相应配置。Ingress Controller 的实现有很多种：有基于 Nginx 的，也有基于 HAProxy的，还有基于 OpenResty 的 Kong Ingress Controller 等，更多 Controller 见：<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/，本文使用基于" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/，本文使用基于</a> Nginx 的 Ingress Controller：<a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">ingress-nginx</a>。</p><a id="more"></a><h1 id="3-helm-部署-Nginx-Ingress-Controller"><a href="#3-helm-部署-Nginx-Ingress-Controller" class="headerlink" title="3 helm 部署 Nginx Ingress Controller"></a>3 helm 部署 Nginx Ingress Controller</h1><p>基于 Nginx 的 Ingress Controller 有两种，一种是 k8s 社区提供的 <a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">ingress-nginx</a>，另一种是 Nginx 社区提供的 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener">kubernetes-igress</a>，关于两者的区别见 <a href="https://github.com/nginxinc/kubernetes-ingress/blob/master/docs/nginx-ingress-controllers.md" target="_blank" rel="noopener">这里</a>。</p><p>在这里我们部署 k8s 社区提供的 <a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">ingress-nginx</a>，Ingress Controller 对外暴露方式采用 hostNetwork，在裸机环境下更多其他暴露方式见：<a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</a><br><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/ingress/2.png" alt="image"></p><p>使用 Helm 官方提供的 Chart <a href="stable/nginx-ingress">stable/nginx-ingress</a>，修改 values 文件：</p><ul><li>使用 DaemonSet 控制器，默认是 Deployment：controller.kind 设为 DaemonSet；</li><li>pod 使用主机网络：controller.hostNetwork 设为 true；</li><li>在hostNetwork 下 pod 使用集群提供 dns 服务：controller.dnsPolicy 设为 ClusterFirstWithHostNet；</li><li>Service 类型设为 ClusterIP，默认是 LoadBalancer：controller.service.type 设为 ClusterIP；</li><li>默认后端镜像使用 docker hub 提供的镜像，Google 国内无法访问；</li></ul><p>helm 部署(国内可以使用微软的helm源)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/nginx-ingress --name nginx-ingress -f myValues.yaml</span><br></pre></td></tr></table></figure><p>部署完成后我们可以看到 Kubernetes 服务中增加了 <code>nginx-ingress-controller</code> 和 <code>nginx-ingress-default-backend</code> 两个服务。<code>nginx-ingress-controller</code> 为 <code>Ingress Controller</code>，主要做为一个七层的负载均衡器来提供 HTTP 路由、粘性会话、SSL 终止、SSL直通、TCP 和 UDP 负载平衡等功能。<code>nginx-ingress-default-backend</code> 为默认的后端，当集群外部的请求通过 Ingress 进入到集群内部时，如果无法负载到相应后端的 Service 上时，这种未知的请求将会被负载到这个默认的后端上。nginx-ingress-default-backend 默认提供了两个 URL 进行访问，其中的 /healthz 用作健康检查返回 200，而 / 返回 404 错误。</p><h1 id="4-使用-Ingress-对外暴露服务-7层"><a href="#4-使用-Ingress-对外暴露服务-7层" class="headerlink" title="4 使用 Ingress 对外暴露服务-7层"></a>4 使用 Ingress 对外暴露服务-7层</h1><h2 id="4-1-HTTP类型服务"><a href="#4-1-HTTP类型服务" class="headerlink" title="4.1 HTTP类型服务"></a>4.1 HTTP类型服务</h2><p>为了快速体验 Ingress，下面部署一个 nginx 服务，然后通过 Ingress 对外暴露 nginx service 进行访问。<br>首先部署 nginx 服务：<br>Deployment + Service</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>接下来创建 Ingress 对外暴露 nginx service 80 端口：<br>ingress.yml:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># use the shared ingress-nginx</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">nginx.kube.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>kubernetes.io/ingress.class: “nginx”：Nginx Ingress Controller 根据该注解自动发现 Ingress；</li><li>host: nginx.kube.com：对外访问的域名；</li><li>serviceName: nginx：对外暴露的 Service 名称；</li><li>servicePort: 80：nginx service 监听的端口；</li></ul><blockquote><p>创建的 Ingress 必须要和对外暴露的 Service 在同一命名空间下！</p></blockquote><h2 id="4-2-HTTPS类型服务"><a href="#4-2-HTTPS类型服务" class="headerlink" title="4.2 HTTPS类型服务"></a>4.2 HTTPS类型服务</h2><p><strong>通过 Ingress 访问 kubernetes dashboard（支持 HTTPS 访问）</strong><br>首先，练习使用，先用自签名证书来代替吧：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout kube-dashboard.key -out kube-dashboard.crt -subj <span class="string">"/CN=dashboard.kube.com/O=dashboard.kube.com"</span></span><br></pre></td></tr></table></figure><p>使用生成的证书创建 k8s Secret 资源，下一步创建的 Ingress 会引用这个 Secret：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls kube-dasboard-ssl --key kube-dashboard.key --cert kube-dashboard.crt -n kube-system</span><br></pre></td></tr></table></figure><p>创建 Ingress 资源对象（支持 HTTPS 访问）：</p><p>kube-dashboard-ingress.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-kube-dashboard</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># use the shared ingress-nginx</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">  - hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">dashboard.kube.com</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">kube-dasboard-ssl</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">dashboard.kube.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>kubernetes.io/ingress.class: “nginx”：Inginx Ingress Controller 根据该注解自动发现 Ingress；</li><li>nginx.ingress.kubernetes.io/backend-protocol: Controller 向后端 Service 转发时使用 HTTPS 协议，这个注解必须添加，否则访问会报错</li></ul><ul><li>secretName: kube-dasboard-ssl：https 证书 Secret；</li><li>host: dashboard.kube.com：对外访问的域名；</li><li>serviceName: kubernetes-dashboard：集群对外暴露的 Service 名称；</li><li>servicePort: 443：service 监听的端口；</li></ul><blockquote><p>注意：创建的 Ingress 必须要和对外暴露的 Service 在同一命名空间下！</p></blockquote><p>将域名 dashboard.kube.com绑定到 k8s 任意节点 ip 即可访问.</p><h2 id="4-3-basic-auth认证"><a href="#4-3-basic-auth认证" class="headerlink" title="4.3 basic-auth认证"></a>4.3 basic-auth认证</h2><h3 id="4-3-1-创建用户名密码"><a href="#4-3-1-创建用户名密码" class="headerlink" title="4.3.1 创建用户名密码"></a>4.3.1 创建用户名密码</h3><p>首先需要安装htpasswd二进制文件，通过htpasswd生成一个“auth”文件;用来存取我们创建的用户及加密之后的密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c auth user1</span><br><span class="line">New password: &lt;bar&gt;</span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user user1</span><br><span class="line"></span><br><span class="line">htpasswd auth user2</span><br><span class="line">2nd user:</span><br><span class="line">htpasswd auth user2</span><br><span class="line">New password: &lt;bar&gt;</span><br><span class="line">New password:</span><br><span class="line">Re-type new password:</span><br><span class="line">Adding password <span class="keyword">for</span> user user2</span><br></pre></td></tr></table></figure><h3 id="4-3-2-创建kubernetes-secret来存储user-pass-pairs"><a href="#4-3-2-创建kubernetes-secret来存储user-pass-pairs" class="headerlink" title="4.3.2 创建kubernetes secret来存储user/pass pairs"></a>4.3.2 创建kubernetes secret来存储user/pass pairs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n &lt;namespace&gt; create secret generic basic-auth --from-file=auth</span><br><span class="line">secret <span class="string">"basic-auth"</span> created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get secret basic-auth -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  auth: Zm9vOiRhcHIxJE9DRzZYeWJcJGNrKDBGSERBa29YWUlsSDkuY3lzVDAK</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: basic-auth</span><br><span class="line">  namespace: default</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure><h3 id="4-3-3-创建Ingress"><a href="#4-3-3-创建Ingress" class="headerlink" title="4.3.3 创建Ingress"></a>4.3.3 创建Ingress</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: basic</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth   #此secret需和ingress在用一namespace下</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: &quot;Authentication Required&quot; #提示符</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: prom.xxxxx.im</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - path: /</span><br><span class="line">            backend:</span><br><span class="line">              serviceName: prometheus-svc</span><br><span class="line">              servicePort: 9090</span><br></pre></td></tr></table></figure><h2 id="4-4-多路径及虚拟主机例子"><a href="#4-4-多路径及虚拟主机例子" class="headerlink" title="4.4 多路径及虚拟主机例子"></a>4.4 多路径及虚拟主机例子</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">my-ingress</span></span><br><span class="line"><span class="attr">  annotations:</span> </span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">api.mydomain.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">api</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">domain.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/web/*</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">backoffice.domain.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">backoffice</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><h1 id="5-使用-Ingress-对外暴露服务-4层"><a href="#5-使用-Ingress-对外暴露服务-4层" class="headerlink" title="5 使用 Ingress 对外暴露服务-4层"></a>5 使用 Ingress 对外暴露服务-4层</h1><p>我们可以看到ingress nginx的args里有这两行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">- --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br></pre></td></tr></table></figure><p>从选项和值可以猜测出，要想代理四层（tcp/udp），得写同namespace里一个名为<code>tcp-service</code>和<code>udp-service</code>的两个configmap的数据 四层的话这边我们创建一个mysql的pod，来代理3306端口到集群外面，则需要写tcp-services这个configmap：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">data:</span><br><span class="line">  3306: &quot;default/mysql:3306&quot;</span><br></pre></td></tr></table></figure><p>四层写这两个ConfigMap的data即可，按照这样去写即可<code>out_port: namespaces/svc_name:port</code>，要给每个ingress加一些nginx里的配置可以查看官方的annotation字段以及值（traefik同理）。</p><p><strong>如果我们用如上helm方式部署ingress-nginx的话</strong></p><p>直接编辑它的vales.yaml文件，在TCP/UDP字段之后添加<code>out_port: namespaces/svc_name:port</code>即可，helm会自动帮你生成对应的configmap，并暴露对应的四层端口</p><p><strong>其他例子</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">udp-services</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="number">2200</span><span class="string">:</span> <span class="string">"default/gitlab:22"</span></span><br><span class="line">  <span class="number">3306</span><span class="string">:</span> <span class="string">"kube-public/mysql:3306"</span></span><br><span class="line">  <span class="number">2202</span><span class="string">:</span> <span class="string">"kube-public/centos:22"</span></span><br><span class="line">  <span class="number">2203</span><span class="string">:</span> <span class="string">"kube-public/mongodb:27017"</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">udp-services</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="number">53</span><span class="string">:</span> <span class="string">"kube-system/kube-dns:53"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/qianghaohao/article/details/99354304&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/qianghaohao/article/details/99354304&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes/ingress-nginx&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/kubernetes/ingress-nginx&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.github.io/ingress-nginx/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://kubernetes.github.io/ingress-nginx/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;1-k8s-对外暴露服务的方法&quot;&gt;&lt;a href=&quot;#1-k8s-对外暴露服务的方法&quot; class=&quot;headerlink&quot; title=&quot;1 k8s 对外暴露服务的方法&quot;&gt;&lt;/a&gt;1 k8s 对外暴露服务的方法&lt;/h1&gt;&lt;p&gt;向 k8s 集群外部暴露服务的方式有三种： nodePort，LoadBalancer 和本文要介绍的 Ingress。每种方式都有各自的优缺点，nodePort 方式在服务变多的情况下会导致节点要开的端口越来越多，不好管理。而 LoadBalancer 更适合结合云提供商的 LB 来使用，但是在 LB 越来越多的情况下对成本的花费也是不可小觑。Ingress 是 k8s 官方提供的用于对外暴露服务的方式，也是在生产环境用的比较多的方式，一般在云环境下是 LB + Ingress Ctroller 方式对外提供服务，这样就可以在一个 LB 的情况下根据域名路由到对应后端的 Service，有点类似于 Nginx 反向代理，只不过在 k8s 集群中，这个反向代理是集群外部流量的统一入口。&lt;/p&gt;
&lt;h1 id=&quot;2-Ingress-及-Ingress-Controller-简介&quot;&gt;&lt;a href=&quot;#2-Ingress-及-Ingress-Controller-简介&quot; class=&quot;headerlink&quot; title=&quot;2 Ingress 及 Ingress Controller 简介&quot;&gt;&lt;/a&gt;2 Ingress 及 Ingress Controller 简介&lt;/h1&gt;&lt;p&gt;Ingress 是 k8s 资源对象，用于对外暴露服务，该资源对象定义了不同主机名（域名）及 URL 和对应后端 Service（k8s Service）的绑定，根据不同的路径路由 http 和 https 流量。而 Ingress Contoller 是一个 pod 服务，封装了一个 web 前端负载均衡器，同时在其基础上实现了动态感知 Ingress 并根据 Ingress 的定义动态生成 前端 web 负载均衡器的配置文件，比如 Nginx Ingress Controller 本质上就是一个 Nginx，只不过它能根据 Ingress 资源的定义动态生成 Nginx 的配置文件，然后动态 Reload。个人觉得 Ingress Controller 的重大作用是将前端负载均衡器和 Kubernetes 完美地结合了起来，一方面在云、容器平台下方便配置的管理，另一方面实现了集群统一的流量入口，而不是像 nodePort 那样给集群打多个孔。&lt;br&gt;&lt;img src=&quot;https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/ingress/1.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;所以，总的来说要使用 Ingress，得先部署 Ingress Controller 实体（相当于前端 Nginx），然后再创建 Ingress （相当于 Nginx 配置的 k8s 资源体现），Ingress Controller 部署好后会动态检测 Ingress 的创建情况生成相应配置。Ingress Controller 的实现有很多种：有基于 Nginx 的，也有基于 HAProxy的，还有基于 OpenResty 的 Kong Ingress Controller 等，更多 Controller 见：&lt;a href=&quot;https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/，本文使用基于&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/，本文使用基于&lt;/a&gt; Nginx 的 Ingress Controller：&lt;a href=&quot;https://github.com/nginxinc/kubernetes-ingress&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ingress-nginx&lt;/a&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="https://gongzhao1.coding.me/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="https://gongzhao1.coding.me/tags/kubernetes/"/>
    
      <category term="ingress" scheme="https://gongzhao1.coding.me/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>python模块之logging</title>
    <link href="https://gongzhao1.coding.me/python%E6%A8%A1%E5%9D%97%E4%B9%8Blogging/"/>
    <id>https://gongzhao1.coding.me/python模块之logging/</id>
    <published>2020-03-24T08:24:47.000Z</published>
    <updated>2020-04-08T14:20:25.872Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.cnblogs.com/yyds/p/6901864.html" target="_blank" rel="noopener">https://www.cnblogs.com/yyds/p/6901864.html</a></li><li><a href="https://www.cnblogs.com/yuanyongqiang/p/11913812.html" target="_blank" rel="noopener">https://www.cnblogs.com/yuanyongqiang/p/11913812.html</a></li><li><a href="https://www.cnblogs.com/nancyzhu/p/8551506.html" target="_blank" rel="noopener">https://www.cnblogs.com/nancyzhu/p/8551506.html</a></li></ul><h1 id="日志相关概念"><a href="#日志相关概念" class="headerlink" title="日志相关概念"></a>日志相关概念</h1><p>日志是一种可以追踪某些软件运行时所发生事件的方法。软件开发人员可以向他们的代码中调用日志记录相关的方法来表明发生了某些事情。一个事件可以用一个可包含可选变量数据的消息来描述。此外，事件也有重要性的概念，这个重要性也可以被称为严重性级别（level）。</p><h2 id="日志的作用"><a href="#日志的作用" class="headerlink" title="日志的作用"></a>日志的作用</h2><p>通过log的分析，可以方便用户了解系统或软件、应用的运行情况；如果你的应用log足够丰富，也可以分析以往用户的操作行为、类型喜好、地域分布或其他更多信息；如果一个应用的log同时也分了多个级别，那么可以很轻易地分析得到该应用的健康状况，及时发现问题并快速定位、解决问题，补救损失。<br>简单来讲就是，我们通过记录和分析日志可以了解一个系统或软件程序运行情况是否正常，也可以在应用程序出现故障时快速定位问题。比如，做运维的同学，在接收到报警或各种问题反馈后，进行问题排查时通常都会先去看各种日志，大部分问题都可以在日志中找到答案。再比如，做开发的同学，可以通过IDE控制台上输出的各种日志进行程序调试。对于运维老司机或者有经验的开发人员，可以快速的通过日志定位到问题的根源。可见，日志的重要性不可小觑。日志的作用可以简单总结为以下3点：</p><ul><li>程序调试</li><li>了解软件程序运行情况，是否正常</li><li>软件程序运行故障分析与问题定位</li></ul><p>如果应用的日志信息足够详细和丰富，还可以用来做用户行为分析，如：分析用户的操作行为、类型洗好、地域分布以及其它更多的信息，由此可以实现改进业务、提高商业利益。</p><h2 id="日志的等级"><a href="#日志的等级" class="headerlink" title="日志的等级"></a>日志的等级</h2><p>我们先来思考下下面的两个问题：</p><ul><li>作为开发人员，在开发一个应用程序时需要什么日志信息？在应用程序正式上线后需要什么日志信息？</li><li>作为应用运维人员，在部署开发环境时需要什么日志信息？在部署生产环境时需要什么日志信息？</li></ul><p>在软件开发阶段或部署开发环境时，为了尽可能详细的查看应用程序的运行状态来保证上线后的稳定性，我们可能需要把该应用程序所有的运行日志全部记录下来进行分析，这是非常耗费机器性能的。当应用程序正式发布或在生产环境部署应用程序时，我们通常只需要记录应用程序的异常信息、错误信息等，这样既可以减小服务器的I/O压力，也可以避免我们在排查故障时被淹没在日志的海洋里。那么，怎样才能在不改动应用程序代码的情况下实现在不同的环境记录不同详细程度的日志呢？这就是日志等级的作用了，我们通过配置文件指定我们需要的日志等级就可以了。</p><p>不同的应用程序所定义的日志等级可能会有所差别，分的详细点的会包含以下几个等级：</p><ul><li>DEBUG</li><li>INFO</li><li>NOTICE</li><li>WARNING</li><li>ERROR</li><li>CRITICAL</li><li>ALERT</li><li>EMERGENCY</li></ul><h2 id="日志字段信息与日志格式"><a href="#日志字段信息与日志格式" class="headerlink" title="日志字段信息与日志格式"></a>日志字段信息与日志格式</h2><p>本节开始问题提到过，一条日志信息对应的是一个事件的发生，而一个事件通常需要包括以下几个内容：</p><ul><li>事件发生时间</li><li>事件发生位置</li><li>事件的严重程度–日志级别</li><li>事件内容</li></ul><p>上面这些都是一条日志记录中可能包含的字段信息，当然还可以包括一些其他信息，如进程ID、进程名称、线程ID、线程名称等。日志格式就是用来定义一条日志记录中包含那些字段的，且日志格式通常都是可以自定义的。</p><blockquote><p>说明：</p><p>输出一条日志时，日志内容和日志级别是需要开发人员明确指定的。对于而其它字段信息，只需要是否显示在日志中就可以了。</p></blockquote><h2 id="日志功能的实现"><a href="#日志功能的实现" class="headerlink" title="日志功能的实现"></a>日志功能的实现</h2><p>几乎所有开发语言都会内置日志相关功能，或者会有比较优秀的第三方库来提供日志操作功能，比如：log4j，log4php等。它们功能强大、使用简单。Python自身也提供了一个用于记录日志的标准库模块–logging。</p><h1 id="logging模块简介"><a href="#logging模块简介" class="headerlink" title="logging模块简介"></a>logging模块简介</h1><p>logging模块定义的函数和类为应用程序和库的开发实现了一个灵活的事件日志系统。logging模块是Python的一个标准库模块，由标准库模块提供日志记录API的关键好处是所有Python模块都可以使用这个日志记录功能。所以，你的应用日志可以将你自己的日志信息与来自第三方模块的信息整合起来。</p><a id="more"></a><h2 id="logging模块的日志级别"><a href="#logging模块的日志级别" class="headerlink" title="logging模块的日志级别"></a>logging模块的日志级别</h2><p>logging模块默认定义了以下几个日志等级，它允许开发人员自定义其他日志级别，但是这是不被推荐的，尤其是在开发供别人使用的库时，因为这会导致日志级别的混乱。</p><table><thead><tr><th>日志等级（level）</th><th>描述</th></tr></thead><tbody><tr><td>DEBUG</td><td>最详细的日志信息，典型应用场景是 问题诊断</td></tr><tr><td>INFO</td><td>信息详细程度仅次于DEBUG，通常只记录关键节点信息，用于确认一切都是按照我们预期的那样进行工作</td></tr><tr><td>WARNING</td><td>当某些不期望的事情发生时记录的信息（如，磁盘可用空间较低），但是此时应用程序还是正常运行的</td></tr><tr><td>ERROR</td><td>由于一个更严重的问题导致某些功能不能正常运行时记录的信息</td></tr><tr><td>CRITICAL</td><td>当发生严重错误，导致应用程序不能继续运行时记录的信息</td></tr></tbody></table><p>开发应用程序或部署开发环境时，可以使用DEBUG或INFO级别的日志获取尽可能详细的日志信息来进行开发或部署调试；应用上线或部署生产环境时，应该使用WARNING或ERROR或CRITICAL级别的日志来降低机器的I/O压力和提高获取错误日志信息的效率。日志级别的指定通常都是在应用程序的配置文件中进行指定的。</p><blockquote><p>说明：</p><ul><li>上面列表中的日志等级是从上到下依次升高的，即：DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; CRITICAL，而日志的信息量是依次减少的；</li><li>当为某个应用程序指定一个日志级别后，应用程序会记录所有日志级别大于或等于指定日志级别的日志信息，而不是仅仅记录指定级别的日志信息，nginx、php等应用程序以及这里要提高的python的logging模块都是这样的。同样，logging模块也可以指定日志记录器的日志级别，只有级别大于或等于该指定日志级别的日志记录才会被输出，小于该等级的日志记录将会被丢弃。</li></ul></blockquote><h2 id="logging模块的使用方式介绍"><a href="#logging模块的使用方式介绍" class="headerlink" title="logging模块的使用方式介绍"></a>logging模块的使用方式介绍</h2><p>logging模块提供了两种记录日志的方式：</p><ul><li>第一种方式是使用logging提供的模块级别的函数</li><li>第二种方式是使用Logging日志系统的四大组件</li></ul><p>其实，logging所提供的模块级别的日志记录函数也是对logging日志系统相关类的封装而已。</p><p><strong>logging模块定义的模块级别的常用函数</strong></p><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>logging.debug(msg, <em>args, *</em>kwargs)</td><td>创建一条严重级别为DEBUG的日志记录</td></tr><tr><td><a href="http://logging.info/" target="_blank" rel="noopener">logging.info</a>(msg, <em>args, *</em>kwargs)</td><td>创建一条严重级别为INFO的日志记录</td></tr><tr><td>logging.warning(msg, <em>args, *</em>kwargs)</td><td>创建一条严重级别为WARNING的日志记录</td></tr><tr><td>logging.error(msg, <em>args, *</em>kwargs)</td><td>创建一条严重级别为ERROR的日志记录</td></tr><tr><td>logging.critical(msg, <em>args, *</em>kwargs)</td><td>创建一条严重级别为CRITICAL的日志记录</td></tr><tr><td>logging.log(level, <em>args, *</em>kwargs)</td><td>创建一条严重级别为level的日志记录</td></tr><tr><td>logging.basicConfig(**kwargs)</td><td>对root logger进行一次性配置</td></tr></tbody></table><p>其中<code>logging.basicConfig(**kwargs)</code>函数用于指定“要记录的日志级别”、“日志格式”、“日志输出位置”、“日志文件的打开模式”等信息，其他几个都是用于记录各个级别日志的函数。</p><p><strong>logging模块的四大组件</strong></p><table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td>loggers</td><td>提供应用程序代码直接使用的接口</td></tr><tr><td>handlers</td><td>用于将日志记录发送到指定的目的位置</td></tr><tr><td>filters</td><td>提供更细粒度的日志过滤功能，用于决定哪些日志记录将会被输出（其它的日志记录将会被忽略）</td></tr><tr><td>formatters</td><td>用于控制日志信息的最终输出格式</td></tr></tbody></table><blockquote><p>说明： logging模块提供的模块级别的那些函数实际上也是通过这几个组件的相关实现类来记录日志的，只是在创建这些类的实例时设置了一些默认值。</p></blockquote><h2 id="使用logging提供的模块级别的函数记录日志"><a href="#使用logging提供的模块级别的函数记录日志" class="headerlink" title="使用logging提供的模块级别的函数记录日志"></a>使用logging提供的模块级别的函数记录日志</h2><p>回顾下前面提到的几个重要信息：</p><ul><li>可以通过logging模块定义的模块级别的方法去完成简单的日志记录</li><li>只有级别大于或等于日志记录器指定级别的日志记录才会被输出，小于该级别的日志记录将会被丢弃。</li></ul><h3 id="最简单的日志输出"><a href="#最简单的日志输出" class="headerlink" title="最简单的日志输出"></a>最简单的日志输出</h3><p>先来试着分别输出一条不同日志级别的日志记录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.debug(&quot;This is a debug log.&quot;)</span><br><span class="line">logging.info(&quot;This is a info log.&quot;)</span><br><span class="line">logging.warning(&quot;This is a warning log.&quot;)</span><br><span class="line">logging.error(&quot;This is a error log.&quot;)</span><br><span class="line">logging.critical(&quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure><p>也可以这样写：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging.log(logging.DEBUG, &quot;This is a debug log.&quot;)</span><br><span class="line">logging.log(logging.INFO, &quot;This is a info log.&quot;)</span><br><span class="line">logging.log(logging.WARNING, &quot;This is a warning log.&quot;)</span><br><span class="line">logging.log(logging.ERROR, &quot;This is a error log.&quot;)</span><br><span class="line">logging.log(logging.CRITICAL, &quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING:root:This is a warning log.</span><br><span class="line">ERROR:root:This is a error log.</span><br><span class="line">CRITICAL:root:This is a critical log.</span><br></pre></td></tr></table></figure><h3 id="那么问题来了"><a href="#那么问题来了" class="headerlink" title="那么问题来了"></a>那么问题来了</h3><p><strong>问题1：为什么前面两条日志没有被打印出来？</strong></p><p>这是因为logging模块提供的日志记录函数所使用的日志器设置的日志级别是<code>WARNING</code>，因此只有<code>WARNING</code>级别的日志记录以及大于它的<code>ERROR</code>和<code>CRITICAL</code>级别的日志记录被输出了，而小于它的<code>DEBUG</code>和<code>INFO</code>级别的日志记录被丢弃了。</p><p><strong>问题2：打印出来的日志信息中各字段表示什么意思？为什么会这样输出？</strong></p><p>上面输出结果中每行日志记录的各个字段含义分别是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">日志级别:日志器名称:日志内容</span><br></pre></td></tr></table></figure><p>之所以会这样输出，是因为logging模块提供的日志记录函数所使用的日志器设置的日志格式默认是BASIC_FORMAT，其值为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%(levelname)s:%(name)s:%(message)s&quot;</span><br></pre></td></tr></table></figure><p><strong>问题3：如果将日志记录输出到文件中，而不是打印到控制台？</strong></p><p>因为在logging模块提供的日志记录函数所使用的日志器设置的处理器所指定的日志输出位置默认为:<br><code>sys.stderr</code>。</p><p><strong>问题4：我是怎么知道这些的？</strong></p><p>查看这些日志记录函数的实现代码，可以发现：当我们没有提供任何配置信息的时候，这些函数都会去调用<code>logging.basicConfig(**kwargs)</code>方法，且不会向该方法传递任何参数。继续查看<code>basicConfig()</code>方法的代码就可以找到上面这些问题的答案了。</p><p><strong>问题5：怎么修改这些默认设置呢？</strong></p><p>其实很简单，在我们调用上面这些日志记录函数之前，手动调用一下basicConfig()方法，把我们想设置的内容以参数的形式传递进去就可以了。</p><h3 id="logging-basicConfig-函数说明"><a href="#logging-basicConfig-函数说明" class="headerlink" title="logging.basicConfig()函数说明"></a>logging.basicConfig()函数说明</h3><p>该方法用于为logging日志系统做一些基本配置，方法定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(**kwargs)</span><br></pre></td></tr></table></figure><p>该函数可接收的关键字参数如下：</p><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>filename</td><td>指定日志输出目标文件的文件名，指定该设置项后日志信心就不会被输出到控制台了</td></tr><tr><td>filemode</td><td>指定日志文件的打开模式，默认为’a’。需要注意的是，该选项要在filename指定时才有效</td></tr><tr><td>format</td><td>指定日志格式字符串，即指定日志输出时所包含的字段信息以及它们的顺序。logging模块定义的格式字段下面会列出。</td></tr><tr><td>datefmt</td><td>指定日期/时间格式。需要注意的是，该选项要在format中包含时间字段%(asctime)s时才有效</td></tr><tr><td>level</td><td>指定日志器的日志级别</td></tr><tr><td>stream</td><td>指定日志输出目标stream，如sys.stdout、sys.stderr以及网络stream。需要说明的是，stream和filename不能同时提供，否则会引发 <code>ValueError</code>异常</td></tr><tr><td>style</td><td>Python 3.2中新添加的配置项。指定format格式字符串的风格，可取值为’%’、’{‘和’$’，默认为’%’</td></tr><tr><td>handlers</td><td>Python 3.3中新添加的配置项。该选项如果被指定，它应该是一个创建了多个Handler的可迭代对象，这些handler将会被添加到root logger。需要说明的是：filename、stream和handlers这三个配置项只能有一个存在，不能同时出现2个或3个，否则会引发ValueError异常。</td></tr></tbody></table><h3 id="logging模块定义的格式字符串字段"><a href="#logging模块定义的格式字符串字段" class="headerlink" title="logging模块定义的格式字符串字段"></a>logging模块定义的格式字符串字段</h3><p>我们来列举一下logging模块中定义好的可以用于format格式字符串中字段有哪些：</p><table><thead><tr><th>字段/属性名称</th><th>使用格式</th><th>描述</th></tr></thead><tbody><tr><td>asctime</td><td>%(asctime)s</td><td>日志事件发生的时间–人类可读时间，如：2003-07-08 16:49:45,896</td></tr><tr><td>created</td><td>%(created)f</td><td>日志事件发生的时间–时间戳，就是当时调用time.time()函数返回的值</td></tr><tr><td>relativeCreated</td><td>%(relativeCreated)d</td><td>日志事件发生的时间相对于logging模块加载时间的相对毫秒数（目前还不知道干嘛用的）</td></tr><tr><td>msecs</td><td>%(msecs)d</td><td>日志事件发生事件的毫秒部分</td></tr><tr><td>levelname</td><td>%(levelname)s</td><td>该日志记录的文字形式的日志级别（’DEBUG’, ‘INFO’, ‘WARNING’, ‘ERROR’, ‘CRITICAL’）</td></tr><tr><td>levelno</td><td>%(levelno)s</td><td>该日志记录的数字形式的日志级别（10, 20, 30, 40, 50）</td></tr><tr><td>name</td><td>%(name)s</td><td>所使用的日志器名称，默认是’root’，因为默认使用的是 rootLogger</td></tr><tr><td>message</td><td>%(message)s</td><td>日志记录的文本内容，通过 <code>msg % args</code>计算得到的</td></tr><tr><td>pathname</td><td>%(pathname)s</td><td>调用日志记录函数的源码文件的全路径</td></tr><tr><td>filename</td><td>%(filename)s</td><td>pathname的文件名部分，包含文件后缀</td></tr><tr><td>module</td><td>%(module)s</td><td>filename的名称部分，不包含后缀</td></tr><tr><td>lineno</td><td>%(lineno)d</td><td>调用日志记录函数的源代码所在的行号</td></tr><tr><td>funcName</td><td>%(funcName)s</td><td>调用日志记录函数的函数名</td></tr><tr><td>process</td><td>%(process)d</td><td>进程ID</td></tr><tr><td>processName</td><td>%(processName)s</td><td>进程名称，Python 3.1新增</td></tr><tr><td>thread</td><td>%(thread)d</td><td>线程ID</td></tr><tr><td>threadName</td><td>%(thread)s</td><td>线程名称</td></tr></tbody></table><h3 id="经过配置的日志输出-举例"><a href="#经过配置的日志输出-举例" class="headerlink" title="经过配置的日志输出(举例)"></a>经过配置的日志输出(举例)</h3><p><strong>先简单配置下日志器的日志级别</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">logging.debug(&quot;This is a debug log.&quot;)</span><br><span class="line">logging.info(&quot;This is a info log.&quot;)</span><br><span class="line">logging.warning(&quot;This is a warning log.&quot;)</span><br><span class="line">logging.error(&quot;This is a error log.&quot;)</span><br><span class="line">logging.critical(&quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEBUG:root:This is a debug log.</span><br><span class="line">INFO:root:This is a info log.</span><br><span class="line">WARNING:root:This is a warning log.</span><br><span class="line">ERROR:root:This is a error log.</span><br><span class="line">CRITICAL:root:This is a critical log.</span><br></pre></td></tr></table></figure><p>所有等级的日志信息都被输出了，说明配置生效了。</p><p><strong>在配置日志器日志级别的基础上，在配置下日志输出目标文件和日志格式</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LOG_FORMAT = &quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span><br><span class="line">logging.basicConfig(filename=&apos;my.log&apos;, level=logging.DEBUG, format=LOG_FORMAT)</span><br><span class="line"></span><br><span class="line">logging.debug(&quot;This is a debug log.&quot;)</span><br><span class="line">logging.info(&quot;This is a info log.&quot;)</span><br><span class="line">logging.warning(&quot;This is a warning log.&quot;)</span><br><span class="line">logging.error(&quot;This is a error log.&quot;)</span><br><span class="line">logging.critical(&quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure><p>此时会发现控制台中已经没有输出日志内容了，但是在python代码文件的相同目录下会生成一个名为’my.log’的日志文件，该文件中的内容为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-05-08 14:29:53,783 - DEBUG - This is a debug log.</span><br><span class="line">2017-05-08 14:29:53,784 - INFO - This is a info log.</span><br><span class="line">2017-05-08 14:29:53,784 - WARNING - This is a warning log.</span><br><span class="line">2017-05-08 14:29:53,784 - ERROR - This is a error log.</span><br><span class="line">2017-05-08 14:29:53,784 - CRITICAL - This is a critical log.</span><br></pre></td></tr></table></figure><p><strong>在上面的基础上，我们再来设置下日期/时间格式</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LOG_FORMAT = &quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span><br><span class="line">DATE_FORMAT = &quot;%m/%d/%Y %H:%M:%S %p&quot;</span><br><span class="line"></span><br><span class="line">logging.basicConfig(filename=&apos;my.log&apos;, level=logging.DEBUG, format=LOG_FORMAT, datefmt=DATE_FORMAT)</span><br><span class="line"></span><br><span class="line">logging.debug(&quot;This is a debug log.&quot;)</span><br><span class="line">logging.info(&quot;This is a info log.&quot;)</span><br><span class="line">logging.warning(&quot;This is a warning log.&quot;)</span><br><span class="line">logging.error(&quot;This is a error log.&quot;)</span><br><span class="line">logging.critical(&quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure><p>此时会在my.log日志文件中看到如下输出内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">05/08/2017 14:29:04 PM - DEBUG - This is a debug log.</span><br><span class="line">05/08/2017 14:29:04 PM - INFO - This is a info log.</span><br><span class="line">05/08/2017 14:29:04 PM - WARNING - This is a warning log.</span><br><span class="line">05/08/2017 14:29:04 PM - ERROR - This is a error log.</span><br><span class="line">05/08/2017 14:29:04 PM - CRITICAL - This is a critical log.</span><br></pre></td></tr></table></figure><p>掌握了上面的内容之后，已经能够满足我们平时开发中需要的日志记录功能。</p><p><strong>另外一个例子</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG,</span><br><span class="line">                    format=<span class="string">"%(asctime)s %(name)s %(levelname)s %(message)s"</span>,</span><br><span class="line">                    datefmt = <span class="string">'%Y-%m-%d  %H:%M:%S %a'</span>    <span class="comment">#注意月份和天数不要搞乱了，这里的格式化符与time模块相同</span></span><br><span class="line">                    )</span><br><span class="line">logging.debug(<span class="string">"msg1"</span>)</span><br><span class="line">logging.info(<span class="string">"msg2"</span>)</span><br><span class="line">logging.warning(<span class="string">"msg3"</span>)</span><br><span class="line">logging.error(<span class="string">"msg4"</span>)</span><br><span class="line">logging.critical(<span class="string">"msg5"</span>)</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root DEBUG msg1</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root INFO msg2</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root WARNING msg3</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root ERROR msg4</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-09</span>  <span class="number">23</span>:<span class="number">37</span>:<span class="number">49</span> Wed root CRITICAL msg5</span><br></pre></td></tr></table></figure><p><strong>输出到文件例子</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(level=logging.DEBUG,<span class="comment">#控制台打印的日志级别</span></span><br><span class="line">                    filename=<span class="string">'new.log'</span>,</span><br><span class="line">                    filemode=<span class="string">'a'</span>,<span class="comment">##模式，有w和a，w就是写模式，每次都会重新写日志，覆盖之前的日志</span></span><br><span class="line">                    <span class="comment">#a是追加模式，默认如果不写的话，就是追加模式</span></span><br><span class="line">                    format=</span><br><span class="line">                    <span class="string">'%(asctime)s - %(pathname)s[line:%(lineno)d] - %(levelname)s: %(message)s'</span></span><br><span class="line">                    <span class="comment">#日志格式</span></span><br><span class="line">                    )</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">LOG_FORMAT = <span class="string">"%(asctime)s %(name)s %(levelname)s %(pathname)s %(message)s "</span><span class="comment">#配置输出日志格式</span></span><br><span class="line">DATE_FORMAT = <span class="string">'%Y-%m-%d  %H:%M:%S %a '</span> <span class="comment">#配置输出时间的格式，注意月份和天数不要搞乱了</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG,</span><br><span class="line">                    format=LOG_FORMAT,</span><br><span class="line">                    datefmt = DATE_FORMAT ,</span><br><span class="line">                    filename=<span class="string">r"d:\test\test.log"</span> <span class="comment">#有了filename参数就不会直接输出显示到控制台，而是直接写入文件</span></span><br><span class="line">                    )</span><br><span class="line">logging.debug(<span class="string">"msg1"</span>)</span><br><span class="line">logging.info(<span class="string">"msg2"</span>)</span><br><span class="line">logging.warning(<span class="string">"msg3"</span>)</span><br><span class="line">logging.error(<span class="string">"msg4"</span>)</span><br><span class="line">logging.critical(<span class="string">"msg5"</span>)</span><br></pre></td></tr></table></figure><p>日志在d:\test目录下，日志具体内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root DEBUG D:/<span class="number">06</span>python/exercise/test_package/test.py msg1</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root INFO D:/<span class="number">06</span>python/exercise/test_package/test.py msg2</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root WARNING D:/<span class="number">06</span>python/exercise/test_package/test.py msg3</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root ERROR D:/<span class="number">06</span>python/exercise/test_package/test.py msg4</span><br><span class="line"><span class="number">2018</span><span class="number">-05</span><span class="number">-10</span>  <span class="number">02</span>:<span class="number">13</span>:<span class="number">46</span> Thu AM  root CRITICAL D:/<span class="number">06</span>python/exercise/test_package/test.py msg5</span><br></pre></td></tr></table></figure><h3 id="其他说明"><a href="#其他说明" class="headerlink" title="其他说明"></a>其他说明</h3><p><strong>几个要说明的内容：</strong></p><ul><li><code>logging.basicConfig()</code>函数是一个一次性的简单配置工具使，也就是说只有在第一次调用该函数时会起作用，后续再次调用该函数时完全不会产生任何操作的，多次调用的设置并不是累加操作。</li><li>日志器（Logger）是有层级关系的，上面调用的logging模块级别的函数所使用的日志器是<code>RootLogger</code>类的实例，其名称为’root’，它是处于日志器层级关系最顶层的日志器，且该实例是以单例模式存在的。</li><li>如果要记录的日志中包含变量数据，可使用一个格式字符串作为这个事件的描述消息（logging.debug、logging.info等函数的第一个参数），然后将变量数据作为第二个参数*args的值进行传递，如:<code>logging.warning(&#39;%s is %d years old.&#39;, &#39;Tom&#39;, 10)</code>，输出内容为<code>WARNING:root:Tom is 10 years old.</code></li><li>logging.debug(), <a href="http://logging.info/" target="_blank" rel="noopener">logging.info</a>()等方法的定义中，除了msg和args参数外，还有一个**kwargs参数。它们支持3个关键字参数: <code>exc_info, stack_info, extra</code>，下面对这几个关键字参数作个说明。</li></ul><p><strong>关于exc_info, stack_info, extra关键词参数的说明:</strong></p><ul><li><strong>exc_info：</strong> 其值为布尔值，如果该参数的值设置为True，则会将异常异常信息添加到日志消息中。如果没有异常信息则添加None到日志信息中。</li><li><strong>stack_info：</strong> 其值也为布尔值，默认值为False。如果该参数的值设置为True，栈信息将会被添加到日志信息中。</li><li><strong>extra：</strong> 这是一个字典（dict）参数，它可以用来自定义消息格式中所包含的字段，但是它的key不能与logging模块定义的字段冲突。</li></ul><p><strong>一个例子：</strong></p><p>在日志消息中添加exc_info和stack_info信息，并添加两个自定义的字端 ip和user</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOG_FORMAT = &quot;%(asctime)s - %(levelname)s - %(user)s[%(ip)s] - %(message)s&quot;</span><br><span class="line">DATE_FORMAT = &quot;%m/%d/%Y %H:%M:%S %p&quot;</span><br><span class="line"></span><br><span class="line">logging.basicConfig(format=LOG_FORMAT, datefmt=DATE_FORMAT)</span><br><span class="line">logging.warning(&quot;Some one delete the log file.&quot;, exc_info=True, stack_info=True, extra=&#123;&apos;user&apos;: &apos;Tom&apos;, &apos;ip&apos;:&apos;47.98.53.222&apos;&#125;)</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">05/08/2017 16:35:00 PM - WARNING - Tom[47.98.53.222] - Some one delete the log file.</span><br><span class="line">NoneType</span><br><span class="line">Stack (most recent call last):</span><br><span class="line">  File &quot;C:/Users/wader/PycharmProjects/LearnPython/day06/log.py&quot;, line 45, in &lt;module&gt;</span><br><span class="line">    logging.warning(&quot;Some one delete the log file.&quot;, exc_info=True, stack_info=True, extra=&#123;&apos;user&apos;: &apos;Tom&apos;, &apos;ip&apos;:&apos;47.98.53.222&apos;&#125;)</span><br></pre></td></tr></table></figure><h2 id="logging模块日志流处理流程"><a href="#logging模块日志流处理流程" class="headerlink" title="logging模块日志流处理流程"></a>logging模块日志流处理流程</h2><p>在介绍logging模块的高级用法之前，很有必要对logging模块所包含的重要组件以及其工作流程做个全面、简要的介绍，这有助于我们更好的理解我们所写的代码（将会触发什么样的操作）。</p><h3 id="logging日志模块四大组件"><a href="#logging日志模块四大组件" class="headerlink" title="logging日志模块四大组件"></a>logging日志模块四大组件</h3><p>在介绍logging模块的日志流处理流程之前，我们先来介绍下logging模块的四大组件：</p><table><thead><tr><th>组件名称</th><th>对应类名</th><th>功能描述</th></tr></thead><tbody><tr><td>日志器</td><td>Logger</td><td>提供了应用程序可一直使用的接口</td></tr><tr><td>处理器</td><td>Handler</td><td>将logger创建的日志记录发送到合适的目的输出</td></tr><tr><td>过滤器</td><td>Filter</td><td>提供了更细粒度的控制工具来决定输出哪条日志记录，丢弃哪条日志记录</td></tr><tr><td>格式器</td><td>Formatter</td><td>决定日志记录的最终输出格式</td></tr></tbody></table><p>logging模块就是通过这些组件来完成日志处理的，上面所使用的logging模块级别的函数也是通过这些组件对应的类来实现的。</p><p><strong>这些组件之间的关系描述：</strong></p><ul><li>日志器（logger）需要通过处理器（handler）将日志信息输出到目标位置，如：文件、sys.stdout、网络等；</li><li>不同的处理器（handler）可以将日志输出到不同的位置；</li><li>日志器（logger）可以设置多个处理器（handler）将同一条日志记录输出到不同的位置；</li><li>每个处理器（handler）都可以设置自己的过滤器（filter）实现日志过滤，从而只保留感兴趣的日志；</li><li>每个处理器（handler）都可以设置自己的格式器（formatter）实现同一条日志以不同的格式输出到不同的地方。</li></ul><p>简单点说就是：日志器（logger）是入口，真正干活儿的是处理器（handler），处理器（handler）还可以通过过滤器（filter）和格式器（formatter）对要输出的日志内容做过滤和格式化等处理操作。</p><h3 id="logging日志模块相关类及其常用方法介绍"><a href="#logging日志模块相关类及其常用方法介绍" class="headerlink" title="logging日志模块相关类及其常用方法介绍"></a>logging日志模块相关类及其常用方法介绍</h3><p>下面介绍下与logging四大组件相关的类：Logger, Handler, Filter, Formatter。</p><h4 id="Logger类"><a href="#Logger类" class="headerlink" title="Logger类"></a>Logger类</h4><p>Logger对象有3个任务要做：</p><ul><li>1）向应用程序代码暴露几个方法，使应用程序可以在运行时记录日志消息；</li><li>2）基于日志严重等级（默认的过滤设施）或filter对象来决定要对哪些日志进行后续处理；</li><li>3）将日志消息传送给所有感兴趣的日志handlers。</li></ul><p>Logger对象最常用的方法分为两类：配置方法 和 消息发送方法</p><p>最常用的配置方法如下：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>Logger.setLevel()</td><td>设置日志器将会处理的日志消息的最低严重级别</td></tr><tr><td>Logger.addHandler() 和 Logger.removeHandler()</td><td>为该logger对象添加 和 移除一个handler对象</td></tr><tr><td>Logger.addFilter() 和 Logger.removeFilter()</td><td>为该logger对象添加 和 移除一个filter对象</td></tr></tbody></table><blockquote><p><strong>关于Logger.setLevel()方法的说明：</strong></p><p>内建等级中，级别最低的是DEBUG，级别最高的是CRITICAL。例如setLevel([logging.INFO])，此时函数参数为INFO，那么该logger将只会处理INFO、WARNING、ERROR和CRITICAL级别的日志，而DEBUG级别的消息将会被忽略/丢弃。</p></blockquote><p>Logger对象配置完成后，可以使用下面的方法来创建日志记录：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>Logger.debug(), <a href="http://logger.info/" target="_blank" rel="noopener">Logger.info</a>(), Logger.warning(), Logger.error(), Logger.critical()</td><td>创建一个与它们的方法名对应等级的日志记录</td></tr><tr><td>Logger.exception()</td><td>创建一个类似于Logger.error()的日志消息</td></tr><tr><td>Logger.log()</td><td>需要获取一个明确的日志level参数来创建一个日志记录</td></tr></tbody></table><blockquote><p><strong>说明：</strong></p><ul><li>Logger.exception()与Logger.error()的区别在于：Logger.exception()将会输出堆栈追踪信息，另外通常只是在一个exception handler中调用该方法。</li><li>Logger.log()与Logger.debug()、<a href="http://logger.info/" target="_blank" rel="noopener">Logger.info</a>()等方法相比，虽然需要多传一个level参数，显得不是那么方便，但是当需要记录自定义level的日志时还是需要该方法来完成。</li></ul></blockquote><p>那么，怎样得到一个Logger对象呢？一种方式是通过Logger类的实例化方法创建一个Logger类的实例，但是我们通常都是用第二种方式–logging.getLogger()方法。</p><p>logging.getLogger()方法有一个可选参数name，该参数表示将要返回的日志器的名称标识，如果不提供该参数，则其值为’root’。若以相同的name参数值多次调用getLogger()方法，将会返回指向同一个logger对象的引用。</p><blockquote><p><strong>关于logger的层级结构与有效等级的说明：</strong></p><ul><li>logger的名称是一个以’.’分割的层级结构，每个’.’后面的logger都是’.’前面的logger的children，例如，有一个名称为 foo 的logger，其它名称分别为 foo.bar, foo.bar.baz 和 foo.bam都是 foo 的后代。</li><li>logger有一个”有效等级（effective level）”的概念。如果一个logger上没有被明确设置一个level，那么该logger就是使用它parent的level;如果它的parent也没有明确设置level则继续向上查找parent的parent的有效level，依次类推，直到找到个一个明确设置了level的祖先为止。需要说明的是，root logger总是会有一个明确的level设置（默认为 WARNING）。当决定是否去处理一个已发生的事件时，logger的有效等级将会被用来决定是否将该事件传递给该logger的handlers进行处理。</li><li>child loggers在完成对日志消息的处理后，默认会将日志消息传递给与它们的祖先loggers相关的handlers。因此，我们不必为一个应用程序中所使用的所有loggers定义和配置handlers，只需要为一个顶层的logger配置handlers，然后按照需要创建child loggers就可足够了。我们也可以通过将一个logger的propagate属性设置为False来关闭这种传递机制。</li></ul></blockquote><h4 id="Handler类"><a href="#Handler类" class="headerlink" title="Handler类"></a>Handler类</h4><p>Handler对象的作用是（基于日志消息的level）将消息分发到handler指定的位置（文件、网络、邮件等）。Logger对象可以通过addHandler()方法为自己添加0个或者更多个handler对象。比如，一个应用程序可能想要实现以下几个日志需求：</p><ul><li>1）把所有日志都发送到一个日志文件中；</li><li>2）把所有严重级别大于等于error的日志发送到stdout（标准输出）；</li><li>3）把所有严重级别为critical的日志发送到一个email邮件地址。<br>这种场景就需要3个不同的handlers，每个handler复杂发送一个特定严重级别的日志到一个特定的位置。</li></ul><p>一个handler中只有非常少数的方法是需要应用开发人员去关心的。对于使用内建handler对象的应用开发人员来说，似乎唯一相关的handler方法就是下面这几个配置方法：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>Handler.setLevel()</td><td>设置handler将会处理的日志消息的最低严重级别</td></tr><tr><td>Handler.setFormatter()</td><td>为handler设置一个格式器对象</td></tr><tr><td>Handler.addFilter() 和 Handler.removeFilter()</td><td>为handler添加 和 删除一个过滤器对象</td></tr></tbody></table><p>需要说明的是，应用程序代码不应该直接实例化和使用Handler实例。因为Handler是一个基类，它只定义了素有handlers都应该有的接口，同时提供了一些子类可以直接使用或覆盖的默认行为。下面是一些常用的Handler：</p><table><thead><tr><th>Handler</th><th>描述</th></tr></thead><tbody><tr><td>logging.StreamHandler</td><td>将日志消息发送到输出到Stream，如std.out, std.err或任何file-like对象。</td></tr><tr><td>logging.FileHandler</td><td>将日志消息发送到磁盘文件，默认情况下文件大小会无限增长</td></tr><tr><td>logging.handlers.RotatingFileHandler</td><td>将日志消息发送到磁盘文件，并支持日志文件按大小切割</td></tr><tr><td>logging.hanlders.TimedRotatingFileHandler</td><td>将日志消息发送到磁盘文件，并支持日志文件按时间切割</td></tr><tr><td>logging.handlers.HTTPHandler</td><td>将日志消息以GET或POST的方式发送给一个HTTP服务器</td></tr><tr><td>logging.handlers.SMTPHandler</td><td>将日志消息发送给一个指定的email地址</td></tr><tr><td>logging.NullHandler</td><td>该Handler实例会忽略error messages，通常被想使用logging的library开发者使用来避免’No handlers could be found for logger XXX’信息的出现。</td></tr></tbody></table><h4 id="Formater类"><a href="#Formater类" class="headerlink" title="Formater类"></a>Formater类</h4><p>Formater对象用于配置日志信息的最终顺序、结构和内容。与logging.Handler基类不同的是，应用代码可以直接实例化Formatter类。另外，如果你的应用程序需要一些特殊的处理行为，也可以实现一个Formatter的子类来完成。</p><p>Formatter类的构造方法定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.Formatter.__init__(fmt=None, datefmt=None, style=&apos;%&apos;)</span><br></pre></td></tr></table></figure><p>可见，该构造方法接收3个可选参数：</p><ul><li>fmt：指定消息格式化字符串，如果不指定该参数则默认使用message的原始值</li><li>datefmt：指定日期格式字符串，如果不指定该参数则默认使用”%Y-%m-%d %H:%M:%S”</li><li>style：Python 3.2新增的参数，可取值为 ‘%’, ‘{‘和 ‘$’，如果不指定该参数则默认使用’%’</li></ul><h4 id="Filter类"><a href="#Filter类" class="headerlink" title="Filter类"></a>Filter类</h4><p>Filter可以被Handler和Logger用来做比level更细粒度的、更复杂的过滤功能。Filter是一个过滤器基类，它只允许某个logger层级下的日志事件通过过滤。该类定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class logging.Filter(name=&apos;&apos;)</span><br><span class="line">    filter(record)</span><br></pre></td></tr></table></figure><p>比如，一个filter实例化时传递的name参数值为’A.B’，那么该filter实例将只允许名称为类似如下规则的loggers产生的日志记录通过过滤：’A.B’，’A.B,C’，’A.B.C.D’，’A.B.D’，而名称为’<a href="http://a.bb/" target="_blank" rel="noopener">A.BB</a>‘, ‘B.A.B’的loggers产生的日志则会被过滤掉。如果name的值为空字符串，则允许所有的日志事件通过过滤。</p><p>filter方法用于具体控制传递的record记录是否能通过过滤，如果该方法返回值为0表示不能通过过滤，返回值为非0表示可以通过过滤。</p><blockquote><p><strong>说明：</strong></p><ul><li>如果有需要，也可以在filter(record)方法内部改变该record，比如添加、删除或修改一些属性。</li><li>我们还可以通过filter做一些统计工作，比如可以计算下被一个特殊的logger或handler所处理的record数量等。</li></ul></blockquote><h3 id="logging日志流处理流程"><a href="#logging日志流处理流程" class="headerlink" title="logging日志流处理流程"></a>logging日志流处理流程</h3><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/13.png" alt="img"></p><p>我们来描述下上面这个图的日志流处理流程：</p><ul><li>1）（在用户代码中进行）日志记录函数调用，如：<a href="http://logger.info/" target="_blank" rel="noopener">logger.info</a>(…)，logger.debug(…)等；</li><li>2）判断要记录的日志级别是否满足日志器设置的级别要求（要记录的日志级别要大于或等于日志器设置的级别才算满足要求），如果不满足则该日志记录会被丢弃并终止后续的操作，如果满足则继续下一步操作；</li><li>3）根据日志记录函数调用时掺入的参数，创建一个日志记录（LogRecord类）对象；</li><li>4）判断日志记录器上设置的过滤器是否拒绝这条日志记录，如果日志记录器上的某个过滤器拒绝，则该日志记录会被丢弃并终止后续的操作，如果日志记录器上设置的过滤器不拒绝这条日志记录或者日志记录器上没有设置过滤器则继续下一步操作–将日志记录分别交给该日志器上添加的各个处理器；</li><li>5）判断要记录的日志级别是否满足处理器设置的级别要求（要记录的日志级别要大于或等于该处理器设置的日志级别才算满足要求），如果不满足记录将会被该处理器丢弃并终止后续的操作，如果满足则继续下一步操作；</li><li>6）判断该处理器上设置的过滤器是否拒绝这条日志记录，如果该处理器上的某个过滤器拒绝，则该日志记录会被当前处理器丢弃并终止后续的操作，如果当前处理器上设置的过滤器不拒绝这条日志记录或当前处理器上没有设置过滤器测继续下一步操作；</li><li>7）如果能到这一步，说明这条日志记录经过了层层关卡允许被输出了，此时当前处理器会根据自身被设置的格式器（如果没有设置则使用默认格式）将这条日志记录进行格式化，最后将格式化后的结果输出到指定位置（文件、网络、类文件的Stream等）；</li><li>8）如果日志器被设置了多个处理器的话，上面的第5-8步会执行多次；</li><li>9）这里才是完整流程的最后一步：判断该日志器输出的日志消息是否需要传递给上一级logger（之前提到过，日志器是有层级关系的）的处理器，如果propagate属性值为1则表示日志消息将会被输出到处理器指定的位置，同时还会被传递给parent日志器的handlers进行处理直到当前日志器的propagate属性为0停止，如果propagate值为0则表示不向parent日志器的handlers传递该消息，到此结束。</li></ul><p>可见，一条日志信息要想被最终输出需要依次经过以下几次过滤：</p><ul><li>日志器等级过滤；</li><li>日志器的过滤器过滤；</li><li>日志器的处理器等级过滤；</li><li>日志器的处理器的过滤器过滤；</li></ul><blockquote><p><strong>需要说明的是：</strong> 关于上面第9个步骤，如果propagate值为1，那么日志消息会直接传递交给上一级logger的handlers进行处理，此时上一级logger的日志等级并不会对该日志消息进行等级过滤。</p></blockquote><p><strong>简化处理流程</strong>:</p><p>1、创建一个logger</p><p>2、设置下logger的日志的等级</p><p>3、创建合适的Handler(FileHandler要有路径)</p><p>4、设置下每个Handler的日志等级</p><p>5、创建下日志的格式</p><p>6、向Handler中添加上面创建的格式</p><p>7、将上面创建的Handler添加到logger中</p><p>8、打印输出logger.debug\logger.info\logger.warning\logger.error\logger.critical</p><h3 id="使用logging四大组件记录日志"><a href="#使用logging四大组件记录日志" class="headerlink" title="使用logging四大组件记录日志"></a>使用logging四大组件记录日志</h3><p>现在，我们对logging模块的重要组件及整个日志流处理流程都应该有了一个比较全面的了解，下面我们来看一个例子。</p><h4 id="1-需求"><a href="#1-需求" class="headerlink" title="1. 需求"></a>1. 需求</h4><p>现在有以下几个日志记录的需求：</p><ul><li>1）要求将所有级别的所有日志都写入磁盘文件中</li><li>2）all.log文件中记录所有的日志信息，日志格式为：日期和时间 - 日志级别 - 日志信息</li><li>3）error.log文件中单独记录error及以上级别的日志信息，日志格式为：日期和时间 - 日志级别 - 文件名[:行号] - 日志信息</li><li>4）要求all.log在每天凌晨进行日志切割</li></ul><h4 id="2-分析"><a href="#2-分析" class="headerlink" title="2. 分析"></a>2. 分析</h4><ul><li>1）要记录所有级别的日志，因此日志器的有效level需要设置为最低级别–DEBUG;</li><li>2）日志需要被发送到两个不同的目的地，因此需要为日志器设置两个handler；另外，两个目的地都是磁盘文件，因此这两个handler都是与FileHandler相关的；</li><li>3）all.log要求按照时间进行日志切割，因此他需要用logging.handlers.TimedRotatingFileHandler; 而error.log没有要求日志切割，因此可以使用FileHandler;</li><li>4）两个日志文件的格式不同，因此需要对这两个handler分别设置格式器；</li></ul><h4 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3. 代码实现"></a>3. 代码实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line">import logging.handlers</span><br><span class="line">import datetime</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(&apos;mylogger&apos;)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">rf_handler = logging.handlers.TimedRotatingFileHandler(&apos;all.log&apos;, when=&apos;midnight&apos;, interval=1, backupCount=7, atTime=datetime.time(0, 0, 0, 0))</span><br><span class="line">rf_handler.setFormatter(logging.Formatter(&quot;%(asctime)s - %(levelname)s - %(message)s&quot;))</span><br><span class="line"></span><br><span class="line">f_handler = logging.FileHandler(&apos;error.log&apos;)</span><br><span class="line">f_handler.setLevel(logging.ERROR)</span><br><span class="line">f_handler.setFormatter(logging.Formatter(&quot;%(asctime)s - %(levelname)s - %(filename)s[:%(lineno)d] - %(message)s&quot;))</span><br><span class="line"></span><br><span class="line">logger.addHandler(rf_handler)</span><br><span class="line">logger.addHandler(f_handler)</span><br><span class="line"></span><br><span class="line">logger.debug(&apos;debug message&apos;)</span><br><span class="line">logger.info(&apos;info message&apos;)</span><br><span class="line">logger.warning(&apos;warning message&apos;)</span><br><span class="line">logger.error(&apos;error message&apos;)</span><br><span class="line">logger.critical(&apos;critical message&apos;)</span><br></pre></td></tr></table></figure><p>all.log文件输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-05-13 16:12:40,612 - DEBUG - debug message</span><br><span class="line">2017-05-13 16:12:40,612 - INFO - info message</span><br><span class="line">2017-05-13 16:12:40,612 - WARNING - warning message</span><br><span class="line">2017-05-13 16:12:40,612 - ERROR - error message</span><br><span class="line">2017-05-13 16:12:40,613 - CRITICAL - critical message</span><br></pre></td></tr></table></figure><p>error.log文件输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017-05-13 16:12:40,612 - ERROR - log.py[:81] - error message</span><br><span class="line">2017-05-13 16:12:40,613 - CRITICAL - log.py[:82] - critical message</span><br></pre></td></tr></table></figure><h4 id="4-其它例子"><a href="#4-其它例子" class="headerlink" title="4.其它例子"></a>4.其它例子</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建handler</span></span><br><span class="line">fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置输出日志格式</span></span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">    datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意 logging.Formatter的大小写</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#为handler指定输出格式，注意大小写</span></span><br><span class="line">fh.setFormatter(formatter)</span><br><span class="line">ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">logger.addHandler(fh)</span><br><span class="line">logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出不同级别的log</span></span><br><span class="line">logger.warning(<span class="string">"泰拳警告"</span>)</span><br><span class="line">logger.info(<span class="string">"提示"</span>)</span><br><span class="line">logger.error(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure><p><strong>python logging 重复写日志问题</strong></p><p>用Python的logging模块记录日志时，可能会遇到重复记录日志的问题，第一条记录写一次，第二条记录写两次，第三条记录写三次</p><p><strong>原因：没有移除handler</strong> <strong>解决：在日志记录完之后removeHandler</strong></p><p>例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建handler</span></span><br><span class="line">    fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置输出日志格式</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">        datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为handler指定输出格式</span></span><br><span class="line">    fh.setFormatter(formatter)</span><br><span class="line">    ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">    logger.addHandler(fh)</span><br><span class="line">    logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line"></span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 泰拳警告</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 提示</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 提示</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br><span class="line"><span class="number">2018</span>/<span class="number">05</span>/<span class="number">10</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">18</span> nick test.py 错误</span><br></pre></td></tr></table></figure><p>分析：可以看到输出结果有重复打印</p><p>原因：第二次调用log的时候，根据getLogger(name)里的name获取同一个logger，而这个logger里已经有了第一次你添加的handler，第二次调用又添加了一个handler，所以，这个logger里有了两个同样的handler，以此类推，调用几次就会有几个handler。</p><p><strong>解决方案1</strong></p><p>添加removeHandler语句</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建handler</span></span><br><span class="line">    fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置输出日志格式</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">        datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为handler指定输出格式</span></span><br><span class="line">    fh.setFormatter(formatter)</span><br><span class="line">    ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">    logger.addHandler(fh)</span><br><span class="line">    logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#解决方案1，添加removeHandler语句，每次用完之后移除Handler</span></span><br><span class="line">    logger.removeHandler(fh)</span><br><span class="line">    logger.removeHandler(ch)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure><p><strong>解决方案2</strong></p><p>在log方法里做判断，如果这个logger已有handler，则不再添加handler。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#解决方案2：这里进行判断，如果logger.handlers列表为空，则添加，否则，直接去写日志</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:</span><br><span class="line">        <span class="comment">#创建handler</span></span><br><span class="line">        fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#设置输出日志格式</span></span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">            datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为handler指定输出格式</span></span><br><span class="line">        fh.setFormatter(formatter)</span><br><span class="line">        ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">        logger.addHandler(fh)</span><br><span class="line">        logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出不同级别的log</span></span><br><span class="line">    logger.info(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log(<span class="string">"泰拳警告"</span>)</span><br><span class="line">log(<span class="string">"提示"</span>)</span><br><span class="line">log(<span class="string">"错误"</span>)</span><br></pre></td></tr></table></figure><p><strong>logger调用方式例子</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#创建logger，如果参数为空则返回root logger</span></span><br><span class="line">    logger = logging.getLogger(<span class="string">"nick"</span>)</span><br><span class="line">    logger.setLevel(logging.DEBUG)  <span class="comment">#设置logger日志等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#这里进行判断，如果logger.handlers列表为空，则添加，否则，直接去写日志</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:</span><br><span class="line">        <span class="comment">#创建handler</span></span><br><span class="line">        fh = logging.FileHandler(<span class="string">"test.log"</span>,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        ch = logging.StreamHandler()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#设置输出日志格式</span></span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            fmt=<span class="string">"%(asctime)s %(name)s %(filename)s %(message)s"</span>,</span><br><span class="line">            datefmt=<span class="string">"%Y/%m/%d %X"</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为handler指定输出格式</span></span><br><span class="line">        fh.setFormatter(formatter)</span><br><span class="line">        ch.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#为logger添加的日志处理器</span></span><br><span class="line">        logger.addHandler(fh)</span><br><span class="line">        logger.addHandler(ch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logger <span class="comment">#直接返回logger</span></span><br><span class="line"></span><br><span class="line">logger = log()</span><br><span class="line">logger.warning(<span class="string">"泰拳警告"</span>)</span><br><span class="line">logger.info(<span class="string">"提示"</span>)</span><br><span class="line">logger.error(<span class="string">"错误"</span>)</span><br><span class="line">logger.debug(<span class="string">"查错"</span>)</span><br></pre></td></tr></table></figure><h4 id="5-屏幕和文件同时输出"><a href="#5-屏幕和文件同时输出" class="headerlink" title="5.屏幕和文件同时输出"></a>5.屏幕和文件同时输出</h4><p>logging库采取了模块化的设计，提供了许多组件：记录器、处理器、过滤器和格式化器。</p><ul><li>Logger 暴露了应用程序代码能直接使用的接口。</li><li>Handler将（记录器产生的）日志记录发送至合适的目的地。</li><li>Filter提供了更好的粒度控制，它可以决定输出哪些日志记录。</li><li>Formatter 指明了最终输出中日志记录的布局。</li></ul><h5 id="Loggers"><a href="#Loggers" class="headerlink" title="Loggers:"></a>Loggers:</h5><p>Logger 对象要做三件事情。首先，它们向应用代码暴露了许多方法，这样应用可以在运行时记录消息。其次，记录器对象通过严重程度（默认的过滤设施）或者过滤器对象来决定哪些日志消息需要记录下来。第三，记录器对象将相关的日志消息传递给所有感兴趣的日志处理器。</p><p>常用的记录器对象的方法分为两类：配置和发送消息。</p><p>这些是最常用的配置方法：</p><p>Logger.setLevel()指定logger将会处理的最低的安全等级日志信息, debug是最低的内置安全等级，critical是最高的内建安全等级。例如，如果严重程度为INFO，记录器将只处理INFO，WARNING，ERROR和CRITICAL消息，DEBUG消息被忽略。<br>Logger.addHandler()和Logger.removeHandler()从记录器对象中添加和删除处理程序对象。处理器详见Handlers。<br>Logger.addFilter()和Logger.removeFilter()从记录器对象添加和删除过滤器对象。</p><h5 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h5><p><code>处理程序</code>对象负责将适当的日志消息（基于日志消息的严重性）分派到处理程序的指定目标。<code>Logger</code> 对象可以通过<code>addHandler()</code>方法增加零个或多个handler对象。举个例子，一个应用可以将所有的日志消息发送至日志文件，所有的错误级别（error）及以上的日志消息发送至标准输出，所有的严重级别（critical）日志消息发送至某个电子邮箱。在这个例子中需要三个独立的处理器，每一个负责将特定级别的消息发送至特定的位置。</p><p>常用的有4种： </p><p><strong>1)    logging.StreamHandler -&gt; 控制台输出</strong> </p><p>使用这个Handler可以向类似与sys.stdout或者sys.stderr的任何文件对象(file object)输出信息。</p><p>它的构造函数是：<br><code>StreamHandler([strm])</code><br>其中strm参数是一个文件对象。默认是sys.stderr</p><p>2)   <strong>logging.FileHandler  -&gt; 文件输出</strong></p><p>和StreamHandler类似，用于向一个文件输出日志信息。不过FileHandler会帮你打开这个文件。它的构造函数是：<br><code>FileHandler(filename[,mode])</code><br>filename是文件名，必须指定一个文件名。<br>mode是文件的打开方式。默认是’a’，即添加到文件末尾。</p><p>3)   <strong>logging.handlers.RotatingFileHandler</strong> <strong>-&gt; 按照大小自动分割日志文件，一旦达到指定的大小重新生成文件</strong> </p><p>这个Handler类似于上面的FileHandler，但是它可以管理文件大小。当文件达到一定大小之后，它会自动将当前日志文件改名，然后创建 一个新的同名日志文件继续输出。比如日志文件是chat.log。当chat.log达到指定的大小之后，RotatingFileHandler自动把 文件改名为chat.log.1。不过，如果chat.log.1已经存在，会先把chat.log.1重命名为chat.log.2。最后重新创建 chat.log，继续输出日志信息。它的构造函数是：<br><code>RotatingFileHandler( filename[, mode[, maxBytes[, backupCount]]])</code><br>其中filename和mode两个参数和FileHandler一样。<br>maxBytes用于指定日志文件的最大文件大小。如果maxBytes为0，意味着日志文件可以无限大，这时上面描述的重命名过程就不会发生。<br>backupCount用于指定保留的备份文件的个数。比如，如果指定为2，当上面描述的重命名过程发生时，原有的chat.log.2并不会被更名，而是被删除。</p><p>4)   <strong>logging.handlers.TimedRotatingFileHandler  -&gt;</strong> <strong>按照时间自动分割日志文件</strong> </p><p>这个Handler和RotatingFileHandler类似，不过，它没有通过判断文件大小来决定何时重新创建日志文件，而是间隔一定时间就 自动创建新的日志文件。重命名的过程与RotatingFileHandler类似，不过新的文件不是附加数字，而是当前时间。它的构造函数是：<br><code>TimedRotatingFileHandler( filename [,when [,interval [,backupCount]]])</code><br>其中filename参数和backupCount参数和RotatingFileHandler具有相同的意义。<br>interval是时间间隔。<br>when参数是一个字符串。表示时间间隔的单位，不区分大小写。它有以下取值：<br>S 秒<br>M 分<br>H 小时<br>D 天<br>W 每星期（interval==0时代表星期一）<br>midnight 每天凌晨</p><h5 id="Formatters"><a href="#Formatters" class="headerlink" title="Formatters"></a>Formatters</h5><p>Formatter对象设置日志信息最后的规则、结构和内容，默认的时间格式为<code>%Y-%m-%d %H:%M:%S</code>，下面是Formatter常用的一些信息</p><table><thead><tr><th>%(name)s</th><th>Logger的名字</th></tr></thead><tbody><tr><td>%(levelno)s</td><td>数字形式的日志级别</td></tr><tr><td>%(levelname)s</td><td>文本形式的日志级别</td></tr><tr><td>%(pathname)s</td><td>调用日志输出函数的模块的完整路径名，可能没有</td></tr><tr><td>%(filename)s</td><td>调用日志输出函数的模块的文件名</td></tr><tr><td>%(module)s</td><td>调用日志输出函数的模块名</td></tr><tr><td>%(funcName)s</td><td>调用日志输出函数的函数名</td></tr><tr><td>%(lineno)d</td><td>调用日志输出函数的语句所在的代码行</td></tr><tr><td>%(created)f</td><td>当前时间，用UNIX标准的表示时间的浮 点数表示</td></tr><tr><td>%(relativeCreated)d</td><td>输出日志信息时的，自Logger创建以 来的毫秒数</td></tr><tr><td>%(asctime)s</td><td>字符串形式的当前时间。默认格式是 “2003-07-08 16:49:45,896”。逗号后面的是毫秒</td></tr><tr><td>%(thread)d</td><td>线程ID。可能没有</td></tr><tr><td>%(threadName)s</td><td>线程名。可能没有</td></tr><tr><td>%(process)d</td><td>进程ID。可能没有</td></tr><tr><td>%(message)s</td><td>用户输出的消息</td></tr></tbody></table><h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>输出log到控制台以及将日志写入log文件。<br>保存2种类型的log， all.log 保存debug, info, warning, critical 信息， error.log则只保存error信息，同时按照时间自动分割日志文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> handlers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span><span class="params">(object)</span>:</span></span><br><span class="line">    level_relations = &#123;</span><br><span class="line">        <span class="string">'debug'</span>:logging.DEBUG,</span><br><span class="line">        <span class="string">'info'</span>:logging.INFO,</span><br><span class="line">        <span class="string">'warning'</span>:logging.WARNING,</span><br><span class="line">        <span class="string">'error'</span>:logging.ERROR,</span><br><span class="line">        <span class="string">'crit'</span>:logging.CRITICAL</span><br><span class="line">    &#125;<span class="comment">#日志级别关系映射</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,filename,level=<span class="string">'info'</span>,when=<span class="string">'D'</span>,backCount=<span class="number">3</span>,fmt=<span class="string">'%(asctime)s - %(pathname)s[line:%(lineno)d] - %(levelname)s: %(message)s'</span>)</span>:</span></span><br><span class="line">        self.logger = logging.getLogger(filename)</span><br><span class="line">        format_str = logging.Formatter(fmt)<span class="comment">#设置日志格式</span></span><br><span class="line">        self.logger.setLevel(self.level_relations.get(level))<span class="comment">#设置日志级别</span></span><br><span class="line">        sh = logging.StreamHandler()<span class="comment">#往屏幕上输出</span></span><br><span class="line">        sh.setFormatter(format_str) <span class="comment">#设置屏幕上显示的格式</span></span><br><span class="line">        th = handlers.TimedRotatingFileHandler(filename=filename,when=when,backupCount=backCount,encoding=<span class="string">'utf-8'</span>)<span class="comment">#往文件里写入#指定间隔时间自动生成文件的处理器</span></span><br><span class="line">        <span class="comment">#实例化TimedRotatingFileHandler</span></span><br><span class="line">        <span class="comment">#interval是时间间隔，backupCount是备份文件的个数，如果超过这个个数，就会自动删除，when是间隔的时间单位，单位有以下几种：</span></span><br><span class="line">        <span class="comment"># S 秒</span></span><br><span class="line">        <span class="comment"># M 分</span></span><br><span class="line">        <span class="comment"># H 小时、</span></span><br><span class="line">        <span class="comment"># D 天、</span></span><br><span class="line">        <span class="comment"># W 每星期（interval==0时代表星期一）</span></span><br><span class="line">        <span class="comment"># midnight 每天凌晨</span></span><br><span class="line">        th.setFormatter(format_str)<span class="comment">#设置文件里写入的格式</span></span><br><span class="line">        self.logger.addHandler(sh) <span class="comment">#把对象加到logger里</span></span><br><span class="line">        self.logger.addHandler(th)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    log = Logger(<span class="string">'all.log'</span>,level=<span class="string">'debug'</span>)</span><br><span class="line">    log.logger.debug(<span class="string">'debug'</span>)</span><br><span class="line">    log.logger.info(<span class="string">'info'</span>)</span><br><span class="line">    log.logger.warning(<span class="string">'警告'</span>)</span><br><span class="line">    log.logger.error(<span class="string">'报错'</span>)</span><br><span class="line">    log.logger.critical(<span class="string">'严重'</span>)</span><br><span class="line">    Logger(<span class="string">'error.log'</span>, level=<span class="string">'error'</span>).logger.error(<span class="string">'error'</span>)</span><br></pre></td></tr></table></figure><p>屏幕上结果如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-03-13 21:06:46,092 - D:/write_to_log.py[line:25] - DEBUG: debug</span><br><span class="line">2018-03-13 21:06:46,092 - D:/write_to_log.py[line:26] - INFO: info</span><br><span class="line">2018-03-13 21:06:46,092 - D:/write_to_log.py[line:27] - WARNING: 警告</span><br><span class="line">2018-03-13 21:06:46,099 - D:/write_to_log.py[line:28] - ERROR: 报错</span><br><span class="line">2018-03-13 21:06:46,099 - D:/write_to_log.py[line:29] - CRITICAL: 严重</span><br><span class="line">2018-03-13 21:06:46,100 - D:/write_to_log.py[line:30] - ERROR: error</span><br></pre></td></tr></table></figure><h2 id="配置logging的几种方式"><a href="#配置logging的几种方式" class="headerlink" title="配置logging的几种方式"></a>配置logging的几种方式</h2><hr><p>作为开发者，我们可以通过以下3中方式来配置logging:</p><ul><li>1）使用Python代码显式的创建loggers, handlers和formatters并分别调用它们的配置函数；</li><li>2）创建一个日志配置文件，然后使用<code>fileConfig()</code>函数来读取该文件的内容；</li><li>3）创建一个包含配置信息的dict，然后把它传递个<code>dictConfig()</code>函数；</li></ul><p>具体说明请参考另一篇博文<a href="http://www.cnblogs.com/yyds/p/6885182.html" target="_blank" rel="noopener"> 《python之配置日志的几种方式》</a></p><h2 id="向日志输出中添加上下文信息"><a href="#向日志输出中添加上下文信息" class="headerlink" title="向日志输出中添加上下文信息"></a>向日志输出中添加上下文信息</h2><hr><p>除了传递给日志记录函数的参数外，有时候我们还想在日志输出中包含一些额外的上下文信息。比如，在一个网络应用中，可能希望在日志中记录客户端的特定信息，如：远程客户端的IP地址和用户名。这里我们来介绍以下几种实现方式：</p><ul><li>通过向日志记录函数传递一个<code>extra</code>参数引入上下文信息</li><li>使用LoggerAdapters引入上下文信息</li><li>使用Filters引入上下文信息</li></ul><p>具体说明请参考另一篇博文<a href="http://www.cnblogs.com/yyds/p/6897964.html" target="_blank" rel="noopener"> 《Python之向日志输出中添加上下文信息》</a></p><p>关于Python logging的更多高级用法，请参考文档<a href="https://docs.python.org/3.5/howto/logging-cookbook.html" target="_blank" rel="noopener">&lt;&lt; Logging CookBook &gt;&gt;</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/yyds/p/6901864.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/yyds/p/6901864.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/yuanyongqiang/p/11913812.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/yuanyongqiang/p/11913812.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/nancyzhu/p/8551506.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/nancyzhu/p/8551506.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;日志相关概念&quot;&gt;&lt;a href=&quot;#日志相关概念&quot; class=&quot;headerlink&quot; title=&quot;日志相关概念&quot;&gt;&lt;/a&gt;日志相关概念&lt;/h1&gt;&lt;p&gt;日志是一种可以追踪某些软件运行时所发生事件的方法。软件开发人员可以向他们的代码中调用日志记录相关的方法来表明发生了某些事情。一个事件可以用一个可包含可选变量数据的消息来描述。此外，事件也有重要性的概念，这个重要性也可以被称为严重性级别（level）。&lt;/p&gt;
&lt;h2 id=&quot;日志的作用&quot;&gt;&lt;a href=&quot;#日志的作用&quot; class=&quot;headerlink&quot; title=&quot;日志的作用&quot;&gt;&lt;/a&gt;日志的作用&lt;/h2&gt;&lt;p&gt;通过log的分析，可以方便用户了解系统或软件、应用的运行情况；如果你的应用log足够丰富，也可以分析以往用户的操作行为、类型喜好、地域分布或其他更多信息；如果一个应用的log同时也分了多个级别，那么可以很轻易地分析得到该应用的健康状况，及时发现问题并快速定位、解决问题，补救损失。&lt;br&gt;简单来讲就是，我们通过记录和分析日志可以了解一个系统或软件程序运行情况是否正常，也可以在应用程序出现故障时快速定位问题。比如，做运维的同学，在接收到报警或各种问题反馈后，进行问题排查时通常都会先去看各种日志，大部分问题都可以在日志中找到答案。再比如，做开发的同学，可以通过IDE控制台上输出的各种日志进行程序调试。对于运维老司机或者有经验的开发人员，可以快速的通过日志定位到问题的根源。可见，日志的重要性不可小觑。日志的作用可以简单总结为以下3点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;程序调试&lt;/li&gt;
&lt;li&gt;了解软件程序运行情况，是否正常&lt;/li&gt;
&lt;li&gt;软件程序运行故障分析与问题定位&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果应用的日志信息足够详细和丰富，还可以用来做用户行为分析，如：分析用户的操作行为、类型洗好、地域分布以及其它更多的信息，由此可以实现改进业务、提高商业利益。&lt;/p&gt;
&lt;h2 id=&quot;日志的等级&quot;&gt;&lt;a href=&quot;#日志的等级&quot; class=&quot;headerlink&quot; title=&quot;日志的等级&quot;&gt;&lt;/a&gt;日志的等级&lt;/h2&gt;&lt;p&gt;我们先来思考下下面的两个问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;作为开发人员，在开发一个应用程序时需要什么日志信息？在应用程序正式上线后需要什么日志信息？&lt;/li&gt;
&lt;li&gt;作为应用运维人员，在部署开发环境时需要什么日志信息？在部署生产环境时需要什么日志信息？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在软件开发阶段或部署开发环境时，为了尽可能详细的查看应用程序的运行状态来保证上线后的稳定性，我们可能需要把该应用程序所有的运行日志全部记录下来进行分析，这是非常耗费机器性能的。当应用程序正式发布或在生产环境部署应用程序时，我们通常只需要记录应用程序的异常信息、错误信息等，这样既可以减小服务器的I/O压力，也可以避免我们在排查故障时被淹没在日志的海洋里。那么，怎样才能在不改动应用程序代码的情况下实现在不同的环境记录不同详细程度的日志呢？这就是日志等级的作用了，我们通过配置文件指定我们需要的日志等级就可以了。&lt;/p&gt;
&lt;p&gt;不同的应用程序所定义的日志等级可能会有所差别，分的详细点的会包含以下几个等级：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DEBUG&lt;/li&gt;
&lt;li&gt;INFO&lt;/li&gt;
&lt;li&gt;NOTICE&lt;/li&gt;
&lt;li&gt;WARNING&lt;/li&gt;
&lt;li&gt;ERROR&lt;/li&gt;
&lt;li&gt;CRITICAL&lt;/li&gt;
&lt;li&gt;ALERT&lt;/li&gt;
&lt;li&gt;EMERGENCY&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;日志字段信息与日志格式&quot;&gt;&lt;a href=&quot;#日志字段信息与日志格式&quot; class=&quot;headerlink&quot; title=&quot;日志字段信息与日志格式&quot;&gt;&lt;/a&gt;日志字段信息与日志格式&lt;/h2&gt;&lt;p&gt;本节开始问题提到过，一条日志信息对应的是一个事件的发生，而一个事件通常需要包括以下几个内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;事件发生时间&lt;/li&gt;
&lt;li&gt;事件发生位置&lt;/li&gt;
&lt;li&gt;事件的严重程度–日志级别&lt;/li&gt;
&lt;li&gt;事件内容&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上面这些都是一条日志记录中可能包含的字段信息，当然还可以包括一些其他信息，如进程ID、进程名称、线程ID、线程名称等。日志格式就是用来定义一条日志记录中包含那些字段的，且日志格式通常都是可以自定义的。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;说明：&lt;/p&gt;
&lt;p&gt;输出一条日志时，日志内容和日志级别是需要开发人员明确指定的。对于而其它字段信息，只需要是否显示在日志中就可以了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;日志功能的实现&quot;&gt;&lt;a href=&quot;#日志功能的实现&quot; class=&quot;headerlink&quot; title=&quot;日志功能的实现&quot;&gt;&lt;/a&gt;日志功能的实现&lt;/h2&gt;&lt;p&gt;几乎所有开发语言都会内置日志相关功能，或者会有比较优秀的第三方库来提供日志操作功能，比如：log4j，log4php等。它们功能强大、使用简单。Python自身也提供了一个用于记录日志的标准库模块–logging。&lt;/p&gt;
&lt;h1 id=&quot;logging模块简介&quot;&gt;&lt;a href=&quot;#logging模块简介&quot; class=&quot;headerlink&quot; title=&quot;logging模块简介&quot;&gt;&lt;/a&gt;logging模块简介&lt;/h1&gt;&lt;p&gt;logging模块定义的函数和类为应用程序和库的开发实现了一个灵活的事件日志系统。logging模块是Python的一个标准库模块，由标准库模块提供日志记录API的关键好处是所有Python模块都可以使用这个日志记录功能。所以，你的应用日志可以将你自己的日志信息与来自第三方模块的信息整合起来。&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://gongzhao1.coding.me/categories/python/"/>
    
    
      <category term="python" scheme="https://gongzhao1.coding.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python模块之时间模块</title>
    <link href="https://gongzhao1.coding.me/python%E6%A8%A1%E5%9D%97%E4%B9%8B%E6%97%B6%E9%97%B4%E6%A8%A1%E5%9D%97/"/>
    <id>https://gongzhao1.coding.me/python模块之时间模块/</id>
    <published>2020-03-15T07:53:22.000Z</published>
    <updated>2020-04-08T14:20:25.873Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://itopic.org/python-time-module.html" target="_blank" rel="noopener">https://itopic.org/python-time-module.html</a></li><li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017648783851616" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/1016959663602400/1017648783851616</a></li><li><a href="https://blog.csdn.net/watfe/article/details/84943732" target="_blank" rel="noopener">https://blog.csdn.net/watfe/article/details/84943732</a></li></ul><a id="more"></a><h1 id="time模块"><a href="#time模块" class="headerlink" title="time模块"></a>time模块</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(time.__doc__)</span><br><span class="line"></span><br><span class="line">Functions:</span><br><span class="line"></span><br><span class="line">time() -- <span class="keyword">return</span> current time <span class="keyword">in</span> seconds since the Epoch <span class="keyword">as</span> a float</span><br><span class="line">clock() -- <span class="keyword">return</span> CPU time since process start <span class="keyword">as</span> a float</span><br><span class="line">sleep() -- delay <span class="keyword">for</span> a number of seconds given <span class="keyword">as</span> a float</span><br><span class="line">gmtime() -- convert seconds since Epoch to UTC tuple</span><br><span class="line">localtime() -- convert seconds since Epoch to local time tuple</span><br><span class="line">asctime() -- convert time tuple to string</span><br><span class="line">ctime() -- convert time <span class="keyword">in</span> seconds to string</span><br><span class="line">mktime() -- convert local time tuple to seconds since Epoch</span><br><span class="line">strftime() -- convert time tuple to string according to format specification</span><br><span class="line">strptime() -- parse string to time tuple according to format specification</span><br><span class="line">tzset() -- change the local timezone</span><br></pre></td></tr></table></figure><h2 id="获取时间戳"><a href="#获取时间戳" class="headerlink" title="获取时间戳"></a>获取时间戳</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>time.time()</span><br><span class="line"><span class="number">1552827527.447389</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>int(time.time())</span><br><span class="line"><span class="number">1552827538</span></span><br></pre></td></tr></table></figure><h2 id="停留x秒"><a href="#停留x秒" class="headerlink" title="停留x秒"></a>停留x秒</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> time.sleep.__doc__</span><br><span class="line">sleep(seconds)</span><br><span class="line"></span><br><span class="line">Delay execution <span class="keyword">for</span> a given number of seconds.  The argument may be</span><br><span class="line">a floating point number <span class="keyword">for</span> subsecond precision.</span><br></pre></td></tr></table></figure><h2 id="time与字符串互转"><a href="#time与字符串互转" class="headerlink" title="time与字符串互转"></a>time与字符串互转</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print time.strftime.__doc__</span><br><span class="line">strftime(format[, tuple]) -&gt; string</span><br><span class="line"></span><br><span class="line">Convert a time tuple to a string according to a format specification.</span><br><span class="line">See the library reference manual for formatting codes. When the time tuple</span><br><span class="line">is not present, current time as returned by localtime() is used.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print time.strptime.__doc__</span><br><span class="line">strptime(string, format) -&gt; struct_time</span><br><span class="line"></span><br><span class="line">Parse a string to a time tuple according to a format specification.</span><br><span class="line">See the library reference manual for formatting codes (same as strftime()).</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"></span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 格式化成2016-03-20 11:45:39形式</span><br><span class="line">print (time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime()))</span><br><span class="line"></span><br><span class="line"># 格式化成Sat Mar 28 22:24:24 2016形式</span><br><span class="line">print (time.strftime(&quot;%a %b %d %H:%M:%S %Y&quot;, time.localtime()))</span><br><span class="line">  </span><br><span class="line"># 将格式字符串转换为时间戳</span><br><span class="line">a = &quot;Sat Mar 28 22:24:24 2016&quot;</span><br><span class="line">print (time.mktime(time.strptime(a,&quot;%a %b %d %H:%M:%S %Y&quot;)))</span><br></pre></td></tr></table></figure><h1 id="datetime模块"><a href="#datetime模块" class="headerlink" title="datetime模块"></a>datetime模块</h1><h2 id="获取当前日期和时间"><a href="#获取当前日期和时间" class="headerlink" title="获取当前日期和时间"></a>获取当前日期和时间</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>now = datetime.now() <span class="comment"># 获取当前datetime</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(now)</span><br><span class="line"><span class="number">2015</span><span class="number">-05</span><span class="number">-18</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">07.198690</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(type(now))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt;</span></span><br></pre></td></tr></table></figure><p>注意到<code>datetime</code>是模块，<code>datetime</code>模块还包含一个<code>datetime</code>类，通过<code>from datetime import datetime</code>导入的才是<code>datetime</code>这个类。</p><p>如果仅导入<code>import datetime</code>，则必须引用全名<code>datetime.datetime</code>。</p><p><code>datetime.now()</code>返回当前日期和时间，其类型是<code>datetime</code>。</p><h2 id="获取指定日期和时间"><a href="#获取指定日期和时间" class="headerlink" title="获取指定日期和时间"></a>获取指定日期和时间</h2><p>要指定某个日期和时间，我们直接用参数构造一个<code>datetime</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dt = datetime(<span class="number">2015</span>, <span class="number">4</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">20</span>) <span class="comment"># 用指定日期时间创建datetime</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(dt)</span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-19</span> <span class="number">12</span>:<span class="number">20</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><h2 id="datetime转换为timestamp"><a href="#datetime转换为timestamp" class="headerlink" title="datetime转换为timestamp"></a>datetime转换为timestamp</h2><p>在计算机中，时间实际上是用数字表示的。我们把1970年1月1日 00:00:00 UTC+00:00时区的时刻称为epoch time，记为<code>0</code>（1970年以前的时间timestamp为负数），当前时间就是相对于epoch time的秒数，称为timestamp。</p><p>你可以认为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timestamp = <span class="number">0</span> = <span class="number">1970</span><span class="number">-1</span><span class="number">-1</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> UTC+<span class="number">0</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><p>对应的北京时间是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timestamp = 0 = 1970-1-1 08:00:00 UTC+8:00</span><br></pre></td></tr></table></figure><p>可见timestamp的值与时区毫无关系，因为timestamp一旦确定，其UTC时间就确定了，转换到任意时区的时间也是完全确定的，这就是为什么计算机存储的当前时间是以timestamp表示的，因为全球各地的计算机在任意时刻的timestamp都是完全相同的（假定时间已校准）。</p><p>把一个<code>datetime</code>类型转换为timestamp只需要简单调用<code>timestamp()</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dt = datetime(<span class="number">2015</span>, <span class="number">4</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">20</span>) <span class="comment"># 用指定日期时间创建datetime</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dt.timestamp() <span class="comment"># 把datetime转换为timestamp</span></span><br><span class="line"><span class="number">1429417200.0</span></span><br></pre></td></tr></table></figure><p>注意Python的timestamp是一个浮点数。如果有小数位，小数位表示毫秒数。</p><p>某些编程语言（如Java和JavaScript）的timestamp使用整数表示毫秒数，这种情况下只需要把timestamp除以1000就得到Python的浮点表示方法。</p><h2 id="timestamp转换为datetime"><a href="#timestamp转换为datetime" class="headerlink" title="timestamp转换为datetime"></a>timestamp转换为datetime</h2><p>要把timestamp转换为<code>datetime</code>，使用<code>datetime</code>提供的<code>fromtimestamp()</code>方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime</span><br><span class="line">&gt;&gt;&gt; t = 1429417200.0</span><br><span class="line">&gt;&gt;&gt; print(datetime.fromtimestamp(t))</span><br><span class="line">2015-04-19 12:20:00</span><br></pre></td></tr></table></figure><p>注意到timestamp是一个浮点数，它没有时区的概念，而datetime是有时区的。上述转换是在timestamp和本地时间做转换。</p><p>本地时间是指当前操作系统设定的时区。例如北京时区是东8区，则本地时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2015-04-19 12:20:00</span><br></pre></td></tr></table></figure><p>实际上就是UTC+8:00时区的时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2015-04-19 12:20:00 UTC+8:00</span><br></pre></td></tr></table></figure><p>而此刻的格林威治标准时间与北京时间差了8小时，也就是UTC+0:00时区的时间应该是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2015-04-19 04:20:00 UTC+0:00</span><br></pre></td></tr></table></figure><p>timestamp也可以直接被转换到UTC标准时区的时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime</span><br><span class="line">&gt;&gt;&gt; t = 1429417200.0</span><br><span class="line">&gt;&gt;&gt; print(datetime.fromtimestamp(t)) # 本地时间</span><br><span class="line">2015-04-19 12:20:00</span><br><span class="line">&gt;&gt;&gt; print(datetime.utcfromtimestamp(t)) # UTC时间</span><br><span class="line">2015-04-19 04:20:00</span><br></pre></td></tr></table></figure><h2 id="str转换为datetime"><a href="#str转换为datetime" class="headerlink" title="str转换为datetime"></a>str转换为datetime</h2><p>很多时候，用户输入的日期和时间是字符串，要处理日期和时间，首先必须把str转换为datetime。转换方法是通过<code>datetime.strptime()</code>实现，需要一个日期和时间的格式化字符串：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime</span><br><span class="line">&gt;&gt;&gt; cday = datetime.strptime(&apos;2015-6-1 18:19:59&apos;, &apos;%Y-%m-%d %H:%M:%S&apos;)</span><br><span class="line">&gt;&gt;&gt; print(cday)</span><br><span class="line">2015-06-01 18:19:59</span><br></pre></td></tr></table></figure><p>字符串<code>&#39;%Y-%m-%d %H:%M:%S&#39;</code>规定了日期和时间部分的格式。详细的说明请参考<a href="https://docs.python.org/3/library/datetime.html#strftime-strptime-behavior" target="_blank" rel="noopener">Python文档</a>。</p><p>注意转换后的datetime是没有时区信息的。</p><h2 id="datetime转换为str"><a href="#datetime转换为str" class="headerlink" title="datetime转换为str"></a>datetime转换为str</h2><p>如果已经有了datetime对象，要把它格式化为字符串显示给用户，就需要转换为str，转换方法是通过<code>strftime()</code>实现的，同样需要一个日期和时间的格式化字符串：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime</span><br><span class="line">&gt;&gt;&gt; now = datetime.now()</span><br><span class="line">&gt;&gt;&gt; print(now.strftime(&apos;%a, %b %d %H:%M&apos;))</span><br><span class="line">Mon, May 05 16:28</span><br></pre></td></tr></table></figure><h2 id="datetime加减"><a href="#datetime加减" class="headerlink" title="datetime加减"></a>datetime加减</h2><p>对日期和时间进行加减实际上就是把datetime往后或往前计算，得到新的datetime。加减可以直接用<code>+</code>和<code>-</code>运算符，不过需要导入<code>timedelta</code>这个类：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime, timedelta</span><br><span class="line">&gt;&gt;&gt; now = datetime.now()</span><br><span class="line">&gt;&gt;&gt; now</span><br><span class="line">datetime.datetime(2015, 5, 18, 16, 57, 3, 540997)</span><br><span class="line">&gt;&gt;&gt; now + timedelta(hours=10)</span><br><span class="line">datetime.datetime(2015, 5, 19, 2, 57, 3, 540997)</span><br><span class="line">&gt;&gt;&gt; now - timedelta(days=1)</span><br><span class="line">datetime.datetime(2015, 5, 17, 16, 57, 3, 540997)</span><br><span class="line">&gt;&gt;&gt; now + timedelta(days=2, hours=12)</span><br><span class="line">datetime.datetime(2015, 5, 21, 4, 57, 3, 540997)</span><br></pre></td></tr></table></figure><p>可见，使用<code>timedelta</code>你可以很容易地算出前几天和后几天的时刻。</p><h2 id="本地时间转换为UTC时间"><a href="#本地时间转换为UTC时间" class="headerlink" title="本地时间转换为UTC时间"></a>本地时间转换为UTC时间</h2><p>本地时间是指系统设定时区的时间，例如北京时间是UTC+8:00时区的时间，而UTC时间指UTC+0:00时区的时间。</p><p>一个<code>datetime</code>类型有一个时区属性<code>tzinfo</code>，但是默认为<code>None</code>，所以无法区分这个<code>datetime</code>到底是哪个时区，除非强行给<code>datetime</code>设置一个时区：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from datetime import datetime, timedelta, timezone</span><br><span class="line">&gt;&gt;&gt; tz_utc_8 = timezone(timedelta(hours=8)) # 创建时区UTC+8:00</span><br><span class="line">&gt;&gt;&gt; now = datetime.now()</span><br><span class="line">&gt;&gt;&gt; now</span><br><span class="line">datetime.datetime(2015, 5, 18, 17, 2, 10, 871012)</span><br><span class="line">&gt;&gt;&gt; dt = now.replace(tzinfo=tz_utc_8) # 强制设置为UTC+8:00</span><br><span class="line">&gt;&gt;&gt; dt</span><br><span class="line">datetime.datetime(2015, 5, 18, 17, 2, 10, 871012, tzinfo=datetime.timezone(datetime.timedelta(0, 28800)))</span><br></pre></td></tr></table></figure><p>如果系统时区恰好是UTC+8:00，那么上述代码就是正确的，否则，不能强制设置为UTC+8:00时区。</p><p><strong>时区转换</strong></p><p>我们可以先通过<code>utcnow()</code>拿到当前的UTC时间，再转换为任意时区的时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 拿到UTC时间，并强制设置时区为UTC+0:00:</span><br><span class="line">&gt;&gt;&gt; utc_dt = datetime.utcnow().replace(tzinfo=timezone.utc)</span><br><span class="line">&gt;&gt;&gt; print(utc_dt)</span><br><span class="line">2015-05-18 09:05:12.377316+00:00</span><br><span class="line"># astimezone()将转换时区为北京时间:</span><br><span class="line">&gt;&gt;&gt; bj_dt = utc_dt.astimezone(timezone(timedelta(hours=8)))</span><br><span class="line">&gt;&gt;&gt; print(bj_dt)</span><br><span class="line">2015-05-18 17:05:12.377316+08:00</span><br><span class="line"># astimezone()将转换时区为东京时间:</span><br><span class="line">&gt;&gt;&gt; tokyo_dt = utc_dt.astimezone(timezone(timedelta(hours=9)))</span><br><span class="line">&gt;&gt;&gt; print(tokyo_dt)</span><br><span class="line">2015-05-18 18:05:12.377316+09:00</span><br><span class="line"># astimezone()将bj_dt转换时区为东京时间:</span><br><span class="line">&gt;&gt;&gt; tokyo_dt2 = bj_dt.astimezone(timezone(timedelta(hours=9)))</span><br><span class="line">&gt;&gt;&gt; print(tokyo_dt2)</span><br><span class="line">2015-05-18 18:05:12.377316+09:00</span><br></pre></td></tr></table></figure><p>时区转换的关键在于，拿到一个<code>datetime</code>时，要获知其正确的时区，然后强制设置时区，作为基准时间。</p><p>利用带时区的<code>datetime</code>，通过<code>astimezone()</code>方法，可以转换到任意时区。</p><p>注：不是必须从UTC+0:00时区转换到其他时区，任何带时区的<code>datetime</code>都可以正确转换，例如上述<code>bj_dt</code>到<code>tokyo_dt</code>的转换。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>datetime</code>表示的时间需要时区信息才能确定一个特定的时间，否则只能视为本地时间。</p><p>如果要存储<code>datetime</code>，最佳方法是将其转换为timestamp再存储，因为timestamp的值与时区完全无关。</p><h1 id="dateutil模块"><a href="#dateutil模块" class="headerlink" title="dateutil模块"></a>dateutil模块</h1><p>安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install python-dateutil</span><br></pre></td></tr></table></figure><h2 id="parser"><a href="#parser" class="headerlink" title="parser"></a>parser</h2><p>parser是根据字符串解析成datetime,字符串可以很随意，可以用时间日期的英文单词，可以用横线、逗号、空格等做分隔符，可以包含时区。<br>没指定时间默认是0点，没指定日期默认是今天，没指定年份默认是今年。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parse(<span class="string">"2018-10-21"</span>)</span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parse(<span class="string">"20181021"</span>)</span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parse(<span class="string">"2018/10/21"</span>)</span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parse(<span class="string">"10-21"</span>)</span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parse(<span class="string">"10/21"</span>)</span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">10</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2 id="rrule"><a href="#rrule" class="headerlink" title="rrule"></a>rrule</h2><p>rrule(self, freq, dtstart=None, interval=1, wkst=None,count=None, until=None, bysetpos=None,bymonth=None, bymonthday=None, byyearday=None, byeaster=None,byweekno=None, byweekday=None, byhour=None, byminute=None, bysecond=None,cache=False)</p><ul><li>freq:可以理解为单位。可以是 YEARLY, MONTHLY, WEEKLY,DAILY, HOURLY, MINUTELY, SECONDLY。即年月日周时分秒</li><li>dtstart,until:是开始和结束时间</li><li>wkst:周开始时间</li><li>interval:间隔</li><li>count:指定生成多少个</li><li>byxxx:指定匹配的周期。比如byweekday=(MO,TU)则只有周一周二的匹配。byweekday可以指定MO,TU,WE,TH,FR,SA,SU。即周一到周日。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> dateutil <span class="keyword">import</span> rrule</span><br><span class="line"></span><br><span class="line">生成一个连续的日期列表</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.DAILY,dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-5'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br><span class="line"></span><br><span class="line">间隔一天</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.DAILY,interval=<span class="number">2</span>,dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-5'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br><span class="line"></span><br><span class="line">只保留前<span class="number">3</span>个元素</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.DAILY,count=<span class="number">3</span>,dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-5'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br><span class="line"></span><br><span class="line">只要周一的</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.DAILY,byweekday=rrule.MO,dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-5'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br><span class="line"></span><br><span class="line">只要周六和周日的</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.DAILY,byweekday=(rrule.SA,rrule.SU),dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-5'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br><span class="line"></span><br><span class="line">以月为间隔</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(rrule.rrule(rrule.MONTHLY,dtstart=parse(<span class="string">'2018-3-15'</span>),until=parse(<span class="string">'2018-7-30'</span>)))</span><br><span class="line">[datetime.datetime(<span class="number">2018</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">datetime.datetime(<span class="number">2018</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>)]</span><br></pre></td></tr></table></figure><p><strong>计算时间差</strong></p><p>rrule可计算出两个datetime对象间相差的年月日等时间数量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">两个日期相差<span class="number">10</span>天</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.DAILY,dtstart=parse(<span class="string">'2018-11-1'</span>),until=parse(<span class="string">'2018-11-10'</span>)).count()</span><br><span class="line"><span class="number">10</span></span><br><span class="line"></span><br><span class="line">某个日期到今天相差多少天</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.DAILY,dtstart=parse(<span class="string">'2018-11-1'</span>),until=datetime.date.today()).count()</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure><p>两个日期相差几个月<br>前一个月为m月，后一个月为n月，当日期不满整月时，差的月数按n-m算，当日期满整月后，差的月数按n-m+1算。<br>差的年数同月数的情况一样。<br>例子如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.MONTHLY,dtstart=parse(<span class="string">'2018-3-15'</span>),until=parse(<span class="string">'2018-11-10'</span>)).count()</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.MONTHLY,dtstart=parse(<span class="string">'2018-3-15'</span>),until=parse(<span class="string">'2018-11-20'</span>)).count()</span><br><span class="line"><span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.YEARLY,dtstart=parse(<span class="string">'2016-3-15'</span>),until=parse(<span class="string">'2018-2-10'</span>)).count()</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rrule.rrule(rrule.YEARLY,dtstart=parse(<span class="string">'2016-3-15'</span>),until=parse(<span class="string">'2018-3-15'</span>)).count()</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure><h1 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h1><h2 id="当前时间转文本"><a href="#当前时间转文本" class="headerlink" title="当前时间转文本"></a>当前时间转文本</h2><p>无论是<code>time</code>或<code>datetime</code>，哪个模块都可以，具体怎么输出，自行调整格式参数<code>&#39;%Y-%m-%d %H:%M:%S&#39;</code></p><table><thead><tr><th>%字符</th><th>表意</th><th>数值范围</th></tr></thead><tbody><tr><td>%y</td><td>年(2位)</td><td>00, 01, …, 99</td></tr><tr><td>%Y</td><td>年(4位)</td><td>0001, 0002, …, 2013, 2014, …, 9998, 9999</td></tr><tr><td>%m</td><td>月</td><td>01, 02, …, 12</td></tr><tr><td>%d</td><td>日</td><td>01, 02, …, 31</td></tr><tr><td>%H</td><td>时(24小时制)</td><td>00, 01, …, 23</td></tr><tr><td>%M</td><td>分</td><td>00, 01, …, 59</td></tr><tr><td>%S</td><td>秒</td><td>00, 01, …, 59</td></tr><tr><td>%f</td><td>毫秒</td><td>000000, 000001, …, 999999</td></tr><tr><td>%z</td><td>时区</td><td>(empty), +0000, -0400, +1030, +063415, -030712.345216</td></tr></tbody></table><p>这里只列一下我用到的，更多可以看官方文档：<br><a href="https://docs.python.org/3/library/datetime.html#strftime-and-strptime-behavior" target="_blank" rel="noopener">https://docs.python.org/3/library/datetime.html#strftime-and-strptime-behavior</a></p><p><strong>【注意】：time、datetime两种时间模块虽然都有strftime，但是(格式,时间)参数位置正好相反。</strong></p><p>time模块（格式在前，时间在后）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t = time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>,time.localtime())</span><br><span class="line">print(type(t),t)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt; 2019-05-25 08:</span><span class="number">56</span>:<span class="number">45</span></span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure><p>datetime模块（格式在后，时间在前）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">dt = datetime.datetime.strftime(datetime.datetime.now(),<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">print(type(dt),dt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt; 2019-05-25 08:</span><span class="number">56</span>:<span class="number">45</span></span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure><h2 id="文本转日期"><a href="#文本转日期" class="headerlink" title="文本转日期"></a>文本转日期</h2><p><strong>常规方法<code>strptime(&quot;日期时间文本&quot;,&quot;文本格式&quot;)</code></strong></p><p>制定时间格式，进行解析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">dt = datetime.datetime.strptime(<span class="string">'2019-05-25T07:46:45.743+0000'</span>,<span class="string">'%Y-%m-%dT%H:%M:%S.%f%z'</span>)</span><br><span class="line">print(type(dt),dt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2019-05-25 07:</span><span class="number">46</span>:<span class="number">45.743000</span>+<span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><p><strong>万能方法<code>parse(&quot;日期时间文本&quot;)</code></strong></p><p>自动解析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from dateutil.parser import parse</span><br><span class="line">dt = parse(&apos;2019-05-25 07:46:45&apos;)</span><br><span class="line">print(type(dt),dt)</span><br><span class="line"></span><br><span class="line"># 输出结果</span><br><span class="line">&lt;class &apos;datetime.datetime&apos;&gt; 2019-05-25 07:46:45</span><br></pre></td></tr></table></figure><p>该方法适用于很多类型时间格式，建议使用前自行测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dt = [&quot;2001.07.04 AD at 12:08:56 PDT&quot;,</span><br><span class="line">&quot;Wed, 4 Jul 2001 12:08:56 -0700&quot;,</span><br><span class="line">&quot;190525&quot;,&quot;2018-08-06T10:00:00.000Z&quot;,</span><br><span class="line">&quot;Wed, Jul 4&quot;,</span><br><span class="line">&quot;12:08 PM&quot;,</span><br><span class="line">&quot;02001.July.04 AD 12:08 PM&quot;,</span><br><span class="line">&quot;20190525083855-0700&quot;,</span><br><span class="line">&quot;2001-07-04T12:08:56.235-0700&quot;,</span><br><span class="line">&quot;Thu Oct 16 07:13:48 GMT 2014&quot;]</span><br><span class="line"></span><br><span class="line">for i in dt:</span><br><span class="line">print(parse(i))</span><br><span class="line"></span><br><span class="line"># 输出结果</span><br><span class="line">2001-07-04 12:08:56</span><br><span class="line">2001-07-04 12:08:56-07:00</span><br><span class="line">2025-05-19 00:00:00</span><br><span class="line">2018-08-06 10:00:00+00:00</span><br><span class="line">2019-07-04 00:00:00</span><br><span class="line">2019-05-25 12:08:00</span><br><span class="line">2001-07-04 12:08:00</span><br><span class="line">2019-05-25 08:38:55-07:00</span><br><span class="line">2001-07-04 12:08:56.235000-07:00</span><br><span class="line">2014-10-16 07:13:48+00:00</span><br></pre></td></tr></table></figure><p>但是注意，国外日期时间的常用格式和国内不一样。单写<code>19-05-25</code>会被解析成<code>2025年5月19日</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(parse(<span class="string">"19-05-25"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"><span class="number">2025</span><span class="number">-05</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure><p>如果是<code>2019-05-25</code>就不会错了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(parse(<span class="string">"2019-05-25"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"><span class="number">2019</span><span class="number">-05</span><span class="number">-25</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><h2 id="时间戳相关"><a href="#时间戳相关" class="headerlink" title="时间戳相关"></a>时间戳相关</h2><p>生成10或13位时间戳（做一些网页爬虫或构造提交时候可能用到）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t = time.time()</span><br><span class="line">print(type(t),t)</span><br><span class="line">print(<span class="string">'10位时间戳:'</span>,str(int(t)))</span><br><span class="line">print(<span class="string">'13位时间戳:'</span>,str(int(t*<span class="number">1000</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">float</span>'&gt; 1558750679.0872486</span></span><br><span class="line"><span class="class">10位时间戳:</span> <span class="number">1558750679</span></span><br><span class="line"><span class="number">13</span>位时间戳: <span class="number">1558750679087</span></span><br><span class="line"><span class="number">12345678910</span></span><br></pre></td></tr></table></figure><p>时间戳转日期时间（10位或13位通用）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">ts = <span class="string">'1517302458364'</span> <span class="comment"># 该值为int或string类型均可</span></span><br><span class="line">dt1 = datetime.datetime.fromtimestamp(float(ts)/<span class="number">10</span>**(len(str(ts))<span class="number">-10</span>))</span><br><span class="line">print(type(dt1),dt1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2018-01-30 16:</span><span class="number">54</span>:<span class="number">18.364000</span></span><br></pre></td></tr></table></figure><h2 id="时间差计算"><a href="#时间差计算" class="headerlink" title="时间差计算"></a>时间差计算</h2><p>如果是两个<code>datatime</code>格式的日期，直接计算一下差值即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">dt1 = datetime.datetime.fromtimestamp(<span class="number">1517302458</span>)</span><br><span class="line">dt2 = datetime.datetime.now()</span><br><span class="line"><span class="comment">#print(type(dt1),dt1)</span></span><br><span class="line"><span class="comment">#print(type(dt2),dt2)</span></span><br><span class="line">td = dt2-dt1</span><br><span class="line"><span class="comment">#print(type(td),td)</span></span><br><span class="line">output = <span class="string">'相差%d天%.1f小时'</span>%(td.days,td.seconds/<span class="number">60</span>/<span class="number">60</span>)</span><br><span class="line">print(output)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2018-01-30 16:</span><span class="number">54</span>:<span class="number">18</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2019-12-16 16:</span><span class="number">18</span>:<span class="number">37.443000</span></span><br><span class="line">&lt;class 'datetime.timedelta'&gt; 684 days, 23:24:19.443000</span><br><span class="line">相差<span class="number">684</span>天<span class="number">23.4</span>小时</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure><p>如果是两个文本格式的日期，用<code>parse()</code>转换成<code>datetime</code>，同样计算差值即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line">arr = [<span class="string">'2018-01-30 16:54:18'</span>,<span class="string">'2019-12-16 16:18:37'</span>]</span><br><span class="line">td = parse(arr[<span class="number">1</span>])-parse(arr[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">'相差%d天%.1f小时'</span>%(td.days,td.seconds/<span class="number">60</span>/<span class="number">60</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">相差<span class="number">684</span>天<span class="number">23.4</span>小时</span><br></pre></td></tr></table></figure><h2 id="时区转换"><a href="#时区转换" class="headerlink" title="时区转换"></a>时区转换</h2><p>直接获取0时区的<code>datetime</code>，并转化为东8区<code>datetime</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timezone,timedelta</span><br><span class="line">dt0 = datetime.utcnow().replace(tzinfo=timezone.utc)</span><br><span class="line">dt8 = dt0.astimezone(timezone(timedelta(hours=<span class="number">8</span>))) <span class="comment"># 转换时区到东八区</span></span><br><span class="line">print(<span class="string">'UTC协调世界时 \t%s\nUTC+8北京时间\t%s'</span>%(dt0,dt8))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">UTC协调世界时 <span class="number">2019</span><span class="number">-05</span><span class="number">-25</span> <span class="number">02</span>:<span class="number">48</span>:<span class="number">54.281741</span>+<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">UTC+<span class="number">8</span>北京时间<span class="number">2019</span><span class="number">-05</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">48</span>:<span class="number">54.281741</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure><p>如果是想将文本格式的<code>2019-05-25T02:48:54.281741+00:00</code>转化到东8区<code>datetime</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timezone,timedelta</span><br><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line">dt0_str = <span class="string">'2019-05-25T02:48:54.281741+00:00'</span></span><br><span class="line">dt0 = parse(dt0_str)</span><br><span class="line">dt8 = dt0.astimezone(timezone(timedelta(hours=<span class="number">8</span>)))</span><br><span class="line">print(type(dt0),dt0)</span><br><span class="line">print(type(dt8),dt8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2019-05-25 02:</span><span class="number">48</span>:<span class="number">54.281741</span>+<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt; 2019-05-25 10:</span><span class="number">48</span>:<span class="number">54.281741</span>+<span class="number">08</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><h2 id="获取常用时间"><a href="#获取常用时间" class="headerlink" title="获取常用时间"></a>获取常用时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime, timedelta</span><br><span class="line"></span><br><span class="line">t1 = datetime.now()</span><br><span class="line"></span><br><span class="line"># 获取本月第一天</span><br><span class="line">t2 = datetime(t1.year, t1.month, 1)</span><br><span class="line">print(t2.strftime(&quot;%Y-%m-%d&quot;))</span><br><span class="line"></span><br><span class="line"># 本月最后一天</span><br><span class="line">t3 = datetime(year=t1.year, month=t1.month+1, day=1) - timedelta(days=1)</span><br><span class="line">print(t3.strftime(&quot;%Y-%m-%d&quot;))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://itopic.org/python-time-module.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://itopic.org/python-time-module.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.liaoxuefeng.com/wiki/1016959663602400/1017648783851616&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.liaoxuefeng.com/wiki/1016959663602400/1017648783851616&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/watfe/article/details/84943732&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/watfe/article/details/84943732&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="python" scheme="https://gongzhao1.coding.me/categories/python/"/>
    
    
      <category term="python" scheme="https://gongzhao1.coding.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python之基础知识</title>
    <link href="https://gongzhao1.coding.me/python%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <id>https://gongzhao1.coding.me/python之基础知识/</id>
    <published>2020-03-15T07:37:14.000Z</published>
    <updated>2020-04-08T14:20:25.871Z</updated>
    
    <content type="html"><![CDATA[<h1 id="python变量下划线小结"><a href="#python变量下划线小结" class="headerlink" title="python变量下划线小结"></a>python变量下划线小结</h1><h2 id="下划线类型"><a href="#下划线类型" class="headerlink" title="下划线类型"></a>下划线类型</h2><p>在python模块或类里面，一些变量的命名上有时会有下划线，表示了变量的特性和被访问限制</p><table><thead><tr><th>描述</th><th>例如</th><th>访问限制</th></tr></thead><tbody><tr><td>前面单下划线</td><td><code>_var</code></td><td>变量所在模块/类以外的地方也能访问该变量，但最好不要</td></tr><tr><td>前面双下划线</td><td><code>__privateVar</code></td><td>变量所在模块/类以外的地方不能访问该变量，这是私有变量</td></tr><tr><td>前后双下划线</td><td>如<code>__name__</code>和<code>__init__</code></td><td>Python内置特殊变量，哪儿都可以访问</td></tr></tbody></table><h2 id="什么是-name"><a href="#什么是-name" class="headerlink" title="什么是__name__"></a>什么是<code>__name__</code></h2><p>一个python脚本，比如 hello.py，就是一个模块，这个模块的名字叫hello；一个模块既可以被其它模块导入（importable），也可以被直接执行（executable）.</p><p><code>__name__</code>是python的内置变量。如果一个模块是被直接执行的话，那么这个模块的<code>__name__</code>变量的值就是 <code>__main__</code>值；而如果这个模块是被其它模块导入的，那么这个模块的<code>__name__</code>变量的值就是模块的名字。</p><a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;python变量下划线小结&quot;&gt;&lt;a href=&quot;#python变量下划线小结&quot; class=&quot;headerlink&quot; title=&quot;python变量下划线小结&quot;&gt;&lt;/a&gt;python变量下划线小结&lt;/h1&gt;&lt;h2 id=&quot;下划线类型&quot;&gt;&lt;a href=&quot;#下划线类型&quot; class=&quot;headerlink&quot; title=&quot;下划线类型&quot;&gt;&lt;/a&gt;下划线类型&lt;/h2&gt;&lt;p&gt;在python模块或类里面，一些变量的命名上有时会有下划线，表示了变量的特性和被访问限制&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;th&gt;例如&lt;/th&gt;
&lt;th&gt;访问限制&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;前面单下划线&lt;/td&gt;
&lt;td&gt;&lt;code&gt;_var&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;变量所在模块/类以外的地方也能访问该变量，但最好不要&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;前面双下划线&lt;/td&gt;
&lt;td&gt;&lt;code&gt;__privateVar&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;变量所在模块/类以外的地方不能访问该变量，这是私有变量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;前后双下划线&lt;/td&gt;
&lt;td&gt;如&lt;code&gt;__name__&lt;/code&gt;和&lt;code&gt;__init__&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Python内置特殊变量，哪儿都可以访问&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h2 id=&quot;什么是-name&quot;&gt;&lt;a href=&quot;#什么是-name&quot; class=&quot;headerlink&quot; title=&quot;什么是__name__&quot;&gt;&lt;/a&gt;什么是&lt;code&gt;__name__&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;一个python脚本，比如 hello.py，就是一个模块，这个模块的名字叫hello；一个模块既可以被其它模块导入（importable），也可以被直接执行（executable）.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;__name__&lt;/code&gt;是python的内置变量。如果一个模块是被直接执行的话，那么这个模块的&lt;code&gt;__name__&lt;/code&gt;变量的值就是 &lt;code&gt;__main__&lt;/code&gt;值；而如果这个模块是被其它模块导入的，那么这个模块的&lt;code&gt;__name__&lt;/code&gt;变量的值就是模块的名字。&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://gongzhao1.coding.me/categories/python/"/>
    
    
      <category term="python" scheme="https://gongzhao1.coding.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python之小技巧</title>
    <link href="https://gongzhao1.coding.me/python%E4%B9%8B%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    <id>https://gongzhao1.coding.me/python之小技巧/</id>
    <published>2020-03-15T07:02:09.000Z</published>
    <updated>2020-04-08T14:20:25.871Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="python字符串中包含大括号时怎么使用string的-format方法？"><a href="#python字符串中包含大括号时怎么使用string的-format方法？" class="headerlink" title="python字符串中包含大括号时怎么使用string的.format方法？"></a>python字符串中包含大括号时怎么使用string的.format方法？</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'hello &#123;name&#125;'</span>.format(name=<span class="string">'world'</span>)的时候大括号是特殊转义字符，如果需要原始的大括号，用&#123;&#123;代替&#123;, 用&#125;&#125;代替&#125;， 如下:</span><br><span class="line">&gt;&gt;&gt; <span class="string">'hello &#123;&#123;worlds in braces!&#125;&#125;, &#123;name&#125;'</span>.format(name=<span class="string">'zhangsan'</span>)</span><br><span class="line"><span class="string">'hello &#123;worlds in braces!&#125;, zhangsan'</span></span><br></pre></td></tr></table></figure><h1 id="python将一组数分成每3个一组的实例"><a href="#python将一组数分成每3个一组的实例" class="headerlink" title="python将一组数分成每3个一组的实例"></a>python将一组数分成每3个一组的实例</h1><p>如下所示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">step = <span class="number">3</span></span><br><span class="line">b = [a[i:i+step] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(a),step)]</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>], [<span class="number">10</span>, <span class="number">11</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b[<span class="number">1</span>]</span><br><span class="line">[<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="Python中字符串、列表、元组、字典之间的相互转换"><a href="#Python中字符串、列表、元组、字典之间的相互转换" class="headerlink" title="Python中字符串、列表、元组、字典之间的相互转换"></a>Python中字符串、列表、元组、字典之间的相互转换</h1><p><a href="https://www.jb51.net/article/174331.htm" target="_blank" rel="noopener">https://www.jb51.net/article/174331.htm</a></p><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><h3 id="字符串转换为列表"><a href="#字符串转换为列表" class="headerlink" title="字符串转换为列表"></a>字符串转换为列表</h3><ol><li>使用list()方法</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">str_1 = <span class="string">"1235"</span></span><br><span class="line">str_2 = <span class="string">'zhangsan'</span></span><br><span class="line">str_3 = <span class="string">'''lisi'''</span></span><br><span class="line">tuple_1 = list(str_1)</span><br><span class="line">tuple_2 = list(str_2)</span><br><span class="line">tuple_3 = list(str_3)</span><br><span class="line">print(type(tuple_1))</span><br><span class="line">print(type(tuple_2))</span><br><span class="line">print(type(tuple_3))</span><br><span class="line">print(tuple_1)</span><br><span class="line">print(tuple_2)</span><br><span class="line">print(tuple_3)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/1.png" alt="img"></p><ol start="2"><li><p>使用Python中字符串的内置方法split()</p><blockquote><p>Python split() 通过指定分隔符对字符串进行切片，如果参数 num 有指定值，则分隔 num+1 个子字符串<br>语法：str.split(str=””, num=string.count(str)).<br>①str – 分隔符，默认为所有的空字符，包括空格、换行(\n)、制表符(\t)等。<br>②num – 分割次数。默认为 -1, 即分隔所有。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">str_1 = <span class="string">"12 35 213"</span></span><br><span class="line">str_2 = <span class="string">'zhang san shi a '</span></span><br><span class="line">str_3 = <span class="string">'zhang san shi a '</span></span><br><span class="line">str_4 = <span class="string">'''li si wang wu'''</span></span><br><span class="line">list_1 = str_1.split(<span class="string">" "</span>)</span><br><span class="line">list_2 = str_2.split(<span class="string">" "</span>,<span class="number">1</span>)</span><br><span class="line">list_3 = str_3.split(<span class="string">" "</span>)</span><br><span class="line">list_4 = str_4.split(<span class="string">" "</span>,<span class="number">2</span>)</span><br><span class="line">print(type(list_1))</span><br><span class="line">print(type(list_2))</span><br><span class="line">print(type(list_3))</span><br><span class="line">print(type(list_4))</span><br><span class="line">print(list_1)</span><br><span class="line">print(list_2)</span><br><span class="line">print(list_3)</span><br><span class="line">print(list_4)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/2.png" alt="img"></p><p>​</p></li></ol><h3 id="字符串-转换为-元组"><a href="#字符串-转换为-元组" class="headerlink" title="字符串 转换为 元组"></a>字符串 转换为 元组</h3><p>使用tuple()方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">str_1 = <span class="string">"1235"</span></span><br><span class="line">str_2 = <span class="string">'zhangsan'</span></span><br><span class="line">str_3 = <span class="string">'''lisi'''</span></span><br><span class="line">list_1 = tuple(str_1)</span><br><span class="line">list_2 = tuple(str_2)</span><br><span class="line">list_3 = tuple(str_3)</span><br><span class="line">print(type(list_1))</span><br><span class="line">print(type(list_2))</span><br><span class="line">print(type(list_3))</span><br><span class="line">print(list_1)</span><br><span class="line">print(list_2)</span><br><span class="line">print(list_3)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/3.png" alt="img"></p><h3 id="字符串-转换为-字典"><a href="#字符串-转换为-字典" class="headerlink" title="字符串 转换为 字典"></a>字符串 转换为 字典</h3><p><strong>利用eval()方法，可以将字典格式的字符串转换为字典</strong></p><blockquote><p>eval() 函数用来执行一个字符串表达式，并返回表达式的值。<br>语法：eval(expression[, globals[, locals]])<br>①expression – 表达式。<br>②globals – 变量作用域，全局命名空间，如果被提供，则必须是一个字典对象。③locals – 变量作用域，局部命名空间，如果被提供，可以是任何映射对象。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str_1 = <span class="string">"&#123;'name':'zhangsan','age':14,'gender':'girl'&#125;"</span></span><br><span class="line">dict_1 = eval(str_1)</span><br><span class="line">print(type(dict_1))</span><br><span class="line">print(dict_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/4.png" alt="img"></p><p><strong>利用json.loads()方法，可以将字典格式的字符串转换为字典</strong></p><blockquote><p>json.loads 用于解码 JSON 数据。该函数返回 Python 字段的数据类型。<br>语法：json.loads(s[, encoding[, cls[, object_hook[, parse_float[, parse_int[, parse_constant[, object_pairs_hook[, **kw]]]]]]]])</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">str_1 = <span class="string">'&#123;"name":"xiaoming","age":18&#125;'</span></span><br><span class="line">dict_1 = json.loads(str_1)</span><br><span class="line">print(type(dict_1))</span><br><span class="line">print(dict_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/5.png" alt="img"></p><h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><h3 id="列表转字符串"><a href="#列表转字符串" class="headerlink" title="列表转字符串"></a>列表转字符串</h3><p>利用‘’.join()将列表中的内容拼接程一个字符串</p><blockquote><p>Python join() 方法用于将序列中的元素（必须是str） 以指定的字符(‘’中指定的) 连接生成一个新的字符串。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list_1 = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line">str_1 = <span class="string">''</span>.join(list_1)</span><br><span class="line">print(type(str_1))</span><br><span class="line">print(str_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/6.png" alt="img"></p><h3 id="列表转字典"><a href="#列表转字典" class="headerlink" title="列表转字典"></a>列表转字典</h3><p><strong>利用for in rang将两个列表转换为字典</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">list_1 = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line">list_2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">dict_1 = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(list_1)):</span><br><span class="line"> dict_1[list_1[i]] = list_2[i]</span><br><span class="line">print(type(dict_1))</span><br><span class="line">print(dict_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/7.png" alt="img"></p><p><strong>利用python内置方法dict()和zip()将两个列表转换为字典</strong></p><blockquote><p>dict() 函数用于创建一个字典。<br>语法：class dict(<strong>kwarg)<br>class dict(mapping, *<em>kwarg)<br>class dict(iterable, *</em>kwarg)①</strong>kwargs – 关键字<br>②mapping – 元素的容器。<br>③iterable – 可迭代对象。</p></blockquote><blockquote><p>zip() 函数用于将可迭代的对象作为参数，将对象中对应的元素打包成一个个元组，然后返回由这些元组组成的列表。<br>语法：zip([iterable, …])<br>iterabl – 一个或多个迭代器;</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">list_1 = [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line">list_2 = [<span class="string">'zhangsan'</span>,<span class="number">18</span>]</span><br><span class="line">dict_1 = dict(zip(list_1, list_2))</span><br><span class="line">print(type(dict_1))</span><br><span class="line">print(dict_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/8.png" alt="img"></p><h2 id="元组（tuple）"><a href="#元组（tuple）" class="headerlink" title="元组（tuple）"></a>元组（tuple）</h2><h3 id="元组转换为字符串"><a href="#元组转换为字符串" class="headerlink" title="元组转换为字符串"></a>元组转换为字符串</h3><ul><li>使用方法<code>__str__</code></li><li>返回一个对象的描述信息</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tuple_1 = (1, 2, 3)</span><br><span class="line">str_1 = tuple_1.__str__()</span><br><span class="line">print(type(str_1))</span><br><span class="line">print(str_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/9.png" alt="img"></p><h3 id="元组转换为列表"><a href="#元组转换为列表" class="headerlink" title="元组转换为列表"></a>元组转换为列表</h3><p>使用方法list()</p><blockquote><p>list() 方法用于将元组转换为列表。<br>语法：list( tup )<br>tup – 要转换为列表的元组。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tuple_1 = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">list_1 = list(tuple_1)</span><br><span class="line">print(type(list_1))</span><br><span class="line">print(list_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/10.png" alt="img"></p><h2 id="字典-dict"><a href="#字典-dict" class="headerlink" title="字典(dict)"></a>字典(dict)</h2><h3 id="字典转换为字符串"><a href="#字典转换为字符串" class="headerlink" title="字典转换为字符串"></a>字典转换为字符串</h3><p>使用 json.dumps()方法</p><blockquote><p>json.dumps 用于将 Python 对象编码成 JSON 字符串。<br>json.dumps(obj, skipkeys=False, ensure_ascii=True, check_circular=True, allow_nan=True, cls=None, indent=None, separators=None, encoding=“utf-8”, default=None, sort_keys=False, **kw)</p></blockquote><h3 id="字典转换为元组"><a href="#字典转换为元组" class="headerlink" title="字典转换为元组"></a>字典转换为元组</h3><ul><li>使用方法 tuple()</li><li>字典在转换为元组之后，只会保存关键字</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dict_1 = &#123;&quot;name&quot;:&quot;zhangsan&quot;,</span><br><span class="line">   &quot;age&quot;:18&#125;</span><br><span class="line">tuple_1 = tuple(dict_1)</span><br><span class="line">print(type(tuple_1))</span><br><span class="line">print(tuple_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/11.png" alt="img"></p><h3 id="字典转换为列表"><a href="#字典转换为列表" class="headerlink" title="字典转换为列表"></a>字典转换为列表</h3><ul><li>使用方法 list()</li><li>字典在转换为列表之后，只会保存关键字</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dict_1 = &#123;<span class="string">"name"</span>:<span class="string">"zhangsan"</span>,</span><br><span class="line">   <span class="string">"age"</span>:<span class="number">18</span>&#125;</span><br><span class="line">list_1 = list(dict_1)</span><br><span class="line">print(type(list_1))</span><br><span class="line">print(list_1)</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/python/12.png" alt="img"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;python字符串中包含大括号时怎么使用string的-format方法？&quot;&gt;&lt;a href=&quot;#python字符串中包含大括号时怎么使用string的-format方法？&quot; class=&quot;headerlink&quot; title=&quot;python字符串中包含大括号时怎么使用string的.format方法？&quot;&gt;&lt;/a&gt;python字符串中包含大括号时怎么使用string的.format方法？&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;hello &amp;#123;name&amp;#125;&#39;&lt;/span&gt;.format(name=&lt;span class=&quot;string&quot;&gt;&#39;world&#39;&lt;/span&gt;)的时候大括号是特殊转义字符，如果需要原始的大括号，用&amp;#123;&amp;#123;代替&amp;#123;, 用&amp;#125;&amp;#125;代替&amp;#125;， 如下:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt;&amp;gt;&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;hello &amp;#123;&amp;#123;worlds in braces!&amp;#125;&amp;#125;, &amp;#123;name&amp;#125;&#39;&lt;/span&gt;.format(name=&lt;span class=&quot;string&quot;&gt;&#39;zhangsan&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;hello &amp;#123;worlds in braces!&amp;#125;, zhangsan&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h1 id=&quot;python将一组数分成每3个一组的实例&quot;&gt;&lt;a href=&quot;#python将一组数分成每3个一组的实例&quot; class=&quot;headerlink&quot; title=&quot;python将一组数分成每3个一组的实例&quot;&gt;&lt;/a&gt;python将一组数分成每3个一组的实例&lt;/h1&gt;&lt;p&gt;如下所示&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;a = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;step = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;b = [a[i:i+step] &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; range(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,len(a),step)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;print(b)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;结果：&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;], [&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;], [&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;], [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;gt;&amp;gt;&amp;gt; &lt;/span&gt;b[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="python" scheme="https://gongzhao1.coding.me/categories/python/"/>
    
    
      <category term="python" scheme="https://gongzhao1.coding.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python模块之subprocess</title>
    <link href="https://gongzhao1.coding.me/python%E6%A8%A1%E5%9D%97%E4%B9%8Bsubprocess/"/>
    <id>https://gongzhao1.coding.me/python模块之subprocess/</id>
    <published>2020-03-15T03:04:49.000Z</published>
    <updated>2020-04-08T14:20:25.872Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>subprocess最早在2.4版本引入。用来生成子进程，并可以通过管道连接他们的输入/输出/错误，以及获得他们的返回值。</p><p>subprocess用来替换多个旧模块和函数：</p><ul><li>os.system</li><li>os.spawn*</li><li>os.popen*</li><li>popen2.*</li><li>commands.*</li></ul><p>运行python的时候，我们都是在创建并运行一个进程，linux中一个进程可以fork一个子进程，并让这个子进程exec另外一个程序。在python中，我们通过标准库中的subprocess包来fork一个子进程，并且运行一个外部的程序。subprocess包中定义有数个创建子进程的函数，这些函数分别以不同的方式创建子进程，所欲我们可以根据需要来从中选取一个使用。另外subprocess还提供了一些管理标准流(standard stream)和管道(pipe)的工具，从而在进程间使用文本通信。</p><a id="more"></a><h1 id="subprocess模块"><a href="#subprocess模块" class="headerlink" title="subprocess模块"></a>subprocess模块</h1><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td>subprocess.run()</td><td>Python 3.5中新增的函数。执行指定的命令，等待命令执行完成后返回一个包含执行结果的CompletedProcess类的实例。</td></tr><tr><td>subprocess.call()</td><td>执行指定的命令，返回命令执行状态，其功能类似于os.system(cmd)。</td></tr><tr><td>subprocess.check_call()</td><td>Python 2.5中新增的函数。 执行指定的命令，如果执行成功则返回状态码，否则抛出异常。其功能等价于subprocess.run(…, check=True)。</td></tr><tr><td>subprocess.check_output()</td><td>Python 2.7中新增的的函数。执行指定的命令，如果执行状态码为0则返回命令执行结果，否则抛出异常。</td></tr><tr><td>subprocess.getoutput(cmd)</td><td>接收字符串格式的命令，执行命令并返回执行结果，其功能类似于os.popen(cmd).read()和commands.getoutput(cmd)。</td></tr><tr><td>subprocess.getstatusoutput(cmd)</td><td>执行cmd命令，返回一个元组(命令执行状态, 命令执行结果输出)，其功能类似于commands.getstatusoutput()。</td></tr></tbody></table><blockquote><p><strong>说明：</strong></p><ol><li>在Python 3.5之后的版本中，官方文档中提倡通过subprocess.run()函数替代其他函数来使用subproccess模块的功能；</li><li>在Python 3.5之前的版本中，我们可以通过subprocess.call()，subprocess.getoutput()等上面列出的其他函数来使用subprocess模块的功能；</li><li>subprocess.run()、subprocess.call()、subprocess.check_call()和subprocess.check_output()都是通过对subprocess.Popen的封装来实现的高级函数，因此如果我们需要更复杂功能时，可以通过subprocess.Popen来完成。</li><li>subprocess.getoutput()和subprocess.getstatusoutput()函数是来自Python 2.x的commands模块的两个遗留函数。它们隐式的调用系统shell，并且不保证其他函数所具有的安全性和异常处理的一致性。另外，它们从Python 3.3.4开始才支持Windows平台。</li></ol></blockquote><h2 id="subprocess-run"><a href="#subprocess-run" class="headerlink" title="subprocess.run()"></a><strong>subprocess.run()</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import subprocess</span><br><span class="line"><span class="comment"># python 解析则传入命令的每个参数的列表</span></span><br><span class="line">&gt;&gt;&gt; subprocess.run([<span class="string">"df"</span>,<span class="string">"-h"</span>])</span><br><span class="line">Filesystem      Size Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/VolGroup-LogVol00</span><br><span class="line">           289G  70G 204G 26% /</span><br><span class="line">tmpfs         64G   0  64G  0% /dev/shm</span><br><span class="line">/dev/sda1       283M  27M 241M 11% /boot</span><br><span class="line">CompletedProcess(args=[<span class="string">'df'</span>, <span class="string">'-h'</span>], returncode=0)</span><br><span class="line"><span class="comment"># 需要交给Linux shell自己解析，则:传入命令字符串，shell=True</span></span><br><span class="line">&gt;&gt;&gt; subprocess.run(<span class="string">"df -h|grep /dev/sda1"</span>,shell=True)</span><br><span class="line">/dev/sda1       283M  27M 241M 11% /boot</span><br><span class="line">CompletedProcess(args=<span class="string">'df -h|grep /dev/sda1'</span>, returncode=0)</span><br></pre></td></tr></table></figure><h2 id="subprocess-call"><a href="#subprocess-call" class="headerlink" title="subprocess.call()"></a><strong>subprocess.call()</strong></h2><p>执行命令，返回命令的结果和执行状态，0或者非0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; res = subprocess.call([<span class="string">"ls"</span>,<span class="string">"-l"</span>])</span><br><span class="line">总用量 28</span><br><span class="line">-rw-r--r-- 1 root root   0 6月 16 10:28 1</span><br><span class="line">drwxr-xr-x 2 root root 4096 6月 22 17:48 _1748</span><br><span class="line">-rw-------. 1 root root 1264 4月 28 20:51 anaconda-ks.cfg</span><br><span class="line">drwxr-xr-x 2 root root 4096 5月 25 14:45 monitor</span><br><span class="line">-rw-r--r-- 1 root root 13160 5月  9 13:36 npm-debug.log</span><br><span class="line"><span class="comment"># 命令执行状态</span></span><br><span class="line">&gt;&gt;&gt; res</span><br><span class="line">0</span><br></pre></td></tr></table></figure><h2 id="subprocess-check-call"><a href="#subprocess-check-call" class="headerlink" title="subprocess.check_call()"></a><strong>subprocess.check_call()</strong></h2><p>执行命令，返回结果和状态，正常为0 ，执行错误则抛出异常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; subprocess.check_call([<span class="string">"ls"</span>,<span class="string">"-l"</span>])</span><br><span class="line">总用量 28</span><br><span class="line">-rw-r--r-- 1 root root   0 6月 16 10:28 1</span><br><span class="line">drwxr-xr-x 2 root root 4096 6月 22 17:48 _1748</span><br><span class="line">-rw-------. 1 root root 1264 4月 28 20:51 anaconda-ks.cfg</span><br><span class="line">drwxr-xr-x 2 root root 4096 5月 25 14:45 monitor</span><br><span class="line">-rw-r--r-- 1 root root 13160 5月  9 13:36 npm-debug.log</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; subprocess.check_call([<span class="string">"lm"</span>,<span class="string">"-l"</span>])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"/usr/lib64/python2.7/subprocess.py"</span>, line 537, <span class="keyword">in</span> check_call</span><br><span class="line">  retcode = call(*popenargs, **kwargs)</span><br><span class="line"> File <span class="string">"/usr/lib64/python2.7/subprocess.py"</span>, line 524, <span class="keyword">in</span> call</span><br><span class="line">  <span class="built_in">return</span> Popen(*popenargs, **kwargs).<span class="built_in">wait</span>()</span><br><span class="line"> File <span class="string">"/usr/lib64/python2.7/subprocess.py"</span>, line 711, <span class="keyword">in</span> __init__</span><br><span class="line">  errread, errwrite)</span><br><span class="line"> File <span class="string">"/usr/lib64/python2.7/subprocess.py"</span>, line 1327, <span class="keyword">in</span> _execute_child</span><br><span class="line">  raise child_exception</span><br><span class="line">OSError: [Errno 2] No such file or directory</span><br></pre></td></tr></table></figure><h2 id="subprocess-getoutput"><a href="#subprocess-getoutput" class="headerlink" title="subprocess.getoutput()"></a><strong>subprocess.getoutput()</strong></h2><p>接受字符串形式的命令，放回执行结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; subprocess.getoutput(<span class="string">'pwd'</span>)</span><br><span class="line"><span class="string">'/root'</span></span><br></pre></td></tr></table></figure><h2 id="subprocess-getstatusoutput"><a href="#subprocess-getstatusoutput" class="headerlink" title="subprocess.getstatusoutput()"></a><strong>subprocess.getstatusoutput()</strong></h2><p>接受字符串形式的命令，返回 一个元组形式的结果，第一个元素是命令执行状态，第二个为执行结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行正确</span></span><br><span class="line">&gt;&gt;&gt; subprocess.getstatusoutput(<span class="string">'pwd'</span>)</span><br><span class="line">(0, <span class="string">'/root'</span>)</span><br><span class="line"><span class="comment">#执行错误</span></span><br><span class="line">&gt;&gt;&gt; subprocess.getstatusoutput(<span class="string">'pd'</span>)</span><br><span class="line">(127, <span class="string">'/bin/sh: pd: command not found'</span>)</span><br></pre></td></tr></table></figure><h2 id="subprocess-check-output"><a href="#subprocess-check-output" class="headerlink" title="subprocess.check_output()"></a><strong>subprocess.check_output()</strong></h2><p>如果当返回值为0时，直接返回输出结果，如果返回值不为0，直接抛出异常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; res = subprocess.check_output(<span class="string">"pwd"</span>)</span><br><span class="line">&gt;&gt;&gt; res</span><br><span class="line">b<span class="string">'/root\n'</span> <span class="comment"># 结果以字节形式返回</span></span><br></pre></td></tr></table></figure><h2 id="subprocess-Popen"><a href="#subprocess-Popen" class="headerlink" title="subprocess.Popen()"></a><strong>subprocess.Popen()</strong></h2><p>其实以上subprocess使用的方法，都是对subprocess.Popen的封装，下面我们就来看看这个Popen方法。</p><h3 id="subprocess-Popen的构造函数"><a href="#subprocess-Popen的构造函数" class="headerlink" title="subprocess.Popen的构造函数"></a>subprocess.Popen的构造函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">subprocess</span>.<span class="title">Popen</span><span class="params">(args, bufsize=<span class="number">-1</span>, executable=None, stdin=None, stdout=None, stderr=None, </span></span></span><br><span class="line"><span class="class"><span class="params">    preexec_fn=None, close_fds=True, shell=False, cwd=None, env=None, universal_newlines=False,</span></span></span><br><span class="line"><span class="class"><span class="params">    startup_info=None, creationflags=<span class="number">0</span>, restore_signals=True, start_new_session=False, pass_fds=<span class="params">()</span>)</span></span></span><br></pre></td></tr></table></figure><blockquote><p>参数说明：</p><ul><li><strong>args：</strong> 要执行的shell命令，可以是字符串，也可以是命令各个参数组成的序列。当该参数的值是一个字符串时，该命令的解释过程是与平台相关的，因此通常建议将args参数作为一个序列传递。</li><li><strong>bufsize：</strong> 指定缓存策略，0表示不缓冲，1表示行缓冲，其他大于1的数字表示缓冲区大小，负数 表示使用系统默认缓冲策略。</li><li><strong>stdin, stdout, stderr：</strong> 分别表示程序标准输入、输出、错误句柄。</li><li><strong>preexec_fn：</strong> 用于指定一个将在子进程运行之前被调用的可执行对象，只在Unix平台下有效。</li><li><strong>close_fds：</strong> 如果该参数的值为True，则除了0,1和2之外的所有文件描述符都将会在子进程执行之前被关闭。</li><li><strong>shell：</strong> 该参数用于标识是否使用shell作为要执行的程序，如果shell值为True，则建议将args参数作为一个字符串传递而不要作为一个序列传递。</li><li><strong>cwd：</strong> 如果该参数值不是None，则该函数将会在执行这个子进程之前改变当前工作目录。</li><li><strong>env：</strong> 用于指定子进程的环境变量，如果env=None，那么子进程的环境变量将从父进程中继承。如果env!=None，它的值必须是一个映射对象。</li><li><strong>universal_newlines：</strong> 如果该参数值为True，则该文件对象的stdin，stdout和stderr将会作为文本流被打开，否则他们将会被作为二进制流被打开。</li><li><strong>startupinfo和creationflags：</strong> 这两个参数只在Windows下有效，它们将被传递给底层的CreateProcess()函数，用于设置子进程的一些属性，如主窗口的外观，进程优先级等。</li></ul></blockquote><h3 id="stdout"><a href="#stdout" class="headerlink" title="stdout"></a>stdout</h3><p>标准输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; res = subprocess.Popen(<span class="string">"ls /tmp/yum.log"</span>, shell=True, stdout=subprocess.PIPE) <span class="comment"># 使用管道</span></span><br><span class="line">&gt;&gt;&gt; res.stdout.read()  <span class="comment"># 标准输出</span></span><br><span class="line">b<span class="string">'/tmp/yum.log\n'</span></span><br><span class="line">res.stdout.close()  <span class="comment"># 关闭</span></span><br></pre></td></tr></table></figure><h3 id="stderr"><a href="#stderr" class="headerlink" title="stderr"></a>stderr</h3><p>标准错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import subprocess</span><br><span class="line">&gt;&gt;&gt; res = subprocess.Popen(<span class="string">"lm -l"</span>,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</span><br><span class="line"><span class="comment"># 标准输出为空</span></span><br><span class="line">&gt;&gt;&gt; res.stdout.read()</span><br><span class="line">b<span class="string">''</span></span><br><span class="line"><span class="comment">#标准错误中有错误信息</span></span><br><span class="line">&gt;&gt;&gt; res.stderr.read()</span><br><span class="line">b<span class="string">'/bin/sh: lm: command not found\n'</span></span><br></pre></td></tr></table></figure><h3 id="poll"><a href="#poll" class="headerlink" title="poll()"></a>poll()</h3><p>定时检查命令有没有执行完毕，执行完毕后返回执行结果的状态，没有执行完毕返回None</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; res = subprocess.Popen(<span class="string">"sleep 10;echo 'hello'"</span>,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(res.poll())</span><br><span class="line">None</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(res.poll())</span><br><span class="line">None</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(res.poll())</span><br><span class="line">0</span><br></pre></td></tr></table></figure><h3 id="wait"><a href="#wait" class="headerlink" title="wait()"></a>wait()</h3><p>等待命令执行完成，并且返回结果状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; obj = subprocess.Popen(<span class="string">"sleep 10;echo 'hello'"</span>,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</span><br><span class="line">&gt;&gt;&gt; obj.wait()</span><br><span class="line"><span class="comment"># 中间会一直等待</span></span><br><span class="line">0</span><br></pre></td></tr></table></figure><h3 id="terminate"><a href="#terminate" class="headerlink" title="terminate()"></a>terminate()</h3><p>结束进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">&gt;&gt;&gt; res = subprocess.Popen(<span class="string">"sleep 20;echo 'hello'"</span>,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</span><br><span class="line">&gt;&gt;&gt; res.terminate() <span class="comment"># 结束进程</span></span><br><span class="line">&gt;&gt;&gt; res.stdout.read()</span><br><span class="line">b<span class="string">''</span></span><br></pre></td></tr></table></figure><h3 id="pid"><a href="#pid" class="headerlink" title="pid"></a>pid</h3><p>获取当前执行子shell的程序的进程号</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">&gt;&gt;&gt; res = subprocess.Popen(<span class="string">"sleep 5;echo 'hello'"</span>,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE)</span><br><span class="line">&gt;&gt;&gt; res.pid <span class="comment"># 获取这个linux shell 的 进程号</span></span><br><span class="line">2778</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;subprocess最早在2.4版本引入。用来生成子进程，并可以通过管道连接他们的输入/输出/错误，以及获得他们的返回值。&lt;/p&gt;
&lt;p&gt;subprocess用来替换多个旧模块和函数：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;os.system&lt;/li&gt;
&lt;li&gt;os.spawn*&lt;/li&gt;
&lt;li&gt;os.popen*&lt;/li&gt;
&lt;li&gt;popen2.*&lt;/li&gt;
&lt;li&gt;commands.*&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;运行python的时候，我们都是在创建并运行一个进程，linux中一个进程可以fork一个子进程，并让这个子进程exec另外一个程序。在python中，我们通过标准库中的subprocess包来fork一个子进程，并且运行一个外部的程序。subprocess包中定义有数个创建子进程的函数，这些函数分别以不同的方式创建子进程，所欲我们可以根据需要来从中选取一个使用。另外subprocess还提供了一些管理标准流(standard stream)和管道(pipe)的工具，从而在进程间使用文本通信。&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://gongzhao1.coding.me/categories/python/"/>
    
    
      <category term="python" scheme="https://gongzhao1.coding.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>shadowsocks服务端搭建</title>
    <link href="https://gongzhao1.coding.me/shadowsocks%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%90%AD%E5%BB%BA/"/>
    <id>https://gongzhao1.coding.me/shadowsocks服务端搭建/</id>
    <published>2020-03-05T03:56:55.000Z</published>
    <updated>2020-04-08T14:20:25.873Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install python-setuptools &amp;&amp; easy_install pip </span><br><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /etc/shadowsocks</span><br><span class="line">sudo vi /etc/shadowsocks/shadowsocks.json</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;server_port&quot;: 8838,</span><br><span class="line">    &quot;method&quot;: &quot;rc4-md5&quot;,</span><br><span class="line">    &quot;password&quot;: &quot;abcd1234&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssserver -c /etc/shadowsocks/shadowsocks.json -d start</span><br></pre></td></tr></table></figure><h1 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssserver -c /etc/shadowsocks/shadowsocks.json -d stop</span><br></pre></td></tr></table></figure><h1 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h1><p>服务器的TCP端口8838要放行</p><h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="最大连接数"><a href="#最大连接数" class="headerlink" title="最大连接数"></a>最大连接数</h2><p>提高最大连接数,添加如下参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">* soft nofile 51200</span><br><span class="line">* hard nofile 51200</span><br></pre></td></tr></table></figure><h2 id="内核参数"><a href="#内核参数" class="headerlink" title="内核参数"></a>内核参数</h2><p>调整内核参数的目标是：</p><p>1.尽可能重用连接和端口号</p><p>2.尽可能增大队列和缓冲区</p><p>3.为高延迟和高流量选择合适的TCP拥塞算法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">fs.file-max = 51200</span><br><span class="line">net.core.rmem_max = 67108864</span><br><span class="line">net.core.wmem_max = 67108864</span><br><span class="line">net.core.netdev_max_backlog = 250000</span><br><span class="line">net.core.somaxconn = 4096</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_fastopen = 3</span><br><span class="line">net.ipv4.tcp_mem = 25600 51200 102400</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_congestion_control = hybla</span><br></pre></td></tr></table></figure><p>使生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install python-setuptools &amp;amp;&amp;amp; easy_install pip &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pip install shadowsocks&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="科学上网" scheme="https://gongzhao1.coding.me/categories/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"/>
    
    
      <category term="shadowsocks" scheme="https://gongzhao1.coding.me/tags/shadowsocks/"/>
    
  </entry>
  
  <entry>
    <title>基金经理之陈洲</title>
    <link href="https://gongzhao1.coding.me/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86%E4%B9%8B%E9%99%88%E6%B4%B2/"/>
    <id>https://gongzhao1.coding.me/基金经理之陈洲/</id>
    <published>2020-03-02T13:32:11.000Z</published>
    <updated>2020-04-08T14:20:25.883Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://mp.weixin.qq.com/s/aqRaTx2FF-AzTH22UcaHyg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/aqRaTx2FF-AzTH22UcaHyg</a></p><p>资产管理行业，是一个责任、经验和知识并重的行业。那些常年默默无闻，努力为投资者获取长期稳健收益的基金经理，会受到投资者的认可和尊重。在我的印象中，在2016年年底就有上海的持有人自发众筹请基金经理吃饭的事儿，在资管界传为美谈。这位基金经理，就是国泰基金的程洲。他管理的国泰聚信价值优势在牛市中能涨、股灾中抗跌，从基金成立日起持有五年平均收益翻倍，让部分持有人收获了满满的幸福感。</p><a id="more"></a><h1 id="公募老将"><a href="#公募老将" class="headerlink" title="公募老将"></a>公募老将</h1><p>程洲自2000年就进入证券行业，从业经历长达19年。他在2004年加盟国泰基金，2008年开始担任基金经理，担任过11年的基金经理，是一位十足的公募老将。其管理的国泰聚信价值优势获得了2016年的金牛奖和三年持续回报明星基金奖，程洲本人也获得过3年期英华奖。</p><p>程洲管理过对“长期稳健收益”要求极高的社保基金。多年的投资实践中，他逐渐形成了对风险控制高度重视的“稳健收益”投资理念，为获取长期优秀的业绩奠定了基础。</p><h1 id="过往业绩优秀"><a href="#过往业绩优秀" class="headerlink" title="过往业绩优秀"></a>过往业绩优秀</h1><p>目前程洲管理的基金资产约48亿，并且产品类型多样，有开放式也有定开式，有混合型也有股票型，有灵活配置型也有行业主题型，还管理社保基金，是一位资产管理的多面手。</p><p>我们从中选取两个代表性的产品进行重点分析，一个是灵活配置型的国泰聚信价值（000362）；另一个是行业主题基金国泰大农业（001579）。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/8.png" alt="img"></p><p>国泰聚信价值成立于2013年12月，是灵活配置型基金（股票投资比例范围30%-95%）。程洲自基金成立任职至今（10月23日），任期已接近6年，任职回报157%，同类排名TOP5%(WIND，90/1939，一级分类，截止2019-10-23）。</p><p>国泰大农业成立于2017年6月，是行业主题型基金（股票投资比例不低于80%），规模2.4亿。程洲也是自基金成立开始任职至今，任期2.4年，任职回报55%，同类排名TOP2%（WIND，83/6023，一级分类，截止2019-10-23）。</p><p>这两只基金虽然投资范围、类型不一样，但业绩在同类中排名都非常靠前。可见程洲的投资管理能力比较全面，没有明显的短板，能驾驭各种类型的产品，应对各种市场行情。</p><h1 id="风险控制"><a href="#风险控制" class="headerlink" title="风险控制"></a>风险控制</h1><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/9.png" alt="img"></p><p>程洲在管理国泰聚信价值期间，任职回报相对于同期沪深300指数的超额收益达到94%。该基金年化收益率高达20%，远高于沪深300指数的9%。尤其是年化波动率和区间最大回撤也远低于沪深300指数，这一点难能可贵。凭借优异的业绩，该基金在2016年度获得一年期开放式混合型金牛基金、三年持续回报平衡混合型明星基金奖。</p><p>在管理国泰大农业期间，任职回报相对于中证大农业指数的超额收益达到41%。该基金的年化收益率高达22%，远高于中证大农业指数的6%。年化波动率和区间最大回撤也低于中证大农业指数。</p><p>从上述数据分析，程洲的投资风格是追求稳健收益，最大程度的控制回撤，减小净值波动。他管理的基金获取超额收益的能力较强，回撤控制的较好，风险收益比较高。</p><h1 id="上马击狂胡：自上而下能择时"><a href="#上马击狂胡：自上而下能择时" class="headerlink" title="上马击狂胡：自上而下能择时"></a>上马击狂胡：自上而下能择时</h1><p>程洲的投资框架可以概括为“取势、明道、优术”。取势，就是判断影响市场的主流发展趋势，进行大类资产配置，追求稳健组合回报。明道，就是善于极端行情下择时，在泡沫严重时及时离场。优术，即坚持简单可靠的基本面投资，选出优质的投资标的。</p><p>程洲具有宏观策略研究经验，具备自上而下的判断能力，在“取势”、“明道”方面相具有独特的优势。他是业内为数不多的具备择时能力、并成功进行择时操作的基金经理。在十多年的牛熊轮回中，择时次数不多，但是往往都在关键点上，有效控制了净值的波动和回撤。</p><p>以仓位灵活的国泰聚信价值为例，2015年上半年在牛市最疯狂的时候，程洲未雨绸缪，大幅将股票仓位从一季度末的87%降至三季度末的35%，并在2016年保持较低的仓位，不仅成功守住了2014-2015年那场牛市中的收益，还降低了2016年初“熔断”期间的损失。</p><p>2018年年初，白马股慢牛行情的末期，程洲也表现出敏锐的嗅觉，将国泰聚信价值的股票仓位从一季度末的91%大幅降至二季度末的59%。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/10.webp" alt="img"></p><p>程洲的择时周期相对较长，更多的是在极端情况下的择时操作，是一种资产泡沫严重时的避险行为。也从侧面反映出程洲的理性和冷静，以及对市场的敬畏。</p><h1 id="下马草军书：自下而上能择股"><a href="#下马草军书：自下而上能择股" class="headerlink" title="下马草军书：自下而上能择股"></a>下马草军书：自下而上能择股</h1><p>经过长期的投资实践，程洲选股的思路也很明确，即三大标准：行业龙头、现金流好、估值低。</p><p>行业龙头公司在各自的领域内有较强的护城河和竞争优势，具备稳定的发展前景。程洲也非常关注小行业中的龙头股，虽然市值小，但是在细分领域内具有很强的话语权，即“小行业中的大公司”。</p><p>现金流好（持续为正），是为了确保企业经营业绩的真实和可靠，一方面寻找出内生增长能力强的优质企业。另一方面，可以过滤掉一些财务问题比较多的公司，比如因缺钱大量融资，负债率很高，一旦遇到危机，容易出大问题。</p><p>而估值低则提供了安全边际，如果出现个股价格明显低于内在价值的情况，经过研究后认为机会不错，就买入并长期持有。一方面以较低的持有成本享受获取企业盈利增长的收益，另一方面还有机会获得估值回归的收益。</p><p>整体来看，程洲的持仓行业较为分散，持股集中度中等，以价值投资风格为主，持仓比较稳定。在市场风格变化较大时，他也会在一定程度上适应市场的风格。这样，他在获得长期稳定业绩的同时，又不失收益弹性。</p><p>程洲投资思路非常清晰、稳定，不追逐热点行业板块，不参与机构抱团。比如2015年上半年计算机、传媒被热捧，2017年以来大消费被机构抱团，国泰聚信价值并没有刻意去配置，依然按照一贯的投资思路管理。</p><p>程洲的持股周期有长有短，有格力电器、中国平安等持股周期3年以上的，也有的持有短于一年。在长期持有（1年以上）的个股中，多数都取得了超额收益。</p><h1 id="追求稳健收益，历史波动低、回撤小，基民可当“甩手掌柜”"><a href="#追求稳健收益，历史波动低、回撤小，基民可当“甩手掌柜”" class="headerlink" title="追求稳健收益，历史波动低、回撤小，基民可当“甩手掌柜”"></a>追求稳健收益，历史波动低、回撤小，基民可当“甩手掌柜”</h1><p>对大多数投资者而言，对波动和风险都比较厌恶。大家所期望的，就是能够找到一位值得托付的基金经理，以高度的责任心和专业的管理能力，为自己的资产保驾护航。自己能安心做一个“甩手掌柜”，这也是基民最大的幸福。而程洲正是这样一位不可多得的基金经理。</p><p>岁月就是一把筛子，将程洲这样优秀的基金经理筛了出来。有如一坛老酒，愈久弥香。</p><p>程洲历经多轮牛熊，对市场充满敬畏之心，以追求稳健收益为目标，控制回撤能力强，在收益指标、风险指标上均位居同类基金前列。历史上他管理的基金常常能先于大盘创新高，使买入并持有的投资者能够收获“时间的玫瑰”。赚到了真金白银，这或许也是持有人众筹请他吃饭的主要原因吧。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/11.png" alt="img"></p><h1 id="新基金"><a href="#新基金" class="headerlink" title="新基金"></a>新基金</h1><p>国泰鑫睿混合（007835），这是程洲的新近发的一只基金。在整体的产品设计上和国泰聚信价值比较相似，为混合型产品。股票投资比例范围是35%-80%，有利于程洲延续一贯灵活配置的投资风格，发挥多行业（偏向特色原料药、新材料和自主可控行业）配置、极端情况下择时、严控回撤等优势。国泰鑫睿混合也将稳健管理，力争为持有人贡献稳定的回报。</p><p>在以前的文章中，我多次给大家分析过，成立于3000点附近的主动偏股基金，在长期往往有不俗的业绩。此时发新基金，对于把握低位建仓的十分有利。并且随着A股市场日益成熟，慢牛行情可期，目前就是不错的配置时点。</p><p>国泰鑫睿混合已于2019年10月21日开始发行，认购期11月8日结束，各银行、券商、第三方销售机构均有销售。期望获得长期稳健收益的投资者可以考虑参与，将资产托付给程洲这样的基金经理，从此做一个幸福的基民。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/aqRaTx2FF-AzTH22UcaHyg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/aqRaTx2FF-AzTH22UcaHyg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;资产管理行业，是一个责任、经验和知识并重的行业。那些常年默默无闻，努力为投资者获取长期稳健收益的基金经理，会受到投资者的认可和尊重。在我的印象中，在2016年年底就有上海的持有人自发众筹请基金经理吃饭的事儿，在资管界传为美谈。这位基金经理，就是国泰基金的程洲。他管理的国泰聚信价值优势在牛市中能涨、股灾中抗跌，从基金成立日起持有五年平均收益翻倍，让部分持有人收获了满满的幸福感。&lt;/p&gt;
    
    </summary>
    
      <category term="基金经理" scheme="https://gongzhao1.coding.me/categories/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    
    
      <category term="基金" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91/"/>
    
      <category term="基金经理" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>基金经理之董承非</title>
    <link href="https://gongzhao1.coding.me/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86%E4%B9%8B%E8%91%A3%E6%89%BF%E9%9D%9E/"/>
    <id>https://gongzhao1.coding.me/基金经理之董承非/</id>
    <published>2020-03-02T13:13:10.000Z</published>
    <updated>2020-04-08T14:20:25.883Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://mp.weixin.qq.com/s?__biz=MzA5MDQxODY5MQ==&amp;mid=2247487742&amp;idx=1&amp;sn=feb16135c29e9e96889f7de394c696f6&amp;source=41#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzA5MDQxODY5MQ==&amp;mid=2247487742&amp;idx=1&amp;sn=feb16135c29e9e96889f7de394c696f6&amp;source=41#wechat_redirect</a></p><p>兴全新视野是一只定期开放式的偏股混合型基金，成立于2015年7月1日，成立至今（2019年10月24日），基金收益率41.16%。而同期上证指数由4053点下跌到2940点，跌幅27.46%，基金收益率大幅战胜上证指数68.62%。</p><p>而现在，从2019年10月25日-31日，新视野再次开放了！那么这只基金值得买吗？分析后的结论或许会让你大吃一惊。</p><a id="more"></a><h1 id="优秀的基金"><a href="#优秀的基金" class="headerlink" title="优秀的基金"></a>优秀的基金</h1><p><strong>战胜指数</strong></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/1.png" alt="image"></p><p>上图为今年以来兴全新视野与上证指数的走势对比图，可以很明显的看出：</p><p><strong>在上涨行情中，基金涨幅跟得上</strong></p><p><strong>在下跌行情中，基金下跌明显较慢</strong></p><p><strong>近几个月震荡行情中，显著超越上证指数</strong></p><hr><p><strong>任意一次开放时买入持有至今，都是盈利的</strong></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/2.png" alt="img"></p><p>昨天（2019年10月24日）的净值为1.4116元，是成立以来所有开放期的最高净值，这代表<strong>所有购买该基金的投资者，都是赚钱的</strong>！</p><hr><p><strong>十年老将，明星基金经理董承非</strong></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/3.png" alt="img"></p><p>董承非管理时间较长的基金共有3只，其中兴全趋势和兴全全球视野在他任职期间的复合收益率都达到了18%。</p><p>兴全新视野因为成立的点位较高，年化收益只有8.31%，但考虑同期指数表现，还是十分牛逼。</p><hr><p><strong>非常有实力的基金公司</strong></p><p>兴全基金旗下所有基金，在业内排名均十分靠前，优秀是其一贯的传统。</p><p>众所周知，我一直是兴全基金的铁杆粉丝，多次推荐兴全基金公司<a href="http://mp.weixin.qq.com/s?__biz=MzU4Mzg0NDIyMA==&mid=2247485415&idx=1&sn=9c10a201d32acff9f14c0b5fc07921e9&chksm=fda3aff4cad426e22554c0266c540191cab58b043b2a76070ebbe6aed96dca57b048731e4e06&scene=21#wechat_redirect" target="_blank" rel="noopener">《你应该知道的一家基金公司</a>》。</p><p>并且我也是董承非的铁杆粉丝，我自己定投的主动型基金中，就有董承非管理的基金。</p><p><strong>那么，兴全新视野开放了，是不是可以买入呢？</strong></p><h1 id="公募外衣的私募产品设计"><a href="#公募外衣的私募产品设计" class="headerlink" title="公募外衣的私募产品设计"></a>公募外衣的私募产品设计</h1><p>下面我来分析一下兴全新视野这个基金。新视野是公募基金，但是从产品设计结构上讲，更像是私募。主要体现在3个地方：</p><ol><li><p>封闭期</p></li><li><p>股票仓位占比</p></li><li><p>业绩报酬</p></li></ol><h2 id="封闭期"><a href="#封闭期" class="headerlink" title="封闭期"></a>封闭期</h2><p>兴全趋势是普通的开放式基金，随时可以进行申购赎回。而兴全新视野是定期开放型，每3个月才开放一次。</p><p>从好的方面看，有的人心态不好，容易受短期行情的影响而随意赎回基金，有封闭期可以限制短期冲动产生的赎回欲望。更容易坚持长期持有，才能真的赚到钱。</p><p>从坏的方面说，基金有封闭期，定期开放申购赎回，对投资者的便利性会有一定影响。</p><p>我认为<strong>3个月封闭期应该是中性的，有好有坏</strong></p><h2 id="股票仓位"><a href="#股票仓位" class="headerlink" title="股票仓位"></a>股票仓位</h2><p>传统的偏股混合型基金，都有股票的最低仓位限制，比如兴全趋势最低股票持仓比例为30%。这代表即使是牛市最高点，也必须<strong>最少持有30%</strong>的股票持仓。</p><p>而兴全新视野的股票仓位为<strong>0-95%</strong>。如果基金经理认为市场行情不好，完全<strong>可以将基金仓位降低到0%</strong>，股市再怎么跌也没关系。因为兴全新视野成立于2015年7月1日，处于市场高位。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/4.png" alt="img"></p><p>在基金成立初期，兴全新视野因为<strong>0仓位优势</strong>，基本上<strong>完全不受市场下跌</strong>的影响。净值走势十分稳健。</p><p>但是随着产品的运行，且目前处于估值低位，0仓位的意义较小</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/5.png" alt="img"></p><p>上图为兴全趋势与兴全新视野的仓位对比，可以看出，<strong>两只基金的仓位目前基本贴合到一起</strong>。</p><p>从业绩表现上看：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/6.png" alt="img"></p><p>上图为2017年至今，兴全趋势与兴全新视野业绩对比。看图可以发现2017年以来，兴全趋势与新视野<strong>走势高度重合</strong>。并且兴全趋势还略高于兴全新视野</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/fund-manager/7.png" alt="img"></p><p>上图是兴全新视野与兴全趋势在2019年的业绩表现对比。延续了以前的趋势，两个基金的业绩走势图，<strong>基本完全重合</strong>。</p><p><strong>从基金仓位和业绩表现上：兴全趋势与兴全新视野</strong>的仓位基本接近一致，且两只基金的业绩差别并不大。</p><h2 id="业绩报酬"><a href="#业绩报酬" class="headerlink" title="业绩报酬"></a>业绩报酬</h2><p>兴全新视野最大的特点是也像私募一样会计提业绩报酬。</p><p>业绩报酬计提规则也很简单：<strong>单个封闭期收益超过1.5%且净值要创新高</strong>（高于过往开放时的最高累计净值），收益超过1.5%的部分，基金公司分成20%。</p><p><strong>计提过程举个例子：</strong></p><p>如果某人于2019年7月25日买入10000份兴全新视野，净值1.304元，总资产13040元。</p><p>1.5%的收益为195.6元</p><p>假设本次开放时净值为1.343元，<strong>10000份</strong>，总资产为13430元。</p><p>盈利为390元，超出部分为194.4元。需要计提业绩报酬 = 194.4 * 0.2 = 38.88元。</p><p>基金公司将对该投资收取38.88元的业绩分成，<strong>收取的方式为扣减份额</strong>。</p><p>38.88元相当于28.95份。</p><p>在计提完业绩报酬后，实际持有的<strong>份额为9971.05份</strong>，净值1.343元，总资产13391.12元。</p><p>虽然从基金收益上看，兴全趋势和兴全新视野的业绩表现差不多，但考虑业绩报酬后，<strong>兴全新视野的实际收益大幅下降</strong>。</p><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><ol><li><p>毫无疑问，董承非是长期业绩十分优秀的牛基基金经理。</p></li><li><p>其旗下管理的两只基金兴全趋势与兴全新视野业绩都很好</p></li><li><p>从业绩上看，两者近几年表现相当</p></li><li><p>兴全新视野的3个月封闭期，我认为有利有弊</p></li><li><p>从费用上说，20%的业绩报酬，将会较大影响投资者的实际收益水平。</p></li><li><p><strong>如果看好董承非，我更推荐购买兴全趋势</strong>。</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzA5MDQxODY5MQ==&amp;amp;mid=2247487742&amp;amp;idx=1&amp;amp;sn=feb16135c29e9e96889f7de394c696f6&amp;amp;source=41#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s?__biz=MzA5MDQxODY5MQ==&amp;amp;mid=2247487742&amp;amp;idx=1&amp;amp;sn=feb16135c29e9e96889f7de394c696f6&amp;amp;source=41#wechat_redirect&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;兴全新视野是一只定期开放式的偏股混合型基金，成立于2015年7月1日，成立至今（2019年10月24日），基金收益率41.16%。而同期上证指数由4053点下跌到2940点，跌幅27.46%，基金收益率大幅战胜上证指数68.62%。&lt;/p&gt;
&lt;p&gt;而现在，从2019年10月25日-31日，新视野再次开放了！那么这只基金值得买吗？分析后的结论或许会让你大吃一惊。&lt;/p&gt;
    
    </summary>
    
      <category term="基金经理" scheme="https://gongzhao1.coding.me/categories/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    
    
      <category term="基金" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91/"/>
    
      <category term="基金经理" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>基金之优秀的基金经理</title>
    <link href="https://gongzhao1.coding.me/%E5%9F%BA%E9%87%91%E4%B9%8B%E4%BC%98%E7%A7%80%E7%9A%84%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    <id>https://gongzhao1.coding.me/基金之优秀的基金经理/</id>
    <published>2020-03-01T04:12:29.000Z</published>
    <updated>2020-04-08T14:20:25.876Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="转载（二鸟说）"><a href="#转载（二鸟说）" class="headerlink" title="转载（二鸟说）"></a>转载（二鸟说）</h1><ul><li><a href="https://mp.weixin.qq.com/s/Fz6phgA53lrWeC4Cb7T9uw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Fz6phgA53lrWeC4Cb7T9uw</a></li><li><a href="https://mp.weixin.qq.com/s/npdQZWezBIvYoFdSM7KcGg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/npdQZWezBIvYoFdSM7KcGg</a></li></ul><h2 id="公募基金主动管理TOP50"><a href="#公募基金主动管理TOP50" class="headerlink" title="公募基金主动管理TOP50"></a>公募基金主动管理TOP50</h2><blockquote><p>需要说明一下，指数基金仅有体现主动管理能力的指数增强基金入选，被动管理的指数基金不在此之列。债券基金也是只有体现大类资产配置和权益管理能力的二级债基、绝对收益基金入选，纯债基金不在研究范围。</p></blockquote><p>权益类公募赚钱不少，但投资者体验较差，这已经是讨论了多年的话题。除了投资者追涨杀跌、高买低卖之外，基金的实际表现与投资者预期的差距也是不容忽视的原因。</p><p>很多投资者认为：主动型基金你既然提计了1.5%的管理费，那你就应该给我把活全干了。首先你要给我做大类资产配置，还要给我择股选券，然后还要给我择时。再说白一点，既要涨的快、赚钱多，又要波动低、回撤小。这就是很多基民的要求。</p><p>要求无可厚非，但现实与理想还是有较大差距的。基金经理是人不是神。大类资产配置、择股选券、择时这三大能力很少有人能通吃的。能做好一项，就是成功的基金经理了，能做好两项绝对是TOP级。基金经理都有自己的能力圈。你要求他的能力圈无限扩大，这是违背客观规律的。</p><p>对基金经理来说，承认自己的能力圈、恪守自己的能力圈，这也是对基民负责。投资者应该是要较为深刻的了解基金经理的投资体系和能力圈，进而选择适合自己的产品。</p><p>成功的基金经理，都有自己的风格，基本都能贴个标签。这个基金是什么特点、怎么使用，基民一目了然。标签实际上就是把晦涩难懂的投资术语通俗化的过程。</p><p>下面我把《<a href="http://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&mid=2247485713&idx=1&sn=47fd68182d73b98126ead3c492b9e338&chksm=eba7108fdcd0999913691a6a2cb155e66af88da7a155d855c103151f808cf7fd3cfe8f75a6e3&scene=21#wechat_redirect" target="_blank" rel="noopener">公募基金主动管理TOP50人名单，价值连城，拿走不谢</a>》里面列的主要基金经理，都贴一个标签，供大家参考。（名单有所调整和补充）</p><a id="more"></a><h2 id="易方达"><a href="#易方达" class="headerlink" title="易方达"></a>易方达</h2><ul><li><p>张坤（易方达中小盘110011）</p><p>价值投资、高ROE、白酒、长期持有、长线绩优</p></li><li><p>萧楠（易方达消费行业110022）</p><p>消费、白酒、择股、长期持有、长线绩优</p></li><li><p>张清华（易方达安心回报110027）</p><p>长期绩优债基、激进二级债基、转债、大类资产配置</p></li><li><p>胡剑（易方达稳健收益110008）</p><p>长期绩优债基、稳健二级债基、大类资产配置、控制回撤</p></li><li><p>陈皓</p></li></ul><h2 id="博时"><a href="#博时" class="headerlink" title="博时"></a>博时</h2><ul><li><p>王俊（博时主题行业160505）</p><p>十年十倍、价值投资、合理估值、控制回撤、稳健</p></li><li><p>过钧（博时信用债券050011）</p><p>长期绩优债基、激进二级债基、转债、大类资产配置</p></li></ul><h2 id="华夏"><a href="#华夏" class="headerlink" title="华夏"></a>华夏</h2><ul><li><p>蔡向阳（华夏回报002001）</p><p>十年十倍、到点分红、价值投资、稳健</p></li></ul><h2 id="广发"><a href="#广发" class="headerlink" title="广发"></a>广发</h2><ul><li><p>傅友兴（广发稳健增长270002）</p><p>股债均衡、大类资产配置、价值投资、控制回撤、长线绩优</p></li><li><p>谭昌杰（广发趋势优选000215）</p><p>绝对收益、大类资产配置、控制回撤、稳健</p></li></ul><h2 id="南方"><a href="#南方" class="headerlink" title="南方"></a>南方</h2><ul><li><p>史博（南方绩优成长202003）</p><p>二十年老将、副总、价值投资、稳健</p></li><li><p>骆帅（南方优选成长202023）</p><p>潜力新秀、价值投资、高ROE、稳健</p></li></ul><h2 id="工银瑞信"><a href="#工银瑞信" class="headerlink" title="工银瑞信"></a>工银瑞信</h2><ul><li><p>鄢耀/王君正（工银金融地产000251）</p><p>金融地产、稳健、长线绩优</p></li><li><p>袁芳（工银文体产业001714）</p><p>潜力新秀、择股、稳健、灵活</p></li><li><p>欧阳凯（工银双利485111）</p><p>长期绩优债基、稳健二级债基、大类资产配置、控制回撤</p></li></ul><h2 id="富国"><a href="#富国" class="headerlink" title="富国"></a>富国</h2><ul><li><p>朱少醒（富国天惠161006）</p><p>二十年老将、副总、十年十倍、成长股投资</p></li><li><p>李笑薇（富国沪深300增强100038）</p><p>副总、海龟、量化、指数增强</p></li><li><p>张峰（富国中国中小盘100061）</p><p>长期绩优QDII、港股及海外、择股</p></li></ul><h2 id="兴全"><a href="#兴全" class="headerlink" title="兴全"></a>兴全</h2><ul><li><p>董承非（兴全趋势163402）</p><p>二十年老将、副总、十年十倍、稳健、择股</p></li><li><p>谢治宇（兴全合润163406）</p><p>300亿操盘手、均衡配置、择股、稳健、长线绩优</p></li><li><p>乔迁（兴全商业模式163415）</p><p>潜力新秀、择股、稳健、灵活</p></li><li><p>申庆（兴全沪深300指数163407）</p><p>二十年老将、量化、指数增强</p></li></ul><h2 id="景顺长城"><a href="#景顺长城" class="headerlink" title="景顺长城"></a>景顺长城</h2><ul><li><p>刘彦春（景顺长城新兴成长260108）</p><p>十年十倍、价值投资、高ROE、择股、白酒、长期持有</p></li><li><p>黎海威（景顺长城量化新动力001974）</p><p>副总、海龟、量化、指数增强</p></li><li><p>余广（景顺长城核心竞争力260116）</p><p>价值投资、高ROE、择股、长期持有</p></li><li><p>鲍无可（景顺长城能源基建260112）</p><p>稳健、高股息、低估值、控制回撤</p></li></ul><h2 id="中欧"><a href="#中欧" class="headerlink" title="中欧"></a>中欧</h2><ul><li><p>曹名长（中欧潜力价值001810）</p><p>价值投资、高股息、低估值</p></li><li><p>周应波（中欧时代先锋001938）</p><p>成长股投资、择股、灵活、长线绩优</p></li><li><p>周蔚文（中欧新蓝筹166022）</p><p>二十年老将、副总、成长股投资、择股</p></li><li><p>葛兰（中欧医疗健康003095）</p><p>医药、潜力新秀、医药科班、择股</p></li></ul><h2 id="汇添富"><a href="#汇添富" class="headerlink" title="汇添富"></a>汇添富</h2><ul><li><p>劳杰男（汇添富价值精选519069）</p><p>价值投资、长期持有、择股、高ROE、稳健、长线绩优</p></li><li><p>雷鸣（汇添富蓝筹稳健519066）</p><p>价值投资、长期持有、择股、高ROE、稳健、灵活、长线绩优</p></li><li><p>王栩（汇添富优势精选519008）</p><p>十年十倍、成长股投资、择股</p></li><li><p>赵鹏飞（汇添富高端制造001725）</p><p>暂无</p></li><li><p>郑磊（汇添富创新医药混合006113）</p><p>医药、择股、医药科班、控制回撤</p></li></ul><h2 id="长安"><a href="#长安" class="headerlink" title="长安"></a>长安</h2><ul><li><p>林忠晶（长安鑫利001281）</p><p>林忠晶：价值投资、高ROE、择股、择时</p></li><li><p>杜振业（长安鑫益002146）</p><p>杜振业：绝对收益、潜力新秀、控制回撤</p></li></ul><h2 id="华安"><a href="#华安" class="headerlink" title="华安"></a>华安</h2><ul><li><p>杨明（华安策略优选040008）</p><p>杨明：价值投资、择股、大金融、长线绩优</p></li><li><p>苏圻涵(华安沪港深通精选001581）</p><p>苏圻涵：长线绩优QDII、港股及海外、择股</p></li><li><p>胡宜斌</p><p>胡宜斌：成长股投资、潜力新秀、择股、科技、5G</p></li></ul><h2 id="交银"><a href="#交银" class="headerlink" title="交银"></a>交银</h2><ul><li><p>王崇（交银新成长518736）</p><p>王崇：均衡配置、择股、稳健、长线绩优</p></li><li><p>何帅（交银优势行业519697）</p><p>何帅：成长股投资、择股、控制回撤、长线绩优</p></li><li><p>杨浩（交银新生活力519772）</p><p>杨浩：成长股投资、择股、TMT</p></li></ul><h2 id="嘉实"><a href="#嘉实" class="headerlink" title="嘉实"></a>嘉实</h2><ul><li><p>归凯（嘉实泰和000595）</p><p>归凯：十年十倍、GRAP、稳健、择股</p></li><li><p>谭丽（嘉实价值优势070019）</p><p>谭丽：价值投资、高股息、低估值、稳健</p></li><li><p>张金涛（嘉实沪港深精选001878）</p><p>暂无</p></li><li><p>洪流</p><p>洪流：二十年老将、GRAP（合理估值下的成长）、稳健、择股</p></li></ul><h2 id="华泰柏瑞"><a href="#华泰柏瑞" class="headerlink" title="华泰柏瑞"></a>华泰柏瑞</h2><ul><li><p>田汉卿（华泰柏瑞量化增强000172）</p><p>田汉卿：副总、海龟、量化、指数增强</p></li></ul><h2 id="东方红"><a href="#东方红" class="headerlink" title="东方红"></a>东方红</h2><ul><li><p>林鹏（东方红沪港深002803）</p><p>林鹏：二十年老将、副总、价值投资、择股、高ROE、长期持有、长线绩优</p></li></ul><h2 id="睿远"><a href="#睿远" class="headerlink" title="睿远"></a>睿远</h2><ul><li><p>傅鹏博（睿远成长价值007119）</p><p>傅鹏博：二十年老将、副总、十年十倍、成长股投资、择股、长线绩优</p></li></ul><h2 id="中庚"><a href="#中庚" class="headerlink" title="中庚"></a>中庚</h2><ul><li><p>丘栋荣（中庚价值领航006551）</p><p>丘栋荣：价值投资、PB-ROE、长线绩优</p></li></ul><h2 id="信达澳银1人："><a href="#信达澳银1人：" class="headerlink" title="信达澳银1人："></a>信达澳银1人：</h2><ul><li><p>冯明远（信达澳银新能源001410）</p><p>冯明远：潜力新秀、成长股投资、择股、科技、5G</p></li></ul><h2 id="国富"><a href="#国富" class="headerlink" title="国富"></a>国富</h2><ul><li><p>徐成（国富沪港深成长精选001605）</p><p>徐成：港股及海外、绩优沪港深、择股</p></li></ul><h2 id="海富通"><a href="#海富通" class="headerlink" title="海富通"></a>海富通</h2><ul><li><p>杜晓海（海富通阿尔法对冲519062）</p><p>杜晓海：对冲、绝对收益、控制回撤、稳健</p></li></ul><h2 id="泓德"><a href="#泓德" class="headerlink" title="泓德"></a>泓德</h2><ul><li><p>邬传雁（泓德远见回报001500）</p><p>邬传雁：副总、成长股投资、稳健、择股、长线绩优</p></li></ul><h2 id="鹏华"><a href="#鹏华" class="headerlink" title="鹏华"></a>鹏华</h2><ul><li>王宗合：价值投资、择股、高ROE、长期持有、白酒、长线绩优</li></ul><h2 id="前海开源"><a href="#前海开源" class="headerlink" title="前海开源"></a>前海开源</h2><ul><li>邱杰：择时、择股、大波段、长线绩优</li></ul><blockquote><p>大家可以看的出来，有4人入选的基金公司共五家：易方达、兴全、中欧、汇添富、景顺长城，这些都是比较注重主动权益产品的基金公司。</p><p>另外，东方红、睿远也都比较强调主动管理能力。东方红由于风格都差不多，只列了林鹏一人。睿远目前只有一只基金。</p></blockquote><h1 id="投资风格梳理"><a href="#投资风格梳理" class="headerlink" title="投资风格梳理"></a>投资风格梳理</h1><p>按照投资风格和基金的类别，再次梳理一遍：</p><p><strong>价值</strong>：张坤、王俊、蔡向阳、史博、骆帅、董承非、谢治宇、曹名长、刘彦春、余广、劳杰男、雷鸣、赵鹏飞、林忠晶、杨明、谭丽、林鹏、丘栋荣</p><p><strong>成长</strong>：袁芳、朱少醒、乔迁、周应波、周蔚文、王栩、王崇、何帅、杨浩、归凯、傅鹏博、冯明远、邬传雁</p><p><strong>量化及指数增强</strong>：李笑薇、黎海威、申庆、田汉卿</p><p><strong>股债平衡</strong>：傅友兴、鲍无可</p><p><strong>港股及海外</strong>：张峰、徐成、张金涛、苏圻涵</p><p><strong>行业主题</strong>：萧楠（消费）、葛兰（医药）、鄢耀/王君正（金融地产）</p><p><strong>激进二级债券</strong>：张清华、过钧</p><p><strong>稳健二级债券</strong>：胡剑、欧阳凯</p><p><strong>绝对收益</strong>：谭昌杰、杜振业</p><p><strong>对冲</strong>：杜晓海</p><blockquote><p>二鸟老师做组合的基金，基本来源于这50人名单。像价值五剑，有几个攻守均衡、风格稳重的老将坐镇，构成基本盘。在今年一季度行情好时，使用了像信达澳银新能源这样极富攻击性的基金去冲锋；去年行情不好时，使用了广发优企精选、富国沪港深行业精选这样比较注重控制回撤的基金去防守。在牛市走到中后期，市场喧嚣、牛熊难辨时，则可能会使用激进二级债基，让张清华、过钧这些擅长宏观研究的牛人来判断。</p><p>绝对收益目标组合，主要是使用的做绝对收益的谭昌杰、杜振业、做对冲的杜晓海以及稳健二级债基胡剑的基金。净值曲线稳步向上，接近于一条15度斜率的直线，不断创新高。</p></blockquote><p>在实战角度的话，我不怕你业绩不好，就怕你没风格。你一会价值，一会成长，来回变来变去的话，这样的基金我是没法使用的。在选基金的时候，像这样的标签如果找不出三个以上的话，就不能入选。</p><p>有特点和风格的基金，即使是业绩暂时落后，我也能理解。比如老曹的中欧恒利，今年被骂的很厉害。但我是不会去骂的。老曹的择股风格是低估值、高股息，比较注重安全性。这两年市场呈“强者恒强”特征，低估值高股息策略在今年是暂时失效的。你不要因为这两年业绩不佳而质疑他的能力，只能说他的风格暂时不适合当前行情。但后面会怎样，这个说不好。风格都是轮动的，没有永远涨的股，也没有永远跌的票。他坚持自己的投资体系，这没问题。相反，如果他把那些低估值的票割肉，去追茅台之类的话，这就是瞎搞了。</p><p>再比如像冯明远的信达澳银新能源，这是一个具有鲜明科技风格的成长型基金，但波动也较大，价值五剑曾使用过一段时间。虽然现在没使用了，但我从来没否定过这只基金。这个基金长期持有没问题，这个我知道。我自己个人账户的话，肯定是不会卖的。价值五剑是公众跟投账户，完全是两码事。把这个基金替换下来，主要是出于控制组合波动考虑的，后面也不排除会阶段性再使用。类似的基金还有胡宜斌的华安媒体互联网。</p><p>对于投资者来说，鲜明的标签也便于基民识别和使用。你认可价值投资长期持有，就去找东方红、睿远、兴全；相信GRAP，就去找嘉实洪流、归凯他们；低估值高股息策略是老曹、谭丽；看好科技板块，能承受一定的波动，就使用冯明远、胡宜斌的基金；要求绝对收益，去找谭昌杰、杜振业；要做择时，还只有前海开源王宏远他们有这个能力；医药的话，得找葛兰、郑磊这些医药科班出身的基金经理；搞消费、白酒，去找萧楠、王宗合。</p><p>主动型基金的风格飘移，这是投资者最头疼的问题。建议每一位基金经理都要承认自己的能力圈、恪守自己的能力圈，进而拓展自己的能力圈。主动基金的基金经理，最好每个人都要有个标签。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;转载（二鸟说）&quot;&gt;&lt;a href=&quot;#转载（二鸟说）&quot; class=&quot;headerlink&quot; title=&quot;转载（二鸟说）&quot;&gt;&lt;/a&gt;转载（二鸟说）&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/Fz6phgA53lrWeC4Cb7T9uw&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/Fz6phgA53lrWeC4Cb7T9uw&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/npdQZWezBIvYoFdSM7KcGg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/npdQZWezBIvYoFdSM7KcGg&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;公募基金主动管理TOP50&quot;&gt;&lt;a href=&quot;#公募基金主动管理TOP50&quot; class=&quot;headerlink&quot; title=&quot;公募基金主动管理TOP50&quot;&gt;&lt;/a&gt;公募基金主动管理TOP50&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;需要说明一下，指数基金仅有体现主动管理能力的指数增强基金入选，被动管理的指数基金不在此之列。债券基金也是只有体现大类资产配置和权益管理能力的二级债基、绝对收益基金入选，纯债基金不在研究范围。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;权益类公募赚钱不少，但投资者体验较差，这已经是讨论了多年的话题。除了投资者追涨杀跌、高买低卖之外，基金的实际表现与投资者预期的差距也是不容忽视的原因。&lt;/p&gt;
&lt;p&gt;很多投资者认为：主动型基金你既然提计了1.5%的管理费，那你就应该给我把活全干了。首先你要给我做大类资产配置，还要给我择股选券，然后还要给我择时。再说白一点，既要涨的快、赚钱多，又要波动低、回撤小。这就是很多基民的要求。&lt;/p&gt;
&lt;p&gt;要求无可厚非，但现实与理想还是有较大差距的。基金经理是人不是神。大类资产配置、择股选券、择时这三大能力很少有人能通吃的。能做好一项，就是成功的基金经理了，能做好两项绝对是TOP级。基金经理都有自己的能力圈。你要求他的能力圈无限扩大，这是违背客观规律的。&lt;/p&gt;
&lt;p&gt;对基金经理来说，承认自己的能力圈、恪守自己的能力圈，这也是对基民负责。投资者应该是要较为深刻的了解基金经理的投资体系和能力圈，进而选择适合自己的产品。&lt;/p&gt;
&lt;p&gt;成功的基金经理，都有自己的风格，基本都能贴个标签。这个基金是什么特点、怎么使用，基民一目了然。标签实际上就是把晦涩难懂的投资术语通俗化的过程。&lt;/p&gt;
&lt;p&gt;下面我把《&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485713&amp;idx=1&amp;sn=47fd68182d73b98126ead3c492b9e338&amp;chksm=eba7108fdcd0999913691a6a2cb155e66af88da7a155d855c103151f808cf7fd3cfe8f75a6e3&amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;公募基金主动管理TOP50人名单，价值连城，拿走不谢&lt;/a&gt;》里面列的主要基金经理，都贴一个标签，供大家参考。（名单有所调整和补充）&lt;/p&gt;
    
    </summary>
    
      <category term="基金经理" scheme="https://gongzhao1.coding.me/categories/%E5%9F%BA%E9%87%91%E7%BB%8F%E7%90%86/"/>
    
    
      <category term="基金" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91/"/>
    
  </entry>
  
  <entry>
    <title>基金之绝对收益基金</title>
    <link href="https://gongzhao1.coding.me/%E5%9F%BA%E9%87%91%E4%B9%8B%E7%BB%9D%E5%AF%B9%E6%94%B6%E7%9B%8A%E5%9F%BA%E9%87%91/"/>
    <id>https://gongzhao1.coding.me/基金之绝对收益基金/</id>
    <published>2020-02-27T16:10:58.000Z</published>
    <updated>2020-04-08T14:20:25.877Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="转载（二鸟说）"><a href="#转载（二鸟说）" class="headerlink" title="转载（二鸟说）"></a>转载（二鸟说）</h1><ul><li><a href="https://mp.weixin.qq.com/s/GzzOK5upb4uBRvcO-OBxSA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/GzzOK5upb4uBRvcO-OBxSA</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485851&amp;idx=1&amp;sn=a9f245e0ad556add1b25b53ff830853b&amp;chksm=eba71005dcd099138b92795378bfe66d078adafc21755ee92062aa8efaf9f728a6ae070f0382&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485851&amp;idx=1&amp;sn=a9f245e0ad556add1b25b53ff830853b&amp;chksm=eba71005dcd099138b92795378bfe66d078adafc21755ee92062aa8efaf9f728a6ae070f0382&amp;scene=21#wechat_redirect</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485728&amp;idx=1&amp;sn=c997f8688cb49f7ba91ab249706a66d3&amp;chksm=eba710bedcd099a859aeb47d9166543f27672e2e9ae8d0d8d5360555d31e920f3b511d18626f&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485728&amp;idx=1&amp;sn=c997f8688cb49f7ba91ab249706a66d3&amp;chksm=eba710bedcd099a859aeb47d9166543f27672e2e9ae8d0d8d5360555d31e920f3b511d18626f&amp;scene=21#wechat_redirect</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485888&amp;idx=1&amp;sn=f9e925a3ca905bcea8f5d749ca07e1ea&amp;chksm=eba7105edcd099480ae44bb824f787aa29598e988c527abf2546f8c9d815132a4562d14503f1&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;mid=2247485888&amp;idx=1&amp;sn=f9e925a3ca905bcea8f5d749ca07e1ea&amp;chksm=eba7105edcd099480ae44bb824f787aa29598e988c527abf2546f8c9d815132a4562d14503f1&amp;scene=21#wechat_redirect</a></li></ul><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>随着最后一只保本基金的转型，保本基金已经成为历史名称。但投资者对于“类保本”产品的需求并不会因此而消失，绝对收益目标基金应运而生。</p><p>所谓绝对收益目标基金，即以追求绝对收益为目标，不与某个资产价格指数进行比较，而以某个固定的收益值进行比较。由此可见，绝对收益基金在运作策略方面与追求相对收益的普通开放式基金存在明显差异。</p><p>绝对收益策略主要包括“固收+”、保本、对冲、以及多种混合策略等。保本策略对应的就是避险策略基金。这实际上是保本基金转型的产品。这类产品现在很少有基金公司愿意发行。具体原因我在《<a href="http://mp.weixin.qq.com/s?__biz=MzU0MDU0MTk0Mw==&mid=2247483974&idx=1&sn=90d9734f4de7e03f34674073d681fdee&chksm=fb36d4decc415dc8b828ad82c9f53b2141fe0ec5e4f2ddea46c6b2b39cd14253d312a2227761&scene=21#wechat_redirect" target="_blank" rel="noopener">保本基金为何纷纷“大逃亡”</a>》进行了分析。</p><p>所以，目前主要采用固收+和对冲这两种策略。“固收+”策略的本质是以中短期绝对收益率为目标、以安全资产为底仓提供基础收益，并在严格控制回撤的前提下寻求利用高弹性资产增强收益的机会。具体有固收+股票、固收+转债、固收+打新等策略。对冲策略则是利用衍生产品对投资组合进行对冲，将组合的系统性风险控制在一定的范围内，从而达到降低波动，控制回撤的效果。</p><p>无论采用哪种策略，都对基金公司和基金经理的实力提出了较高的要求。管理这类基金，不仅要同时具备固收和权益的投资能力，还需要具备大类资产配置、衍生品交易以及打新等方面的能力。因此，绝对收益目标基金并不是任何基金经理都能管得好的，由此决定了这类产品的稀缺性。</p><p>按合规要求，基金公司原则上是不能公开宣传“绝对收益”的，光从基金名称是看不出什么名堂来的。你要深入研究他的投资策略和净值表现才能确定。因此，在海量的基金中选出这类产品，就是一项极其费脑筋的工作。</p><p>为此，我们通过细致认真地研究，甄选出五个在运作中执行了绝对收益策略的产品。我们认为这几个基金还是比较靠谱的。现详细介绍如下，以供大家参考。</p><a id="more"></a><h1 id="“固收-”策略产品"><a href="#“固收-”策略产品" class="headerlink" title="“固收+”策略产品"></a><strong>“固收+”策略产品</strong></h1><ol><li><p>光大保德信安和/安诚债券（003109）</p></li><li><p>长城新优选混合（002227）</p></li><li><p>银华汇利灵活配置混合（001289）</p></li></ol><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/1.webp" alt="image"></p><p>这三只基金中，光大保德信的产品为二级债基，长城和银华的产品为混合基金，目前均开放申赎。从上图中三只产品的业绩走势：平缓的增长伴随极小的回撤，我们可以判断出它们都是按照绝对收益策略进行运作的。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/2.png" alt="image"></p><p>在收益表现方面，三只产品在存续期内走势十分平稳，累积收益随时间持续增长，并在各个期间均取得了正收益。其中长城新优选表现抢眼，在各个期间内均取得了最高的收益，三年累积收益高达25.6%，年化收益超过8%。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/3.png" alt="image"></p><p>此外，三只产品在斩获理想的收益同时，也很好的控制了净值回撤。从上图可以看出，它们在存续期内绝大多数的时候，最大回撤都控制在-0.5%以内，即便在极端市场行情中，最大回撤也都控制在了-1.5%以内。这充分体现了绝对收益目标基金在控制回撤方面的严格性，而这也正是这类产品与普通二级债基以及增强债基的区别。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/4.png" alt="image"></p><p>从资产配置方面可以看出，三只产品均为典型的“固收+”组合，底仓均由债券构成，并少量持有股票寻求收益增强。在以固收+股票为主的同时，也少量运用了转债和打新策略。其中长城新优选持有股票比重最大，组合整体的历史波动也是最高的，这在一定程度上解释了为何它在三只产品中收益最高。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/5.webp" alt="img"></p><p>从上面持有人结构数据可以看出，机构十分青睐这类产品。一方面是由机构资金的风险偏好决定的。另一方面，这类产品受“聪明资金”追捧的程度，也能从侧面反映出其稀缺程度。其中长城优选机构资金占比高达97%，银华汇利机构资金占比也超过90%，几乎可以视为“机构定制版”产品。</p><p><strong>另外三个优秀产品</strong>：</p><ol start="4"><li>广发趋势优选（000215）</li><li>长安鑫益（002146）</li><li>安信稳健增值（001316）</li></ol><p>这次为大家选出的三只样本基金是长安鑫益增强（002146，自2018年2季度定位于绝对收益）、安信稳健增值(001316)、广发趋势优选(000215)。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/6.png" alt="img"></p><p>长安鑫益增强自2018年二季度以来，安信稳健增值、广发趋势优选自成立以来，累计净值曲线都平稳向上，实现了年年正收益。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/7.png" alt="img"></p><p>再细化到季度。最近8个季度中，长安鑫益增强和安信稳健增值连续实现季度正收益，广发趋势优选仅有一个季度没有实现正收益，而同期同类平均和沪深300均有五次是负收益。这种绝对收益无疑给了投资者极佳的投资体验。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/8.webp" alt="img"></p><p>在回撤控制方面，这三只基金也做的很出色。2015年6月至2019年8月，A股经历了熊市、反弹、震荡等七个阶段的行情。</p><p>2015/12/26—2016/1/29期间，A股急速下跌，短短24个交易日，沪深300急跌23.2%，最大回撤24.2%，同期安信稳健增值最大回撤仅为0.7%，广发趋势优选最大回撤仅为1.7%。</p><p>2019/4/20—2019/8/7股市震荡下行期间，沪深300最大回撤为11.5%，但是三只基金最大回撤均得到了很好的控制，长安鑫益增强最大回撤为0.1%，安信稳健增值为1%，广发趋势优选为0.8%。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/9.png" alt="img"></p><p>从阶段收益可以看出，时间周期越长，这类基金积累的收益越多。</p><p>近1年长安鑫益增强累计收益达到了20.31%，安信稳健增值为8.89%、广发趋势优选为6.75%。近2年，安信稳健增值累计收益17.02%，广发趋势优选累计收益15.75%，同期沪深300下跌2.32%。</p><p>正如广发趋势优选基金经理谭昌杰所言：只要方向正确，慢就是快。这类基金虽然每年的收益未必很高，但回撤小，长期下来经过复利的积累，做出的累积收益依然惊人。像运作时间最长的广发趋势优选，成立不到6年，累计净值已超过1.82。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/10.png" alt="img"></p><p>上述三只基金之所以能实现绝对收益目标，主要是做好了以下三个方面：第一、做好固定收益投资，获取长期稳健收益；第二、根据股市行情变化，灵活操作股票，在严格控制回撤前提下，获取弹性收益；第三、基金经理管理思路明确，长期坚守交易纪律。</p><p>简单的说，就是股市涨时赚固定收益加股市上涨的钱；股市下跌时，只赚固定收益的钱，回避股市下跌的损失，即“债券打底，择机炒股，严控回撤，积少成多”。</p><p>长安鑫益增强自2018年2季度定位于绝对收益基金之后，坚持以债券配置为主，股票配置为辅。在债券方面根据情况在利率债和信用债之间进行灵活配置，比如2019年主要采用长久期利率债和短久期高收益信用债搭配的策略。</p><p>在股票方面，持仓范围是0-30%，操作策略是“低仓位+短线”。无论股票行情好还是不好，都保持着极低的仓位（6%以下），在趋势性、震荡、反弹行情中进行短线操作，及时止盈止损，确保不会对净值造成太大的影响。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/11.png" alt="img"></p><p>安信稳健增值在债券配置方面，主要投资高评级的国企债券和利率债、可转债，维持一定的杠杆水平，债券市值占资产净值比长期维持在100%以上。</p><p>该基金股票持仓范围是0%–95%，采用“长期持有+择时调仓”的策略。坚持价值投资，精选优质并且估值合理的蓝筹股，长期持有，持仓基本控制在0%-15%之间。一旦有发生系统性风险的可能，便会果断降低股票仓位。比如2018年四季度末股票持仓将至6%，2019年一季度末股票持仓提升至12%，持仓比例调整比较频繁。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/12.png" alt="img"></p><p>广发趋势优选主要是通过 “自上而下选择低相关性的、风险较低的多类别资产构建组合，重视风险控制，及时做好止损”来实现绝对收益的。</p><p>在债券配置方面，偏好于选择1-3年期AAA国企债作为底仓，为绝对收益的构建足够的安全垫。在股票配置方面，会在行业和个股层面进行分散，单只个股的集中度尽量不超过2%，此外，还制定了严格的止损标准，投资标的跌到一定程度，必须卖出。</p><p>该基金股票持仓范围是0%–95%，采用“自上而下+择时调仓”的策略。从历史数据来看，该基金股票市值占资产净值比波动较大，在2017年牛行情中维持在40%左右，2018年熊市中则迅速降低至20%以下。表明该基金是通过择时，在下跌市场降低股票仓位，在上涨市场增加股票仓位，获取绝对收益。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/13.png" alt="img"></p><p>上述基金实现绝对收益的原理，通俗说的话就是：债券投资为收益打底，股票投资提供弹性。当然，这只是我们从投资者的角度，通过公开信息进行的研究。基金经理所采取的策略要远比这个复杂，而且实际操作难度很大。绝对收益策略堪称基金公司和基金经理的“绝活”。</p><p>在资管行业，其实大家都很希望能给投资者提供产品，收益还不错，最重要的是投资体验极佳。但到目前为止，经历过牛熊检验，真正跑出来的屈指可数，这类产品极度稀缺。道理很简单，对绝对收益产品而言玩股票就像在走钢丝绳，稍有不慎回撤控制不住就垮下去了。而不使用权益资产，仅靠债券是难以做出满意的收益的。</p><p>二鸟老师主理的“绝对收益目标组合”也是以追求绝对收益为目标，自成立以来年化收益接近10%，最大回撤低于2%，实现了“稳稳的幸福”。</p><h1 id="对冲策略产品"><a href="#对冲策略产品" class="headerlink" title="对冲策略产品"></a><strong>对冲策略产品</strong></h1><ol><li><p>南方绝对收益（000844）</p></li><li><p>汇添富绝对收益（000762）</p></li></ol><p>这两只产品是市面上十分少见的在名称中包含“绝对收益”字样的产品，两者均采用了对冲策略。其中南方绝对收益是市场上屈指可数的几个纯粹对冲策略产品之一，汇添富绝对收益则属于“固收+”、对冲、打新等共存的多策略产品。关于这一点，我们可以从两只产品的资产配置上很清楚的看到。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/14.png" alt="img"></p><p>南方绝对收益在持有股票的同时大量持有衍生品，组合中没有债券。而汇添富绝对收益组合中债券的权重接近40%，而衍生品的权重较小。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/15.webp" alt="img"></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/16.png" alt="img"></p><p>从业绩表现上看，两只产品累积收益增长平稳，且在所有区间上都获得了正收益，策略应用十分成功。其中汇添富的收益表现相对更好一些，今年对冲策略运用较少，持有的债券和股票贡献了较多的收益。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/17.webp" alt="img"></p><p>在控制回撤方面，这两只产品相对于之前介绍过的三只纯“固收+”产品而言相对较大，在多数时间里最大回撤控制在1%以内，极端市场中控制在2%左右。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/fund/bird/18.png" alt="img"></p><p>这两只基金均为定期开放产品。最近一期开放日期：南方绝对收收益是2019年12月12日至19日，汇添富绝对收益是2019年11月8日至22日，过期不候。</p><p>另外还有一个海富通阿尔法对冲（519062），这是目前市场上为数不多的日常开放的对冲产品。运作时间最长，业绩非常优秀。这个基金我之前曾多次介绍过，这里不详细说了。</p><p>至于两类策略孰优孰劣，不能简单对比收益，应该进行综合评判。就反映收益/风险比的夏普比率而言，我们发现纯“固收+”的产品表现更好，而纯对冲策略的南方绝对收益较弱。介于两者之间的汇添富绝对收益，由于采取了混合策略，表现居中。当然，由于研究的样本较小，对两种策略的优劣尚不宜得出结论。</p><p>考虑到目前我国资本市场可以用于对冲的衍生品工具还不完备，且衍生品交易存在诸多限制，因此对冲组合有可能存在较大的基差，进而影响对冲的效果。因此，我们认为“固收+”具有更强的可操作性，从而成为绝对收益目标基金的主流策略。</p><h1 id="绝对收益目标组合"><a href="#绝对收益目标组合" class="headerlink" title="绝对收益目标组合"></a>绝对收益目标组合</h1><h2 id="初心"><a href="#初心" class="headerlink" title="初心"></a>初心</h2><p>如何才能帮投资者赚到钱？这也是我写公号、开组合的初心。实践已证明，最简单可行的方法就是让跟投人长期持有。</p><p>第一个是相对收益思路：优选基金、动态管理。通过对主流指数（如沪深300）的大幅超越，树立跟投人信心。同时做好投资者陪伴服务，一起渡过市场低迷的时段。通过长期持有优质基金，静待时间玫瑰的绽放。这就是价值五剑。</p><p>第二个是绝对收益思路。如果能把净值曲线做成一条接近斜率15度的直线，回撤小，稳步上行的话，跟投人就能具备极佳的投资体验。这样甚至投资者陪伴服务都可以不需要了。因为跟投人不论何时买入都能盈利。</p><p>这种思路其实已经跑出样板了：我要稳稳的幸福。我最初的想法是：对标“我要稳稳的幸福”，适当放大一些波动，力争做出更高一点的收益。在2018年10月31日，股市一片哀嚎声中，我在且慢上开仓建了这个组合。相比于交银，我们最大的优势就是能全市场择基（我要稳稳的幸福是交银的内部FOF），择天下英才而用之。</p><h2 id="求索"><a href="#求索" class="headerlink" title="求索"></a>求索</h2><p>做绝对收益最核心的是严控回撤，一般是采用CPPI或风险平价策略。我要稳稳的幸福就是采用风险平价策略。我本人并非金融工程科班出身，对量化、建模这一块并没有优势，我的优势在于优选基金。经过再三考虑，我采用的是优选绝对收益目标基金+大类资产配置的策略。选出优秀的绝对收益目标基金，通过基金经理的管理作为第一层保障。同时主理人进行大类资产配置和基金池的动态管理，严控组合净值的回撤，作为第二层保障。</p><p>在优选基金时，注意投资方法的分散化和多样化。最初是按配置策略、短债策略、对冲策略、综合策略去选基金。随着收益安全垫的积累，将短债策略更换为更为积极的长债策略，同时加入了小仓位的股债平衡型基金以增加组合收益的弹性。随着科创板开市，打新的制度红利较为明显，后续也加入了打新策略。</p><p>按照“固收+”的观点，“固收+股票”、“固收+转债”、“固收+打新”的思想皆有体现。同时还使用了对冲基金（市场中性策略）。绝对收益目标组合实现了投资方法和收益来源的多样化。</p><p>最初还尝试使用小仓位的基金进行波段操作以进一步增厚收益，但在实践中发现异常困难。研判的工作量、难度与仓位的大小并没有关系。哪怕是极小仓位，也不能有任何闪失。所以后面彻底放弃。</p><h2 id="韧性"><a href="#韧性" class="headerlink" title="韧性"></a>韧性</h2><p>绝对收益目标组合目前使用了6只成分基金，这一年股、债两市都有较大的波动，但这些基金都表现出了极强的韧性。反映在组合上面，就是净值异常坚挺。</p><p>易方达稳健收益（110008）：由易方达固收总经理胡剑老师亲自执掌，近8年时间除2011年年微亏外，其余年份全部取得正收益。这虽然是一只普通二级债基，并非采用绝对收益策略，但我仍给予高度信任。建仓初期由于股市点位较低，直接赋予了30%的仓位。现在虽有所降低，仍有25%的仓位。</p><p>广发趋势优选（000215）：这是一个默默的数钱、不声张的基金。名字里没有“绝对收益”这四个字，实际上是采用绝对收益策略。2015年2月谭昌杰接手之后，净值曲线基本就是一条斜率为15度的直线。</p><p>长安鑫益增强（002146）：这个更牛，几乎没有回撤，天天飘红不说，收益更是高的令人发指。他到底用了何种策略？神一般的存在。但他天天飘红不假，已经两年了。</p><p>海富通阿尔法对冲（519062）：运行时间最长，收益最好的且每日开放的对冲基金，极其稀缺。这个基金在成分基金里面收益虽不是最高，但对组合极其重要。他不仅自身能实现正收益，而且独立于股、债两市，经常是与股市反向波动，较好的平抑了组合的波动率。</p><p>光大保德信诚鑫（003116）：固收+打新的基金，底仓以银行股为主，相对安全。这只基金调入较晚，错过了科创板开市那几天的涨幅。不然组合的净值还能提升0.5个点。</p><p>广发稳健增长（270002）、泓德致远（004965）：两个优秀的股债平衡型基金，具备净值不断创新高的能力，具备极高的风险收益比。组合小仓位使用，用于增厚收益。</p><h2 id="远方"><a href="#远方" class="headerlink" title="远方"></a>远方</h2><p>随着组合的影响力不断增大，也有人提出了一些质疑。比较典型的就是：组合的混合型基金占比较大，股票仓位较高，对未来能否保持高收益低回撤表示怀疑。在此我做一下解释。</p><p>先说股票仓位和回撤的问题。组合的股票总仓位我们控制在20%以内，对标二级债基，而且还使用了对冲的手段。这些基金表面上是混合基金，实际上都是以绝对收益为目标的基金，基金经理本身就在控制回撤。说股票仓位高的人，明显是对这几个基金的风格不太了解。只要这些基金不改变现有投资策略，组合的波动和回撤的控制是没有问题的。况且我还天天盯着，在进行二次把关。</p><p>再说一下收益的问题。组合成立以来，正好赶上了股债双牛的好时光，因而取得了将近10%的收益。随着时间的拉长，年化收益率可能会缓慢的降下来。这个组合的首要目标是控制回撤，收益并不是摆在首位的。在产品说明书里也写的很清楚：“力争实现5%的年化收益率”，我们也从未宣传和强调组合的高收益率。</p><p>未来随着时间的推移，组合的年化收益率如果降到5%-7%的区间，这都是很正常的事。如果未来仍维持着这个高收益，那是你们自己的福气。我找对了人，你们也找对了人。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;转载（二鸟说）&quot;&gt;&lt;a href=&quot;#转载（二鸟说）&quot; class=&quot;headerlink&quot; title=&quot;转载（二鸟说）&quot;&gt;&lt;/a&gt;转载（二鸟说）&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/GzzOK5upb4uBRvcO-OBxSA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/GzzOK5upb4uBRvcO-OBxSA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485851&amp;amp;idx=1&amp;amp;sn=a9f245e0ad556add1b25b53ff830853b&amp;amp;chksm=eba71005dcd099138b92795378bfe66d078adafc21755ee92062aa8efaf9f728a6ae070f0382&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485851&amp;amp;idx=1&amp;amp;sn=a9f245e0ad556add1b25b53ff830853b&amp;amp;chksm=eba71005dcd099138b92795378bfe66d078adafc21755ee92062aa8efaf9f728a6ae070f0382&amp;amp;scene=21#wechat_redirect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485728&amp;amp;idx=1&amp;amp;sn=c997f8688cb49f7ba91ab249706a66d3&amp;amp;chksm=eba710bedcd099a859aeb47d9166543f27672e2e9ae8d0d8d5360555d31e920f3b511d18626f&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485728&amp;amp;idx=1&amp;amp;sn=c997f8688cb49f7ba91ab249706a66d3&amp;amp;chksm=eba710bedcd099a859aeb47d9166543f27672e2e9ae8d0d8d5360555d31e920f3b511d18626f&amp;amp;scene=21#wechat_redirect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485888&amp;amp;idx=1&amp;amp;sn=f9e925a3ca905bcea8f5d749ca07e1ea&amp;amp;chksm=eba7105edcd099480ae44bb824f787aa29598e988c527abf2546f8c9d815132a4562d14503f1&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s?__biz=MzI4MTYyODkxMw==&amp;amp;mid=2247485888&amp;amp;idx=1&amp;amp;sn=f9e925a3ca905bcea8f5d749ca07e1ea&amp;amp;chksm=eba7105edcd099480ae44bb824f787aa29598e988c527abf2546f8c9d815132a4562d14503f1&amp;amp;scene=21#wechat_redirect&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;随着最后一只保本基金的转型，保本基金已经成为历史名称。但投资者对于“类保本”产品的需求并不会因此而消失，绝对收益目标基金应运而生。&lt;/p&gt;
&lt;p&gt;所谓绝对收益目标基金，即以追求绝对收益为目标，不与某个资产价格指数进行比较，而以某个固定的收益值进行比较。由此可见，绝对收益基金在运作策略方面与追求相对收益的普通开放式基金存在明显差异。&lt;/p&gt;
&lt;p&gt;绝对收益策略主要包括“固收+”、保本、对冲、以及多种混合策略等。保本策略对应的就是避险策略基金。这实际上是保本基金转型的产品。这类产品现在很少有基金公司愿意发行。具体原因我在《&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzU0MDU0MTk0Mw==&amp;mid=2247483974&amp;idx=1&amp;sn=90d9734f4de7e03f34674073d681fdee&amp;chksm=fb36d4decc415dc8b828ad82c9f53b2141fe0ec5e4f2ddea46c6b2b39cd14253d312a2227761&amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;保本基金为何纷纷“大逃亡”&lt;/a&gt;》进行了分析。&lt;/p&gt;
&lt;p&gt;所以，目前主要采用固收+和对冲这两种策略。“固收+”策略的本质是以中短期绝对收益率为目标、以安全资产为底仓提供基础收益，并在严格控制回撤的前提下寻求利用高弹性资产增强收益的机会。具体有固收+股票、固收+转债、固收+打新等策略。对冲策略则是利用衍生产品对投资组合进行对冲，将组合的系统性风险控制在一定的范围内，从而达到降低波动，控制回撤的效果。&lt;/p&gt;
&lt;p&gt;无论采用哪种策略，都对基金公司和基金经理的实力提出了较高的要求。管理这类基金，不仅要同时具备固收和权益的投资能力，还需要具备大类资产配置、衍生品交易以及打新等方面的能力。因此，绝对收益目标基金并不是任何基金经理都能管得好的，由此决定了这类产品的稀缺性。&lt;/p&gt;
&lt;p&gt;按合规要求，基金公司原则上是不能公开宣传“绝对收益”的，光从基金名称是看不出什么名堂来的。你要深入研究他的投资策略和净值表现才能确定。因此，在海量的基金中选出这类产品，就是一项极其费脑筋的工作。&lt;/p&gt;
&lt;p&gt;为此，我们通过细致认真地研究，甄选出五个在运作中执行了绝对收益策略的产品。我们认为这几个基金还是比较靠谱的。现详细介绍如下，以供大家参考。&lt;/p&gt;
    
    </summary>
    
      <category term="基金" scheme="https://gongzhao1.coding.me/categories/%E5%9F%BA%E9%87%91/"/>
    
    
      <category term="基金" scheme="https://gongzhao1.coding.me/tags/%E5%9F%BA%E9%87%91/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes之存储详解</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E4%B9%8B%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/"/>
    <id>https://gongzhao1.coding.me/Kubernetes之存储详解/</id>
    <published>2020-02-27T15:42:55.000Z</published>
    <updated>2020-04-08T14:20:25.835Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.kubernetes.org.cn/pvpvcstorageclass" target="_blank" rel="noopener">https://www.kubernetes.org.cn/pvpvcstorageclass</a></li><li><a href="https://www.jianshu.com/p/99e610067bc8" target="_blank" rel="noopener">https://www.jianshu.com/p/99e610067bc8</a></li></ul><h1 id="简书介绍"><a href="#简书介绍" class="headerlink" title="简书介绍"></a>简书介绍</h1><p>前面我们学习了Kubernetes中的Volume，我们可以发现前文中的Volume（无论何种类型）和使用它的Pod都是一种静态绑定关系，在Pod定义文件中，同时定义了它使用的Volume。在这种情况下，Volume是Pod的附属品，我们无法像创建其他资源（例如Pod，Node，Deployment等等）一样创建一个Volume。</p><p>因此Kubernetes提出了PersistentVolume（PV）的概念。PersistentVolume和Volume一样，代表了集群中的一块存储区域，然而Kubernetes将PersistentVolume抽象成了一种集群资源，类似于集群中的Node对象，这意味着我们可以使用Kubernetes API来创建PersistentVolume对象。PV与Volume最大的不同是PV拥有着独立于Pod的生命周期。</p><p>而PersistentVolumeClaim（PVC）代表了用户对PV资源的请求。用户需要使用PV资源时，只需要创建一个PVC对象（包括指定使用何种存储资源，使用多少GB，以何种模式使用PV等信息），Kubernetes会自动为我们分配我们所需的PV。如果把PersistentVolume类比成集群中的Node，那么PersistentVolumeClaim就相当于集群中的Pod，Kubernetes为Pod分配可用的Node，为PersistentVolumeClaim分配可用的PersistentVolume。</p><a id="more"></a><h2 id="PV的静态创建"><a href="#PV的静态创建" class="headerlink" title="PV的静态创建"></a>PV的静态创建</h2><p>首先是一个创建PV的简单例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">slow</span></span><br><span class="line"><span class="attr">  mountOptions:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hard</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nfsvers=4.1</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/tmp</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure><p>PV 的访问模式（accessModes）有三种：</p><ul><li>ReadWriteOnce（RWO）：是最基本的方式，可读可写，但只支持被单个 Pod 挂载。</li><li>ReadOnlyMany（ROX）：可以以只读的方式被多个 Pod 挂载。</li><li>ReadWriteMany（RWX）：这种存储可以以读写的方式被多个 Pod 共享。</li></ul><blockquote><p>不是每一种PV都支持这三种方式，例如ReadWriteMany，目前支持的还比较少。在 PVC 绑定 PV 时通常根据两个条件来绑定，一个是存储的大小，另一个就是访问模式。</p></blockquote><p>PV 的回收策略（persistentVolumeReclaimPolicy，即 PVC 释放卷的时候 PV 该如何操作）也有三种：</p><ul><li>Retain，不清理, 保留 Volume（需要手动清理）</li><li>Recycle，删除数据，即 rm -rf /thevolume/*（只有 NFS 和 HostPath 支持）</li><li>Delete，删除存储资源，比如删除 AWS EBS 卷（只有 AWS EBS, GCE PD, Azure Disk 和 Cinder 支持）</li></ul><blockquote><p>PVC释放卷是指用户删除一个PVC对象时，那么与该PVC对象绑定的PV就会被释放。</p></blockquote><h2 id="PV支持的类型"><a href="#PV支持的类型" class="headerlink" title="PV支持的类型"></a>PV支持的类型</h2><p>定义PV时，我们需要指定其底层存储的类型，例如上文中创建的PV，底层使用nfs存储。目前Kuberntes支持以下类型：</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>AzureFile</li><li>AzureDisk</li><li>FC (Fibre Channel)**</li><li>FlexVolume</li><li>Flocker</li><li>NFS</li><li>iSCSI</li><li>RBD (Ceph Block Device)</li><li>CephFS</li><li>Cinder (OpenStack block storage)</li><li>Glusterfs</li><li>VsphereVolume</li><li>Quobyte Volumes</li><li>HostPath (Single node testing only – local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</li><li>VMware Photon</li><li>Portworx Volumes</li><li>ScaleIO Volumes</li><li>StorageOS</li></ul><h2 id="PVC的创建"><a href="#PVC的创建" class="headerlink" title="PVC的创建"></a>PVC的创建</h2><p>当我们定义好一个PV后，我们希望像使用Volume那样使用这个PV，那么我们需要做的就是创建一个PVC对象，并在Pod定义中使用这个PVC。<br> 定义一个PVC：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">slow</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      release:</span> <span class="string">"stable"</span></span><br></pre></td></tr></table></figure><p>Pod通过挂在Volume的方式应用PVC：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">myfrontend</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">dockerfile/nginx</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">      - mountPath:</span> <span class="string">"/var/www/html"</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">mypd</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mypd</span></span><br><span class="line"><span class="attr">      persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">        claimName:</span> <span class="string">myclaim</span></span><br></pre></td></tr></table></figure><p>下面简要分析一下定义的PVC文件的关键：</p><ul><li>首先关注这个配置：<code>storageClassName: slow</code>。此配置用于绑定PVC和PV。这表明这个PVC希望使用<code>storageClassName=slow</code>的PV。返回到上文中PV的定义，我们可以看到PV定义中也包含<code>storageClassName=slow</code>的配置。</li><li>接下来是<code>accessModes = ReadWriteOnce</code>。这表明这个PV希望使用<code>storageClassName=slow</code>，并且<code>accessModes = ReadWriteOnce</code>的PV。</li><li>在上述条件都满足后，PVC还可以指定PV必须满足的Label，如<code>matchLabels: release: &quot;stable&quot;</code>。这表明此PVC希望使用<code>storageClassName=slow</code>，<code>accessModes = ReadWriteOnce</code>并且拥有Label：<code>release: &quot;stable&quot;</code>的PV。</li><li>最后是<code>storage: 8Gi</code>。这表明此PVC希望使用8G的Volume资源。</li></ul><blockquote><p>通过上面的分析，我们可以看到PVC和PV的绑定，不是简单的通过Label来进行。而是要综合<code>storageClassName</code>，<code>accessModes</code>，<code>matchLabels</code>以及<code>storage</code>来进行绑定。</p></blockquote><h2 id="PV的动态创建"><a href="#PV的动态创建" class="headerlink" title="PV的动态创建"></a>PV的动态创建</h2><p>上文中我们通过PersistentVolume描述文件创建了一个PV。这样的创建方式我们成为<strong>静态创建</strong>。这样的创建方式有一个弊端，那就是假如我们创建PV时指定大小为50G，而PVC请求80G的PV，那么此PVC就无法找到合适的PV来绑定。因此产生了了PV的动态创建。</p><p>PV的动态创建依赖于StorageClass对象。我们不需要手动创建任何PV，所有的工作都由StorageClass为我们完成。一个例子如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">slow</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">io1</span></span><br><span class="line"><span class="attr">  zones:</span> <span class="string">us-east-1d,</span> <span class="string">us-east-1c</span></span><br><span class="line"><span class="attr">  iopsPerGB:</span> <span class="string">"10"</span></span><br></pre></td></tr></table></figure><p>这个例子使用AWS提供的插件（ kubernetes.io/aws-ebs）创建了一个基于AWS底层存储的StorageClass。这意味着使用这个StorageClass，那么所有的PV都是AWSElasticBlockStore类型的。</p><p>StorageClass的定义包含四个部分：</p><ul><li>provisioner：指定 Volume 插件的类型，包括内置插件（如 <code>kubernetes.io/aws-ebs</code>）和外部插件（如 <a href="https://link.jianshu.com?t=https%3A%2F%2Fgithub.com%2Fkubernetes-incubator%2Fexternal-storage%2Ftree%2Fmaster%2Fceph%2Fcephfs" target="_blank" rel="noopener">external-storage</a> 提供的 <code>ceph.com/cephfs</code>）。</li><li>mountOptions：指定挂载选项，当 PV 不支持指定的选项时会直接失败。比如 NFS 支持 hard 和 nfsvers=4.1 等选项。</li><li>parameters：指定 provisioner 的选项，比如 kubernetes.io/aws-ebs 支持 type、zone、iopsPerGB 等参数。</li><li>reclaimPolicy：指定回收策略，同 PV 的回收策略。</li></ul><p>手动创建的PV时，我们指定了<code>storageClassName=slow</code>的配置项，然后Pod定义中也通过指定<code>storageClassName=slow</code>，从而完成绑定。而通过StorageClass实现动态PV时，我们只需要指定StorageClass的<code>metadata.name</code>。</p><p>回到上文中创建PVC的例子，此时PVC指定了<code>storageClassName=slow</code>。那么Kubernetes会在集群中寻找是否存在<code>metadata.name=slow</code>的StorageClass，如果存在，此StorageClass会自动为此PVC创建一个<code>accessModes = ReadWriteOnce</code>，并且大小为8GB的PV。</p><blockquote><p>通过StorageClass的使用，使我们从提前构建静态PV池的工作中解放出来。</p></blockquote><h2 id="PV的生命周期"><a href="#PV的生命周期" class="headerlink" title="PV的生命周期"></a>PV的生命周期</h2><p>PV的生命周期包括 5 个阶段：</p><ul><li>Provisioning，即 PV 的创建，可以直接创建 PV（静态方式），也可以使用 StorageClass 动态创建</li><li>Binding，将 PV 分配给 PVC</li><li>Using，Pod 通过 PVC 使用该 Volume，并可以通过准入控制 StorageProtection（1.9及以前版本为PVCProtection）阻止删除正在使用的 PVC</li><li>Releasing，Pod 释放 Volume 并删除 PVC</li><li>Reclaiming，回收 PV，可以保留 PV 以便下次使用，也可以直接从云存储中删除<br> Deleting，删除 PV 并从云存储中删除后段存储</li></ul><p>根据这 5 个阶段，PV 的状态有以下 4 种</p><ul><li>Available：可用</li><li>Bound：已经分配给 PVC</li><li>Released：PVC 解绑但还未执行回收策略</li><li>Failed：发生错误</li></ul><p>一个PV从创建到销毁的具体流程如下：</p><ol><li>一个PV创建完后状态会变成Available，等待被PVC绑定。</li><li>一旦被PVC邦定，PV的状态会变成Bound，就可以被定义了相应PVC的Pod使用。</li><li>Pod使用完后会释放PV，PV的状态变成Released。</li><li>变成Released的PV会根据定义的回收策略做相应的回收工作。有三种回收策略，Retain、Delete 和 Recycle。Retain就是保留现场，K8S什么也不做，等待用户手动去处理PV里的数据，处理完后，再手动删除PV。Delete 策略，K8S会自动删除该PV及里面的数据。Recycle方式，K8S会将PV里的数据删除，然后把PV的状态变成Available，又可以被新的PVC绑定使用。</li></ol><h2 id="DefaultStorageClass"><a href="#DefaultStorageClass" class="headerlink" title="DefaultStorageClass"></a>DefaultStorageClass</h2><p>前面我们说到，PVC和PV的绑定是通过StorageClassName进行的。然而如果定义PVC时没有指定StorageClassName呢？这取决与<a href="https://link.jianshu.com?t=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fadmin%2Fadmission-controllers%2F%23defaultstorageclass" target="_blank" rel="noopener">admission插件</a>是否开启了DefaultDefaultStorageClass功能：</p><ul><li>如果DefaultDefaultStorageClass功能开启，那么此PVC的StorageClassName就会被指定为DefaultStorageClass。DefaultStorageClass从何处而来呢？原来在定义StorageClass时，可以在Annotation中添加一个键值对：<code>storageclass.kubernetes.io/is-default-class: true</code>，那么此StorageClass就变成默认的StorageClass了。</li><li>如果DefaultDefaultStorageClass功能没有开启，那么没有指定StorageClassName的PVC只能被绑定到同样没有指定StorageClassName的PV。</li></ul><h1 id="中文文档介绍之PV-PVC-StorageClass"><a href="#中文文档介绍之PV-PVC-StorageClass" class="headerlink" title="中文文档介绍之PV/PVC/StorageClass"></a>中文文档介绍之PV/PVC/StorageClass</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>PersistentVolume（PV）是集群中已由管理员配置的一段网络存储。 集群中的资源就像一个节点是一个集群资源。 PV是诸如卷之类的卷插件，但是具有独立于使用PV的任何单个pod的生命周期。 该API对象捕获存储的实现细节，即NFS，iSCSI或云提供商特定的存储系统。</p><p>PersistentVolumeClaim（PVC）是用户存储的请求。 它类似于pod。Pod消耗节点资源，PVC消耗存储资源。 pod可以请求特定级别的资源（CPU和内存）。 权限要求可以请求特定的大小和访问模式。</p><p>虽然PersistentVolumeClaims允许用户使用抽象存储资源，但是常见的是，用户需要具有不同属性（如性能）的PersistentVolumes，用于不同的问题。 群集管理员需要能够提供多种不同于PersistentVolumes的PersistentVolumes，而不仅仅是大小和访问模式，而不会使用户了解这些卷的实现细节。 对于这些需求，存在StorageClass资源。</p><p>StorageClass为管理员提供了一种描述他们提供的存储的“类”的方法。 不同的类可能映射到服务质量级别，或备份策略，或者由群集管理员确定的任意策略。 Kubernetes本身对于什么类别代表是不言而喻的。 这个概念有时在其他存储系统中称为“配置文件”</p><p>例子<br><a href="https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/" target="_blank" rel="noopener">https://kubernetes.io/docs/user-guide/persistent-volumes/walkthrough/</a></p><h2 id="Lifecycle-of-a-volume-and-claim"><a href="#Lifecycle-of-a-volume-and-claim" class="headerlink" title="Lifecycle of a volume and claim"></a>Lifecycle of a volume and claim</h2><p>PV是集群中的资源。 PVC是对这些资源的请求，也是对资源的索赔检查。 PV和PVC之间的相互作用遵循这个生命周期:</p><p>Provisioning ——-&gt; Binding ——–&gt;Using——&gt;Releasing——&gt;Recycling</p><p><strong>Provisioning</strong></p><p>这里有两种PV的提供方式:静态或者动态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Static</span><br><span class="line">集群管理员创建多个PV。 它们携带可供集群用户使用的真实存储的详细信息。 它们存在于Kubernetes API中，可用于消费。</span><br><span class="line">Dynamic</span><br><span class="line">当管理员创建的静态PV都不匹配用户的PersistentVolumeClaim时，集群可能会尝试为PVC动态配置卷。 此配置基于StorageClasses：PVC必须请求一个类，并且管理员必须已创建并配置该类才能进行动态配置。 要求该类的声明有效地为自己禁用动态配置</span><br></pre></td></tr></table></figure><p><strong>Binding</strong></p><p>在动态配置的情况下，用户创建或已经创建了具有特定数量的存储请求和特定访问模式的PersistentVolumeClaim。 主机中的控制回路监视新的PVC，找到匹配的PV（如果可能），并将它们绑定在一起。 如果为新的PVC动态配置PV，则循环将始终将该PV绑定到PVC。 否则，用户总是至少得到他们要求的内容，但是卷可能超出了要求。 一旦绑定，PersistentVolumeClaim绑定是排他的，不管用于绑定它们的模式。</p><p>如果匹配的卷不存在，PVC将保持无限期。 随着匹配卷变得可用，PVC将被绑定。 例如，提供许多50Gi PV的集群将不匹配要求100Gi的PVC。 当集群中添加100Gi PV时，可以绑定PVC。</p><p><strong>Using</strong></p><p>Pod使用PVC作为卷。 集群检查声明以找到绑定的卷并挂载该卷的卷。 对于支持多种访问模式的卷，用户在将其声明用作pod中的卷时指定所需的模式。</p><p>一旦用户有声明并且该声明被绑定，绑定的PV属于用户，只要他们需要它。 用户通过在其Pod的卷块中包含persistentVolumeClaim来安排Pods并访问其声明的PV。</p><p><strong>Releasing</strong></p><p>当用户完成卷时，他们可以从允许资源回收的API中删除PVC对象。 当声明被删除时，卷被认为是“释放的”，但是它还不能用于另一个声明。 以前的索赔人的数据仍然保留在必须根据政策处理的卷上.</p><p><strong>Reclaiming</strong><br>PersistentVolume的回收策略告诉集群在释放其声明后，该卷应该如何处理。 目前，卷可以是保留，回收或删除。 保留可以手动回收资源。 对于那些支持它的卷插件，删除将从Kubernetes中删除PersistentVolume对象，以及删除外部基础架构（如AWS EBS，GCE PD，Azure Disk或Cinder卷）中关联的存储资产。 动态配置的卷始终被删除</p><p><strong>Recycling</strong></p><p>如果受适当的卷插件支持，回收将对卷执行基本的擦除（rm -rf / thevolume / *），并使其再次可用于新的声明。<br>但是，管理员可以使用Kubernetes控制器管理器命令行参数来配置自定义的回收站pod模板，如这里所述。 定制回收站模板必须包含卷规范，如下例所示：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv-recycler-</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">vol</span></span><br><span class="line"><span class="attr">    hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/any/path/it/will/be/replaced</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">pv-recycler</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">"gcr.io/google_containers/busybox"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"test -e /scrub &amp;&amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/*  &amp;&amp; test -z \"$(ls -A /scrub)\" || exit 1"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">vol</span></span><br><span class="line"><span class="attr">      mountPath:</span> <span class="string">/scrub</span></span><br></pre></td></tr></table></figure><h2 id="Types-of-Persistent-Volumes"><a href="#Types-of-Persistent-Volumes" class="headerlink" title="Types of Persistent Volumes"></a>Types of Persistent Volumes</h2><p>PV当前支持的类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GCEPersistentDisk </span><br><span class="line">AWSElasticBlockStore </span><br><span class="line">AzureFile </span><br><span class="line">AzureDisk </span><br><span class="line">FC (Fibre Channel) </span><br><span class="line">FlexVolume </span><br><span class="line">Flocker </span><br><span class="line">NFS </span><br><span class="line">iSCSI </span><br><span class="line">RBD (Ceph Block Device) </span><br><span class="line">CephFS </span><br><span class="line">Cinder (OpenStack block storage) </span><br><span class="line">Glusterfs </span><br><span class="line">VsphereVolume </span><br><span class="line">Quobyte Volumes </span><br><span class="line">HostPath (single node testing only – local storage is not supported in any way and WILL NOT WORK in a multi-node cluster) </span><br><span class="line">VMware Photon </span><br><span class="line">Portworx Volumes </span><br><span class="line">ScaleIO Volumes</span><br></pre></td></tr></table></figure><h2 id="Persistent-Volumes"><a href="#Persistent-Volumes" class="headerlink" title="Persistent Volumes"></a>Persistent Volumes</h2><p>每个PV包含了Spec和Staus, 在PV的定义中指定该内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv0003</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: slow</span><br><span class="line">  nfs:</span><br><span class="line">    path: /tmp</span><br><span class="line">    server: 172.17.0.2</span><br></pre></td></tr></table></figure><p><strong>Capacity</strong></p><p>通常，PV将具有特定的存储容量。 这是使用PV的容量属性设置的。 看到库伯纳斯资源模型，以了解容量预期的单位。</p><p>目前，存储大小是唯一可以设置或请求的资源。 未来的属性可能包括IOPS，吞吐量等</p><p><strong>Access Modes</strong></p><p>PersistentVolume可以以资源提供者支持的任何方式安装在主机上。 如下表所示，提供商将具有不同的功能，每个PV的访问模式都被设置为该特定卷支持的特定模式。 例如，NFS可以支持多个读/写客户端，但是特定的NFS PV可能会以只读方式在服务器上导出。 每个PV都有自己的一组访问模式来描述具体的PV功能。<br>访问模式:<br>ReadWriteOnce – the volume can be mounted as read-write by a single node (单node的读写)<br>ReadOnlyMany – the volume can be mounted read-only by many nodes (多node的只读)<br>ReadWriteMany – the volume can be mounted as read-write by many nodes (多node的读写)<br>Notice:单个PV挂载的时候只支持一种访问模式<br>PV提供插件支持的access mode参考kubernetes官方文档</p><p><strong>Class</strong></p><p>PV可以有一个类，通过将storageClassName属性设置为StorageClass的名称来指定。 特定类的PV只能绑定到请求该类的PVC。 没有storageClassName的PV没有类，只能绑定到不需要特定类的PVC。<br>在过去，使用了注释volume.beta.kubernetes.io/storage-class而不是storageClassName属性。 该注释仍然可以工作，但将来Kubernetes版本将不再适用。</p><p><strong>Reclaim Policy</strong></p><p>目前的回收政策是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Retain – manual reclamation </span><br><span class="line">Recycle – basic scrub (“rm -rf /thevolume/*”) </span><br><span class="line">Delete – associated storage asset such as AWS EBS, GCE PD, Azure Disk, or OpenStack Cinder volume is deleted</span><br></pre></td></tr></table></figure><p>目前，只有NFS和HostPath支持回收。 AWS EBS，GCE PD，Azure Disk和Cinder卷支持删除</p><p><strong>Phase</strong></p><p>卷将处于以下阶段之一：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Available – a free resource that is not yet bound to a claim </span><br><span class="line">Bound – the volume is bound to a claim </span><br><span class="line">Released – the claim has been deleted, but the resource is not yet reclaimed by the cluster </span><br><span class="line">Failed – the volume has failed its automatic reclamation</span><br></pre></td></tr></table></figure><h2 id="PersistentVolumeClaims"><a href="#PersistentVolumeClaims" class="headerlink" title="PersistentVolumeClaims"></a>PersistentVolumeClaims</h2><p>每个PVC包含spec和status</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: myclaim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 8Gi</span><br><span class="line">  storageClassName: slow</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      release: &quot;stable&quot;</span><br><span class="line">    matchExpressions:</span><br><span class="line">      - &#123;key: environment, operator: In, values: [dev]&#125;</span><br></pre></td></tr></table></figure><p><strong>Access Modes</strong></p><p>当请求具有特定访问模式的存储时，声明使用与卷相同的约定</p><p><strong>Resources</strong></p><p>声明（如pod）可以请求特定数量的资源。 在这种情况下，请求用于存储。 相同的资源模型适用于卷和声明</p><p><strong>Selector</strong></p><p>声明可以指定标签选择器以进一步过滤该卷集。 只有标签与选择器匹配的卷才能绑定到声明。 选择器可以由两个字段组成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matchLabels - 卷必须具有带此值的标签</span><br><span class="line">matchExpressions - 通过指定关键字和值的关键字，值列表和运算符所做的要求列表。 有效运算符包括In，NotIn，Exists和DoesNotExist。</span><br></pre></td></tr></table></figure><p>所有来自matchLabels和matchExpressions的要求都与AND一起使用，所有这些要求都必须满足才能匹配。</p><p><strong>Class</strong></p><p>声明可以通过使用属性storageClassName指定StorageClass的名称来请求特定的类。只有所请求的类的PV，与PVC相同的storageClassName的PV可以绑定到PVC。</p><p>PVC不一定要求一个班级。它的storageClassName设置为等于“”的PVC总是被解释为请求没有类的PV，因此它只能绑定到没有类的PV（没有注释或一个等于“”）。没有storageClassName的PVC不完全相同，并且根据是否启用了DefaultStorageClass入门插件，集群的处理方式不同。</p><p>如果接纳插件已打开，则管理员可以指定默认的StorageClass。没有storageClassName的所有PVC只能绑定到该默认的PV。通过将StorageClass对象中的annotation storageclass.kubernetes.io/is-default-class设置为“true”来指定默认的StorageClass。如果管理员没有指定默认值，则集群会对PVC创建做出响应，就像入门插件被关闭一样。如果指定了多个默认值，则验收插件禁止创建所有PVC。<br>如果入门插件已关闭，则不存在默认StorageClass的概念。没有storageClassName的所有PVC只能绑定到没有类的PV。在这种情况下，没有storageClassName的PVC的处理方式与将其storageClassName设置为“”的PVC相同。</p><p>根据安装方法，安装过程中可以通过addon manager在Kubernetes群集中部署默认的StorageClass。</p><p>当PVC指定一个选择器，除了请求一个StorageClass之外，这些要求被AND组合在一起：只有所请求的类和所请求的标签的PV可能被绑定到PVC。请注意，当前，具有非空选择器的PVC不能为其动态配置PV。</p><p>在过去，使用了注释volume.beta.kubernetes.io/storage-class，而不是storageClassName属性。该注释仍然可以工作，但在未来的Kubernetes版本中它将不被支持。</p><p><strong>声明PVC作为Volumes</strong></p><p>Pods通过将声明用作卷来访问存储。 声明必须存在于与使用声明的pod相同的命名空间中。 群集在pod的命名空间中查找声明，并使用它来获取支持声明的PersistentVolume。 然后将体积安装到主机并进入Pod。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: myfrontend</span><br><span class="line">      image: dockerfile/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">      - mountPath: &quot;/var/www/html&quot;</span><br><span class="line">        name: mypd</span><br><span class="line">  volumes:</span><br><span class="line">    - name: mypd</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: myclaim</span><br></pre></td></tr></table></figure><p>PersistentVolumes绑定是独占的，并且由于PersistentVolumeClaims是命名空间对象，所以只能在一个命名空间内安装“许多”模式（ROX，RWX）—PVC支持被多个pod挂载</p><h2 id="StorageClasses"><a href="#StorageClasses" class="headerlink" title="StorageClasses"></a>StorageClasses</h2><p>每个StorageClass包含字段provisioninger和参数，当属于类的PersistentVolume需要动态配置时使用。</p><p>StorageClass对象的名称很重要，用户可以如何请求特定的类。 管理员在首次创建StorageClass对象时设置类的名称和其他参数，并且在创建对象后无法更新对象。</p><p>管理员可以仅为不要求任何特定类绑定的PVC指定默认的StorageClass：有关详细信息，请参阅PersistentVolumeClaim部分。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: standard</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  type: gp2</span><br></pre></td></tr></table></figure><p><strong>Provisioner</strong></p><p>存储类有一个供应商，它确定用于配置PV的卷插件。 必须指定此字段。</p><p>您不限于指定此处列出的“内部”供应商（其名称前缀为“kubernetes.io”并与Kubernetes一起运送）。 您还可以运行和指定外部提供程序，它们是遵循Kubernetes定义的规范的独立程序。 外部提供者的作者对代码的生命周期，供应商的运输状况，运行状况以及使用的卷插件（包括Flex）等都有充分的自主权。存储库kubernetes-incubator /外部存储库包含一个库 用于编写实施大部分规范的外部提供者以及各种社区维护的外部提供者。</p><p><strong>Parameters</strong></p><p>存储类具有描述属于存储类的卷的参数。 取决于供应商，可以接受不同的参数。 例如，参数类型的值io1和参数iopsPerGB特定于EBS。 当省略参数时，使用一些默认值。</p><p>AWS/GCE/Glusterfs/</p><p>OpenStack Cinder</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: gold</span><br><span class="line">provisioner: kubernetes.io/cinder</span><br><span class="line">parameters:</span><br><span class="line">  type: fast</span><br><span class="line">  availability: nova</span><br><span class="line">type: VolumeType created in Cinder. Default is empty. </span><br><span class="line">availability: Availability Zone. If not specified, volumes are generally round-robin-ed across all active zones where Kubernetes cluster has a node.</span><br></pre></td></tr></table></figure><p>其它类型的storageClass配置参考</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</span><br></pre></td></tr></table></figure><p><strong>配置</strong></p><p>如果您正在编写在各种群集上运行并需要持久存储的配置模板或示例，我们建议您使用以下模式：</p><p>在您的配置文件夹（包括部署，ConfigMaps等）中包含PersistentVolumeClaim对象。<br>在配置中不要包含PersistentVolume对象，因为实例化配置的用户可能没有创建PersistentVolumes的权限。<br>给用户提供实例化模板时提供存储类名称的选项。<br>１．　如果用户提供存储类名称，并且集群是1.4或更高版本，请将该值放入PVC的volume.beta.kubernetes.io/storage-class注释中。如果集群的管理员启用了StorageClasses，这将导致PVC与正确的存储类匹配。<br>２．　如果用户不提供存储类名称或者集群是版本1.3，那么在PVC上放置一个volume.alpha.kubernetes.io/storage-class：default注释。<br>这将导致在某些群集上为用户自动配置PV，并具有合理的默认特性。<br>尽管在名称中使用了alpha，但这个注释背后的代码具有beta级别的支持。<br>３．　不要使用volume.beta.kubernetes.io/storage-class：包含空字符串的任何值，因为它将阻止DefaultStorageClass接纳控制器运行（如果启用）。</p><p>在您的工具中，请注意在一段时间后未绑定的PVC，并将其表示给用户，因为这可能表明集群没有动态存储支持（在这种情况下，用户应创建匹配的PV）或集群没有存储系统（在这种情况下，用户无法部署需要PVC的配置）。</p><p>在将来，我们预计大多数集群都将启用DefaultStorageClass，并提供某种形式的存储。但是，可能没有任何存储类名可用于所有集群，因此默认情况下继续不设置。在某种程度上，alpha注释将不再有意义，但PVC上的未设置的storageClass字段将具有所需的效果。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.kubernetes.org.cn/pvpvcstorageclass&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.kubernetes.org.cn/pvpvcstorageclass&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/99e610067bc8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.jianshu.com/p/99e610067bc8&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;简书介绍&quot;&gt;&lt;a href=&quot;#简书介绍&quot; class=&quot;headerlink&quot; title=&quot;简书介绍&quot;&gt;&lt;/a&gt;简书介绍&lt;/h1&gt;&lt;p&gt;前面我们学习了Kubernetes中的Volume，我们可以发现前文中的Volume（无论何种类型）和使用它的Pod都是一种静态绑定关系，在Pod定义文件中，同时定义了它使用的Volume。在这种情况下，Volume是Pod的附属品，我们无法像创建其他资源（例如Pod，Node，Deployment等等）一样创建一个Volume。&lt;/p&gt;
&lt;p&gt;因此Kubernetes提出了PersistentVolume（PV）的概念。PersistentVolume和Volume一样，代表了集群中的一块存储区域，然而Kubernetes将PersistentVolume抽象成了一种集群资源，类似于集群中的Node对象，这意味着我们可以使用Kubernetes API来创建PersistentVolume对象。PV与Volume最大的不同是PV拥有着独立于Pod的生命周期。&lt;/p&gt;
&lt;p&gt;而PersistentVolumeClaim（PVC）代表了用户对PV资源的请求。用户需要使用PV资源时，只需要创建一个PVC对象（包括指定使用何种存储资源，使用多少GB，以何种模式使用PV等信息），Kubernetes会自动为我们分配我们所需的PV。如果把PersistentVolume类比成集群中的Node，那么PersistentVolumeClaim就相当于集群中的Pod，Kubernetes为Pod分配可用的Node，为PersistentVolumeClaim分配可用的PersistentVolume。&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="https://gongzhao1.coding.me/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="https://gongzhao1.coding.me/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群监控之pushgateway</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E4%B9%8Bpushgateway/"/>
    <id>https://gongzhao1.coding.me/Kubernetes集群监控之pushgateway/</id>
    <published>2020-02-20T08:20:35.000Z</published>
    <updated>2020-04-08T14:20:25.862Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.cnblogs.com/xiao987334176/p/9933963.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiao987334176/p/9933963.html</a></li><li><a href="https://www.jianshu.com/p/e59793e8c0c2" target="_blank" rel="noopener">https://www.jianshu.com/p/e59793e8c0c2</a></li></ul><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="https://github.com/prometheus/pushgateway" target="_blank" rel="noopener">Pushgateway</a> 是 Prometheus 生态中一个重要工具，使用它的原因主要是：</p><ul><li>Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。</li><li>在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。</li></ul><p>由于以上原因，不得不使用 pushgateway，但在使用之前，有必要了解一下它的一些弊端：</p><ul><li>将多个节点数据汇总到 pushgateway, 如果 pushgateway 挂了，受影响比多个 target 大。</li><li>Prometheus 拉取状态 <code>up</code> 只针对 pushgateway, 无法做到对每个节点有效。</li><li>Pushgateway 可以持久化推送给它的所有监控数据。</li></ul><p>因此，即使你的监控已经下线，prometheus 还会拉取到旧的监控数据，需要手动清理 pushgateway 不要的数据。 </p><p>拓扑图如下：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/23.png" alt="image"></p><a id="more"></a><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>基于docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom/pushgateway</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=pg \</span><br><span class="line">  -p 9091:9091 \</span><br><span class="line">  prom/pushgateway</span><br></pre></td></tr></table></figure><p>访问url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.91.132:9091/</span><br></pre></td></tr></table></figure><h1 id="配置prometheus"><a href="#配置prometheus" class="headerlink" title="配置prometheus"></a>配置prometheus</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     60s</span><br><span class="line">  evaluation_interval: 60s</span><br><span class="line"> </span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9090&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: prometheus</span><br><span class="line"> </span><br><span class="line">  - job_name: linux</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.91.132:9100&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: localhost</span><br><span class="line"></span><br><span class="line">  - job_name: pushgateway</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.91.132:9091&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: pushgateway</span><br></pre></td></tr></table></figure><h1 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h1><p>正常情况我们会使用 Client SDK 推送数据到 pushgateway, 但是我们还可以通过 API 来管理, 例如：</p><h2 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h2><p>向 {job=”some_job”} 添加单条数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;some_metric 3.14&quot; | curl -X POST --data-binary @- http://pushgateway.example.org:9091/metrics/job/some_job</span><br></pre></td></tr></table></figure><p> –data-binary 表示发送二进制数据，注意：它是使用POST方式发送的！</p><p>添加更多更复杂数据，通常数据会带上 instance, 表示来源位置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http://pushgateway.example.org:9091/metrics/job/some_job/instance/some_instance</span><br><span class="line"># TYPE some_metric counter</span><br><span class="line">some_metric&#123;label=&quot;val1&quot;&#125; 42</span><br><span class="line"># TYPE another_metric gauge</span><br><span class="line"># HELP another_metric Just an example.</span><br><span class="line">another_metric 2398.283</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>注意：必须是指定的格式才行！ </p><p>删除某个组下的某实例的所有数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://pushgateway.example.org:9091/metrics/job/some_job/instance/some_instance</span><br></pre></td></tr></table></figure><p>删除某个组下的所有数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE http://pushgateway.example.org:9091/metrics/job/some_job</span><br></pre></td></tr></table></figure><p>可以发现 pushgateway 中的数据我们通常按照 <code>job</code> 和 <code>instance</code> 分组分类，所以这两个参数不可缺少。</p><p>因为 Prometheus 配置 pushgateway 的时候，也会指定 job 和 instance, 但是它只表示 pushgateway 实例，不能真正表达收集数据的含义。所以在 prometheus 中配置 pushgateway 的时候，需要添加 <code>honor_labels: true</code> 参数， 从而避免收集数据本身的 <code>job</code> 和 <code>instance</code> 被覆盖。</p><p>注意，为了防止 pushgateway 重启或意外挂掉，导致数据丢失，我们可以通过 <code>-persistence.file</code> 和 <code>-persistence.interval</code> 参数将数据持久化下来。</p><h2 id="python脚本（flask）"><a href="#python脚本（flask）" class="headerlink" title="python脚本（flask）"></a>python脚本（flask）</h2><p><strong>安装模块</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install flask</span><br><span class="line">pip3 install prometheus_client</span><br></pre></td></tr></table></figure><h2 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h2><p>Prometheus提供4种类型Metrics：<code>Counter</code>, <code>Gauge</code>, <code>Summary</code>和<code>Histogram</code></p><p><strong>Counter</strong></p><p>Counter可以增长，并且在程序重启的时候会被重设为0，常被用于任务个数，总处理时间，错误个数等只增不减的指标。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import prometheus_client</span><br><span class="line">from prometheus_client import Counter</span><br><span class="line">from prometheus_client.core import CollectorRegistry</span><br><span class="line">from flask import Response, Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">requests_total = Counter(&quot;request_count&quot;, &quot;Total request cout of the host&quot;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;/metrics&quot;)</span><br><span class="line">def requests_count():</span><br><span class="line">    requests_total.inc()</span><br><span class="line">    # requests_total.inc(2)</span><br><span class="line">    return Response(prometheus_client.generate_latest(requests_total),</span><br><span class="line">                    mimetype=&quot;text/plain&quot;)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    requests_total.inc()</span><br><span class="line">    return &quot;Hello World&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run(host=&quot;0.0.0.0&quot;)</span><br></pre></td></tr></table></figure><p>运行该脚本，访问youhost:5000/metrics</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP request_count Total request cout of the host</span><br><span class="line"># TYPE request_count counter</span><br><span class="line">request_count 3.0</span><br></pre></td></tr></table></figure><p><strong>Gauge</strong></p><p>Gauge与Counter类似，唯一不同的是Gauge数值可以减少，常被用于温度、利用率等指标。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">import prometheus_client</span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">from flask import Response, Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">random_value = Gauge(&quot;random_value&quot;, &quot;Random value of the request&quot;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;/metrics&quot;)</span><br><span class="line">def r_value():</span><br><span class="line">    random_value.set(random.randint(0, 10))</span><br><span class="line">    return Response(prometheus_client.generate_latest(random_value),</span><br><span class="line">                    mimetype=&quot;text/plain&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run(host=&quot;0.0.0.0&quot;)</span><br></pre></td></tr></table></figure><p>运行该脚本，访问youhost:5000/metrics</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP random_value Random value of the request</span><br><span class="line"># TYPE random_value gauge</span><br><span class="line">random_value 3.0</span><br></pre></td></tr></table></figure><p><strong>Summary/Histogram</strong></p><p>Summary/Histogram概念比较复杂，一般exporter很难用到，暂且不说。</p><h2 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h2><p>使用labels来区分metric的特征</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from prometheus_client import Counter</span><br><span class="line"></span><br><span class="line">c = Counter(&apos;requests_total&apos;, &apos;HTTP requests total&apos;, [&apos;method&apos;, &apos;clientip&apos;])</span><br><span class="line"></span><br><span class="line">c.labels(&apos;get&apos;, &apos;127.0.0.1&apos;).inc()</span><br><span class="line">c.labels(&apos;post&apos;, &apos;192.168.0.1&apos;).inc(3)</span><br><span class="line">c.labels(method=&quot;get&quot;, clientip=&quot;192.168.0.1&quot;).inc()</span><br></pre></td></tr></table></figure><p><strong>REGISTRY</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from prometheus_client import Counter, Gauge</span><br><span class="line">from prometheus_client.core import CollectorRegistry</span><br><span class="line"></span><br><span class="line">REGISTRY = CollectorRegistry(auto_describe=False)</span><br><span class="line"></span><br><span class="line">requests_total = Counter(&quot;request_count&quot;, &quot;Total request cout of the host&quot;, registry=REGISTRY)</span><br><span class="line">random_value = Gauge(&quot;random_value&quot;, &quot;Random value of the request&quot;, registry=REGISTRY)</span><br></pre></td></tr></table></figure><h1 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h1><h2 id="网卡流量"><a href="#网卡流量" class="headerlink" title="网卡流量"></a>网卡流量</h2><p>先访问这篇文章《python 获取网卡实时流量》：<a href="http://www.py3study.com/Article/details/id/347.html" target="_blank" rel="noopener">http://www.py3study.com/Article/details/id/347.html</a></p><p>下面这段python脚本，主要是参考上面文章的基础上修改的</p><p>发送本机网卡流量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">import prometheus_client</span><br><span class="line">from prometheus_client import Counter</span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">from prometheus_client.core import CollectorRegistry</span><br><span class="line">import psutil</span><br><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">def get_key():</span><br><span class="line">    key_info = psutil.net_io_counters(pernic=True).keys()</span><br><span class="line"></span><br><span class="line">    recv = &#123;&#125;</span><br><span class="line">    sent = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    for key in key_info:</span><br><span class="line">        recv.setdefault(key, psutil.net_io_counters(pernic=True).get(key).bytes_recv)</span><br><span class="line">        sent.setdefault(key, psutil.net_io_counters(pernic=True).get(key).bytes_sent)</span><br><span class="line"></span><br><span class="line">    return key_info, recv, sent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_rate(func):</span><br><span class="line">    import time</span><br><span class="line"></span><br><span class="line">    key_info, old_recv, old_sent = func()</span><br><span class="line"></span><br><span class="line">    time.sleep(1)</span><br><span class="line"></span><br><span class="line">    key_info, now_recv, now_sent = func()</span><br><span class="line"></span><br><span class="line">    net_in = &#123;&#125;</span><br><span class="line">    net_out = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    for key in key_info:</span><br><span class="line">        # float(&apos;%.2f&apos; % a)</span><br><span class="line">        # net_in.setdefault(key, float(&apos;%.2f&apos; %((now_recv.get(key) - old_recv.get(key)) / 1024)))</span><br><span class="line">        # net_out.setdefault(key, float(&apos;%.2f&apos; %((now_sent.get(key) - old_sent.get(key)) / 1024)))</span><br><span class="line"></span><br><span class="line">        # 计算流量</span><br><span class="line">        net_in.setdefault(key, now_recv.get(key) - old_recv.get(key))</span><br><span class="line">        net_out.setdefault(key, now_sent.get(key) - old_sent.get(key))</span><br><span class="line"></span><br><span class="line">    return key_info, net_in, net_out</span><br><span class="line"></span><br><span class="line"># def get_host_ip():</span><br><span class="line">#     &quot;&quot;&quot;</span><br><span class="line">#     查询本机ip地址,针对单网卡</span><br><span class="line">#     :return: ip</span><br><span class="line">#     &quot;&quot;&quot;</span><br><span class="line">#     try:</span><br><span class="line">#         s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">#         s.connect((&apos;8.8.8.8&apos;, 80))</span><br><span class="line">#         ip = s.getsockname()[0]</span><br><span class="line">#     finally:</span><br><span class="line">#         s.close()</span><br><span class="line">#         return ip</span><br><span class="line"></span><br><span class="line"># 打印多网卡 mac 和 ip 信息</span><br><span class="line">def PrintNetIfAddr():</span><br><span class="line">    dic = psutil.net_if_addrs()</span><br><span class="line">    net_dic = &#123;&#125;</span><br><span class="line">    net_dic[&apos;no_ip&apos;] = []  # 无ip的网卡列表</span><br><span class="line">    for adapter in dic:</span><br><span class="line">        snicList = dic[adapter]</span><br><span class="line">        mac = &apos;无 mac 地址&apos;</span><br><span class="line">        ipv4 = &apos;无 ipv4 地址&apos;</span><br><span class="line">        ipv6 = &apos;无 ipv6 地址&apos;</span><br><span class="line">        for snic in snicList:</span><br><span class="line">            if snic.family.name in &#123;&apos;AF_LINK&apos;, &apos;AF_PACKET&apos;&#125;:</span><br><span class="line">                mac = snic.address</span><br><span class="line">            elif snic.family.name == &apos;AF_INET&apos;:</span><br><span class="line">                ipv4 = snic.address</span><br><span class="line">            elif snic.family.name == &apos;AF_INET6&apos;:</span><br><span class="line">                ipv6 = snic.address</span><br><span class="line">        # print(&apos;%s, %s, %s, %s&apos; % (adapter, mac, ipv4, ipv6))</span><br><span class="line"></span><br><span class="line">        # 判断网卡名不在net_dic中时,并且网卡不是lo</span><br><span class="line">        if adapter not in net_dic and adapter != &apos;lo&apos;:</span><br><span class="line">            if not ipv4.startswith(&quot;无&quot;):  # 判断ip地址不是以无开头</span><br><span class="line">                net_dic[adapter] = ipv4  # 增加键值对</span><br><span class="line">            else:</span><br><span class="line">                net_dic[&apos;no_ip&apos;].append(adapter)  # 无ip的网卡</span><br><span class="line"></span><br><span class="line">    # print(net_dic)</span><br><span class="line">    return net_dic</span><br><span class="line"></span><br><span class="line">key_info, net_in, net_out = get_rate(get_key)</span><br><span class="line"></span><br><span class="line"># ip=get_host_ip()  # 本机ip</span><br><span class="line">hostname = socket.gethostname() # 主机名</span><br><span class="line"></span><br><span class="line">REGISTRY = CollectorRegistry(auto_describe=False)</span><br><span class="line">input = Gauge(&quot;network_traffic_input&quot;, hostname,[&apos;adapter_name&apos;,&apos;unit&apos;,&apos;ip&apos;,&apos;instance&apos;],registry=REGISTRY)  # 流入</span><br><span class="line">output = Gauge(&quot;network_traffic_output&quot;, hostname,[&apos;adapter_name&apos;,&apos;unit&apos;,&apos;ip&apos;,&apos;instance&apos;],registry=REGISTRY)  # 流出</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for key in key_info:</span><br><span class="line">    net_addr = PrintNetIfAddr()</span><br><span class="line">    # 判断网卡不是lo(回环网卡)以及 不是无ip的网卡</span><br><span class="line">    if key != &apos;lo&apos; and  key not in net_addr[&apos;no_ip&apos;]:</span><br><span class="line">        # 流入和流出</span><br><span class="line">        input.labels(ip=net_addr[key],adapter_name=key, unit=&quot;Byte&quot;,instance=hostname).inc(net_in.get(key))</span><br><span class="line">        output.labels(ip=net_addr[key],adapter_name=key, unit=&quot;Byte&quot;,instance=hostname).inc(net_out.get(key))</span><br><span class="line"></span><br><span class="line">requests.post(&quot;http://192.168.91.132:9091/metrics/job/network_traffic&quot;,data=prometheus_client.generate_latest(REGISTRY))</span><br><span class="line">print(&quot;发送了一次网卡流量数据&quot;)</span><br></pre></td></tr></table></figure><p>执行脚本，它会发送1次数据给Push Gateway</p><p>取到的流量没有除以1024，所以默认是字节</p><p><strong>注意：发送的链接，约定成俗的格式如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://Pushgateway地址:9091/metrics/job/监控项目</span><br></pre></td></tr></table></figure><p>比如监控etcd，地址就是这样的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://Pushgateway地址:9091/metrics/job/etcd</span><br></pre></td></tr></table></figure><h3 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h3><p>关键代码，就是这几行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REGISTRY = CollectorRegistry(auto_describe=False)</span><br><span class="line">input = Gauge(&quot;network_traffic_input&quot;, hostname,[&apos;adapter_name&apos;,&apos;unit&apos;,&apos;ip&apos;,&apos;instance&apos;],registry=REGISTRY)  # 流入</span><br><span class="line">output = Gauge(&quot;network_traffic_output&quot;, hostname,[&apos;adapter_name&apos;,&apos;unit&apos;,&apos;ip&apos;,&apos;instance&apos;],registry=REGISTRY)  # 流出</span><br><span class="line"></span><br><span class="line">input.labels(ip=net_addr[key],adapter_name=key, unit=&quot;Byte&quot;,instance=hostname).inc(net_in.get(key))</span><br><span class="line">output.labels(ip=net_addr[key],adapter_name=key, unit=&quot;Byte&quot;,instance=hostname).inc(net_out.get(key))</span><br></pre></td></tr></table></figure><p>1、自定义的指标收集类都必须到CollectorRegistry进行注册， 指标数据通过CollectorRegistry类的方法或者函数，返回给Prometheus.<br>2、CollectorRegistry必须提供register()和unregister()函数，一个指标收集器可以注册多个CollectorRegistry.<br>3、客户端库必须是线程安全的</p><p>代码第一行，声明了CollectorRegistry</p><p>input和output是流入流出的流量。Metrics使用的是Gauge</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input = Gauge(&quot;network_traffic_input&quot;, hostname,[&apos;adapter_name&apos;,&apos;unit&apos;,&apos;ip&apos;,&apos;instance&apos;],registry=REGISTRY)  # 流入</span><br></pre></td></tr></table></figure><p>network_traffic_input表示键值，它必须唯一。因为在grafana图表中，要用这个键值绘制图表。</p><p>“” 为空，它其实对应的是描述信息。为了避免数据冗长，一般不写它。</p><p>[‘adapter_name’,’unit’,’ip’,’instance’] ，它是一个列表，里面每一个元素都是labels，它是用来区分metric的特征</p><p>registry=REGISTRY 把数据注册到REGISTRY中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.labels(ip=net_addr[key],adapter_name=key, unit=&quot;Byte&quot;,instance=hostname).inc(net_in.get(key))</span><br></pre></td></tr></table></figure><p>这里定义了input的labels，括号里面有3个键值对。<strong>注意：这3个键值对必须在[‘adapter_name’,’unit’,’ip’] 列表中。</strong></p><p>如果labels中要增加键值对，那么上面的列表中，也要增加对应的元素。否则会报错！</p><p>inc表示具体值。它对应的是input</p><p>刷新Push Gateway页面<code>IP:9091</code> 就可以看到流入流出的数据了</p><h2 id="python脚本（非flask）"><a href="#python脚本（非flask）" class="headerlink" title="python脚本（非flask）"></a>python脚本（非flask）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from prometheus_client import CollectorRegistry, Gauge, pushadd_to_gateway</span><br><span class="line"></span><br><span class="line">def push2gateway(datas):</span><br><span class="line"></span><br><span class="line">    registry = CollectorRegistry()</span><br><span class="line"></span><br><span class="line">    g = Gauge(&apos;node_process_status_info&apos;,&apos;process monitor&apos;,[&apos;group&apos;,&apos;process_name&apos;,&apos;status&apos;,&apos;days&apos;,&apos;icon&apos;],registry=registry)</span><br><span class="line"></span><br><span class="line">    for group,process,status,runtime,icon in datas:</span><br><span class="line"></span><br><span class="line">        print group,process,status,runtime,icon</span><br><span class="line"></span><br><span class="line">        g.labels(group,process,status,str(runtime),icon).set(icon)</span><br><span class="line"></span><br><span class="line">    pushadd_to_gateway(&apos;10.10.148.34:9091&apos;, job=&apos;pushgateway&apos; ,registry=registry,timeout=200)</span><br></pre></td></tr></table></figure><p>以上函数中，</p><p>node_process_status_info 表示指标名</p><p>list参数中的值表示标签名</p><p>循环只是为了给同一个指标的不同标签设置不同的value</p><p>g.labels括号中表示按顺序为标签名赋值</p><p>g.labels末尾的set表示该标签下的value值</p><p>最后推送的时候指标越多,timeout应该设置越高，否则会推送失败，具体时间根据现场网络状况测试一下就知道了</p><p><strong>完整的案例，检测URL返回状态码并推送到pushgateway</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">from prometheus_client import CollectorRegistry, Gauge, pushadd_to_gateway</span><br><span class="line"></span><br><span class="line">url = &apos;[http://10.10.164.119:8500/v1/a/b/net.c.api.d](http://10.10.164.119:8500/v1/a/b/net.c.api.d)&apos;</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line"></span><br><span class="line">    &quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36 QIHU 360SE&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_code = requests.get(url,headers=headers).status_code</span><br><span class="line"></span><br><span class="line">print status_code</span><br><span class="line"></span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line"></span><br><span class="line">g = Gauge(&apos;node_web_status_code&apos;,&apos;web monitor&apos;,[&apos;url&apos;],registry=registry)</span><br><span class="line"></span><br><span class="line">g.labels(url).set(status_code)</span><br><span class="line"></span><br><span class="line">pushadd_to_gateway(&apos;10.10.148.34:9091&apos;, job=&apos;pushgateway&apos; ,registry=registry,timeout=200)</span><br></pre></td></tr></table></figure><p><strong>注意</strong>:</p><blockquote><p>使用prometheus_client推送到pushgateway的时候，如果你的指标拥有多个标签，并且在循环里写入了很多次推送，但是在pushgateway中往往只能看到最后一个，这大概是因为pushgateway推送的时候相同的指标名(job名)是以覆盖的方式进行的（具体没有更多研究和验证，我的问题解决便放下了）。所以这个时候可以将pushadd_to_gateway放在指标注册的最后，如下：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def findpush(path,g):</span><br><span class="line">    output = os.popen(&apos;hadoop fs -du -h %s&apos;%path)</span><br><span class="line">    for line in output.readlines():</span><br><span class="line">        row = filter(lambda x:x,map(lambda x:x.strip().replace(&quot; &quot;,&quot;&quot;),line.split(&quot;  &quot;)))</span><br><span class="line">        row_info =  (conversion(row[0]),conversion(row[1]),row[2])</span><br><span class="line">        g.labels(row_info[2],&apos;false&apos;).set(row_info[0])</span><br><span class="line">        g.labels(row_info[2],&apos;true&apos;).set(row_info[1])</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    registry = CollectorRegistry()</span><br><span class="line">    g = Gauge(&apos;hadoop_hdfs_du_filesize_metrics&apos;,&apos;hdfs filepath filesize from hadoop fs du&apos;,[&apos;path&apos;,&apos;backupornot&apos;],registry=registry)</span><br><span class="line"></span><br><span class="line">    for path in paths:</span><br><span class="line">        findpush(path,g)</span><br><span class="line">    pushadd_to_gateway(&apos;pushgateway的IP地址:9091&apos;, job=&apos;custom&apos; ,registry=g,timeout=200)</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用Prometheus监控，有2中方式</p><ol><li><p>暴露http方式的Metrics，注意：需要在Prometheus的配置文件中添加job</p></li><li><p>主动发送数据到Pushgateway，注意：只需要添加一个Pushgateway就可以了。它相当于一个API，无论有多少个服务器，发送到统一的地址。</p></li></ol><p>生产环境中，一般使用Pushgateway，简单，也不需要修改Prometheus的配置文件！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/xiao987334176/p/9933963.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/xiao987334176/p/9933963.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/e59793e8c0c2&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.jianshu.com/p/e59793e8c0c2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/prometheus/pushgateway&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Pushgateway&lt;/a&gt; 是 Prometheus 生态中一个重要工具，使用它的原因主要是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。&lt;/li&gt;
&lt;li&gt;在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于以上原因，不得不使用 pushgateway，但在使用之前，有必要了解一下它的一些弊端：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将多个节点数据汇总到 pushgateway, 如果 pushgateway 挂了，受影响比多个 target 大。&lt;/li&gt;
&lt;li&gt;Prometheus 拉取状态 &lt;code&gt;up&lt;/code&gt; 只针对 pushgateway, 无法做到对每个节点有效。&lt;/li&gt;
&lt;li&gt;Pushgateway 可以持久化推送给它的所有监控数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因此，即使你的监控已经下线，prometheus 还会拉取到旧的监控数据，需要手动清理 pushgateway 不要的数据。 &lt;/p&gt;
&lt;p&gt;拓扑图如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/23.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://gongzhao1.coding.me/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="prometheus" scheme="https://gongzhao1.coding.me/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群监控之exporter</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E4%B9%8Bexporter/"/>
    <id>https://gongzhao1.coding.me/Kubernetes集群监控之exporter/</id>
    <published>2020-02-19T10:57:27.000Z</published>
    <updated>2020-04-08T14:20:25.845Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/exporters/</a></p><p>blackbox_exporter:</p><ul><li><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">https://github.com/prometheus/blackbox_exporter</a></li><li><a href="https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter" target="_blank" rel="noopener">https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter</a></li><li><a href="https://blog.csdn.net/qq_25934401/article/details/84325356" target="_blank" rel="noopener">https://blog.csdn.net/qq_25934401/article/details/84325356</a></li></ul><p>node_exporter</p><ul><li><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter</a></li><li><a href="https://www.cnblogs.com/bigberg/p/10118137.html" target="_blank" rel="noopener">https://www.cnblogs.com/bigberg/p/10118137.html</a></li></ul><p>mysql_exporter:</p><ul><li><a href="https://github.com/prometheus/mysqld_exporter" target="_blank" rel="noopener">https://github.com/prometheus/mysqld_exporter</a></li></ul><p>jmx_exporter:</p><ul><li><a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">https://github.com/prometheus/jmx_exporter</a></li><li><a href="https://www.cnblogs.com/caizhenghui/p/9132414.html" target="_blank" rel="noopener">https://www.cnblogs.com/caizhenghui/p/9132414.html</a></li></ul><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>大部分exporter都可以在<a href="https://github.com/prometheus中搜到" target="_blank" rel="noopener">https://github.com/prometheus中搜到</a></p><p>以及可以使用<code>helm search node-exporter</code>来进行搜索</p><a id="more"></a><h1 id="blackbox-exporter黑盒监测"><a href="#blackbox-exporter黑盒监测" class="headerlink" title="blackbox_exporter黑盒监测"></a>blackbox_exporter黑盒监测</h1><p>Prometheus 官方提供的 exporter 之一，可以提供 http、dns、tcp、icmp 的监控数据采集</p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p><strong>安装包部署</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[sss@prometheus01 ]$ cd /usr/local/blackbox_exporter/</span><br><span class="line">[sss@prometheus01 ]$ wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.12.0/blackbox_exporter-0.12.0.linux-amd64.tar.gz </span><br><span class="line">[sss@prometheus01 ]$ tar zxvf blackbox_exporter-0.12.0.linux-amd64.tar.gz</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ cd blackbox_exporter-0.12.0.linux-amd64</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ ll</span><br><span class="line">total 15720</span><br><span class="line">-rwxr-xr-x. 1 1000 1000 16074005 Feb 27  2018 blackbox_exporter</span><br><span class="line">-rw-rw-r--. 1 1000 1000      932 Nov 21 16:05 blackbox.yml</span><br><span class="line">-rw-rw-r--. 1 1000 1000    11357 Feb 27  2018 LICENSE</span><br><span class="line">-rw-rw-r--. 1 1000 1000       94 Feb 27  2018 NOTICE</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$cp -r blackbox_exporter /usr/local/bin</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ cat /etc/supervisord.conf|grep blackbox -A 20</span><br><span class="line">[program:blackbox_exporter]</span><br><span class="line">command=/usr/local/bin/blackbox_exporter   --config.file=/usr/local/prometheus/blackbox_exporter/blackbox_exporter-0.12.0.linux-amd64/blackbox.yml </span><br><span class="line">stdout_logfile=/tmp/prometheus/blackbox_exporter.log</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=5</span><br><span class="line">priority=1</span><br><span class="line">user=root</span><br><span class="line">stopasgroup=true</span><br><span class="line">killasgroup=true</span><br><span class="line">[sss@prometheus01 blackbox_exporter-0.12.0.linux-amd64]$ supervisorctl  status |grep blackbox</span><br><span class="line">blackbox_exporter                RUNNING   pid 25343, uptime 0:19:25</span><br></pre></td></tr></table></figure><p>blackbox的配置文件</p><ul><li>通过 blackbox.yml 定义模块详细信息</li><li>在 Prometheus 配置文件中引用该模块以及配置被监控目标主机</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">modules:</span><br><span class="line">  http_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 10s</span><br><span class="line">    http:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot; ##如果http监测是使用ipv4 就要写上，目前国内使用ipv6很少。</span><br><span class="line">  http_post_2xx_query: ##用于post请求使用的模块）由于每个接口传参不同 可以定义多个module 用于不同接口（例如此命名为http_post_2xx_query 用于监测query.action接口 </span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 15s</span><br><span class="line">    http:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot; ##使用ipv4</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Content-Type: application/json ##header头</span><br><span class="line">      body: &apos;&#123;&quot;hmac&quot;:&quot;&quot;,&quot;params&quot;:&#123;&quot;publicFundsKeyWords&quot;:&quot;xxx&quot;&#125;&#125;&apos; ##传参</span><br><span class="line">  tcp_connect:</span><br><span class="line">    prober: tcp</span><br><span class="line">  pop3s_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^+OK&quot;</span><br><span class="line">      tls: true</span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: false</span><br><span class="line">  ssh_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^SSH-2.0-&quot;</span><br><span class="line">  irc_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - send: &quot;NICK prober&quot;</span><br><span class="line">      - send: &quot;USER prober prober prober :prober&quot;</span><br><span class="line">      - expect: &quot;PING :([^ ]+)&quot;</span><br><span class="line">        send: &quot;PONG $&#123;1&#125;&quot;</span><br><span class="line">      - expect: &quot;^:[^ ]+ 001&quot;</span><br><span class="line">  icmp:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br></pre></td></tr></table></figure><p><strong>在kubernetes集群中部署</strong></p><p>blackbox_exporter-deploy.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus-blackbox-exporter</span><br><span class="line">        image: prom/blackbox-exporter:v0.16.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: 50Mi</span><br><span class="line">            cpu: 50m</span><br><span class="line">          limits:</span><br><span class="line">            memory: 60Mi</span><br><span class="line">            cpu: 100m</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /etc/blackbox_exporter</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/etc/blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --web.listen-address=:9115</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-blackbox-exporter</span><br><span class="line">          </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">  - name: blackbox</span><br><span class="line">    port: 9115</span><br><span class="line">    targetPort: 9115</span><br><span class="line">    protocol: TCP</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          valid_status_codes: []</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      http_post_2xx: # http post 监测模块</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          method: POST</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 10s</span><br><span class="line">      icmp:</span><br><span class="line">        prober: icmp</span><br><span class="line">        timeout: 10s</span><br><span class="line">        icmp:</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br></pre></td></tr></table></figure><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li><p>HTTP 测试</p><p>定义 Request Header 信息<br>判断 Http status / Http Respones Header / Http Body 内容</p></li><li><p>TCP 测试</p><p>业务组件端口状态监听</p><p>应用层协议定义与监听</p></li><li><p>ICMP 测试</p><p>主机探活机制</p></li><li><p>POST 测试</p><p>接口联通性</p></li><li><p>SSL 证书过期时间</p></li></ul><h3 id="http测试"><a href="#http测试" class="headerlink" title="http测试"></a>http测试</h3><ul><li>相关代码块添加到 Prometheus 文件内</li><li>对应 blackbox.yml文件的 http_2xx 模块</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox_http_2xx&apos;</span><br><span class="line">  scrape_interval: 45s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - https://www.baidu.com/</span><br><span class="line">        - 172.0.0.1:9090</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 10.XXX.XX.XX:9115  # The blackbox exporter&apos;s real hostname:port.</span><br></pre></td></tr></table></figure><h3 id="TCP-测试"><a href="#TCP-测试" class="headerlink" title="TCP 测试"></a>TCP 测试</h3><ul><li>监听 业务端口地址，用来判断服务是否在线，我觉的和telnet 差不多</li><li>相关代码块添加到 Prometheus 文件内</li><li>对应 blackbox.yml文件的 tcp_connect 模块</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;blackbox_telnet_port]&quot;</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets: [ &apos;1x3.x1.xx.xx4:443&apos; ]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;xxxidc机房ip监控&apos;</span><br><span class="line">      - targets: [&apos;10.xx.xx.xxx:443&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;Process status of nginx(main) server&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 10.xxx.xx.xx:9115</span><br></pre></td></tr></table></figure><h3 id="ICMP-测试"><a href="#ICMP-测试" class="headerlink" title="ICMP 测试"></a>ICMP 测试</h3><ul><li>相关代码块添加到 Prometheus 配置文件内</li><li>对应 blackbox.yml文件的 icmp 模块</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox00_ping_idc_ip&apos;</span><br><span class="line">  scrape_interval: 10s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [icmp]  #ping</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets: [ &apos;1x.xx.xx.xx&apos; ]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;xxnginx 虚拟IP&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        regex: (.*)(:80)?</span><br><span class="line">        target_label: __param_target</span><br><span class="line">        replacement: $&#123;1&#125;</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        regex: (.*)</span><br><span class="line">        target_label: ping</span><br><span class="line">        replacement: $&#123;1&#125;</span><br><span class="line">      - source_labels: []</span><br><span class="line">        regex: .*</span><br><span class="line">        target_label: __address__</span><br><span class="line">        replacement: 1x.xxx.xx.xx:9115</span><br></pre></td></tr></table></figure><h3 id="POST-测试"><a href="#POST-测试" class="headerlink" title="POST 测试"></a>POST 测试</h3><ul><li>监听业务接口地址，用来判断接口是否在线</li><li>相关代码块添加到 Prometheus 文件内</li><li>对应 blackbox.yml文件的 http_post_2xx_query 模块（监听query.action这个接口）</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;blackbox_http_2xx_post&apos;</span><br><span class="line">  scrape_interval: 10s</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [http_post_2xx_query]</span><br><span class="line">  static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - https://xx.xxx.com/api/xx/xx/fund/query.action</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;Interface monitoring&apos;</span><br><span class="line">  relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 1x.xx.xx.xx:9115  # The blackbox exporter&apos;s real hostname:port.</span><br></pre></td></tr></table></figure><h2 id="查看监听过程"><a href="#查看监听过程" class="headerlink" title="查看监听过程"></a>查看监听过程</h2><p>类似于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.10.65:9115/probe?target=prometheus.io&amp;module=http_2xx&amp;debug=true</span><br></pre></td></tr></table></figure><h2 id="告警应用测试"><a href="#告警应用测试" class="headerlink" title="告警应用测试"></a>告警应用测试</h2><p>icmp、tcp、http、post 监测是否正常可以观察probe_success 这一指标<br>probe_success == 0 ##联通性异常<br>probe_success == 1 ##联通性正常<br>告警也是判断这个指标是否等于0，如等于0 则触发异常报警</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[sss@prometheus01 prometheus]$ cat rules/blackbox-alert.rules </span><br><span class="line">groups:</span><br><span class="line">- name: blackbox_network_stats</span><br><span class="line">  rules:</span><br><span class="line">  - alert: blackbox_network_stats</span><br><span class="line">    expr: probe_success == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125;  is down&quot;</span><br><span class="line">      description: &quot;This requires immediate action!&quot;</span><br></pre></td></tr></table></figure><h3 id="SSL-证书过期时间监测"><a href="#SSL-证书过期时间监测" class="headerlink" title="SSL 证书过期时间监测"></a>SSL 证书过期时间监测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &apos;EOF&apos; &gt; prometheus.yml</span><br><span class="line">rule_files:</span><br><span class="line">  - ssl_expiry.rules</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;blackbox&apos;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - example.com  # Target to probe</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: 127.0.0.1:9115  # Blackbox exporter.</span><br><span class="line">        EOF </span><br><span class="line">cat &lt;&lt; &apos;EOF&apos; &gt; ssl_expiry.rules </span><br><span class="line">groups: </span><br><span class="line">  - name: ssl_expiry.rules </span><br><span class="line">    rules: </span><br><span class="line">      - alert: SSLCertExpiringSoon </span><br><span class="line">        expr: probe_ssl_earliest_cert_expiry&#123;job=&quot;blackbox&quot;&#125; - time() &lt; 86400 * 30 </span><br><span class="line">        for: 10m</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="自定义探针测试"><a href="#自定义探针测试" class="headerlink" title="自定义探针测试"></a>自定义探针测试</h3><p>HTTP服务通常会以不同的形式对外展现，有些可能就是一些简单的网页，而有些则可能是一些基于REST的API服务。 对于不同类型的HTTP的探测需要管理员能够对HTTP探针的行为进行更多的自定义设置，包括：HTTP请求方法、HTTP头信息、请求参数等。对于某些启用了安全认证的服务还需要能够对HTTP探测设置相应的Auth支持。对于HTTPS类型的服务还需要能够对证书进行自定义设置。</p><p>如下所示，这里通过method定义了探测时使用的请求方法，对于一些需要请求参数的服务，还可以通过headers定义相关的请求头信息，使用body定义请求内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http_post_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Content-Type: application/json</span><br><span class="line">      body: &apos;&#123;&#125;&apos;</span><br></pre></td></tr></table></figure><p>如果HTTP服务启用了安全认证，Blockbox Exporter内置了对basic_auth的支持，可以直接设置相关的认证信息即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http_basic_auth_example:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Host: &quot;login.example.com&quot;</span><br><span class="line">      basic_auth:</span><br><span class="line">        username: &quot;username&quot;</span><br><span class="line">        password: &quot;mysecret&quot;</span><br></pre></td></tr></table></figure><p> 对于使用了Bear Token的服务也可以通过bearer_token配置项直接指定令牌字符串，或者通过bearer_token_file指定令牌文件。</p><p>对于一些启用了HTTPS的服务，但是需要自定义证书的服务，可以通过tls_config指定相关的证书信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_custom_ca_example:</span><br><span class="line">   prober: http</span><br><span class="line">   http:</span><br><span class="line">     method: GET</span><br><span class="line">     tls_config:</span><br><span class="line">       ca_file: &quot;/certs/my_cert.crt&quot;</span><br></pre></td></tr></table></figure><h3 id="自定义探针行为"><a href="#自定义探针行为" class="headerlink" title="自定义探针行为"></a>自定义探针行为</h3><p>在默认情况下HTTP探针只会对HTTP返回状态码进行校验，如果状态码为2XX（200 &lt;= StatusCode &lt; 300）则表示探测成功，并且探针返回的指标probe_success值为1。</p><p>如果用户需要指定HTTP返回状态码，或者对HTTP版本有特殊要求，如下所示，可以使用valid_http_versions和valid_status_codes进行定义：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">    valid_status_codes: []</span><br></pre></td></tr></table></figure><p>默认情况下，Blockbox返回的样本数据中也会包含指标probe_http_ssl，用于表明当前探针是否使用了SSL：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP probe_http_ssl Indicates if SSL was used for the final redirect</span><br><span class="line"># TYPE probe_http_ssl gauge</span><br><span class="line">probe_http_ssl 0</span><br></pre></td></tr></table></figure><p>而如果用户对于HTTP服务是否启用SSL有强制的标准。则可以使用fail_if_ssl和fail_if_not_ssl进行配置。fail_if_ssl为true时，表示如果站点启用了SSL则探针失败，反之成功。fail_if_not_ssl刚好相反。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    valid_status_codes: []</span><br><span class="line">    method: GET</span><br><span class="line">    no_follow_redirects: false</span><br><span class="line">    fail_if_ssl: false</span><br><span class="line">    fail_if_not_ssl: false</span><br></pre></td></tr></table></figure><p>除了基于HTTP状态码，HTTP协议版本以及是否启用SSL作为控制探针探测行为成功与否的标准以外，还可以匹配HTTP服务的响应内容。使用fail_if_matches_regexp和fail_if_not_matches_regexp用户可以定义一组正则表达式，用于验证HTTP返回内容是否符合或者不符合正则表达式的内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http_2xx_example:</span><br><span class="line">  prober: http</span><br><span class="line">  timeout: 5s</span><br><span class="line">  http:</span><br><span class="line">    method: GET</span><br><span class="line">    fail_if_matches_regexp:</span><br><span class="line">      - &quot;Could not connect to database&quot;</span><br><span class="line">    fail_if_not_matches_regexp:</span><br><span class="line">      - &quot;Download the latest version here&quot;</span><br></pre></td></tr></table></figure><p>最后需要提醒的时，默认情况下HTTP探针会走IPV6的协议。 在大多数情况下，可以使用preferred_ip_protocol=ip4强制通过IPV4的方式进行探测。在Bloackbox响应的监控样本中，也会通过指标probe_ip_protocol，表明当前的协议使用情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6</span><br><span class="line"># TYPE probe_ip_protocol gauge</span><br><span class="line">probe_ip_protocol 6</span><br></pre></td></tr></table></figure><p>除了支持对HTTP协议进行网络探测以外，Blackbox还支持对TCP、DNS、ICMP等其他网络协议，感兴趣的读者可以从Blackbox的Github项目中获取更多使用信息.</p><h1 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h1><h2 id="功能对照表"><a href="#功能对照表" class="headerlink" title="功能对照表"></a>功能对照表</h2><p>默认开启的功能</p><table><thead><tr><th>名称</th><th>说明</th><th>系统</th></tr></thead><tbody><tr><td>arp</td><td>从 <code>/proc/net/arp</code> 中收集 ARP 统计信息</td><td>Linux</td></tr><tr><td>conntrack</td><td>从 <code>/proc/sys/net/netfilter/</code> 中收集 conntrack 统计信息</td><td>Linux</td></tr><tr><td>cpu</td><td>收集 cpu 统计信息</td><td>Darwin, Dragonfly,FreeBSD, Linux</td></tr><tr><td>diskstats</td><td>从 <code>/proc/diskstats</code> 中收集磁盘 I/O 统计信息</td><td>Linux</td></tr><tr><td>edac</td><td>错误检测与纠正统计信息</td><td>Linux</td></tr><tr><td>entropy</td><td>可用内核熵信息</td><td>Linux</td></tr><tr><td>exec</td><td>execution 统计信息</td><td>Dragonfly, FreeBSD</td></tr><tr><td>filefd</td><td>从 <code>/proc/sys/fs/file-nr</code> 中收集文件描述符统计信息</td><td>Linux</td></tr><tr><td>filesystem</td><td>文件系统统计信息，例如磁盘已使用空间</td><td>Darwin, Dragonfly,FreeBSD, Linux, OpenBSD</td></tr><tr><td>hwmon</td><td>从 <code>/sys/class/hwmon/</code> 中收集监控器或传感器数据信息</td><td>Linux</td></tr><tr><td>infiniband</td><td>从 InfiniBand 配置中收集网络统计信息</td><td>Linux</td></tr><tr><td>loadavg</td><td>收集系统负载信息</td><td>Darwin, Dragonfly, FreeBSD,Linux, NetBSD, OpenBSD, Solaris</td></tr><tr><td>mdadm</td><td>从 <code>/proc/mdstat</code> 中获取设备统计信息</td><td>Linux</td></tr><tr><td>meminfo</td><td>内存统计信息</td><td>Darwin, Dragonfly,FreeBSD, Linux</td></tr><tr><td>netdev</td><td>网口流量统计信息，单位 bytes</td><td>Darwin, Dragonfly,FreeBSD, Linux, OpenBSD</td></tr><tr><td>netstat</td><td>从 <code>/proc/net/netstat</code> 收集网络统计数据，等同于 <code>netstat -s</code></td><td>Linux</td></tr><tr><td>sockstat</td><td>从 <code>/proc/net/sockstat</code> 中收集 socket 统计信息</td><td>Linux</td></tr><tr><td>stat</td><td>从 <code>/proc/stat</code> 中收集各种统计信息，包含系统启动时间，forks, 中断等</td><td>Linux</td></tr><tr><td>textfile</td><td>通过 <code>--collector.textfile.directory</code>参数指定本地文本收集路径，收集文本信息</td><td>any</td></tr><tr><td>time</td><td>系统当前时间</td><td>any</td></tr><tr><td>uname</td><td>通过 <code>uname</code> 系统调用, 获取系统信息</td><td>any</td></tr><tr><td>vmstat</td><td>从 <code>/proc/vmstat</code> 中收集统计信息</td><td>Linux</td></tr><tr><td>wifi</td><td>收集 wifi 设备相关统计数据</td><td>Linux</td></tr><tr><td>xfs</td><td>收集 xfs 运行时统计信息</td><td>Linux (kernel 4.4+)</td></tr><tr><td>zfs</td><td>收集 zfs 性能统计信息</td><td>Linux</td></tr></tbody></table><p>默认关闭的功能</p><table><thead><tr><th>名称</th><th>说明</th><th>系统</th></tr></thead><tbody><tr><td>bonding</td><td>收集系统配置以及激活的绑定网卡数量</td><td>Linux</td></tr><tr><td>buddyinfo</td><td>从 <code>/proc/buddyinfo</code> 中收集内存碎片统计信息</td><td>Linux</td></tr><tr><td>devstat</td><td>收集设备统计信息</td><td>Dragonfly, FreeBSD</td></tr><tr><td>drbd</td><td>收集远程镜像块设备（DRBD）统计信息</td><td>Linux</td></tr><tr><td>interrupts</td><td>收集更具体的中断统计信息</td><td>Linux，OpenBSD</td></tr><tr><td>ipvs</td><td>从 <code>/proc/net/ip_vs</code> 中收集 IPVS 状态信息，从 <code>/proc/net/ip_vs_stats</code> 获取统计信息</td><td>Linux</td></tr><tr><td>ksmd</td><td>从 <code>/sys/kernel/mm/ksm</code> 中获取内核和系统统计信息</td><td>Linux</td></tr><tr><td>logind</td><td>从 <code>logind</code> 中收集会话统计信息</td><td>Linux</td></tr><tr><td>meminfo_numa</td><td>从 <code>/proc/meminfo_numa</code> 中收集内存统计信息</td><td>Linux</td></tr><tr><td>mountstats</td><td>从 <code>/proc/self/mountstat</code> 中收集文件系统统计信息，包括 NFS 客户端统计信息</td><td>Linux</td></tr><tr><td>nfs</td><td>从 <code>/proc/net/rpc/nfs</code> 中收集 NFS 统计信息，等同于 <code>nfsstat -c</code></td><td>Linux</td></tr><tr><td>qdisc</td><td>收集队列推定统计信息</td><td>Linux</td></tr><tr><td>runit</td><td>收集 runit 状态信息</td><td>any</td></tr><tr><td>supervisord</td><td>收集 supervisord 状态信息</td><td>any</td></tr><tr><td>systemd</td><td>从 <code>systemd</code> 中收集设备系统状态信息</td><td>Linux</td></tr><tr><td>tcpstat</td><td>从 <code>/proc/net/tcp</code> 和 <code>/proc/net/tcp6</code> 收集 TCP 连接状态信息</td><td>Linux</td></tr></tbody></table><p>注意：我们可以使用 <code>--collectors.enabled</code> 运行参数指定 node_exporter 收集的功能模块, 如果不指定，将使用默认模块。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>下载地址：<a href="https://prometheus.io/download/#node_exporter" target="_blank" rel="noopener">https://prometheus.io/download/#node_exporter</a></p><h3 id="安装包安装"><a href="#安装包安装" class="headerlink" title="安装包安装"></a>安装包安装</h3><p><strong>安装node exporter</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf node_exporter-0.16.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv node_exporter-0.16.0.linux-amd64 /usr/local/node_exporter</span><br></pre></td></tr></table></figure><p><strong>创建systemd服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/node_exporter.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/node_exporter/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p><strong>启动node_exporter</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl status node_exporter</span><br><span class="line">systemctl enable node_exporter</span><br></pre></td></tr></table></figure><p><strong>验证启动成功</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1:9100/metrics</span><br></pre></td></tr></table></figure><h3 id="kubernetes安装"><a href="#kubernetes安装" class="headerlink" title="kubernetes安装"></a>kubernetes安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: prometheus-node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-node-exporter</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/node-exporter:v0.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: prometheus-node-exporter</span><br><span class="line">        ports:</span><br><span class="line">        - name: prom-node-exp</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          hostPort: 9100</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 20m</span><br><span class="line">            memory: 2Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      hostPID: true</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics-path: &apos;/metrics&apos;</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: prometheus-node-exporter</span><br><span class="line">      port: 9100</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>可以利用 Prometheus 的 static_configs 来拉取 node_exporter 的数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;node&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9100&apos;]</span><br></pre></td></tr></table></figure><p>重启prometheus，然后在Prometheus页面中的Targets中就能看到新加入的node</p><h2 id="常用查询语句"><a href="#常用查询语句" class="headerlink" title="常用查询语句"></a>常用查询语句</h2><p>收集到 node_exporter 的数据后，我们可以使用 PromQL 进行一些业务查询和监控，下面是一些比较常见的查询</p><p>以下查询均以单个节点作为例子，如果大家想查看所有节点，将 <code>instance=&quot;xxx&quot;</code> 去掉即可。</p><h3 id="cpu使用率"><a href="#cpu使用率" class="headerlink" title="cpu使用率"></a>cpu使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - (avg by (instance) (irate(node_cpu&#123;instance=&quot;172.16.8.153:9100&quot;, mode=&quot;idle&quot;&#125;[5m])) * 100)</span><br></pre></td></tr></table></figure><h3 id="CPU各个mode使用率"><a href="#CPU各个mode使用率" class="headerlink" title="CPU各个mode使用率"></a>CPU各个mode使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg by (instance, mode) (irate(node_cpu&#123;instance=&quot;172.16.8.153:9100&quot;&#125;[5m])) * 100</span><br></pre></td></tr></table></figure><ul><li><strong>User</strong>：CPU一共花了多少比例的时间运行在用户态空间或者说是用户进程(running user space processes)。典型的用户态空间程序有：Shells、数据库、web服务器等</li><li><strong>Nice</strong>：可理解为，<strong>用户空间进程</strong>的CPU的调度优先级，范围为[-20,19]</li><li><strong>System</strong>：System的含义与User相似。System表示：CPU花了多少比例的时间在内核空间运行。分配内存、IO操作、创建子进程……都是内核操作。这也表明，当IO操作频繁时，System参数会很高</li><li><strong>ioWait</strong>：在计算机中，读写磁盘的操作远比CPU运行的速度要慢，CPU负载处理数据，而数据一般在磁盘上需要读到内存中才能处理。当CPU发起读写操作后，需要等着磁盘驱动器将数据读入内存,从而导致CPU 在等待的这一段时间内无事可做。CPU处于这种等待状态的时间由Wait参数来衡量</li><li><strong>Idle</strong>：CPU处于空闲状态时间比例。一般而言，idel + user + nice 约等于100%</li></ul><h3 id="机器平均负载"><a href="#机器平均负载" class="headerlink" title="机器平均负载"></a>机器平均负载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance=&quot;172.16.8.153:9100&quot;&#125;   // 1分钟负载</span><br><span class="line">node_load5&#123;instance=&quot;172.16.8.153:9100&quot;&#125;   // 5分钟负载</span><br><span class="line">node_load15&#123;instance=&quot;172.16.8.153:9100&quot;&#125;  // 15分钟负载</span><br></pre></td></tr></table></figure><h3 id="内存使用率"><a href="#内存使用率" class="headerlink" title="内存使用率"></a>内存使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100-(node_memory_MemFree&#123;instance=&quot;172.16.8.172:9100&quot;&#125;+node_memory_Cached&#123;instance=&quot;172.16.8.172:9100&quot;&#125;+node_memory_Buffers&#123;instance=&quot;172.16.8.172:9100&quot;&#125;)/node_memory_MemTotal&#123;instance=&quot;172.16.8.172:9100&quot;&#125; * 100</span><br></pre></td></tr></table></figure><h3 id="磁盘使用率"><a href="#磁盘使用率" class="headerlink" title="磁盘使用率"></a>磁盘使用率</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - node_filesystem_free&#123;instance=&quot;172.16.8.153:9100&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; / node_filesystem_size&#123;instance=&quot;172.16.8.153:9100&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; * 100</span><br></pre></td></tr></table></figure><h3 id="网卡出入包"><a href="#网卡出入包" class="headerlink" title="网卡出入包"></a>网卡出入包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 入包量</span><br><span class="line">sum by (instance) (rate(node_network_receive_bytes&#123;instance=&quot;172.16.8.153:9100&quot;,device!=&quot;lo&quot;&#125;[5m]))</span><br><span class="line"></span><br><span class="line">// 出包量</span><br><span class="line">sum by (instance) (rate(node_network_transmit_bytes&#123;instance=&quot;172.16.8.153:9100&quot;,device!=&quot;lo&quot;&#125;[5m]))</span><br></pre></td></tr></table></figure><h2 id="dashboard模板"><a href="#dashboard模板" class="headerlink" title="dashboard模板"></a>dashboard模板</h2><p>可以在grafana官网中搜索对应模板</p><h1 id="Mysql-exporter"><a href="#Mysql-exporter" class="headerlink" title="Mysql exporter"></a>Mysql exporter</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>使用helm安装部署</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm --fetch mysql_exporter</span><br></pre></td></tr></table></figure><p>拉取下来之后修改values文件</p><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>mysqld_exporter需要连接Mysql，首先为它创建用户并赋予所需要的权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;exporter&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos; WITH MAX_USER_CONNECTIONS 3;</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &apos;exporter&apos;@&apos;%&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h2 id="prometheus配置"><a href="#prometheus配置" class="headerlink" title="prometheus配置"></a>prometheus配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;mysql&apos;</span><br><span class="line">        static_configs:</span><br><span class="line">          - targets:</span><br><span class="line">            - localhost:9104</span><br></pre></td></tr></table></figure><h2 id="验证状态"><a href="#验证状态" class="headerlink" title="验证状态"></a>验证状态</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9104/metrics</span><br></pre></td></tr></table></figure><h1 id="jmx-exporter"><a href="#jmx-exporter" class="headerlink" title="jmx_exporter"></a>jmx_exporter</h1><h2 id="举例监控kafka"><a href="#举例监控kafka" class="headerlink" title="举例监控kafka"></a>举例监控kafka</h2><p>jmx_prometheus_javaagent 方式收集kafka指标</p><p>下载jmx_prometheus_javaagent和kafka.yml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/prometheus/jmx_exporter/master/example_configs/kafka-0-8-2.yml</span><br><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.6/jmx_prometheus_javaagent-0.6.jar</span><br></pre></td></tr></table></figure><p>编辑kafka的启动文件  <a href="http://kafka-server-start.sh/" target="_blank" rel="noopener">kafka-server-start.sh</a></p><p>添加几行代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JMX_PORT=&quot;9999&quot;</span><br><span class="line">export KAFKA_OPTS=&quot;-javaagent:/path/jmx_prometheus_javaagent-0.6.jar=9991:/path/kafka-0-8-2.yml&quot;</span><br></pre></td></tr></table></figure><p>然后重启kafka。<br>访问 <a href="http://localhost:9991/metrics" target="_blank" rel="noopener">http://localhost:9991/metrics</a> 可以看到各种指标了。</p><h2 id="举例监控hadoop"><a href="#举例监控hadoop" class="headerlink" title="举例监控hadoop"></a>举例监控hadoop</h2><p>下载jar包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure><p>创建配置文件</p><p>创建namenode.yaml(datanode.yaml)放在任意位置，内容为你想要的metrics</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">startDelaySeconds: 0</span><br><span class="line">hostPort: master:1234 #master为本机IP（一般可设置为localhost）；1234为想设置的jmx端口（可设置为未被占用的端口）</span><br><span class="line">#jmxUrl: service:jmx:rmi:///jndi/rmi://127.0.0.1:1234/jmxrmi</span><br><span class="line">ssl: false</span><br><span class="line">lowercaseOutputName: false</span><br><span class="line">lowercaseOutputLabelNames: false</span><br></pre></td></tr></table></figure><p>参数说明</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>startDelaySeconds</td><td>start delay before serving requests. Any requests within the delay period will result in an empty metrics set.</td></tr><tr><td>hostPort</td><td>The host and port to connect to via remote JMX. If neither this nor jmxUrl is specified, will talk to the local JVM.</td></tr><tr><td>username</td><td>The username to be used in remote JMX password authentication.</td></tr><tr><td>password</td><td>The password to be used in remote JMX password authentication.</td></tr><tr><td>jmxUrl</td><td>A full JMX URL to connect to. Should not be specified if hostPort is.</td></tr><tr><td>ssl</td><td>Whether JMX connection should be done over SSL. To configure certificates you have to set following system properties: <code>-Djavax.net.ssl.keyStore=/home/user/.keystore</code> <code>-Djavax.net.ssl.keyStorePassword=changeit</code> <code>-Djavax.net.ssl.trustStore=/home/user/.truststore</code> <code>-Djavax.net.ssl.trustStorePassword=changeit</code></td></tr><tr><td>lowercaseOutputName</td><td>Lowercase the output metric name. Applies to default format and <code>name</code>. Defaults to false.</td></tr><tr><td>lowercaseOutputLabelNames</td><td>Lowercase the output metric label names. Applies to default format and <code>labels</code>. Defaults to false.</td></tr><tr><td>whitelistObjectNames</td><td>A list of <a href="http://docs.oracle.com/javase/6/docs/api/javax/management/ObjectName.html" target="_blank" rel="noopener">ObjectNames</a> to query. Defaults to all mBeans.</td></tr><tr><td>blacklistObjectNames</td><td>A list of <a href="http://docs.oracle.com/javase/6/docs/api/javax/management/ObjectName.html" target="_blank" rel="noopener">ObjectNames</a> to not query. Takes precedence over <code>whitelistObjectNames</code>. Defaults to none.</td></tr><tr><td>rules</td><td>A list of rules to apply in order, processing stops at the first matching rule. Attributes that aren’t matched aren’t collected. If not specified, defaults to collecting everything in the default format.</td></tr><tr><td>pattern</td><td>Regex pattern to match against each bean attribute. The pattern is not anchored. Capture groups can be used in other options. Defaults to matching everything.</td></tr><tr><td>attrNameSnakeCase</td><td>Converts the attribute name to snake case. This is seen in the names matched by the pattern and the default format. For example, anAttrName to an_attr_name. Defaults to false.</td></tr><tr><td>name</td><td>The metric name to set. Capture groups from the <code>pattern</code> can be used. If not specified, the default format will be used. If it evaluates to empty, processing of this attribute stops with no output.</td></tr><tr><td>value</td><td>Value for the metric. Static values and capture groups from the <code>pattern</code> can be used. If not specified the scraped mBean value will be used.</td></tr><tr><td>valueFactor</td><td>Optional number that <code>value</code> (or the scraped mBean value if <code>value</code> is not specified) is multiplied by, mainly used to convert mBean values from milliseconds to seconds.</td></tr><tr><td>labels</td><td>A map of label name to label value pairs. Capture groups from <code>pattern</code> can be used in each. <code>name</code> must be set to use this. Empty names and values are ignored. If not specified and the default format is not being used, no labels are set.</td></tr><tr><td>help</td><td>Help text for the metric. Capture groups from <code>pattern</code> can be used. <code>name</code> must be set to use this. Defaults to the mBean attribute decription and the full name of the attribute.</td></tr><tr><td>type</td><td>The type of the metric, can be <code>GAUGE</code>, <code>COUNTER</code> or <code>UNTYPED</code>. <code>name</code> must be set to use this. Defaults to <code>UNTYPED</code>.</td></tr></tbody></table><p>修改$HADOOP_HOME/etc/hadoop/hadoop-env.sh </p><p>NameNode节点添加：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_NAMENODE_OPTS=&quot;-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false   -Dcom.sun.management.jmxremote.port=1234 $HADOOP_NAMENODE_OPTS &quot;</span><br></pre></td></tr></table></figure><p>DataNode节点添加：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_DATANODE_OPTS=&quot;-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false   -Dcom.sun.management.jmxremote.port=1235 $HADOOP_DATANODE_OPTS &quot;</span><br></pre></td></tr></table></figure><p>ps:</p><blockquote><p>端口1234（1235）要与之前设置的jmx端口保持一致</p></blockquote><p>修改$HADOOP_HOME/bin/hdfs</p><p>NameNode:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_NAMENODE_OPTS=&quot;$HADOOP_NAMENODE_OPTS -javaagent:/home/hadoop/jmx_prometheus_javaagent-0.3.1.jar=9200:/home/hadoop/namenode.yaml&quot;</span><br></pre></td></tr></table></figure><p>DataNode:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_DATANODE_OPTS=&quot;$HADOOP_DATANODE_OPTS -javaagent:/home/hadoop/jmx_prometheus_javaagent-0.3.1.jar=9300:/home/hadoop/datanode.yaml&quot;</span><br></pre></td></tr></table></figure><p>提示：9200（9300）为jmx_exporter提供metrics数据端口，后续Prometheus从此端口获取数据</p><p>访问<code>http://master:9200/metrics</code>就能获得需要的<code>metrics</code>数据:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.</span><br><span class="line"># TYPE jvm_buffer_pool_used_bytes gauge</span><br><span class="line">jvm_buffer_pool_used_bytes&#123;pool=&quot;direct&quot;,&#125; 1181032.0</span><br><span class="line">jvm_buffer_pool_used_bytes&#123;pool=&quot;mapped&quot;,&#125; 0.0</span><br><span class="line"># HELP jvm_buffer_pool_capacity_bytes Bytes capacity of a given JVM buffer pool.</span><br><span class="line"># TYPE jvm_buffer_pool_capacity_bytes gauge</span><br><span class="line">jvm_buffer_pool_capacity_bytes&#123;pool=&quot;direct&quot;,&#125; 1181032.0</span><br><span class="line">jvm_buffer_pool_capacity_bytes&#123;pool=&quot;mapped&quot;,&#125; 0.0</span><br><span class="line"># HELP jvm_buffer_pool_used_buffers Used buffers of a given JVM buffer pool.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://prometheus.io/docs/instrumenting/exporters/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://prometheus.io/docs/instrumenting/exporters/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;blackbox_exporter:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/prometheus/blackbox_exporter&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus/blackbox_exporter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/qq_25934401/article/details/84325356&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/qq_25934401/article/details/84325356&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;node_exporter&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/prometheus/node_exporter&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus/node_exporter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/bigberg/p/10118137.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/bigberg/p/10118137.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;mysql_exporter:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/prometheus/mysqld_exporter&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus/mysqld_exporter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;jmx_exporter:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/prometheus/jmx_exporter&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus/jmx_exporter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/caizhenghui/p/9132414.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/caizhenghui/p/9132414.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;大部分exporter都可以在&lt;a href=&quot;https://github.com/prometheus中搜到&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus中搜到&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;以及可以使用&lt;code&gt;helm search node-exporter&lt;/code&gt;来进行搜索&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://gongzhao1.coding.me/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="exporter" scheme="https://gongzhao1.coding.me/tags/exporter/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群监控之grafana</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E4%B9%8Bgrafana/"/>
    <id>https://gongzhao1.coding.me/Kubernetes集群监控之grafana/</id>
    <published>2020-02-19T10:29:37.000Z</published>
    <updated>2020-04-08T14:20:25.845Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://segmentfault.com/a/1190000016237454" target="_blank" rel="noopener">https://segmentfault.com/a/1190000016237454</a></li><li><a href="https://blog.csdn.net/wzygis/article/details/52727067" target="_blank" rel="noopener">https://blog.csdn.net/wzygis/article/details/52727067</a></li></ul><a id="more"></a><h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><p>grafana-deploy.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:6.5.2</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 10</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/health</span><br><span class="line">            port: 3000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">        name: grafana</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          name: grafana</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/health</span><br><span class="line">            port: 3000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/grafana/grafana.ini</span><br><span class="line">          name: config</span><br><span class="line">          subPath: grafana.ini</span><br><span class="line">        - mountPath: /var/lib/grafana</span><br><span class="line">          name: storage</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: prometheus-grafana</span><br><span class="line">        name: config</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: storage</span><br></pre></td></tr></table></figure><p>grafana-config.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  grafana.ini: |</span><br><span class="line">    [server]</span><br><span class="line">    root_url = https://test.com</span><br><span class="line">    [log]</span><br><span class="line">    mode = console</span><br><span class="line">    level = info</span><br><span class="line">    [paths]</span><br><span class="line">    data = /var/lib/grafana/data</span><br><span class="line">    logs = /var/log/grafana</span><br><span class="line">    plugins = /var/lib/grafana/plugins</span><br><span class="line">    provisioning = /etc/grafana/provisioning</span><br><span class="line">    [smtp]</span><br><span class="line">    enabled = true</span><br><span class="line">    host = ****</span><br><span class="line">    user = ****</span><br><span class="line">    password = ****</span><br><span class="line">    cert_file =</span><br><span class="line">    key_file =</span><br><span class="line">    skip_verify = false</span><br><span class="line">    from_address = ****</span><br><span class="line">    from_name =****</span><br><span class="line">    [emails]</span><br><span class="line">    welcome_email_on_sign_up = true</span><br></pre></td></tr></table></figure><p>grafana-svc.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">    #prometheus.io/tcp-probe: &apos;true&apos;</span><br><span class="line">    #prometheus.io/tcp-probe-port: &apos;80&apos;</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30028</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h1 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h1><pre><code>grafana后端的配置文件可以是多个以.ini结尾的配置文件，主要从三个配置文件读取配置：默认是$WORKING_DIR/conf/defaults.ini，其次用户配置是$WORKING_DIR/conf/custom.ini，用户配置则可以在命令行启动grafana时通过--config参数重新指定配置文件来覆盖。如果你是以deb或者rpm安装的，则默认的配置文件是/etc/grafana/grafana.ini，这个文件是在init.d的启动脚本中通过--config参数指定的。    所有在配置文件中的配置都可以通过环境变量来覆盖，使用的语法如下：GF_&lt;SectionName&gt;_&lt;KeyName&gt;，例如：</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[security]</span><br><span class="line">admin_user = admin</span><br><span class="line"> </span><br><span class="line">[auth.google]</span><br><span class="line">client_secret = 0ldS3cretKey</span><br></pre></td></tr></table></figure><p>如果使用环境变量，则是如下： </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export GF_SECURITY_ADMIN_USER=true</span><br><span class="line">export GF_AUTH_GOOGLE_CLIENT_SECRET=newS3cretKey</span><br></pre></td></tr></table></figure><p>下面具体看看每个配置段的配置：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">app_mode：应用名称，默认是production</span><br><span class="line"> </span><br><span class="line">[path]</span><br><span class="line">data：一个grafana用来存储sqlite3、临时文件、回话的地址路径</span><br><span class="line">logs：grafana存储logs的路径</span><br><span class="line"> </span><br><span class="line">[server]</span><br><span class="line">http_addr：监听的ip地址，，默认是0.0.0.0</span><br><span class="line">http_port：监听的端口，默认是3000</span><br><span class="line">protocol：http或者https，，默认是http</span><br><span class="line">domain：这个设置是root_url的一部分，当你通过浏览器访问grafana时的公开的domian名称，默认是localhost</span><br><span class="line">enforce_domain：如果主机的header不匹配domian，则跳转到一个正确的domain上，默认是false</span><br><span class="line">root_url：这是一个web上访问grafana的全路径url，默认是%(protocol)s://%(domain)s:%(http_port)s/</span><br><span class="line">router_logging：是否记录web请求日志，默认是false</span><br><span class="line">cert_file：如果使用https则需要设置</span><br><span class="line">cert_key：如果使用https则需要设置</span><br><span class="line"> </span><br><span class="line">[database]</span><br><span class="line">grafana默认需要使用数据库存储用户和dashboard信息，默认使用sqlite3来存储，你也可以换成其他数据库</span><br><span class="line">type：可以是mysql、postgres、sqlite3，默认是sqlite3</span><br><span class="line">path：只是sqlite3需要，定义sqlite3的存储路径</span><br><span class="line">host：只是mysql、postgres需要，默认是127.0.0.1:3306</span><br><span class="line">name：grafana的数据库名称，默认是grafana</span><br><span class="line">user：连接数据库的用户</span><br><span class="line">password：数据库用户的密码</span><br><span class="line">ssl_mode：只是postgres使用</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[security]</span><br><span class="line">admin_user：grafana默认的admin用户，默认是admin</span><br><span class="line">admin_password：grafana admin的默认密码，默认是admin</span><br><span class="line">login_remember_days：多少天内保持登录状态</span><br><span class="line">secret_key：保持登录状态的签名</span><br><span class="line">disable_gravatar：</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[users]</span><br><span class="line">allow_sign_up：是否允许普通用户登录，如果设置为false，则禁止用户登录，默认是true，则admin可以创建用户，并登录grafana</span><br><span class="line">allow_org_create：如果设置为false，则禁止用户创建新组织，默认是true</span><br><span class="line">auto_assign_org：当设置为true的时候，会自动的把新增用户增加到id为1的组织中，当设置为false的时候，新建用户的时候会新增一个组织</span><br><span class="line">auto_assign_org_role：新建用户附加的规则，默认是Viewer，还可以是Admin、Editor</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.anonymous]</span><br><span class="line">enabled：设置为true，则开启允许匿名访问，默认是false</span><br><span class="line">org_name：为匿名用户设置组织名称</span><br><span class="line">org_role：为匿名用户设置的访问规则，默认是Viewer</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.github]</span><br><span class="line">针对github项目的，很明显，呵呵</span><br><span class="line">enabled = false</span><br><span class="line">allow_sign_up = false</span><br><span class="line">client_id = some_id</span><br><span class="line">client_secret = some_secret</span><br><span class="line">scopes = user:email</span><br><span class="line">auth_url = https://github.com/login/oauth/authorize</span><br><span class="line">token_url = https://github.com/login/oauth/access_token</span><br><span class="line">api_url = https://api.github.com/user</span><br><span class="line">team_ids =</span><br><span class="line">allowed_domains =</span><br><span class="line">allowed_organizations =</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.google]</span><br><span class="line">针对google app的，呵呵</span><br><span class="line">enabled = false</span><br><span class="line">allow_sign_up = false</span><br><span class="line">client_id = some_client_id</span><br><span class="line">client_secret = some_client_secret</span><br><span class="line">scopes = https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email</span><br><span class="line">auth_url = https://accounts.google.com/o/oauth2/auth</span><br><span class="line">token_url = https://accounts.google.com/o/oauth2/token</span><br><span class="line">api_url = https://www.googleapis.com/oauth2/v1/userinfo</span><br><span class="line">allowed_domains =</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.basic]</span><br><span class="line">enabled：当设置为true，则http api开启基本认证</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.ldap]</span><br><span class="line">enabled：设置为true则开启LDAP认证，默认是false</span><br><span class="line">config_file：如果开启LDAP，指定LDAP的配置文件/etc/grafana/ldap.toml</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[auth.proxy]</span><br><span class="line">允许你在一个HTTP反向代理上进行认证设置</span><br><span class="line">enabled：默认是false</span><br><span class="line">header_name：默认是X-WEBAUTH-USER</span><br><span class="line">header_property：默认是个名称username</span><br><span class="line">auto_sign_up：默认是true。开启自动注册，如果用户在grafana DB中不存在</span><br><span class="line"> </span><br><span class="line">[analytics]</span><br><span class="line">reporting_enabled：如果设置为true，则会发送匿名使用分析到stats.grafana.org，主要用于跟踪允许实例、版本、dashboard、错误统计。默认是true</span><br><span class="line">google_analytics_ua_id：使用GA进行分析，填写你的GA ID即可</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[dashboards.json]</span><br><span class="line">如果你有一个系统自动产生json格式的dashboard，则可以开启这个特性试试</span><br><span class="line">enabled：默认是false</span><br><span class="line">path：一个全路径用来包含你的json dashboard，默认是/var/lib/grafana/dashboards</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[session]</span><br><span class="line">provider：默认是file，值还可以是memory、mysql、postgres</span><br><span class="line">provider_config：这个值的配置由provider的设置来确定，如果provider是file，则是data/xxxx路径类型，如果provider是mysql，则是user:password@tcp(127.0.0.1:3306)/database_name，如果provider是postgres，则是user=a password=b host=localhost port=5432 dbname=c sslmode=disable</span><br><span class="line">cookie_name：grafana的cookie名称</span><br><span class="line">cookie_secure：如果设置为true，则grafana依赖https，默认是false</span><br><span class="line">session_life_time：session过期时间，默认是86400秒，24小时</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">以下是官方文档没有，配置文件中有的</span><br><span class="line">[smtp]</span><br><span class="line">enabled = false</span><br><span class="line">host = localhost:25</span><br><span class="line">user =</span><br><span class="line">password =</span><br><span class="line">cert_file =</span><br><span class="line">key_file =</span><br><span class="line">skip_verify = false</span><br><span class="line">from_address = admin@grafana.localhost</span><br><span class="line"> </span><br><span class="line">[emails]</span><br><span class="line">welcome_email_on_sign_up = false</span><br><span class="line">templates_pattern = emails/*.html</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[log]</span><br><span class="line">mode：可以是console、file，默认是console、file，也可以设置多个，用逗号隔开</span><br><span class="line">buffer_len：channel的buffer长度，默认是10000</span><br><span class="line">level：可以是"Trace", "Debug", "Info", "Warn", "Error", "Critical"，默认是info</span><br><span class="line"> </span><br><span class="line">[log.console]</span><br><span class="line">level：设置级别</span><br><span class="line"> </span><br><span class="line">[log.file]</span><br><span class="line">level：设置级别</span><br><span class="line">log_rotate：是否开启自动轮转</span><br><span class="line">max_lines：单个日志文件的最大行数，默认是1000000</span><br><span class="line">max_lines_shift：单个日志文件的最大大小，默认是28，表示256MB</span><br><span class="line">daily_rotate：每天是否进行日志轮转，默认是true</span><br><span class="line">max_days：日志过期时间，默认是7,7天后删除</span><br></pre></td></tr></table></figure><h1 id="Grafana相关使用"><a href="#Grafana相关使用" class="headerlink" title="Grafana相关使用"></a>Grafana相关使用</h1><h2 id="将数据源添加到Grafana"><a href="#将数据源添加到Grafana" class="headerlink" title="将数据源添加到Grafana"></a>将数据源添加到Grafana</h2><ol><li>点击顶部标题中的Grafana图标打开侧边菜单</li><li>在<code>Dashboards</code>链接下的侧边菜单中，你应找到名为<code>Data Sources</code>的链接</li><li>点击顶部标题中的<code>+ Add data source</code>按钮</li><li>从类型下拉列表中选择<code>Prometheus</code></li></ol><blockquote><p>注意：如果你没有在侧边菜单中看到<code>Data Sources</code>链接，则表示你当前的用户没有当前组织的<code>Admin</code>角色。</p></blockquote><p><strong>数据源选项</strong></p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>Name</td><td>数据源名称，这是你在面板和查询中引用数据源的方式</td></tr><tr><td>Default</td><td>默认数据源意味着它将为新面板预先选择</td></tr><tr><td>Url</td><td>你的Prometheus服务的http协议，IP和端口（默认端口通常是9090）</td></tr><tr><td>Access</td><td>Server (default) = 需要从Grafana后端/服务器访问的URL，Browser = 需要从浏览器访问的URL</td></tr><tr><td>Basic Auth</td><td>启用对Prometheus数据源的基本身份验证</td></tr><tr><td>User</td><td>你的Prometheus用户名</td></tr><tr><td>Password</td><td>数据库用户的密码</td></tr><tr><td>Scrape interval</td><td>这将用作Prometheus步骤查询参数的下限，默认值为15秒</td></tr></tbody></table><h2 id="查询编辑器"><a href="#查询编辑器" class="headerlink" title="查询编辑器"></a>查询编辑器</h2><p>单击标题，以编辑模式打开图形 &gt; 编辑（或在鼠标悬停在面板上时按<code>e</code>键）。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/22.gif" alt="image"></p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>Query expression</td><td>Prometheus查询表达式，请查看<a href="http://prometheus.io/docs/querying/basics/" target="_blank" rel="noopener">Prometheus文档</a></td></tr><tr><td>Legend format</td><td>使用名称或模式控制时间系列的名称，例如，<code></code>将替换为标签<code>hostname</code>的标签值</td></tr><tr><td>Min step</td><td>设置Prometheus步骤选项的下限，步骤控制Prometheus查询引擎执行范围查询时跳转的大小，遗憾的是，没有官方的prometheus文档链接到这个非常重要的选项</td></tr><tr><td>Resolution</td><td>控制步骤选项，小步骤可以创建高分辨率图形，但在较大的时间范围内可能会很慢，降低分辨率可以加快速度。<code>1/2</code>将尝试设置步骤选项以为每个其他像素生成1个数据点，值为<code>1/10</code>将尝试设置步长选项，因此每10个像素就有一个数据点。</td></tr><tr><td>Metric lookup</td><td>在此输入字段来搜索指标名称</td></tr><tr><td>Format as</td><td>在表格，时间序列或心跳图之间切换，表格格式仅适用于表格面板，心跳图格式适用于在心跳图面板上显示具有直方图类型的指标。在引擎盖下，它将累积的直方图转换为规则序列，并按桶绑定对序列进行排序。</td></tr></tbody></table><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>你可以在指标查询中使用变量代替硬编码服务器、应用程序和传感器名称等内容。变量显示为仪表盘顶部的下拉选择框，这些下拉菜单可以轻松更改仪表盘中显示的数据。查看模板文档，了解模板功能和不同类型的模板变量。</p><h3 id="查询变量"><a href="#查询变量" class="headerlink" title="查询变量"></a>查询变量</h3><p>查询类型的变量允许你查询Prometheus以获取指标、标签或标签值的列表，Prometheus数据源插件提供了以下可在<code>Query</code>输入字段中使用的函数。</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>label_values(label)</td><td>返回每个指标中<code>label</code>的标签值列表</td></tr><tr><td>label_values(metric, label)</td><td>返回指定指标中<code>label</code>的标签值列表</td></tr><tr><td>metrics(metric)</td><td>返回与指定的<code>metric</code>正则表达式匹配的指标列表</td></tr><tr><td>query_result(query)</td><td>返回<code>query</code>的Prometheus查询结果列表</td></tr></tbody></table><p>有关指标名称、标签名称和标签值的详细信息，请参阅<a href="http://prometheus.io/docs/concepts/data_model/#metric-names-and-labels" target="_blank" rel="noopener">Prometheus文档</a>。</p><h3 id="使用区间和范围变量"><a href="#使用区间和范围变量" class="headerlink" title="使用区间和范围变量"></a>使用区间和范围变量</h3><blockquote><p>支持<code>$__range</code>，<code>$__range_s</code>和<code>$__range_ms</code>，仅适用于Grafana v5.3</p></blockquote><p>可以在查询变量中使用一些全局内置变量；<code>$__interval</code>，<code>$__interval_ms</code>，<code>$__range</code>，<code>$__range_s</code>和<code>$__range_ms</code>，有关详细信息，请参阅全局内置变量。当你需要过滤变量查询时，这些可以方便地与<code>query_result</code>函数一起使用，因为<code>label_values</code>函数不支持查询。</p><p>确保将变量的<code>refresh</code>触发器设置为<code>On Time Range Change</code>，以便在更改仪表盘上的时间范围时获取正确的实例。</p><p><strong>用法示例：</strong></p><p>根据仪表盘中显示的时间范围内的平均QPS，使用最繁忙的5个请求实例填充变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query: query_result(topk(5, sum(rate(http_requests_total[$__range])) by (instance)))</span><br><span class="line">Regex: /&quot;([^&quot;]+)&quot;/</span><br></pre></td></tr></table></figure><p>使用更精确的<code>$__range_s</code>，在仪表板中显示的时间范围内具有特定状态的实例填充变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query: query_result(max_over_time(&lt;metric&gt;[$&#123;__range_s&#125;s]) != &lt;state&gt;)</span><br><span class="line">Regex:</span><br></pre></td></tr></table></figure><h3 id="在查询中使用变量"><a href="#在查询中使用变量" class="headerlink" title="在查询中使用变量"></a>在查询中使用变量</h3><p>有两种语法：</p><ul><li><code>$</code> 例如：<code>rate(http_requests_total{job=~“$job”}[5m])</code></li><li><code>[[varname]]</code> 例如：<code>rate(http_requests_total{job=~”[[job]]“}[5m])</code></li></ul><p>为什么两种方式？第一种语法更易于读写，但不允许你在单词的中间使用变量，启用“多值”或“包括所有值”选项后，Grafana会将标签从纯文本转换为正则表达式兼容的字符串，这意味着你必须使用<code>=〜</code>而不是<code>=</code>。</p><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><p>注解允许你在图表上叠加丰富的事件信息，你可以通过仪表盘菜单/注解视图添加注解查询。</p><p>Prometheus支持两种查询注解的方法：</p><ul><li>常规指标查询</li><li>针对挂起和触发警报的Prometheus查询（有关详细信息，请参阅在<a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/#inspecting-alerts-during-runtime" target="_blank" rel="noopener">运行时检查警报</a>）</li></ul><p>步骤选项可用于限制从查询返回的事件数。</p><h2 id="将Grafana指标纳入Prometheus"><a href="#将Grafana指标纳入Prometheus" class="headerlink" title="将Grafana指标纳入Prometheus"></a>将Grafana指标纳入Prometheus</h2><p>从4.6.0开始，Grafana在<code>/metrics</code>端点上为Prometheus公开了指标，我们还在Grafana中捆绑了一个仪表盘，以便你可以更快地开始查看指标。你可以通过到数据源编辑页面并点击仪表盘选项卡来导入捆绑的仪表盘，在那里你可以找到一个Grafana仪表盘和一个Prometheus仪表盘，导入并开始查看所有指标！</p><h2 id="使用Provisioning配置数据源"><a href="#使用Provisioning配置数据源" class="headerlink" title="使用Provisioning配置数据源"></a>使用Provisioning配置数据源</h2><p>现在可以使用Grafana的Provisioning系统使用配置文件配置数据源，你可以在<a href="https://segmentfault.com/a/1190000016235952#articleHeader6" target="_blank" rel="noopener">Provisioning文档页面</a>上阅读有关其工作原理以及可以为数据源设置的所有设置的更多信息。</p><p>以下是此数据源的一些Provisioning示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: 1</span><br><span class="line"></span><br><span class="line">datasources:</span><br><span class="line">  - name: Prometheus</span><br><span class="line">    type: prometheus</span><br><span class="line">    access: proxy</span><br><span class="line">    url: http://localhost:9090</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://segmentfault.com/a/1190000016237454&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://segmentfault.com/a/1190000016237454&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/wzygis/article/details/52727067&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/wzygis/article/details/52727067&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="监控" scheme="https://gongzhao1.coding.me/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="grafana" scheme="https://gongzhao1.coding.me/tags/grafana/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群监控之alertmanager</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E4%B9%8Balertmanager/"/>
    <id>https://gongzhao1.coding.me/Kubernetes集群监控之alertmanager/</id>
    <published>2020-02-18T09:44:56.000Z</published>
    <updated>2020-04-08T14:20:25.844Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><p><a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">https://github.com/prometheus/alertmanager</a></p></li><li><p><a href="https://prometheus.io/docs/alerting/alertmanager/" target="_blank" rel="noopener">https://prometheus.io/docs/alerting/alertmanager/</a></p></li><li><p><a href="https://www.cnblogs.com/wangxu01/articles/11654836.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangxu01/articles/11654836.html</a></p></li></ul><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Alertmanager 主要用于接收 Prometheus 发送的告警信息，它支持丰富的告警通知渠道，而且很容易做到告警信息进行去重，降噪，分组等，是一款前卫的告警通知系统。</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/19.png" alt="image"></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/21.png" alt="image"></p><a id="more"></a><h1 id="配置部署"><a href="#配置部署" class="headerlink" title="配置部署"></a>配置部署</h1><h2 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h2><p>一、部署Alertmanager<br>二、配置Prometheus与Alertmanager通信<br>三、配置告警<br>　　1. prometheus指定rules目录<br>　　2. configmap存储告警规则<br>　　3. configmap挂载到容器rules目录</p><h2 id="部署alertmanager"><a href="#部署alertmanager" class="headerlink" title="部署alertmanager"></a>部署alertmanager</h2><p>alertmanager-deploy.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/alertmanager:v0.19.0</span><br><span class="line">        name: alertmanager</span><br><span class="line">        args:</span><br><span class="line">        - &quot;--config.file=/etc/alertmanager/config/alertmanager.yml&quot;</span><br><span class="line">        - &quot;--storage.path=/alertmanager&quot;</span><br><span class="line">        - &quot;--data.retention=720h&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/alertmanager&quot;</span><br><span class="line">          name: data</span><br><span class="line">        - mountPath: &quot;/etc/alertmanager/config&quot;</span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: &quot;/etc/alertmanager/template&quot;</span><br><span class="line">          name: alertmanager-tmpl</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br><span class="line">      - name: alertmanager-tmpl</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-tmpl</span><br></pre></td></tr></table></figure><p>alertmanager-svc.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: alertmanager</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9093</span><br><span class="line">    targetPort: 9093</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 30027</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: alertmanager</span><br></pre></td></tr></table></figure><p>alertmanager-config.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 1m</span><br><span class="line">      wechat_api_corp_id: &apos;*****&apos;</span><br><span class="line">      wechat_api_url: &apos;*****&apos;</span><br><span class="line">      wechat_api_secret: &apos;*****&apos;</span><br><span class="line">      smtp_smarthost: &apos;*****&apos;</span><br><span class="line">      smtp_from: &apos;****&apos;</span><br><span class="line">      smtp_auth_username: &apos;****&apos;</span><br><span class="line">      smtp_auth_password: &apos;****&apos;</span><br><span class="line">      smtp_require_tls: true</span><br><span class="line"></span><br><span class="line">    templates:</span><br><span class="line">    - &apos;/etc/alertmanager/template/*.tmpl&apos;</span><br><span class="line"></span><br><span class="line">    route:</span><br><span class="line">      group_by: [&apos;alertname&apos;, &apos;job&apos;]</span><br><span class="line">      group_wait: 20s</span><br><span class="line">      group_interval: 20s</span><br><span class="line">      repeat_interval: 2m</span><br><span class="line">      receiver: &apos;email&apos;</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: &quot;email&quot;</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        continue: true</span><br><span class="line">        match_re:</span><br><span class="line">          severity: critical|error|warning</span><br><span class="line">      #- receiver: &quot;wechat&quot;</span><br><span class="line">        #group_wait: 10s</span><br><span class="line">        #continue: true</span><br><span class="line">        #match_re:</span><br><span class="line">          #severity: critical|error|warning</span><br><span class="line"></span><br><span class="line">    receivers:</span><br><span class="line">    #- name: &quot;wechat&quot;</span><br><span class="line">      #wechat_configs:</span><br><span class="line">      #- send_resolved: true</span><br><span class="line">        #to_party: &apos;1&apos;</span><br><span class="line">        #agent_id: 1000003</span><br><span class="line">        #corp_id: &apos;****&apos;</span><br><span class="line">        #api_url: &apos;****&apos;</span><br><span class="line">        #api_secret: &apos;****&apos;</span><br><span class="line">    - name: &quot;email&quot;</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: &apos;****&apos;</span><br><span class="line">        send_resolved: true</span><br><span class="line"></span><br><span class="line">    inhibit_rules:</span><br><span class="line">    - source_match:</span><br><span class="line">        severity: &apos;critical&apos;</span><br><span class="line">      target_match:</span><br><span class="line">        severity: &apos;error&apos;</span><br><span class="line">      equal: [&apos;alertname&apos;]</span><br></pre></td></tr></table></figure><p>alertmanager-tmpl.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-tmpl</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  wechat.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;wechat.default.message&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">  email.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;email.default.html&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure><p>部署之后通过IP：9093访问alertmanager UI界面</p><p>在这个页面中我们可以进行一些操作，比如过滤、分组等等，里面还有两个新的概念：Inhibition(抑制)和 Silences(静默)。</p><ul><li>Inhibition：如果某些其他警报已经触发了，则对于某些警报，Inhibition 是一个抑制通知的概念。例如：一个警报已经触发，它正在通知整个集群是不可达的时，Alertmanager 则可以配置成关心这个集群的其他警报无效。这可以防止与实际问题无关的数百或数千个触发警报的通知，Inhibition 需要通过上面的配置文件进行配置。</li><li>Silences：静默是一个非常简单的方法，可以在给定时间内简单地忽略所有警报。Silences 基于 matchers配置，类似路由树。来到的警告将会被检查，判断它们是否和活跃的 Silences 相等或者正则表达式匹配。如果匹配成功，则不会将这些警报发送给接收者。</li></ul><h2 id="配置Prometheus与alertmanager通信"><a href="#配置Prometheus与alertmanager通信" class="headerlink" title="配置Prometheus与alertmanager通信"></a>配置Prometheus与alertmanager通信</h2><p>编辑 prometheus-configmap.yaml 配置文件添加绑定信息</p><p>最后的alert模块修改一下，之前的都注释</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">      - targets: [&quot;alertmanager:80&quot;]   ####需要修改alertmanger服务名字，集群内部通过服务名调用</span><br></pre></td></tr></table></figure><h1 id="配置告警"><a href="#配置告警" class="headerlink" title="配置告警"></a>配置告警</h1><h2 id="prometheus指定rules目录"><a href="#prometheus指定rules目录" class="headerlink" title="prometheus指定rules目录"></a>prometheus指定rules目录</h2><p>编辑 prometheus-configmap.yaml 添加报警信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 添加：指定读取rules配置</span><br><span class="line">rules_files:</span><br><span class="line">- /etc/config/rules/*.rules</span><br></pre></td></tr></table></figure><h2 id="configmap存储告警规则"><a href="#configmap存储告警规则" class="headerlink" title="configmap存储告警规则"></a>configmap存储告警规则</h2><p>创建yaml文件同过configmap存储告警规则</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#vim prometheus-rules.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-rules</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  # 通用角色</span><br><span class="line">  general.rules: |</span><br><span class="line">    groups:</span><br><span class="line">    - name: general.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: InstanceDown</span><br><span class="line">        expr: up == 0</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error </span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; 停止工作&quot;</span><br><span class="line">          description: &quot;&#123;&#123; $labels.instance &#125;&#125; job &#123;&#123; $labels.job &#125;&#125; 已经停止5分钟以上.&quot;</span><br><span class="line">  # Node对所有资源的监控</span><br><span class="line">  node.rules: |</span><br><span class="line">    groups:</span><br><span class="line">    - name: node.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: NodeFilesystemUsage</span><br><span class="line">        expr: 100 - (node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_size_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125; * 100) &gt; 80 </span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning </span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; : &#123;&#123; $labels.mountpoint &#125;&#125; 分区使用率过高&quot;</span><br><span class="line">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;: &#123;&#123; $labels.mountpoint &#125;&#125; 分区使用大于80% (当前值: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line"></span><br><span class="line">      - alert: NodeMemoryUsage</span><br><span class="line">        expr: 100 - (node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) / node_memory_MemTotal_bytes * 100 &gt; 80</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; 内存使用率过高&quot;</span><br><span class="line">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;内存使用大于80% (当前值: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line"></span><br><span class="line">      - alert: NodeCPUUsage    </span><br><span class="line">        expr: 100 - (avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance) * 100) &gt; 60 </span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; CPU使用率过高&quot;       </span><br><span class="line">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;CPU使用大于60% (当前值: &#123;&#123; $value &#125;&#125;)&quot;</span><br></pre></td></tr></table></figure><h2 id="configmap挂载到容器rules目录"><a href="#configmap挂载到容器rules目录" class="headerlink" title="configmap挂载到容器rules目录"></a>configmap挂载到容器rules目录</h2><p>修改挂载点位置，使用之前部署的prometheus动态PV</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#vim prometheus-statefulset.yaml</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: config-volume</span><br><span class="line">              mountPath: /etc/config</span><br><span class="line">            - name: prometheus-data</span><br><span class="line">              mountPath: /data</span><br><span class="line">            # 添加：指定rules的configmap配置文件名称</span><br><span class="line">            - name: prometheus-rules</span><br><span class="line">              mountPath: /etc/config/rules</span><br><span class="line">              subPath: &quot;&quot;</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: prometheus-config</span><br><span class="line">        # 添加：name rules</span><br><span class="line">        - name: prometheus-rules</span><br><span class="line">          # 添加：配置文件</span><br><span class="line">          configMap:</span><br><span class="line">            # 添加：定义文件名称</span><br><span class="line">            name: prometheus-rules</span><br></pre></td></tr></table></figure><h2 id="alertmananger报警配置说明"><a href="#alertmananger报警配置说明" class="headerlink" title="alertmananger报警配置说明"></a>alertmananger报警配置说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#cat alertmanager-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  # 配置文件名称</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      # 告警自定义邮件</span><br><span class="line">      smtp_smarthost: &apos;smtp.163.com:25&apos;</span><br><span class="line">      smtp_from: &apos;w.jjwx@163.com&apos;</span><br><span class="line">      smtp_auth_username: &apos;w.jjwx@163.com&apos;</span><br><span class="line">      smtp_auth_password: &apos;密码&apos;</span><br><span class="line">      smtp_hello: &apos;163.com&apos;</span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    route:</span><br><span class="line">       # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span><br><span class="line">      group_by: [&apos;job&apos;,&apos;alertname&apos;,&apos;severity&apos;]</span><br><span class="line">      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span><br><span class="line">      group_wait: 30s</span><br><span class="line">      group_interval: 5m</span><br><span class="line">      # 当第一个报警发送后，等待&apos;group_interval&apos;时间来发送新的一组报警信息。</span><br><span class="line">      repeat_interval: 12h</span><br><span class="line">      # 如果一个报警信息已经发送成功了，等待&apos;repeat_interval&apos;时间来重新发送他们</span><br><span class="line"></span><br><span class="line">      #group_interval: 5m</span><br><span class="line">      #repeat_interval: 12h</span><br><span class="line"></span><br><span class="line">      receiver: default #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: webhook</span><br><span class="line">        match:</span><br><span class="line">          alertname:  NodeMemoryUsage #匹配这个内存报警</span><br><span class="line"></span><br><span class="line">    receivers:</span><br><span class="line">    - name: &apos;default&apos;</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: &apos;314144952@qq.com&apos;</span><br><span class="line">        send_resolved: true</span><br><span class="line">    - name: &apos;webhook&apos;</span><br><span class="line">      webhook_configs:</span><br><span class="line">      - url: &apos;http://dingtalk-hook:5000&apos;</span><br><span class="line">        send_resolved: true</span><br></pre></td></tr></table></figure><p>部分参数说明：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span><br><span class="line">  group_by: [&apos;alertname&apos;, &apos;cluster&apos;]</span><br><span class="line">  # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span><br><span class="line">  group_wait: 30s</span><br><span class="line"> </span><br><span class="line">  # 当第一个报警发送后，等待&apos;group_interval&apos;时间来发送新的一组报警信息。</span><br><span class="line">  group_interval: 5m</span><br><span class="line"> </span><br><span class="line">  # 如果一个报警信息已经发送成功了，等待&apos;repeat_interval&apos;时间来重新发送他们</span><br><span class="line">  repeat_interval: 5m</span><br><span class="line"> </span><br><span class="line">  # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span><br><span class="line">  receiver: default</span><br><span class="line"> </span><br><span class="line">  # 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。</span><br></pre></td></tr></table></figure><h2 id="配置告警信息模板"><a href="#配置告警信息模板" class="headerlink" title="配置告警信息模板"></a>配置告警信息模板</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-tmpl</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  wechat.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;wechat.default.message&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">  email.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;email.default.html&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[toc]&lt;/p&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/prometheus/alertmanager&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/prometheus/alertmanager&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://prometheus.io/docs/alerting/alertmanager/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://prometheus.io/docs/alerting/alertmanager/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/wangxu01/articles/11654836.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/wangxu01/articles/11654836.html&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Alertmanager 主要用于接收 Prometheus 发送的告警信息，它支持丰富的告警通知渠道，而且很容易做到告警信息进行去重，降噪，分组等，是一款前卫的告警通知系统。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/19.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/21.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://gongzhao1.coding.me/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="alertmanager" scheme="https://gongzhao1.coding.me/tags/alertmanager/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群监控之全手动部署</title>
    <link href="https://gongzhao1.coding.me/Kubernetes%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E4%B9%8B%E5%85%A8%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2/"/>
    <id>https://gongzhao1.coding.me/Kubernetes集群监控之全手动部署/</id>
    <published>2020-02-18T06:27:50.000Z</published>
    <updated>2020-04-08T14:20:25.863Z</updated>
    
    <content type="html"><![CDATA[<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://blog.csdn.net/liukuan73/article/details/78881008" target="_blank" rel="noopener">https://blog.csdn.net/liukuan73/article/details/78881008</a></li><li><a href="https://github.com/liukuan73/kubernetes-addons" target="_blank" rel="noopener">https://github.com/liukuan73/kubernetes-addons</a></li></ul><h1 id="总体目标"><a href="#总体目标" class="headerlink" title="总体目标"></a>总体目标</h1><p>从监控平台本身的业务需求来看，至少应该通过平台获取到以下的监控数据：</p><p>性能指标(如：CPU、Memory、Load、磁盘、网络等）</p><ul><li>容器、Pod相关的性能指标数据</li><li>主机节点相关的性能指标数据</li><li>容器内进程自己主动暴露的指标数据</li><li>k8s上应用的网络性能，如http、tcp等数据</li></ul><p>状态指标</p><ul><li>k8s资源对象（Deployment、Daemonset、Pod等）的运行状态指标</li><li>k8s平台组件（如kube-apiserver、kube-scheduler等）的运行状态指标</li></ul><p>获取监控数据之后，还需要对监控进行可视化展示，以及对监控中出现的异常情况进行告警。</p><a id="more"></a><h1 id="主流方案"><a href="#主流方案" class="headerlink" title="主流方案"></a>主流方案</h1><p>目前对于kubernetes的主流监控方案主要有以下几种：</p><p><strong>Heapster+InfluxDB+Grafana</strong></p><p>每个K8S节点的Kubelet内含cAdvisor，暴露出API，Heapster通过访问这些端点得到容器监控数据。它支持多种储存方式，常用的是InfluxDB。这套方案的缺点是数据来源单一、缺乏报警功能以及InfluxDB的单点问题，而且Heapster也已经在新版本中被deprecated(被metrics server取代)了。这种实现方案的详细介绍请见这篇文章。</p><p><strong>Metrics-Server+InfluxDB+Grafana</strong></p><p>k8s从1.8版本开始，CPU、内存等资源的metrics信息可以通过 Metrics API来获取，用户还可以通过kubectl top直接获取这些metrics信息。Metrics API需要部署Metrics-Server。</p><p><strong>各种Exporter+Prometheus+Grafana</strong></p><p>通过各种export采集不同维度的监控指标，并通过Prometheus支持的数据格式暴露出来，Prometheus定期pull数据并用Grafana展示，异常情况使用AlertManager告警。本方案下文详细叙述。</p><h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p>总体实现思路如下：</p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/19.png" alt="image"></p><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/prometheus/20.png" alt="image"></p><p><strong>采集</strong></p><ul><li><p>通过cadvisor采集容器、Pod相关的性能指标数据，并通过暴露的/metrics接口用prometheus抓取</p></li><li><p>通过prometheus-node-exporter采集主机的性能指标数据，并通过暴露的/metrics接口用prometheus抓取</p></li><li><p>应用侧自己采集容器中进程主动暴露的指标数据（暴露指标的功能由应用自己实现，并添加平台侧约定的annotation，平台侧负责根据annotation实现通过Prometheus的抓取）</p></li><li><p>通过blackbox-exporter采集应用的网络性能(http、tcp、icmp等)数据，并通过暴露的/metrics接口用prometheus抓取</p></li><li><p>通过kube-state-metrics采集k8s资源对象的状态指标数据，并通过暴露的/metrics接口用prometheus抓取</p></li><li><p>通过etcd、kubelet、kube-apiserver、kube-controller-manager、kube-scheduler自身暴露的/metrics获取节点上与k8s集群相关的一些特征指标数据。</p></li></ul><p><strong>存储（汇聚），通过prometheus pull并汇聚各种exporter的监控数据</strong></p><p><strong>展示，通过grafana展示监控信息</strong></p><p><strong>告警，通过alertmanager进行告警</strong></p><h1 id="监控指标采集实现"><a href="#监控指标采集实现" class="headerlink" title="监控指标采集实现"></a>监控指标采集实现</h1><h2 id="容器、Pod相关的性能指标数据—cAdvisor"><a href="#容器、Pod相关的性能指标数据—cAdvisor" class="headerlink" title="容器、Pod相关的性能指标数据—cAdvisor"></a>容器、Pod相关的性能指标数据—cAdvisor</h2><p>cAdvisor是谷歌开源的一个容器监控工具，cadvisor采集了主机上容器相关的性能指标数据，通过容器的指标还可进一步计算出pod的指标。</p><p>cadvisor提供的一些主要指标有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">container_cpu_*</span><br><span class="line">container_fs_*</span><br><span class="line">container_memory_*</span><br><span class="line">container_network_*</span><br><span class="line">container_spec_*(cpu/memory)</span><br><span class="line">container_start_time_*</span><br><span class="line">container_tasks_state_*</span><br></pre></td></tr></table></figure><p><strong>cadvisor接口</strong></p><p>目前cAdvisor集成到了kubelet组件内，可以在kubernetes集群中每个启动了kubelet的节点使用cAdvisor提供的metrics接口获取该节点所有容器相关的性能指标数据。1.7.3版本以前，cadvisor的metrics数据集成在kubelet的metrics中，在1.7.3以后版本中cadvisor的metrics被从kubelet的metrics独立出来了，在prometheus采集的时候变成两个scrape的job。</p><p>cAdvisor对外提供服务的默认端口为<strong><em>4194</em></strong>，主要提供两种接口:</p><ul><li><p>Prometheus格式指标接口：nodeIP:4194/metrics(或者通过kubelet暴露的cadvisor接口nodeIP:10255/metrics/cadvisor);</p></li><li><p>WebUI界面接口：nodeIP:4194/containers/</p></li></ul><p>Prometheus作为一个时间序列数据收集，处理，存储的服务，能够监控的对象必须通过http api暴露出基于Prometheus认可的数据模型的监控数据，cAdvisor接口（nodeIP:4194/metrics）暴露的监控指标数据如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># HELP cadvisor_version_info A metric with a constant &apos;1&apos; value labeled by kernel version, OS version, docker version, cadvisor version &amp; cadvisor revision.</span><br><span class="line"># TYPE cadvisor_version_info gauge</span><br><span class="line">cadvisor_version_info&#123;cadvisorRevision=&quot;&quot;,cadvisorVersion=&quot;&quot;,dockerVersion=&quot;1.12.6&quot;,kernelVersion=&quot;4.9.0-1.2.el7.bclinux.x86_64&quot;,osVersion=&quot;CentOS Linux 7 (Core)&quot;&#125; 1</span><br><span class="line"># HELP container_cpu_cfs_periods_total Number of elapsed enforcement period intervals.</span><br><span class="line"># TYPE container_cpu_cfs_periods_total counter</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;&quot;,id=&quot;/kubepods/burstable/pod1b0c1f83322defae700f33b1b8b7f572&quot;,image=&quot;&quot;,name=&quot;&quot;,namespace=&quot;&quot;,pod_name=&quot;&quot;&#125; 7.062239e+06</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;&quot;,id=&quot;/kubepods/burstable/pod7f86ba308f28df9915b802bc48cfee3a&quot;,image=&quot;&quot;,name=&quot;&quot;,namespace=&quot;&quot;,pod_name=&quot;&quot;&#125; 1.574206e+06</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;&quot;,id=&quot;/kubepods/burstable/podb0c8f695146fe62856bc23709a3e056b&quot;,image=&quot;&quot;,name=&quot;&quot;,namespace=&quot;&quot;,pod_name=&quot;&quot;&#125; 7.107043e+06</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;&quot;,id=&quot;/kubepods/burstable/podc8cf73836b3caba7bf952ce1ac5a5934&quot;,image=&quot;&quot;,name=&quot;&quot;,namespace=&quot;&quot;,pod_name=&quot;&quot;&#125; 5.932159e+06</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;&quot;,id=&quot;/kubepods/burstable/podfaa9db59-64b7-11e8-8792-00505694eb6a&quot;,image=&quot;&quot;,name=&quot;&quot;,namespace=&quot;&quot;,pod_name=&quot;&quot;&#125; 6.979547e+06</span><br><span class="line">container_cpu_cfs_periods_total&#123;container_name=&quot;calico-node&quot;,id=&quot;/kubepods/burstable/podfaa9db59-64b7-11e8-8792-</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>Prometheus配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;cadvisor&apos;</span><br><span class="line">  # 通过https访问apiserver，通过apiserver的api获取数据</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">        </span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等 </span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从k8s的node对象获取数据</span><br><span class="line">  - role: node</span><br><span class="line"></span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 用新的前缀代替原label name前缀，没有replacement的话功能就是去掉label name前缀</span><br><span class="line">  # 例如：以下两句的功能就是将__meta_kubernetes_node_label_kubernetes_io_hostname</span><br><span class="line">  # 变为kubernetes_io_hostname</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">    </span><br><span class="line">  # replacement中的值将会覆盖target_label中指定的label name的值,</span><br><span class="line">  # 即__address__的值会被替换为kubernetes.default.svc:443</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    replacement: kubernetes.default.svc:443</span><br><span class="line">    </span><br><span class="line">  # 获取__meta_kubernetes_node_name的值</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    #匹配一个或多个任意字符，将上述source_labels的值生成变量</span><br><span class="line">    regex: (.+)</span><br><span class="line">    # replacement中的值将会覆盖target_label中指定的label name的值,</span><br><span class="line">    # 即__metrics_path__的值会被替换为/api/v1/nodes/$&#123;1&#125;/proxy/metrics,</span><br><span class="line">    # 其中$&#123;1&#125;的值会被替换为__meta_kubernetes_node_name的值</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line">    </span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">    - action: replace</span><br><span class="line">      source_labels: [id]</span><br><span class="line">      regex: &apos;^/machine\.slice/machine-rkt\\x2d([^\\]+)\\.+/([^/]+)\.service$&apos;</span><br><span class="line">      target_label: rkt_container_name</span><br><span class="line">      replacement: &apos;$&#123;2&#125;-$&#123;1&#125;&apos;</span><br><span class="line">    - action: replace</span><br><span class="line">      source_labels: [id]</span><br><span class="line">      regex: &apos;^/system\.slice/(.+)\.service$&apos;</span><br><span class="line">      target_label: systemd_service_name</span><br><span class="line">      replacement: &apos;$&#123;1&#125;&apos;</span><br></pre></td></tr></table></figure><p>之后，在prometheus的target(IP:Port/targets)中可以看到cadvisor相应的target</p><p><strong>PS:</strong></p><blockquote><p>关于配置文件的一些说明：</p><ol><li>以上配置遵照官方example配置，通过apiserver提供的api做代理获取cAdvisor（ <a href="https://kubernetes.default.svc:443/api/v1/nodes/k8smaster01/proxy/metrics/cadvisor" target="_blank" rel="noopener">https://kubernetes.default.svc:443/api/v1/nodes/k8smaster01/proxy/metrics/cadvisor</a> ）的监控指标(和从nodeIP:4194/metrics获取到的内容是一样的)，而不是直接从node上获取。为什么这样做，官方这样解释的：This means it will work if Prometheus is running out of cluster, or can’t connect to nodes for some other reason (e.g. because of firewalling)。</li><li>Promethues在K8S集群内通过DNS地址 <a href="https://kubernetes.default.svc访问apiserver来scrape数据" target="_blank" rel="noopener">https://kubernetes.default.svc访问apiserver来scrape数据</a></li><li>Prometheus配置文件的语法规则较复杂，为便于理解，我加了一些注释；更多语法规则请见Prometheus官方文档。</li></ol></blockquote><p>关于target中label的一些说明，target中必有的几个source label有：</p><ol><li>__address__(当static_configs时通过targets手工配置，当kubernetes_sd_configs时，值从apiserver中获取)、</li><li>__metrics_path__(默认值是/metrics)、</li><li>__scheme__(默认值是http)</li><li>job</li></ol><p>其他source label则是根据kubernetes_sd_configs时设置的- role(如endpoints、nodes、service、pod等)从k8s资源对象的label、annotation及其他一些信息中提取的</p><h2 id="主机节点性能指标数据—node-exporter"><a href="#主机节点性能指标数据—node-exporter" class="headerlink" title="主机节点性能指标数据—node-exporter"></a>主机节点性能指标数据—node-exporter</h2><p>Prometheus社区提供的<a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">NodeExporter</a>项目可以对主机的关键度量指标进行监控，通过Kubernetes的DeamonSet可以在各个主机节点上部署有且仅有一个NodeExporter实例，实现对主机性能指标数据的监控。node-exporter所采集的指标主要有:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_*</span><br><span class="line">node_disk_*</span><br><span class="line">node_entropy_*</span><br><span class="line">node_filefd_*</span><br><span class="line">node_filesystem_*</span><br><span class="line">node_forks_*</span><br><span class="line">node_intr_total_*</span><br><span class="line">node_ipvs_*</span><br><span class="line">node_load_*</span><br><span class="line">node_memory_*</span><br><span class="line">node_netstat_*</span><br><span class="line">node_network_*</span><br><span class="line">node_nf_conntrack_*</span><br><span class="line">node_scrape_*</span><br><span class="line">node_sockstat_*</span><br><span class="line">node_time_seconds_*</span><br><span class="line">node_timex_*</span><br><span class="line">node_xfs_*</span><br></pre></td></tr></table></figure><p><strong>Prometheus配置</strong></p><p>node-exporter-daemonset.yaml, node-exporter-svc.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: prometheus-node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-node-exporter</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/node-exporter:v0.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: prometheus-node-exporter</span><br><span class="line">        ports:</span><br><span class="line">        - name: prom-node-exp</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          hostPort: 9100</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 9100</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 20m</span><br><span class="line">            memory: 2Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      hostPID: true</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics: &apos;true&apos;</span><br><span class="line">    prometheus.io/app-metrics-path: &apos;/metrics&apos;</span><br><span class="line">  name: prometheus-node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: prometheus-node-exporter</span><br><span class="line">      port: 9100</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-node-exporter</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure><p>PS：</p><blockquote><p>1.为了让容器里的node-exporter获取到主机上的网络、PID、IPC指标，这里设置了hostNetwork: true、hostPID: true、hostIPC: true，来与主机共用网络、PID、IPC这三个namespace。</p><p>2.此处在Service的annotations中定义标注prometheus.io/scrape: ‘true’，表明该Service需要被Promethues发现并采集数据。</p></blockquote><p>通过NodeExporter暴露的metrics接口(nodeIP:9100/metrics)查看采集到的数据，可以看到是按Prometheus的格式输出的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># HELP node_arp_entries ARP entries by device</span><br><span class="line"># TYPE node_arp_entries gauge</span><br><span class="line">node_arp_entries&#123;device=&quot;calid63983a5754&quot;&#125; 1</span><br><span class="line">node_arp_entries&#123;device=&quot;calid67ce395c9e&quot;&#125; 1</span><br><span class="line">node_arp_entries&#123;device=&quot;calid857f2bf9d5&quot;&#125; 1</span><br><span class="line">node_arp_entries&#123;device=&quot;calief3a4b64165&quot;&#125; 1</span><br><span class="line">node_arp_entries&#123;device=&quot;eno16777984&quot;&#125; 9</span><br><span class="line"># HELP node_boot_time Node boot time, in unixtime.</span><br><span class="line"># TYPE node_boot_time gauge</span><br><span class="line">node_boot_time 1.527752719e+09</span><br><span class="line"># HELP node_context_switches Total number of context switches.</span><br><span class="line"># TYPE node_context_switches counter</span><br><span class="line">node_context_switches 3.1425612674e+10</span><br><span class="line"># HELP node_cpu Seconds the cpus spent in each mode.</span><br><span class="line"># TYPE node_cpu counter</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;guest&quot;&#125; 0</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;guest_nice&quot;&#125; 0</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;idle&quot;&#125; 2.38051096e+06</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;iowait&quot;&#125; 11904.19</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;irq&quot;&#125; 0</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;nice&quot;&#125; 2990.94</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;softirq&quot;&#125; 8038.3</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>Prometheus配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;prometheus-node-exporter&apos;</span><br><span class="line">  </span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  #The endpoints role discovers targets from listed endpoints of a service. For each</span><br><span class="line">  #endpoint address one target is discovered per port. If the endpoint is backed by</span><br><span class="line">  #a pod, all additional container ports of the pod, not bound to an endpoint port,</span><br><span class="line">  #are discovered as targets as well</span><br><span class="line">  - role: endpoints</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 只保留endpoints的annotations中含有prometheus.io/scrape: &apos;true&apos;和port的name为prometheus-node-exporter的endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    regex: true;prometheus-node-exporter</span><br><span class="line">    action: keep</span><br><span class="line">  # Match regex against the concatenated source_labels. Then, set target_label to replacement, </span><br><span class="line">  # with match group references ($&#123;1&#125;, $&#123;2&#125;, ...) in replacement substituted by their value. </span><br><span class="line">  # If regex does not match, no replacement takes place.</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __scheme__</span><br><span class="line">    regex: (https?)</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    regex: (.+)(?::\d+);(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">  # 去掉label name中的前缀__meta_kubernetes_service_label_</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">  # 将__meta_kubernetes_namespace重命名为kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  # 将__meta_kubernetes_service_name重命名为kubernetes_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_name</span><br></pre></td></tr></table></figure><h2 id="采集应用实例中某个进程自己暴露的指标数据"><a href="#采集应用实例中某个进程自己暴露的指标数据" class="headerlink" title="采集应用实例中某个进程自己暴露的指标数据"></a>采集应用实例中某个进程自己暴露的指标数据</h2><p>有的应用具有暴露容器内具体进程性能指标的需求，这些指标由应用侧实现采集并暴露，平台侧做汇聚。</p><h3 id="如何标识哪些是主动暴露监控指标的应用并获取指标"><a href="#如何标识哪些是主动暴露监控指标的应用并获取指标" class="headerlink" title="如何标识哪些是主动暴露监控指标的应用并获取指标"></a>如何标识哪些是主动暴露监控指标的应用并获取指标</h3><p>平台侧可以约定好带哪些annotation前缀的服务是自主暴露监控指标的服务。应用添加平台侧约定的这些annotations，平台侧可以根据这些annotations实现Prometheus的scrape。</p><p>例如，应用侧为自己的服务添加如下平台侧约定约定的annotation：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">prometheus.io/app-metrics: &apos;true&apos;</span><br><span class="line">prometheus.io/app-metrics-port: &apos;8080&apos;</span><br><span class="line">prometheus.io/app-metrics-path: &apos;/metrics&apos;</span><br></pre></td></tr></table></figure><p>Prometheus可以：</p><ul><li>根据prometheus.io/scrape: ‘true’获知对应的endpoint是需要被scrape的</li><li>根据prometheus.io/app-metrics: ‘true’获知对应的endpoint中有应用进程暴露的metrics</li><li>根据prometheus.io/app-metrics-port: ‘8080’获知进程暴露的metrics的端口号</li><li>根据prometheus.io/app-metrics-path: ‘/metrics’获知进程暴露的metrics的具体路径</li></ul><h3 id="如何给应用加一些标志信息，并带到Prometheus侧"><a href="#如何给应用加一些标志信息，并带到Prometheus侧" class="headerlink" title="如何给应用加一些标志信息，并带到Prometheus侧"></a>如何给应用加一些标志信息，并带到Prometheus侧</h3><p>可能还需要根据平台和业务的需求添加其他一些以prometheus.io/app-info-为前缀的annotation，Prometheus截取下前缀，保留后半部分做key，连同value保留下来。这样满足在平台对应用做其他一些标识的需求。比如加入如下annotation来标识应用所属的的环境、租户以及应用名称</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prometheus.io/app-info-env: &apos;test&apos;</span><br><span class="line">prometheus.io/app-info-tenant: &apos;test-tenant&apos;</span><br><span class="line">prometheus.io/app-info-name: &apos;test-app&apos;</span><br></pre></td></tr></table></figure><p><strong>Prometheus配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kubernetes-app-metrics&apos;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  #The endpoints role discovers targets from listed endpoints of a service. For each</span><br><span class="line">  #endpoint address one target is discovered per port. If the endpoint is backed by</span><br><span class="line">  #a pod, all additional container ports of the pod, not bound to an endpoint port,</span><br><span class="line">  #are discovered as targets as well</span><br><span class="line">  - role: endpoints</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 只保留endpoint中含有prometheus.io/scrape: &apos;true&apos;的annotation的endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_app_metrics]</span><br><span class="line">    regex: true;true</span><br><span class="line">    action: keep</span><br><span class="line">  # 将用户指定的进程的metrics_path替换默认的metrics_path</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_app_metrics_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  # 用pod_ip和用户指定的进程的metrics端口组合成真正的可以拿到数据的地址来替换原始__address__</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_service_annotation_prometheus_io_app_metrics_port]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    regex: (.+);(.+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">  # 去掉label name中的前缀__meta_kubernetes_service_annotation_prometheus_io_app_info_</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br></pre></td></tr></table></figure><p>PS:</p><blockquote><p>最后两行的作用是将例如<code>prometheus.io/app-info-tenant</code>的annotation名切割成名为<code>tenant</code>的label。</p></blockquote><h2 id="通过blackbox-exporter采集应用的网络性能数据"><a href="#通过blackbox-exporter采集应用的网络性能数据" class="headerlink" title="通过blackbox-exporter采集应用的网络性能数据"></a>通过blackbox-exporter采集应用的网络性能数据</h2><p><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">blackbox-exporter</a>是一个黑盒探测工具，可以对服务的http、tcp、icmp等进行网络探测。</p><h3 id="blackbox-exporter部署"><a href="#blackbox-exporter部署" class="headerlink" title="blackbox-exporter部署"></a>blackbox-exporter部署</h3><p>blackbox-exporter-deploy.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus-blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus-blackbox-exporter</span><br><span class="line">        image: prom/blackbox-exporter:v0.16.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: 50Mi</span><br><span class="line">            cpu: 50m</span><br><span class="line">          limits:</span><br><span class="line">            memory: 60Mi</span><br><span class="line">            cpu: 100m</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /etc/blackbox_exporter</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/etc/blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --web.listen-address=:9115</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-blackbox-exporter</span><br></pre></td></tr></table></figure><p>black-exporter-config.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          valid_status_codes: []</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      http_post_2xx: # http post 监测模块</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 10s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          method: POST</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 10s</span><br><span class="line">      icmp:</span><br><span class="line">        prober: icmp</span><br><span class="line">        timeout: 10s</span><br><span class="line">        icmp:</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br></pre></td></tr></table></figure><p>black-exporter-svc.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  name: prometheus-blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus-blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">  - name: blackbox</span><br><span class="line">    port: 9115</span><br><span class="line">    targetPort: 9115</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure><p>PS：</p><blockquote><p>blackbox-exporter的配置文件为/etc/blackbox_exporter/blackbox.yml，可以运行时动态的重新加载配置文件，当重新加载配置文件失败时，不影响在运行的配置。重载方式：curl -XPOST <a href="http://IP:9115/-/reload" target="_blank" rel="noopener">http://IP:9115/-/reload</a></p></blockquote><p><strong>Prometheus配置</strong></p><p>在Prometheus的config文件中分别配置对http和tcp的探测：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kubernetes-service-http-probe&apos;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: service</span><br><span class="line">  # 将metrics_path由默认的/metrics改为/probe</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  # Optional HTTP URL parameters.</span><br><span class="line">  # 生成__param_module=&quot;http_2xx&quot;的label</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 只保留含有label为prometheus/io=scrape的service</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_http_probe]</span><br><span class="line">    regex: true;true</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __param_target</span><br><span class="line">    regex: (.+);(.+);(.+);(.+)</span><br><span class="line">    replacement: $1.$2:$3$4</span><br><span class="line">  # 用__address__这个label的值创建一个名为__param_target的label为blackbox-exporter,值为内部service的访问地址，作为blackbox-exporter采集用</span><br><span class="line">  #- source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]</span><br><span class="line">  #  action: replace</span><br><span class="line">  #  target_label: __param_target</span><br><span class="line">  #  regex: (.+);(.+)</span><br><span class="line">  #  replacement: $1$2</span><br><span class="line">  # 用blackbox-exporter的service地址值”prometheus-blackbox-exporter:9115&quot;替换原__address__的值</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    replacement: prometheus-blackbox-exporter:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  # 去掉label name中的前缀__meta_kubernetes_service_annotation_prometheus_io_app_info_</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br><span class="line">  #- source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">  #  target_label: kubernetes_namespace</span><br><span class="line">  #- source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">  #  target_label: kubernetes_name</span><br><span class="line">## kubernetes-services and kubernetes-ingresses are blackbox_exporter related</span><br><span class="line"></span><br><span class="line"># Example scrape config for probing services via the Blackbox Exporter.</span><br><span class="line"># </span><br><span class="line"># The relabeling allows the actual service scrape endpoint to be configured</span><br><span class="line"># for all or only some services.</span><br><span class="line">- job_name: &apos;kubernetes-service-tcp-probe&apos;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: service</span><br><span class="line">  # 将metrics_path由默认的/metrics改为/probe</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  # Optional HTTP URL parameters.</span><br><span class="line">  # 生成__param_module=&quot;tcp_connect&quot;的label</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 只保留含有label为prometheus/io=scrape的service</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe]</span><br><span class="line">    regex: true;true</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe_port]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __param_target</span><br><span class="line">    regex: (.+);(.+);(.+)</span><br><span class="line">    replacement: $1.$2:$3</span><br><span class="line">  # 用__address__这个label的值创建一个名为__param_target的label为blackbox-exporter,值为内部service的访问地址，作为blackbox-exporter采集用</span><br><span class="line">  #- source_labels: [__address__]</span><br><span class="line">  #  target_label: __param_target</span><br><span class="line">  # 用blackbox-exporter的service地址值”prometheus-blackbox-exporter:9115&quot;替换原__address__的值</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    replacement: prometheus-blackbox-exporter:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  # 去掉label name中的前缀__meta_kubernetes_service_annotation_prometheus_io_app_info_</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br></pre></td></tr></table></figure><p><strong>应用侧配置</strong></p><p>应用可以在service中指定平台侧约定的annotation，实现监控平台对该应用的网络服务进行探测：</p><p>http探测</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">prometheus.io/http-probe: &apos;true&apos;</span><br><span class="line">prometheus.io/http-probe-port: &apos;8080&apos;</span><br><span class="line">prometheus.io/http-probe-path: &apos;/healthz&apos;</span><br></pre></td></tr></table></figure><p>tcp探测</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">prometheus.io/tcp-probe: &apos;true&apos;</span><br><span class="line">prometheus.io/tcp-probe-port: &apos;80&apos;</span><br></pre></td></tr></table></figure><p>Prometheus根据这些annotation可以获知相应service是需要被探测的，探测的具体网络协议是http还是tcp或其他，以及具体的探测端口。http探测的话还要知道探测的具体url。</p><h2 id="资源对象-Deployment、Pod等-的状态—kube-state-metrics"><a href="#资源对象-Deployment、Pod等-的状态—kube-state-metrics" class="headerlink" title="资源对象(Deployment、Pod等)的状态—kube-state-metrics"></a>资源对象(Deployment、Pod等)的状态—kube-state-metrics</h2><p>kube-state-metrics采集了k8s中各种资源对象的状态信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kube_daemonset_*（创建时间、所处的阶段、期望跑在几台节点上、应当正在运行的节点数量、不应该跑却跑了daemon pod的节点数、跑好了pod(ready)的节点数）</span><br><span class="line">kube_deployment_*（创建时间、是否将k8s的label转化为prometheus的label、所处的阶段、是不是以处于paused状态并不再被dp controller处理、期望副本数、rolling update时最多不可用副本数、dp controller观察到的阶段、实际副本数、availabel副本数、unavailabel副本数、updated副本数)</span><br><span class="line">kube_job_*（是否执行完成、创建时间戳...)</span><br><span class="line">kube_namespace_*</span><br><span class="line">kube_node_*</span><br><span class="line">kube_persistentvolumeclaim_*</span><br><span class="line">kube_pod_container_*</span><br><span class="line">kube_pod_*</span><br><span class="line">kube_replicaset_*</span><br><span class="line">kube_service_*</span><br><span class="line">kube_statefulset_*</span><br></pre></td></tr></table></figure><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>kube-state-metrics-deploy.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-state-metrics</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: bitnami/kube-state-metrics:1.8.0</span><br><span class="line">        ports:</span><br><span class="line">        - protocol: TCP</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 20m</span><br><span class="line">            memory: 512Mi</span><br></pre></td></tr></table></figure><p>kube-state-metrics-svc.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-state-metrics</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: kube-state-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-state-metrics</span><br></pre></td></tr></table></figure><p><strong>Prometheus配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kube-state-metrics&apos;</span><br><span class="line">  </span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line"></span><br><span class="line">  #The endpoints role discovers targets from listed endpoints of a service. For each</span><br><span class="line">  #endpoint address one target is discovered per port. If the endpoint is backed by</span><br><span class="line">  #a pod, all additional container ports of the pod, not bound to an endpoint port,</span><br><span class="line">  #are discovered as targets as well</span><br><span class="line">  - role: endpoints</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 只保留endpoint中的annotations含有prometheus.io/scrape: &apos;true&apos;和port的name为prometheus-node-exporter的endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape,__meta_kubernetes_endpoint_port_name]</span><br><span class="line">    regex: true;kube-state-metrics</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __scheme__</span><br><span class="line">    regex: (https?)</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    regex: (.+)(?::\d+);(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">  # 去掉label name中的前缀__meta_kubernetes_service_label_</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">  # 将__meta_kubernetes_namespace重命名为kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  # 将__meta_kubernetes_service_name重命名为kubernetes_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_name</span><br></pre></td></tr></table></figure><h2 id="k8s集群组件的状态指标采集"><a href="#k8s集群组件的状态指标采集" class="headerlink" title="k8s集群组件的状态指标采集"></a>k8s集群组件的状态指标采集</h2><p>etcd、kube-controller-manager、kube-scheduler、kube-proxy、kube-apiserver、kubelet这几个k8d平台组件分别向外暴露了prometheus标准的指标接口/metrics。可通过配置prometheus来进行读取。</p><h3 id="etcd指标获取"><a href="#etcd指标获取" class="headerlink" title="etcd指标获取"></a>etcd指标获取</h3><p>以kubeadm启动的k8s集群中，etcd是以static pod的形式启动的，默认没有service及对应的endpoint可供集群内的prometheus访问。所以首先创建一个用来为prometheus提供接口的service（endpoint），etcd-svc.yaml文件如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: etcd-prometheus-discovery</span><br><span class="line">  labels:</span><br><span class="line">    component: etcd</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    component: etcd</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 2379</span><br><span class="line">    targetPort: 2379</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure><p>prometheus配置抓取的文件加入如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;etcd&apos;</span><br><span class="line"></span><br><span class="line">  # 通过https访问apiserver</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从endpoints获取apiserver数据</span><br><span class="line">  - role: endpoints</span><br><span class="line"></span><br><span class="line">  #relabel_configs允许在抓取之前对任何目标及其标签进行修改。</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 选择哪些label</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class="line">    # 上述选择的label的值需要与下述对应</span><br><span class="line">    regex: true;kube-system;etcd-prometheus-discovery</span><br><span class="line">    # 含有符合regex的source_label的endpoints进行保留</span><br><span class="line">    action: keep</span><br></pre></td></tr></table></figure><h3 id="kube-proxy指标获取"><a href="#kube-proxy指标获取" class="headerlink" title="kube-proxy指标获取"></a>kube-proxy指标获取</h3><p>kube-proxy通过10249端口暴露/metrics指标。与3.6.1同理，kube-proxy-svc.yaml如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: kube-proxy-prometheus-discovery</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-proxy</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-proxy</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 10249</span><br><span class="line">    targetPort: 10249</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure><p>prometheus配置抓取的文件加入如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kube-proxy&apos;</span><br><span class="line"></span><br><span class="line"># 通过https访问apiserver</span><br><span class="line">tls_config:</span><br><span class="line">  ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">#以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等</span><br><span class="line">kubernetes_sd_configs:</span><br><span class="line"># 从endpoints获取apiserver数据</span><br><span class="line">- role: endpoints</span><br><span class="line"></span><br><span class="line">#relabel_configs允许在抓取之前对任何目标及其标签进行修改。</span><br><span class="line">relabel_configs:</span><br><span class="line"># 选择哪些label</span><br><span class="line">- source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class="line">  # 上述选择的label的值需要与下述对应</span><br><span class="line">  regex: true;kube-system;kube-proxy-prometheus-discovery</span><br><span class="line">  # 含有符合regex的source_label的endpoints进行保留</span><br><span class="line">  action: keep</span><br></pre></td></tr></table></figure><h3 id="kube-scheduler指标获取"><a href="#kube-scheduler指标获取" class="headerlink" title="kube-scheduler指标获取"></a>kube-scheduler指标获取</h3><p>kube-scheduler通过10251端口暴露/metrics指标。与3.6.1同理，kube-scheduler-svc.yaml如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: kube-scheduler-prometheus-discovery</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    component: kube-scheduler</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 10251</span><br><span class="line">    targetPort: 10251</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure><p>prometheus对应的配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kube-scheduler&apos;</span><br><span class="line"></span><br><span class="line">  # 通过https访问apiserver</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从endpoints获取apiserver数据</span><br><span class="line">  - role: endpoints</span><br><span class="line"></span><br><span class="line">  #relabel_configs允许在抓取之前对任何目标及其标签进行修改。</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 选择哪些label</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class="line">    # 上述选择的label的值需要与下述对应</span><br><span class="line">    regex: true;kube-system;kube-scheduler-prometheus-discovery</span><br><span class="line">    # 含有符合regex的source_label的endpoints进行保留</span><br><span class="line">    action: keep</span><br></pre></td></tr></table></figure><h3 id="kube-controller-manager指标获取"><a href="#kube-controller-manager指标获取" class="headerlink" title="kube-controller-manager指标获取"></a>kube-controller-manager指标获取</h3><p>kube-controller-manager通过10252端口暴露/metrics指标。与etcd同理，kube-controller-manager-svc.yaml如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: kube-controller-manager-prometheus-discovery</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-controller-manager</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    component: kube-controller-manager</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 10252</span><br><span class="line">    targetPort: 10252</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure><p>prometheus配置抓取的文件加入如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kube-controller-manager&apos;</span><br><span class="line"></span><br><span class="line">  # 通过https访问apiserver</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从endpoints获取apiserver数据</span><br><span class="line">  - role: endpoints</span><br><span class="line"></span><br><span class="line">  #relabel_configs允许在抓取之前对任何目标及其标签进行修改。</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 选择哪些label</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class="line">    # 上述选择的label的值需要与下述对应</span><br><span class="line">    regex: true;kube-system;kube-controller-manager-prometheus-discovery</span><br><span class="line">    # 含有符合regex的source_label的endpoints进行保留</span><br><span class="line">    action: keep</span><br></pre></td></tr></table></figure><p>以上四步配置好后可以在promethues的web UI中看到对应的targets</p><h3 id="kube-apiserver数据获取"><a href="#kube-apiserver数据获取" class="headerlink" title="kube-apiserver数据获取"></a>kube-apiserver数据获取</h3><p>kube-apiserver与上面四个组件不同的是，部署好后集群中默认会有一个名为kubernetes的service和对应的名为kubernetes的endpoint，这个endpoint就是集群内的kube-apiserver的访问入口。可以如下配置prometheus抓取数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kube-apiservers&apos;</span><br><span class="line"></span><br><span class="line">  # 通过https访问apiserver</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"></span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从endpoints获取apiserver数据</span><br><span class="line">  - role: endpoints</span><br><span class="line"></span><br><span class="line">  #relabel_configs允许在抓取之前对任何目标及其标签进行修改。</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 选择哪些label</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    # 上述选择的label的值需要与下述对应</span><br><span class="line">    regex: default;kubernetes;https</span><br><span class="line">    # 含有符合regex的source_label的endpoints进行保留</span><br><span class="line">    action: keep</span><br></pre></td></tr></table></figure><h3 id="kubelet数据获取"><a href="#kubelet数据获取" class="headerlink" title="kubelet数据获取"></a>kubelet数据获取</h3><p>kubelet暴露的metrics端口默认为 10255：</p><ul><li>提供的prometheus格式指标接口：nodeIP:10255/metrics，使用Prometheus从这里取数据</li><li>kubelet提供的stats/summary接口：nodeIP:10255/stats/summary，heapster和最新的metrics-server从这里获取数据</li></ul><p>kubelet采集的指标主要有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiserver_client_certificate_expiration_seconds_bucket</span><br><span class="line">apiserver_client_certificate_expiration_seconds_sum</span><br><span class="line">apiserver_client_certificate_expiration_seconds_count</span><br><span class="line">etcd_helper_cache_entry_count</span><br><span class="line">etcd_helper_cache_hit_count</span><br><span class="line">etcd_helper_cache_miss_count</span><br><span class="line">etcd_request_cache_add_latencies_summary</span><br><span class="line">etcd_request_cache_add_latencies_summary_sum</span><br><span class="line">etcd_request_cache_add_latencies_summary_count</span><br><span class="line">etcd_request_cache_get_latencies_summary</span><br><span class="line">etcd_request_cache_get_latencies_summary_sum</span><br><span class="line">etcd_request_cache_get_latencies_summary_count</span><br><span class="line">kubelet_cgroup_manager_latency_microseconds</span><br><span class="line">kubelet_containers_per_pod_count</span><br><span class="line">kubelet_docker_operations</span><br><span class="line">kubelet_network_plugin_operations_latency_microseconds</span><br><span class="line">kubelet_pleg_relist_interval_microseconds</span><br><span class="line">kubelet_pleg_relist_latency_microseconds</span><br><span class="line">kubelet_pod_start_latency_microseconds</span><br><span class="line">kubelet_pod_worker_latency_microseconds</span><br><span class="line">kubelet_running_container_count</span><br><span class="line">kubelet_running_pod_count</span><br><span class="line">kubelet_runtime_operations*</span><br><span class="line">kubernetes_build_info</span><br><span class="line">process_cpu_seconds_total</span><br><span class="line">reflector*</span><br><span class="line">rest_client_request_*</span><br><span class="line">storage_operation_duration_seconds_*</span><br></pre></td></tr></table></figure><p>查看kubelet监控指标数据（nodeIP:10255/metrics）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span><br><span class="line"># TYPE apiserver_audit_event_total counter</span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span><br><span class="line"># TYPE apiserver_client_certificate_expiration_seconds histogram</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;0&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;21600&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;43200&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;86400&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;172800&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;345600&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;604800&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;2.592e+06&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;7.776e+06&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;1.5552e+07&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;3.1104e+07&quot;&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=&quot;+Inf&quot;&#125; 4161</span><br><span class="line">apiserver_client_certificate_expiration_seconds_sum 1.3091542942737878e+12</span><br><span class="line">apiserver_client_certificate_expiration_seconds_count 4161</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>kubelet由于在每个节点上都有且仅有一个，所以可以通过k8s的node对象找到kubelet的指标，prometheus配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &apos;kubelet&apos;</span><br><span class="line">  # 通过https访问apiserver，通过apiserver的api获取数据</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">          </span><br><span class="line">  #以k8s的角色(role)来定义收集，比如node,service,pod,endpoints,ingress等等 </span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 从k8s的node对象获取数据</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  # 用新的前缀代替原label name前缀，没有replacement的话功能就是去掉label_name前缀</span><br><span class="line">  # 例如：以下两句的功能就是将__meta_kubernetes_node_label_kubernetes_io_hostname</span><br><span class="line">  # 变为kubernetes_io_hostname</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  # replacement中的值将会覆盖target_label中指定的label name的值,</span><br><span class="line">  # 即__address__的值会被替换为kubernetes.default.svc:443</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    replacement: kubernetes.default.svc:443</span><br><span class="line">    #replacement: 10.142.21.21:6443</span><br><span class="line">  # 获取__meta_kubernetes_node_name的值</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    #匹配一个或多个任意字符，将上述source_labels的值生成变量</span><br><span class="line">    regex: (.+)</span><br><span class="line">    # 将# replacement中的值将会覆盖target_label中指定的label name的值,</span><br><span class="line">    # 即__metrics_path__的值会被替换为/api/v1/nodes/$&#123;1&#125;/proxy/metrics,</span><br><span class="line">    # 其中$&#123;1&#125;的值会被替换为__meta_kubernetes_node_name的值</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="line">  #or:</span><br><span class="line">  #- source_labels: [__address__]</span><br><span class="line">  #  regex: &apos;(.*):10250&apos;</span><br><span class="line">  #  replacement: &apos;$&#123;1&#125;:4194&apos;</span><br><span class="line">  #  target_label: __address__</span><br><span class="line">  #- source_labels: [__meta_kubernetes_node_label_role]</span><br><span class="line">  #  action: replace</span><br><span class="line">  #  target_label: role</span><br></pre></td></tr></table></figure><h1 id="Prometheus部署"><a href="#Prometheus部署" class="headerlink" title="Prometheus部署"></a>Prometheus部署</h1><p><strong>prometheus-rbac.yml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: prometheus</span><br><span class="line">    namespace: monitoring</span><br></pre></td></tr></table></figure><p><strong>prometheus-sts.yml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  serviceName: prometheus</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: prometheus</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      containers:</span><br><span class="line">        - name: prometheus</span><br><span class="line">          image: &quot;prom/prometheus:v2.14.0&quot;</span><br><span class="line">          imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">          command:</span><br><span class="line">          - &quot;/bin/prometheus&quot;</span><br><span class="line">          args:</span><br><span class="line">            - --config.file=/etc/prometheus/config/prometheus.yml</span><br><span class="line">            - --storage.tsdb.path=/prometheus</span><br><span class="line">            - --storage.tsdb.retention=14d</span><br><span class="line">            - --web.enable-lifecycle</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 9090</span><br><span class="line">              protocol: TCP</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /-/ready</span><br><span class="line">              port: 9090</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /-/healthy</span><br><span class="line">              port: 9090</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          # based on 10 running nodes with 30 pods each</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 200m</span><br><span class="line">              memory: 8Gi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 4Gi</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: prometheus-config</span><br><span class="line">              mountPath: /etc/prometheus/config</span><br><span class="line">              #mountPath: /etc/prometheus/prometheus.yml</span><br><span class="line">              #subPath: prometheus.yml</span><br><span class="line">            - name: prometheus-rules</span><br><span class="line">              mountPath: /etc/prometheus/rules</span><br><span class="line">            - name: prometheus-data</span><br><span class="line">              mountPath: /prometheus</span><br><span class="line">      volumes:</span><br><span class="line">        - name: prometheus-config</span><br><span class="line">          configMap:</span><br><span class="line">            name: prometheus-config</span><br><span class="line">        - name: prometheus-rules</span><br><span class="line">          configMap:</span><br><span class="line">            name: prometheus-rules</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: nfs-rw</span><br><span class="line">        volume.beta.kubernetes.io/storage-provisioner: flexvolume-huawei.com/fuxinfs</span><br><span class="line">      enable: true</span><br><span class="line">      name: prometheus-data</span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteOnce</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 200Gi</span><br></pre></td></tr></table></figure><p>对args参数做几点说明:</p><ul><li><p>–storage.tsdb.path：tsdb数据库存储路径</p></li><li><p>–storage.tsdb.retention：数据保留多久，可以看官方文档存储部分</p></li><li><p>–config.file：指定prometheus的config文件的路径</p></li><li><p>–web.enable-lifecycle：加上这个参数后可以向/-/reload(curl -XPOST 10.142.232.150:30006/-/reload)发送HTTP POST请求实现prometheus在config文件修改后的动态reload，更多信息请查看官方文档</p></li><li><p>–web.enable-admin-api：加上这个参数可以为一些高级用户暴露操作数据库功能的API，比如快照备份(curl -XPOST http://<prometheus>/api/v2/admin/tsdb/snapshot)，更多信息请查看官方文档 TSDB Admin APIs部分</prometheus></p></li></ul><p><strong>prometheus-svc.yml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    nodePort: 30026</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: prometheus</span><br></pre></td></tr></table></figure><p><strong>prometheus-config.yml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  prometheus.yml: |</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval:     15s</span><br><span class="line">      evaluation_interval: 15s</span><br><span class="line">      scrape_timeout:      10s</span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - alertmanager:9093</span><br><span class="line">    rule_files:</span><br><span class="line">    - &quot;/etc/prometheus/rules/*.rules&quot;</span><br><span class="line"></span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: &apos;Prometheus&apos;</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line">    #- job_name: &apos;federate&apos;</span><br><span class="line">      #scrape_interval: 30s</span><br><span class="line">      #scrape_timeout:  30s</span><br><span class="line">      #honor_labels: true</span><br><span class="line">      #metrics_path: &apos;/federate&apos;</span><br><span class="line">      #params:</span><br><span class="line">        #&apos;match[]&apos;:</span><br><span class="line">          #- &apos;&#123;job=~&quot;.+&quot;&#125;&apos;</span><br><span class="line">          ##- &apos;&#123;job=~&quot;kubernetes-.*&quot;&#125;&apos;</span><br><span class="line">      #static_configs:</span><br><span class="line">        #- targets:</span><br><span class="line">          #- &apos;prometheus.prometheus:9090&apos;</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;Web&apos;</span><br><span class="line">      scrape_interval: 60s</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [&quot;https://www.baidu.com&quot;]</span><br><span class="line">          labels:</span><br><span class="line">            service: baidu</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: __param_target</span><br><span class="line">        - source_labels: [__param_target]</span><br><span class="line">          target_label: instance</span><br><span class="line">        - target_label: __address__</span><br><span class="line">          replacement: localhost:9115</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;Ping&apos;</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [icmp]</span><br><span class="line">      static_configs:</span><br><span class="line">       - targets: [&apos;192.168.0.11&apos;]</span><br><span class="line">         labels:</span><br><span class="line">           suites: &apos;test&apos;</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__address__]</span><br><span class="line">          target_label: __param_target</span><br><span class="line">        - source_labels: [__param_target]</span><br><span class="line">          target_label: instance</span><br><span class="line">        - target_label: __address__</span><br><span class="line">          replacement: localhost:9115</span><br><span class="line"></span><br><span class="line">    #- job_name: &apos;Mysql&apos;</span><br><span class="line">      #scrape_interval: 5s</span><br><span class="line">      #static_configs:</span><br><span class="line">        #- targets: [&apos;localhost:9104&apos;]</span><br><span class="line">          #labels:</span><br><span class="line">            #instance: cnhwrds01</span><br><span class="line"></span><br><span class="line">    #- job_name: ECS</span><br><span class="line">      #static_configs:</span><br><span class="line">        #- targets: [&apos;192.168.0.11:9100&apos;]</span><br><span class="line">          #labels:</span><br><span class="line">            #instance: test</span><br><span class="line"></span><br><span class="line">    #- job_name: Redis</span><br><span class="line">      #static_configs:</span><br><span class="line">      #- targets: [&apos;localhost:9121&apos;]</span><br><span class="line">        #labels:</span><br><span class="line">          #instance: test</span><br><span class="line"></span><br><span class="line">    #- job_name: pushgateway</span><br><span class="line">      #scrape_interval: 1m</span><br><span class="line">      #static_configs:</span><br><span class="line">        #- targets: [&apos;localhost:9091&apos;]</span><br><span class="line">          #labels:</span><br><span class="line">            #instance: pushgateway</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-apiservers&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: default;kubernetes;https</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-nodes&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-service-endpoints&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __scheme__</span><br><span class="line">        regex: (https?)</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-services&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-ingresses&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: ingress</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]</span><br><span class="line">        regex: (.+);(.+);(.+)</span><br><span class="line">        replacement: $&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_ingress_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-pods&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">        target_label: __address__</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;prometheus-node-exporter&apos;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      #The endpoints role discovers targets from listed endpoints of a service. For each</span><br><span class="line">      #endpoint address one target is discovered per port. If the endpoint is backed by</span><br><span class="line">      #a pod, all additional container ports of the pod, not bound to an endpoint port,</span><br><span class="line">      #are discovered as targets as well</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      # 只保留endpoints的annotations中含有prometheus.io/scrape: &apos;true&apos;和port的name为prometheus-node-exporter的endpoint</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        regex: true;prometheus-node-exporter</span><br><span class="line">        action: keep</span><br><span class="line">      # Match regex against the concatenated source_labels. Then, set target_label to replacement,</span><br><span class="line">      # with match group references ($&#123;1&#125;, $&#123;2&#125;, ...) in replacement substituted by their value.</span><br><span class="line">      # If regex does not match, no replacement takes place.</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __scheme__</span><br><span class="line">        regex: (https?)</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: (.+)(?::\d+);(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">      # 去掉label name中的前缀__meta_kubernetes_service_label_</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      # 将__meta_kubernetes_namespace重命名为kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      # 将__meta_kubernetes_service_name重命名为kubernetes_name</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-cadvisor&apos;</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-service-http-probe&apos;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_http_probe]</span><br><span class="line">        regex: true;true</span><br><span class="line">        action: keep</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __param_target</span><br><span class="line">        regex: (.+);(.+);(.+);(.+)</span><br><span class="line">        replacement: $1.$2:$3$4</span><br><span class="line">      # 用__address__这个label的值创建一个名为__param_target的label为blackbox-exporter,值为内部service的访问地址，作为blackbox-exporter采集用</span><br><span class="line">      #- source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]</span><br><span class="line">      #  action: replace</span><br><span class="line">      #  target_label: __param_target</span><br><span class="line">      #  regex: (.+);(.+)</span><br><span class="line">      #  replacement: $1$2</span><br><span class="line">      # 用blackbox-exporter的service地址值”prometheus-blackbox-exporter:9115&quot;替换原__address__的值</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: prometheus-blackbox-exporter:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      # 去掉label name中的前缀__meta_kubernetes_service_annotation_prometheus_io_app_info_</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubernetes-service-tcp-probe&apos;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [tcp_connect]</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe]</span><br><span class="line">        regex: true;true</span><br><span class="line">        action: keep</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __param_target</span><br><span class="line">        regex: (.+);(.+);(.+)</span><br><span class="line">        replacement: $1.$2:$3</span><br><span class="line">      # 用__address__这个label的值创建一个名为__param_target的label为blackbox-exporter,值为内部service的访问地址，作为blackbox-exporter采集用</span><br><span class="line">      #- source_labels: [__address__]</span><br><span class="line">      #  target_label: __param_target</span><br><span class="line">      # 用blackbox-exporter的service地址值”prometheus-blackbox-exporter:9115&quot;替换原__address__的值</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: prometheus-blackbox-exporter:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      # 去掉label name中的前缀__meta_kubernetes_service_annotation_prometheus_io_app_info_</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kube-state-metrics&apos;</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      # 只保留endpoint中的annotations含有prometheus.io/scrape: &apos;true&apos;和port的name为prometheus-node-exporter的endpoint</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape,__meta_kubernetes_endpoint_port_name]</span><br><span class="line">        regex: true;kube-state-metrics</span><br><span class="line">        action: keep</span><br><span class="line">      # 去掉label name中的前缀__meta_kubernetes_service_label_</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      # 将__meta_kubernetes_namespace重命名为kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      # 将__meta_kubernetes_service_name重命名为kubernetes_name</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;kubelet&apos;</span><br><span class="line">      # 通过https访问apiserver，通过apiserver的api获取数据</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      # 从k8s的node对象获取数据</span><br><span class="line">      - role: node</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      # 获取__meta_kubernetes_node_name的值</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="line"></span><br><span class="line">    - job_name: &apos;coredns&apos;</span><br><span class="line">      # 通过https访问apiserver</span><br><span class="line">      #scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        regex: true;kube-system;coredns-prometheus-discovery;http-metrics</span><br><span class="line">        action: keep</span><br></pre></td></tr></table></figure><p><strong>prometheus-rules.yml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-rules</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  alertmanager.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: alertmanager.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: AlertmanagerReloadFailed</span><br><span class="line">        expr: alertmanager_config_last_reload_successful == 0</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Reloading Alertmanager&apos;s configuration has failed for &#123;&#123; $labels.namespace</span><br><span class="line">            &#125;&#125;/&#123;&#123; $labels.pod&#125;&#125;.</span><br><span class="line">          summary: Alertmanager configuration reload has failed</span><br><span class="line">  general.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: general.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: TargetDown</span><br><span class="line">        expr: 100 * (count(up == 0) BY (job) / count(up) BY (job)) &gt; 10</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $value &#125;&#125;% or more of &#123;&#123; $labels.job &#125;&#125; targets are down.&apos;</span><br><span class="line">          summary: Targets are down</span><br><span class="line">      - alert: DeadMansSwitch</span><br><span class="line">        expr: vector(1)</span><br><span class="line">        labels:</span><br><span class="line">          severity: none</span><br><span class="line">        annotations:</span><br><span class="line">          description: This is a DeadMansSwitch meant to ensure that the entire Alerting</span><br><span class="line">            pipeline is functional.</span><br><span class="line">          summary: Alerting DeadMansSwitch</span><br><span class="line">      - alert: TooManyOpenFileDescriptors</span><br><span class="line">        expr: 100 * (process_open_fds / process_max_fds) &gt; 95</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.job &#125;&#125;: &#123;&#123; $labels.namespace &#125;&#125;/&#123;&#123; $labels.pod &#125;&#125; (&#123;&#123;</span><br><span class="line">            $labels.instance &#125;&#125;) is using &#123;&#123; $value &#125;&#125;% of the available file/socket descriptors.&apos;</span><br><span class="line">          summary: too many open file descriptors</span><br><span class="line">      - record: instance:fd_utilization</span><br><span class="line">        expr: process_open_fds / process_max_fds</span><br><span class="line">      - alert: FdExhaustionClose</span><br><span class="line">        expr: predict_linear(instance:fd_utilization[1h], 3600 * 4) &gt; 1</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.job &#125;&#125;: &#123;&#123; $labels.namespace &#125;&#125;/&#123;&#123; $labels.pod &#125;&#125; (&#123;&#123;</span><br><span class="line">            $labels.instance &#125;&#125;) instance will exhaust in file/socket descriptors soon&apos;</span><br><span class="line">          summary: file descriptors soon exhausted</span><br><span class="line">      - alert: FdExhaustionClose</span><br><span class="line">        expr: predict_linear(instance:fd_utilization[10m], 3600) &gt; 1</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.job &#125;&#125;: &#123;&#123; $labels.namespace &#125;&#125;/&#123;&#123; $labels.pod &#125;&#125; (&#123;&#123;</span><br><span class="line">            $labels.instance &#125;&#125;) instance will exhaust in file/socket descriptors soon&apos;</span><br><span class="line">          summary: file descriptors soon exhausted</span><br><span class="line">  job.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: job.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: CronJobRunning</span><br><span class="line">        expr: time() -kube_cronjob_next_schedule_time &gt; 3600</span><br><span class="line">        for: 1h</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: CronJob &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.cronjob&#125;&#125; is taking more than 1h to complete</span><br><span class="line">          summary: CronJob didn&apos;t finish after 1h</span><br><span class="line">      - alert: JobCompletion</span><br><span class="line">        expr: kube_job_spec_completions - kube_job_status_succeeded  &gt; 0</span><br><span class="line">        for: 1h</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Job completion is taking more than 1h to complete</span><br><span class="line">            cronjob &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.job&#125;&#125;</span><br><span class="line">          summary: Job &#123;&#123;$labels.job&#125;&#125; didn&apos;t finish to complete after 1h</span><br><span class="line">      - alert: JobFailed</span><br><span class="line">        expr: kube_job_status_failed  &gt; 0</span><br><span class="line">        for: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Job &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.job&#125;&#125; failed to complete</span><br><span class="line">          summary: Job failed</span><br><span class="line">  kube-apiserver.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: kube-apiserver.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: K8SApiserverDown</span><br><span class="line">        expr: absent(up&#123;job=&quot;kubernetes-apiservers&quot;&#125; == 1)</span><br><span class="line">        for: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: Prometheus failed to scrape API server(s), or all API servers have</span><br><span class="line">            disappeared from service discovery.</span><br><span class="line">          summary: API server unreachable</span><br><span class="line">      - alert: K8SApiServerLatency</span><br><span class="line">        expr: histogram_quantile(0.99, sum(apiserver_request_latencies_bucket&#123;subresource!=&quot;log&quot;,verb!~&quot;CONNECT|WATCHLIST|WATCH|PROXY&quot;&#125;)</span><br><span class="line">          WITHOUT (instance, resource)) / 1e+06 &gt; 1</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: 99th percentile Latency for &#123;&#123; $labels.verb &#125;&#125; requests to the</span><br><span class="line">            kube-apiserver is higher than 1s.</span><br><span class="line">          summary: Kubernetes apiserver latency is high</span><br><span class="line">  kube-state-metrics.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: kube-state-metrics.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: DeploymentGenerationMismatch</span><br><span class="line">        expr: kube_deployment_status_observed_generation != kube_deployment_metadata_generation</span><br><span class="line">        for: 15m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Observed deployment generation does not match expected one for</span><br><span class="line">            deployment &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.deployment&#125;&#125;</span><br><span class="line">          summary: Deployment is outdated</span><br><span class="line">      - alert: DeploymentReplicasNotUpdated</span><br><span class="line">        expr: ((kube_deployment_status_replicas_updated != kube_deployment_spec_replicas)</span><br><span class="line">          or (kube_deployment_status_replicas_available != kube_deployment_spec_replicas))</span><br><span class="line">          unless (kube_deployment_spec_paused == 1)</span><br><span class="line">        for: 15m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Replicas are not updated and available for deployment &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.deployment&#125;&#125;</span><br><span class="line">          summary: Deployment replicas are outdated</span><br><span class="line">      - alert: DaemonSetRolloutStuck</span><br><span class="line">        expr: kube_daemonset_status_number_ready / kube_daemonset_status_desired_number_scheduled</span><br><span class="line">          * 100 &lt; 100</span><br><span class="line">        for: 15m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Only &#123;&#123;$value&#125;&#125;% of desired pods scheduled and ready for daemon</span><br><span class="line">            set &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.daemonset&#125;&#125;</span><br><span class="line">          summary: DaemonSet is missing pods</span><br><span class="line">      - alert: K8SDaemonSetsNotScheduled</span><br><span class="line">        expr: kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled</span><br><span class="line">          &gt; 0</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: A number of daemonsets are not scheduled.</span><br><span class="line">          summary: Daemonsets are not scheduled correctly</span><br><span class="line">      - alert: DaemonSetsMissScheduled</span><br><span class="line">        expr: kube_daemonset_status_number_misscheduled &gt; 0</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: A number of daemonsets are running where they are not supposed</span><br><span class="line">            to run.</span><br><span class="line">          summary: Daemonsets are not scheduled correctly</span><br><span class="line">      - alert: PodFrequentlyRestarting</span><br><span class="line">        expr: increase(kube_pod_container_status_restarts_total[1h]) &gt; 5</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Pod &#123;&#123;$labels.namespaces&#125;&#125;/&#123;&#123;$labels.pod&#125;&#125; is was restarted &#123;&#123;$value&#125;&#125;</span><br><span class="line">            times within the last hour</span><br><span class="line">          summary: Pod is restarting frequently</span><br><span class="line">      - alert: KubeNodeNotReady</span><br><span class="line">        expr: kube_node_status_condition&#123;job=&quot;kube-state-metrics&quot;,condition=&quot;Ready&quot;,status=&quot;true&quot;&#125; == 0</span><br><span class="line">        for: 1h</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          message: &apos;&#123;&#123; $labels.node &#125;&#125; has been unready for more than an hour&apos;</span><br><span class="line">          runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubenodenotready</span><br><span class="line">      - alert: K8SManyNodesNotReady</span><br><span class="line">        expr: count(kube_node_status_condition&#123;condition=&quot;Ready&quot;,status=&quot;true&quot;&#125; == 0)</span><br><span class="line">          &gt; 1 and (count(kube_node_status_condition&#123;condition=&quot;Ready&quot;,status=&quot;true&quot;&#125; ==</span><br><span class="line">          0) / count(kube_node_status_condition&#123;condition=&quot;Ready&quot;,status=&quot;true&quot;&#125;)) &gt; 0.5</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $value &#125;&#125; Kubernetes nodes (more than 10% are in the NotReady</span><br><span class="line">            state).&apos;</span><br><span class="line">          summary: Many Kubernetes nodes are Not Ready</span><br><span class="line">  kubelet.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: kubelet.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: K8SKubeletDown</span><br><span class="line">        expr: count(up&#123;job=&quot;kubelet&quot;&#125; == 0) / count(up&#123;job=&quot;kubelet&quot;&#125;) &gt; 0.03</span><br><span class="line">        for: 1h</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Prometheus failed to scrape &#123;&#123; $value &#125;&#125;% of kubelets.</span><br><span class="line">          summary: Many Kubelets cannot be scraped</span><br><span class="line">      - alert: K8SManyKubeletDown</span><br><span class="line">        expr: absent(up&#123;job=&quot;kubelet&quot;&#125; == 1) or count(up&#123;job=&quot;kubelet&quot;&#125; == 0) / count(up&#123;job=&quot;kubelet&quot;&#125;)</span><br><span class="line">          &gt; 0.5</span><br><span class="line">        for: 1h</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: Prometheus failed to scrape &#123;&#123; $value &#125;&#125;% of kubelets, or all Kubelets</span><br><span class="line">            have disappeared from service discovery.</span><br><span class="line">          summary: Many Kubelets cannot be scraped</span><br><span class="line">      - alert: K8SKubeletTooManyPods</span><br><span class="line">        expr: kubelet_running_pod_count &gt; 100</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Kubelet &#123;&#123;$labels.instance&#125;&#125; is running &#123;&#123;$value&#125;&#125; pods, close</span><br><span class="line">            to the limit of 110</span><br><span class="line">          summary: Kubelet is close to pod limit</span><br><span class="line">  kubernetes.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: kubernetes.rules</span><br><span class="line">      rules:</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:spec_memory_limit_bytes</span><br><span class="line">        expr: sum(label_replace(container_spec_memory_limit_bytes&#123;container_name!=&quot;&quot;&#125;,</span><br><span class="line">          &quot;controller&quot;, &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace,</span><br><span class="line">          controller, pod_name, container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:spec_cpu_shares</span><br><span class="line">        expr: sum(label_replace(container_spec_cpu_shares&#123;container_name!=&quot;&quot;&#125;, &quot;controller&quot;,</span><br><span class="line">          &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace, controller, pod_name,</span><br><span class="line">          container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:cpu_usage:rate</span><br><span class="line">        expr: sum(label_replace(irate(container_cpu_usage_seconds_total&#123;container_name!=&quot;&quot;&#125;[5m]),</span><br><span class="line">          &quot;controller&quot;, &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace,</span><br><span class="line">          controller, pod_name, container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_usage:bytes</span><br><span class="line">        expr: sum(label_replace(container_memory_usage_bytes&#123;container_name!=&quot;&quot;&#125;, &quot;controller&quot;,</span><br><span class="line">          &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace, controller, pod_name,</span><br><span class="line">          container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_working_set:bytes</span><br><span class="line">        expr: sum(label_replace(container_memory_working_set_bytes&#123;container_name!=&quot;&quot;&#125;,</span><br><span class="line">          &quot;controller&quot;, &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace,</span><br><span class="line">          controller, pod_name, container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_rss:bytes</span><br><span class="line">        expr: sum(label_replace(container_memory_rss&#123;container_name!=&quot;&quot;&#125;, &quot;controller&quot;,</span><br><span class="line">          &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace, controller, pod_name,</span><br><span class="line">          container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_cache:bytes</span><br><span class="line">        expr: sum(label_replace(container_memory_cache&#123;container_name!=&quot;&quot;&#125;, &quot;controller&quot;,</span><br><span class="line">          &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace, controller, pod_name,</span><br><span class="line">          container_name)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_pagefaults:rate</span><br><span class="line">        expr: sum(label_replace(irate(container_memory_failures_total&#123;container_name!=&quot;&quot;&#125;[5m]),</span><br><span class="line">          &quot;controller&quot;, &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace,</span><br><span class="line">          controller, pod_name, container_name, scope, type)</span><br><span class="line">      - record: cluster_namespace_controller_pod_container:memory_oom:rate</span><br><span class="line">        expr: sum(label_replace(irate(container_memory_failcnt&#123;container_name!=&quot;&quot;&#125;[5m]),</span><br><span class="line">          &quot;controller&quot;, &quot;$1&quot;, &quot;pod_name&quot;, &quot;^(.*)-[a-z0-9]+&quot;)) BY (cluster, namespace,</span><br><span class="line">          controller, pod_name, container_name, scope, type)</span><br><span class="line">      - record: cluster:memory_allocation:percent</span><br><span class="line">        expr: 100 * sum(container_spec_memory_limit_bytes&#123;pod_name!=&quot;&quot;&#125;) BY (cluster)</span><br><span class="line">          / sum(machine_memory_bytes) BY (cluster)</span><br><span class="line">      - record: cluster:memory_used:percent</span><br><span class="line">        expr: 100 * sum(container_memory_usage_bytes&#123;pod_name!=&quot;&quot;&#125;) BY (cluster) / sum(machine_memory_bytes)</span><br><span class="line">          BY (cluster)</span><br><span class="line">      - record: cluster:cpu_allocation:percent</span><br><span class="line">        expr: 100 * sum(container_spec_cpu_shares&#123;pod_name!=&quot;&quot;&#125;) BY (cluster) / sum(container_spec_cpu_shares&#123;id=&quot;/&quot;&#125;</span><br><span class="line">          * ON(cluster, instance) machine_cpu_cores) BY (cluster)</span><br><span class="line">      - record: cluster_resource_verb:apiserver_latency:quantile_seconds</span><br><span class="line">        expr: histogram_quantile(0.99, sum(apiserver_request_latencies_bucket) BY (le,</span><br><span class="line">          cluster, job, resource, verb)) / 1e+06</span><br><span class="line">        labels:</span><br><span class="line">          quantile: &quot;0.99&quot;</span><br><span class="line">      - record: cluster_resource_verb:apiserver_latency:quantile_seconds</span><br><span class="line">        expr: histogram_quantile(0.9, sum(apiserver_request_latencies_bucket) BY (le,</span><br><span class="line">          cluster, job, resource, verb)) / 1e+06</span><br><span class="line">        labels:</span><br><span class="line">          quantile: &quot;0.9&quot;</span><br><span class="line">      - record: cluster_resource_verb:apiserver_latency:quantile_seconds</span><br><span class="line">        expr: histogram_quantile(0.5, sum(apiserver_request_latencies_bucket) BY (le,</span><br><span class="line">          cluster, job, resource, verb)) / 1e+06</span><br><span class="line">        labels:</span><br><span class="line">          quantile: &quot;0.5&quot;</span><br><span class="line">  node.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: node.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: NodeExporterDown</span><br><span class="line">        expr: absent(up&#123;job=&quot;prometheus-node-exporter&quot;&#125; == 1)</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Prometheus could not scrape a node-exporter for more than 10m,</span><br><span class="line">            or node-exporters have disappeared from discovery.</span><br><span class="line">          summary: node-exporter cannot be scraped</span><br><span class="line">      - alert: K8SNodeOutOfDisk</span><br><span class="line">        expr: kube_node_status_condition&#123;condition=&quot;OutOfDisk&quot;,status=&quot;true&quot;&#125; == 1</span><br><span class="line">        labels:</span><br><span class="line">          service: k8s</span><br><span class="line">          severity: critical</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.node &#125;&#125; has run out of disk space.&apos;</span><br><span class="line">          summary: Node ran out of disk space.</span><br><span class="line">      - alert: K8SNodeMemoryPressure</span><br><span class="line">        expr: kube_node_status_condition&#123;condition=&quot;MemoryPressure&quot;,status=&quot;true&quot;&#125; == 1</span><br><span class="line">        labels:</span><br><span class="line">          service: k8s</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.node &#125;&#125; is under memory pressure.&apos;</span><br><span class="line">          summary: Node is under memory pressure.</span><br><span class="line">      - alert: K8SNodeDiskPressure</span><br><span class="line">        expr: kube_node_status_condition&#123;condition=&quot;DiskPressure&quot;,status=&quot;true&quot;&#125; == 1</span><br><span class="line">        labels:</span><br><span class="line">          service: k8s</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: &apos;&#123;&#123; $labels.node &#125;&#125; is under disk pressure.&apos;</span><br><span class="line">          summary: Node is under disk pressure.</span><br><span class="line">      - alert: NodeCPUUsage</span><br><span class="line">        expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total&#123;job=&quot;prometheus-node-exporter&quot;,mode=&quot;idle&quot;&#125;[5m])) * 100)) &gt; 90</span><br><span class="line">        for: 30m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: High CPU usage detected&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;: CPU usage is above 90% (current value is: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">      - alert: NodeMemoryUsage</span><br><span class="line">        expr: (((node_memory_MemTotal_bytes-node_memory_MemFree_bytes-node_memory_Cached_bytes)/(node_memory_MemTotal_bytes)*100)) &gt; 90</span><br><span class="line">        for: 30m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: High memory usage detected&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 90% (current value is: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  prometheus.rules: |+</span><br><span class="line">    groups:</span><br><span class="line">    - name: prometheus.rules</span><br><span class="line">      rules:</span><br><span class="line">      - alert: PrometheusReloadFailed</span><br><span class="line">        expr: prometheus_config_last_reload_successful == 0</span><br><span class="line">        for: 10m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          description: Reloading Prometheus&apos; configuration has failed for &#123;&#123; $labels.namespace</span><br><span class="line">            &#125;&#125;/&#123;&#123; $labels.pod&#125;&#125;.</span><br><span class="line">          summary: Prometheus configuration reload has failed</span><br></pre></td></tr></table></figure><h1 id="可视化展示Grafana"><a href="#可视化展示Grafana" class="headerlink" title="可视化展示Grafana"></a>可视化展示Grafana</h1><h2 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:6.5.2</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 10</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/health</span><br><span class="line">            port: 3000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">        name: grafana</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          name: grafana</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/health</span><br><span class="line">            port: 3000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/grafana/grafana.ini</span><br><span class="line">          name: config</span><br><span class="line">          subPath: grafana.ini</span><br><span class="line">        - mountPath: /var/lib/grafana</span><br><span class="line">          name: storage</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: prometheus-grafana</span><br><span class="line">        name: config</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: storage</span><br><span class="line">        </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  grafana.ini: |</span><br><span class="line">    [server]</span><br><span class="line">    root_url = https://www.baidu.com</span><br><span class="line">    [log]</span><br><span class="line">    mode = console</span><br><span class="line">    level = info</span><br><span class="line">    [paths]</span><br><span class="line">    data = /var/lib/grafana/data</span><br><span class="line">    logs = /var/log/grafana</span><br><span class="line">    plugins = /var/lib/grafana/plugins</span><br><span class="line">    provisioning = /etc/grafana/provisioning</span><br><span class="line">    [smtp]</span><br><span class="line">    enabled = true</span><br><span class="line">    host = user</span><br><span class="line">    user = user</span><br><span class="line">    password = password</span><br><span class="line">    cert_file =</span><br><span class="line">    key_file =</span><br><span class="line">    skip_verify = false</span><br><span class="line">    from_address = user</span><br><span class="line">    from_name = user</span><br><span class="line">    [emails]</span><br><span class="line">    welcome_email_on_sign_up = true</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">    #prometheus.io/tcp-probe: &apos;true&apos;</span><br><span class="line">    #prometheus.io/tcp-probe-port: &apos;80&apos;</span><br><span class="line">  name: prometheus-grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30028</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h2 id="grafana配置"><a href="#grafana配置" class="headerlink" title="grafana配置"></a>grafana配置</h2><ul><li>添加数据源</li><li>添加dashboard</li></ul><p>一些比较实用的模板：</p><p>315这个模板是cadvisor采集的各种指标的图表<br>1860这个模板是node-exporter采集的各种主机相关的指标的图表<br>6417这个模板是kube-state-metrics采集的各种k8s资源对象的状态的图表<br>4859和4865这两个模板是blackbox-exporter采集的服务的http状态指标的图表（两个效果基本一样，选择其一即可）<br>5345这个模板是blackbox-exporter采集的服务的网络状态指标的图表</p><h1 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h1><p>设置警报和通知的主要步骤：</p><ul><li>安装配置Alertmanager</li><li>配置Prometheus与Alertmanager通信</li><li>在Prometheus中创建告警规则</li></ul><h2 id="部署-2"><a href="#部署-2" class="headerlink" title="部署"></a>部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/alertmanager:v0.19.0</span><br><span class="line">        name: alertmanager</span><br><span class="line">        args:</span><br><span class="line">        - &quot;--config.file=/etc/alertmanager/config/alertmanager.yml&quot;</span><br><span class="line">        - &quot;--storage.path=/alertmanager&quot;</span><br><span class="line">        - &quot;--data.retention=720h&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/alertmanager&quot;</span><br><span class="line">          name: data</span><br><span class="line">        - mountPath: &quot;/etc/alertmanager/config&quot;</span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: &quot;/etc/alertmanager/template&quot;</span><br><span class="line">          name: alertmanager-tmpl</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br><span class="line">      - name: alertmanager-tmpl</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-tmpl</span><br><span class="line">          </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 1m</span><br><span class="line">      wechat_api_corp_id: &apos;****&apos;</span><br><span class="line">      wechat_api_url: &apos;****&apos;</span><br><span class="line">      wechat_api_secret: &apos;****&apos;</span><br><span class="line">      smtp_smarthost: &apos;****&apos;</span><br><span class="line">      smtp_from: &apos;****&apos;</span><br><span class="line">      smtp_auth_username: &apos;****&apos;</span><br><span class="line">      smtp_auth_password: &apos;****&apos;</span><br><span class="line">      smtp_require_tls: true</span><br><span class="line"></span><br><span class="line">    templates:</span><br><span class="line">    - &apos;/etc/alertmanager/template/*.tmpl&apos;</span><br><span class="line"></span><br><span class="line">    route:</span><br><span class="line">      group_by: [&apos;alertname&apos;, &apos;job&apos;]</span><br><span class="line">      group_wait: 20s</span><br><span class="line">      group_interval: 20s</span><br><span class="line">      repeat_interval: 2m</span><br><span class="line">      receiver: &apos;email&apos;</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: &quot;email&quot;</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        continue: true</span><br><span class="line">        match_re:</span><br><span class="line">          severity: critical|error|warning</span><br><span class="line">      #- receiver: &quot;wechat&quot;</span><br><span class="line">        #group_wait: 10s</span><br><span class="line">        #continue: true</span><br><span class="line">        #match_re:</span><br><span class="line">          #severity: critical|error|warning</span><br><span class="line"></span><br><span class="line">    receivers:</span><br><span class="line">    #- name: &quot;wechat&quot;</span><br><span class="line">      #wechat_configs:</span><br><span class="line">      #- send_resolved: true</span><br><span class="line">        #to_party: &apos;1&apos;</span><br><span class="line">        #agent_id: 1000003</span><br><span class="line">        #corp_id: &apos;****&apos;</span><br><span class="line">        #api_url: &apos;****&apos;</span><br><span class="line">        #api_secret: &apos;****&apos;</span><br><span class="line">    - name: &quot;email&quot;</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: &apos;cumt_gongzhao@163.com&apos;</span><br><span class="line">        send_resolved: true</span><br><span class="line"></span><br><span class="line">    inhibit_rules:</span><br><span class="line">    - source_match:</span><br><span class="line">        severity: &apos;critical&apos;</span><br><span class="line">      target_match:</span><br><span class="line">        severity: &apos;error&apos;</span><br><span class="line">      equal: [&apos;alertname&apos;]</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: alertmanager</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &apos;true&apos;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9093</span><br><span class="line">    targetPort: 9093</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 30027</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: alertmanager</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-tmpl</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  wechat.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;wechat.default.message&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">  email.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;email.default.html&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @警报</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    @恢复</span><br><span class="line">    状态: &#123;&#123; .Status &#125;&#125;</span><br><span class="line">    名称: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    级别: &#123;&#123; .Labels.severity  &#125;&#125;</span><br><span class="line">    实例: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    信息: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    恢复: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="关联Prometheus与alertmanager"><a href="#关联Prometheus与alertmanager" class="headerlink" title="关联Prometheus与alertmanager"></a>关联Prometheus与alertmanager</h2><p>在Prometheus的架构中被划分成两个独立的部分。Prometheus负责产生告警，而Alertmanager负责告警产生后的后续处理。因此Alertmanager部署完成后，需要在Prometheus中设置Alertmanager相关的信息。</p><p>编辑Prometheus配置文件prometheus.yml,并添加以下内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">      - targets: [&apos;alertmanager:9093&apos;]</span><br></pre></td></tr></table></figure><p>reload Prometheus后可以在AlertManager的webui上查看告警信息：<a href="http://ip/" target="_blank" rel="noopener">http://IP</a>:Port</p><h2 id="设置报警规则"><a href="#设置报警规则" class="headerlink" title="设置报警规则"></a>设置报警规则</h2><p>详见prometheus-rules.yml</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/liukuan73/article/details/78881008&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/liukuan73/article/details/78881008&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/liukuan73/kubernetes-addons&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/liukuan73/kubernetes-addons&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;总体目标&quot;&gt;&lt;a href=&quot;#总体目标&quot; class=&quot;headerlink&quot; title=&quot;总体目标&quot;&gt;&lt;/a&gt;总体目标&lt;/h1&gt;&lt;p&gt;从监控平台本身的业务需求来看，至少应该通过平台获取到以下的监控数据：&lt;/p&gt;
&lt;p&gt;性能指标(如：CPU、Memory、Load、磁盘、网络等）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;容器、Pod相关的性能指标数据&lt;/li&gt;
&lt;li&gt;主机节点相关的性能指标数据&lt;/li&gt;
&lt;li&gt;容器内进程自己主动暴露的指标数据&lt;/li&gt;
&lt;li&gt;k8s上应用的网络性能，如http、tcp等数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;状态指标&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;k8s资源对象（Deployment、Daemonset、Pod等）的运行状态指标&lt;/li&gt;
&lt;li&gt;k8s平台组件（如kube-apiserver、kube-scheduler等）的运行状态指标&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;获取监控数据之后，还需要对监控进行可视化展示，以及对监控中出现的异常情况进行告警。&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://gongzhao1.coding.me/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="prometheus" scheme="https://gongzhao1.coding.me/tags/prometheus/"/>
    
  </entry>
  
</feed>
