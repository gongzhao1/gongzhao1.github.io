<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="kubernetes,elk,">





  <link rel="alternate" href="/atom.xml" title="GZ" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="前言我们首先介绍一下传统的日志监控方案。其中，ELK Stack 是我们最熟悉不过的架构。所谓ELK，分别指Elastic公司的Elasticsearch、Logstash、Kibana。在比较旧的ELK架构中，Logstash身兼日志的采集、过滤两职。但由于Logstash基于JVM，性能有一定限制，因此，目前业界更推荐使用Go语言开发FIiebeat代替Logstash的采集功能，Logsta">
<meta name="keywords" content="kubernetes,elk">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes集群日志收集 Filebeat+ELK">
<meta property="og:url" content="https://gongzhao1.coding.me/Kubernetes集群日志收集-Filebeat-ELK/index.html">
<meta property="og:site_name" content="GZ">
<meta property="og:description" content="前言我们首先介绍一下传统的日志监控方案。其中，ELK Stack 是我们最熟悉不过的架构。所谓ELK，分别指Elastic公司的Elasticsearch、Logstash、Kibana。在比较旧的ELK架构中，Logstash身兼日志的采集、过滤两职。但由于Logstash基于JVM，性能有一定限制，因此，目前业界更推荐使用Go语言开发FIiebeat代替Logstash的采集功能，Logsta">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/arch01.png">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/arch02.png">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way01.png">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way02.png">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way03.png">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way04.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1713288-576df433afd79aad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1713288-68fb389cf57d907a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/1713288-ee26aebbb743e752.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp">
<meta property="og:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/es01.png">
<meta property="og:updated_time" content="2020-04-08T14:20:25.840Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes集群日志收集 Filebeat+ELK">
<meta name="twitter:description" content="前言我们首先介绍一下传统的日志监控方案。其中，ELK Stack 是我们最熟悉不过的架构。所谓ELK，分别指Elastic公司的Elasticsearch、Logstash、Kibana。在比较旧的ELK架构中，Logstash身兼日志的采集、过滤两职。但由于Logstash基于JVM，性能有一定限制，因此，目前业界更推荐使用Go语言开发FIiebeat代替Logstash的采集功能，Logsta">
<meta name="twitter:image" content="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/arch01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://gongzhao1.coding.me/Kubernetes集群日志收集-Filebeat-ELK/">





  <title>Kubernetes集群日志收集 Filebeat+ELK | GZ</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GZ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">痛苦是财富，这话是扯淡。少年，痛苦就是痛苦，对痛苦的思考才是财富</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gongzhao1.coding.me/Kubernetes集群日志收集-Filebeat-ELK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="弓昭">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/panda.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GZ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kubernetes集群日志收集 Filebeat+ELK</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-22T23:06:43+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次阅读
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们首先介绍一下传统的日志监控方案。其中，ELK Stack 是我们最熟悉不过的架构。所谓ELK，分别指Elastic公司的Elasticsearch、Logstash、Kibana。在比较旧的ELK架构中，Logstash身兼日志的采集、过滤两职。但由于Logstash基于JVM，性能有一定限制，因此，目前业界更推荐使用Go语言开发FIiebeat代替Logstash的采集功能，Logstash只作为了日志过滤的中间件。</p>
<p>最常见的ELK架构如下：</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/arch01.png" alt="image"></p>
<p>如上图所示，各角色功能如下：</p>
<ul>
<li>多个Filebeat在各个业务端进行日志采集，然后上传至Logstash</li>
<li>多个Logstash节点并行（负载均衡，不作为集群），对日志记录进行过滤处理，然后上传至Elasticsearch集群</li>
<li>多个Elasticsearch构成集群服务，提供日志的索引和存储能力</li>
<li>Kibana负责对Elasticsearch中的日志数据进行检索、分析</li>
</ul>
<p>当然，在该架构中，根据业务特点，还可以加入某些中间件，如Redis、Kafak等：</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/arch02.png" alt="image"></p>
<p>如上图所示，使用Redis或Kafka集群作为消息缓冲队列，可以降低大量FIlebeat对Logstash的并发访问压力。</p>
<a id="more"></a>

<h1 id="日志采集方式"><a href="#日志采集方式" class="headerlink" title="日志采集方式"></a>日志采集方式</h1><p>官方文档：<a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/logging/</a></p>
<h2 id="方式1：-Node级别日志代理"><a href="#方式1：-Node级别日志代理" class="headerlink" title="方式1： Node级别日志代理"></a>方式1： Node级别日志代理</h2><p>在每个节点（即宿主机）上可以独立运行一个Node级日志代理，通常的实现方式为DaemonSet。用户应用只需要将日志写到<strong>标准输出</strong>，Docker 的日志驱动会将每个容器的标准输出收集并写入到主机文件系统，这样Node级日志代理就可以将日志统一收集并上传。另外，可以使用K8S的logrotate或Docker 的log-opt 选项负责日志的轮转。</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way01.png" alt="image"></p>
<p>Docker默认的日志驱动（LogDriver）是json-driver，其会将日志以JSON文件的方式存储。所有容器输出到控制台的日志，都会以<code>*-json.log</code>的命名方式保存在<code>/var/lib/docker/containers/</code>目录下。对于Docker日志驱动的具体介绍，请参考<a href="https://docs.docker.com/config/containers/logging/configure/" target="_blank" rel="noopener">官方文档</a>。另外，除了收集Docker容器日志，一般建议同时收集K8S自身的日志以及宿主机的所有系统日志，其位置都在<code>var/log</code>下。</p>
<p>所以，简单来说，本方式就是在每个node上各运行一个日志代理容器，对本节点<code>/var/log</code>和 <code>/var/lib/docker/containers/</code>两个目录下的日志进行采集，然后汇总到elasticsearch集群，最后通过kibana展示。</p>
<h2 id="方式2：伴生容器（sidecar-container）作为日志代理"><a href="#方式2：伴生容器（sidecar-container）作为日志代理" class="headerlink" title="方式2：伴生容器（sidecar container）作为日志代理"></a>方式2：伴生容器（sidecar container）作为日志代理</h2><p>创建一个伴生容器（也可称作日志容器），与应用程序容器在处于同一个Pod中。同时伴生容器内部运行一个独立的、专门为收集应用日志的代理，常见的有Logstash、Fluentd 、Filebeat等。日志容器通过共享卷可以获得应用容器的日志，然后进行上传。</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way02.png" alt="image"></p>
<h2 id="方式3：应用直接上传日志"><a href="#方式3：应用直接上传日志" class="headerlink" title="方式3：应用直接上传日志"></a>方式3：应用直接上传日志</h2><p>应用程序容器直接通过网络连接上传日志到后端，这是最简单的方式。</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way03.png" alt="image"></p>
<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/way04.png" alt="image"></p>
<p>其中，相对来说，方式1在业界使用更为广泛，并且官方也更为推荐。因此，最终我们采用ELK+Filebeat架构，并基于方式1.</p>
<h1 id="日志采集部署"><a href="#日志采集部署" class="headerlink" title="日志采集部署"></a>日志采集部署</h1><h2 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h2><p>GitHub: <a href="https://github.com/elastic/beats" target="_blank" rel="noopener">https://github.com/elastic/beats</a></p>
<p>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/index.html</a></p>
<p>有任何问题请优先查找官方文档！！！</p>
<h3 id="filebeat处理多行日志"><a href="#filebeat处理多行日志" class="headerlink" title="filebeat处理多行日志"></a>filebeat处理多行日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: True</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/mysql-slow-*</span><br><span class="line">#这个地方是关键，我们给上边日志加上了tags，方便在logstash里边通过这个tags 过滤并格式化自己想要的内容；</span><br><span class="line">  tags: [&quot;mysql_slow_logs&quot;]</span><br><span class="line">#有的时候日志不是一行输出的，如果不用multiline的话，会导致一条日志被分割成多条收集过来，形成不完整日志，这样的日志对于我们来说是没有用的！通过正则匹配语句开头，这样multiline 会在匹配开头之后，一直到下一个这样开通的语句合并成一条语句。</span><br><span class="line">#pattern：多行日志开始的那一行匹配的pattern</span><br><span class="line">#negate：是否需要对pattern条件转置使用，不翻转设为true，反转设置为false</span><br><span class="line">#match：匹配pattern后，与前面（before）还是后面（after）的内容合并为一条日志</span><br><span class="line">#max_lines：合并的最多行数（包含匹配pattern的那一行 默认值是500行</span><br><span class="line">#timeout：到了timeout之后，即使没有匹配一个新的pattern（发生一个新的事件），也把已经匹配的日志事件发送出去</span><br><span class="line">  multiline.pattern: &apos;^\d&#123;4&#125;/\d&#123;2&#125;/\d&#123;2&#125;&apos;  (2018\05\01  我的匹配是已这样的日期开头的）</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.Max_lines:20</span><br><span class="line">  multiline.timeout: 10s</span><br><span class="line">#在输入中排除符合正则表达式列表的那些行</span><br><span class="line">  exclude_lines: [&quot;^DBG&quot;]</span><br><span class="line">#包含输入中符合正则表达式列表的那些行默认包含所有行include_lines执行完毕之后会执行exclude_lines。</span><br><span class="line">  include_lines: [&quot;^ERR&quot;, &quot;^WARN&quot;]</span><br><span class="line">  </span><br><span class="line">#向输出的每一条日志添加额外的信息比如“level:debug”方便后续对日志进行分组统计。默认情况下会在输出信息的fields子目录下以指定的新增fields建立子目录例如fields.level。</span><br><span class="line">  fields:</span><br><span class="line">    level: debug</span><br><span class="line">    review: 1</span><br><span class="line">#如果该选项设置为true则新增fields成为顶级目录而不是将其放在fields目录下。自定义的field会覆盖filebeat默认的field。</span><br><span class="line">  fields_under_root: false</span><br><span class="line"></span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/mysql-sql-*</span><br><span class="line">  tags: [&quot;mysql_sql_logs&quot;]</span><br><span class="line">  multiline.pattern: &apos;^\d&#123;4&#125;/\d&#123;2&#125;/\d&#123;2&#125;&apos;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.timeout: 10s</span><br><span class="line">  encoding: utf-8</span><br><span class="line">  document_type: mysql-proxy</span><br><span class="line">  scan_frequency: 20s</span><br><span class="line">  harverster_buffer_size: 16384</span><br><span class="line">  max_bytes: 10485760</span><br><span class="line">  tail_files: true</span><br><span class="line"> #tail_files：如果设置为true，Filebeat从文件尾开始监控文件新增内容，把新增的每一行文件作为一个事件依次发送，而不是从文件开始处重新发送所有内容。默认是false；</span><br></pre></td></tr></table></figure>

<p>filebeat测试配置文件是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat test config</span><br></pre></td></tr></table></figure>

<h3 id="Yaml-File"><a href="#Yaml-File" class="headerlink" title="Yaml File"></a>Yaml File</h3><p><strong>filebeat-kubernetes.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span> <span class="comment"># "" indicates the core API group</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">filebeat.config:</span></span><br><span class="line"><span class="attr">      inputs:</span></span><br><span class="line">        <span class="comment"># Mounted `filebeat-inputs` configmap:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">$&#123;path.config&#125;/inputs.d/*.yml</span></span><br><span class="line">        <span class="comment"># Reload inputs configs as they change:</span></span><br><span class="line">        <span class="string">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      modules:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">        <span class="comment"># Reload module configs as they change:</span></span><br><span class="line">        <span class="string">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># To enable hints based autodiscover, remove `filebeat.config.inputs` configuration and uncomment this:</span></span><br><span class="line">    <span class="comment">#filebeat.autodiscover:</span></span><br><span class="line">    <span class="comment">#  providers:</span></span><br><span class="line">    <span class="comment">#    - type: kubernetes</span></span><br><span class="line">    <span class="comment">#      hints.enabled: true</span></span><br><span class="line"><span class="attr">    processors:</span></span><br><span class="line"><span class="attr">      - add_cloud_metadata:</span></span><br><span class="line">    <span class="string">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="string">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="comment">#output.elasticsearch:</span></span><br><span class="line">    <span class="comment">#  hosts: ['$&#123;ELASTICSEARCH_HOST:elasticsearch-service&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="comment">#username: $&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="comment">#password: $&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line">    <span class="string">output.redis:</span></span><br><span class="line"><span class="attr">      hosts:</span> <span class="string">["192.168.0.95:6379"]</span></span><br><span class="line"><span class="attr">      db:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      key:</span> <span class="string">"k8s"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat-inputs</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">kubernetes.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">    - type:</span> <span class="string">docker</span></span><br><span class="line">      <span class="string">containers.ids:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"*"</span></span><br><span class="line"><span class="attr">      processors:</span></span><br><span class="line"><span class="attr">        - add_kubernetes_metadata:</span></span><br><span class="line"><span class="attr">            in_cluster:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      multiline:</span></span><br><span class="line"><span class="attr">        pattern:</span> <span class="string">'(^((0[1-9])|([12][0-9])|(3[01])|[1-9])-(\w+)-(\d\d)&#123;1,2&#125;)|(^(\d\d)&#123;1,2&#125;-(0?[1-9]|1[0-2])-((0[1-9])|([12][0-9])|(3[01])|[1-9]))'</span></span><br><span class="line"><span class="attr">        negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        match:</span> <span class="string">after</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        elastic-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">docker.elastic.co/beats/filebeat:6.8.1</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">[</span></span><br><span class="line">          <span class="string">"-c"</span><span class="string">,</span> <span class="string">"/etc/filebeat.yml"</span><span class="string">,</span></span><br><span class="line">          <span class="string">"-e"</span><span class="string">,</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">elasticsearch-service</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"9200"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTIC_CLOUD_ID</span></span><br><span class="line"><span class="attr">          value:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTIC_CLOUD_AUTH</span></span><br><span class="line"><span class="attr">          value:</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          runAsUser:</span> <span class="number">0</span></span><br><span class="line">          <span class="comment"># If using Red Hat OpenShift uncomment this:</span></span><br><span class="line">          <span class="comment">#privileged: true</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">100</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/filebeat.yml</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">filebeat.yml</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">inputs</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/filebeat/inputs.d</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/filebeat/data</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">filebeat-config</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">inputs</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">filebeat-inputs</span></span><br><span class="line">      <span class="comment"># data folder stores a registry of read status for all files, so we don't send everything again on a Filebeat pod restart</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/lib/filebeat</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<p>我们先重点关注一下DaemonSet的<code>volumeMounts</code>和<code>volumes</code>，以了解ConfigMap的挂载方式：</p>
<ul>
<li>config<br><code>filebeat-config</code>这个Configmap会生成一个<code>filebeat.yml</code>文件，其会被挂载为Filebeat的配置文件<code>/etc/filebeat.yml</code></li>
<li>inputs<br><code>inputs</code>这个Configmap会生成一个<code>filebeat-inputs.yml</code>文件，其会被挂载到路径<code>/usr/share/filebeat/inputs.d</code>下，并被<code>filebeat.yml</code>引用</li>
<li>data<br>Filebeat自身的数据挂载为hostPath: <code>/var/lib/filebeat</code></li>
<li>varlibdockercontainers<br>K8S集群的日志都存储在<code>/var/lib/docker/containers</code>，Filebeat将从该路径进行收集日志</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f filebeat-kubernetes.yaml</span><br></pre></td></tr></table></figure>

<h2 id="Redis-Kafka"><a href="#Redis-Kafka" class="headerlink" title="Redis/Kafka"></a>Redis/Kafka</h2><p>这里缓存选择Redis，直接采用云服务商提供的了，大家可以也可以自己搭建。</p>
<p>只需要将Redis的数据库以及IP地址写到filebeat以及logstash中即可，具体可以参照filebeat以及logstash的配置文件。</p>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><p>GitHub:<a href="https://github.com/elastic/logstash" target="_blank" rel="noopener">https://github.com/elastic/logstash</a></p>
<p>官方文档：<a href="https://www.elastic.co/guide/en/logstash/current/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/index.html</a></p>
<h3 id="Logstash配置文件详解"><a href="#Logstash配置文件详解" class="headerlink" title="Logstash配置文件详解"></a>Logstash配置文件详解</h3><p>/logstash/config/logstash.yml：主要用于控制logstash运行时的状态<br>/logstash/config/startup.options：logstash 运行相关参数</p>
<p><strong>logstash.yml</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>用途</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td><code>node.name</code></td>
<td>节点名称</td>
<td>主机名称</td>
</tr>
<tr>
<td><code>path.data</code></td>
<td>/数据存储路径</td>
<td>LOGSTASH_HOME/data/</td>
</tr>
<tr>
<td><code>pipeline.workers</code></td>
<td>输出通道的工作workers数据量（提升输出效率）</td>
<td>cpu核数</td>
</tr>
<tr>
<td><code>pipeline.output.workers</code></td>
<td>每个输出插件的工作wokers数量</td>
<td>1</td>
</tr>
<tr>
<td><code>pipeline.batch.size</code></td>
<td>每次input数量</td>
<td>125</td>
</tr>
<tr>
<td><code>path.config</code></td>
<td>过滤配置文件目录</td>
<td></td>
</tr>
<tr>
<td><code>config.reload.automatic</code></td>
<td>自动重新加载被修改配置</td>
<td><code>false</code> or <code>true</code></td>
</tr>
<tr>
<td><code>config.reload.interval</code></td>
<td>配置文件检查时间</td>
<td></td>
</tr>
<tr>
<td><code>path.logs</code></td>
<td>日志输出路径</td>
<td></td>
</tr>
<tr>
<td><code>http.host</code></td>
<td>绑定主机地址，用户指标收集</td>
<td>“127.0.0.1”</td>
</tr>
<tr>
<td><code>http.port</code></td>
<td>绑定端口</td>
<td>5000-9700</td>
</tr>
<tr>
<td><code>log.level</code></td>
<td>日志输出级别,如果config.debug开启，这里一定要是debug日志</td>
<td>info</td>
</tr>
<tr>
<td><code>log.format</code></td>
<td>日志格式</td>
<td>* plain*</td>
</tr>
<tr>
<td><code>path.plugins</code></td>
<td>自定义插件目录</td>
<td></td>
</tr>
</tbody></table>
<p><strong>startup.options</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>JAVACMD</code>=/usr/bin/java</td>
<td>本地jdk</td>
</tr>
<tr>
<td><code>LS_HOME</code>=/opt/logstash</td>
<td>logstash所在目录</td>
</tr>
<tr>
<td><code>LS_SETTINGS_DIR</code>=”${LS_HOME}/config”</td>
<td>默认logstash配置文件目录</td>
</tr>
<tr>
<td><code>LS_OPTS</code>=”–path.settings ${LS_SETTINGS_DIR}”</td>
<td>logstash启动命令参数 指定配置文件目录</td>
</tr>
<tr>
<td><code>LS_JAVA_OPTS</code>=””</td>
<td>指定jdk目录</td>
</tr>
<tr>
<td><code>LS_PIDFILE</code>=/var/run/logstash.pid</td>
<td>logstash.pid所在目录</td>
</tr>
<tr>
<td><code>LS_USER</code>=logstash</td>
<td>logstash启动用户</td>
</tr>
<tr>
<td><code>LS_GROUP</code>=logstash</td>
<td>logstash启动组</td>
</tr>
<tr>
<td><code>LS_GC_LOG_FILE</code>=/var/log/logstash/gc.log</td>
<td>logstash jvm gc日志路径</td>
</tr>
<tr>
<td><code>LS_OPEN_FILES</code>=65534</td>
<td>logstash最多打开监控文件数量</td>
</tr>
</tbody></table>
<p>测试配置文件是否正确，可以用下面这个方法测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$/usr/share/logstash/bin/logstash -t -f /etc/logstash/conf.d/nginx.conf</span><br></pre></td></tr></table></figure>

<h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><p><strong>input plugin  让logstash可以读取特定的事件源。</strong></p>
<p>  事件源可以是从stdin屏幕输入读取，可以从file指定的文件，也可以从es，filebeat，kafka，redis等读取</p>
<ul>
<li><p><strong>stdin</strong> 标准输入</p>
</li>
<li><p><strong>file</strong>   </p>
<p>从文件读取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">file&#123;</span><br><span class="line">    path =&gt; [&apos;/var/log/nginx/access.log&apos;]  #要输入的文件路径</span><br><span class="line">    type =&gt; &apos;nginx_access_log&apos;</span><br><span class="line">    start_position =&gt; &quot;beginning&quot;</span><br><span class="line">&#125;</span><br><span class="line"># path  可以用/var/log/*.log,/var/log/**/*.log，如果是/var/log则是/var/log/*.log</span><br><span class="line"># type 通用选项. 用于激活过滤器</span><br><span class="line"># start_position 选择logstash开始读取文件的位置，begining或者end。</span><br><span class="line">还有一些常用的例如：discover_interval，exclude，sincedb_path,sincedb_write_interval等可以参考官网</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>syslog</strong>  </p>
<p>通过网络将系统日志消息读取为事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syslog&#123;</span><br><span class="line">    port =&gt;&quot;514&quot; </span><br><span class="line">    type =&gt; &quot;syslog&quot;</span><br><span class="line">&#125;</span><br><span class="line"># port 指定监听端口(同时建立TCP/UDP的514端口的监听)</span><br><span class="line"></span><br><span class="line">#从syslogs读取需要实现配置rsyslog：</span><br><span class="line"># cat /etc/rsyslog.conf   加入一行</span><br><span class="line">*.* @172.17.128.200:514　  #指定日志输入到这个端口，然后logstash监听这个端口，如果有新日志输入则读取</span><br><span class="line"># service rsyslog restart   #重启日志服务</span><br></pre></td></tr></table></figure>
</li>
<li><p>beats   </p>
<p>从Elastic beats接收事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">beats &#123;</span><br><span class="line">    port =&gt; 5044   #要监听的端口</span><br><span class="line">&#125;</span><br><span class="line"># 还有host等选项</span><br><span class="line"></span><br><span class="line"># 从beat读取需要先配置beat端，从beat输出到logstash。</span><br><span class="line"># vim /etc/filebeat/filebeat.yml </span><br><span class="line">..........</span><br><span class="line">output.logstash:</span><br><span class="line">hosts: [&quot;localhost:5044&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>kafka</strong>  </p>
<p>将 kafka topic 中的数据读取为事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kafka&#123;</span><br><span class="line">    bootstrap_servers=&gt; &quot;kafka01:9092,kafka02:9092,kafka03:9092&quot;</span><br><span class="line">    topics =&gt; [&quot;access_log&quot;]</span><br><span class="line">    group_id =&gt; &quot;logstash-file&quot;</span><br><span class="line">    codec =&gt; &quot;json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kafka&#123;</span><br><span class="line">    bootstrap_servers=&gt; &quot;kafka01:9092,kafka02:9092,kafka03:9092&quot;</span><br><span class="line">    topics =&gt; [&quot;weixin_log&quot;,&quot;user_log&quot;]  </span><br><span class="line">    codec =&gt; &quot;json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># bootstrap_servers 用于建立群集初始连接的Kafka实例的URL列表。</span><br><span class="line"># topics  要订阅的主题列表，kafka topics</span><br><span class="line"># group_id 消费者所属组的标识符，默认为logstash。kafka中一个主题的消息将通过相同的方式分发到Logstash的group_id</span><br><span class="line"># codec 通用选项，用于输入数据的编解码器。</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>　　还有很多的input插件类型，可以参考官方文档来配置。</p>
<p><strong>filter plugin 过滤器插件，对事件执行中间处理</strong></p>
<ul>
<li><p>grok  </p>
<p> 解析文本并构造 。把非结构化日志数据通过正则解析成结构化和可查询化  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    grok &#123;</span><br><span class="line">            match =&gt; &#123;&quot;message&quot;=&gt;&quot;^%&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;%&#123;WORD:verb&#125; %&#123;DATA:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;&quot; %&#123;NUMBER:response:int&#125; (?:-|%&#123;NUMBER:bytes:int&#125;) %&#123;QS:referrer&#125; %&#123;QS:agent&#125;$&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">匹配nginx日志</span><br><span class="line"># 203.202.254.16 - - [22/Jun/2018:16:12:54 +0800] &quot;GET / HTTP/1.1&quot; 200 3700 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/601.7.7 (KHTML, like Gecko) Version/9.1.2 Safari/601.7.7&quot;</span><br><span class="line">#220.181.18.96 - - [13/Jun/2015:21:14:28 +0000] &quot;GET /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意这里grok 可以有多个match匹配规则，如果前面的匹配失败可以使用后面的继续匹配。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grok &#123;</span><br><span class="line">    match =&gt; [&quot;message&quot;, &quot;%&#123;IP:clientip&#125; - %&#123;USER:user&#125; \[%&#123;HTTPDATE:raw_datetime&#125;\] \&quot;(?:%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;)\&quot; (?:\&quot;%&#123;DATA:body&#125;\&quot; )?(?:\&quot;%&#123;DATA:cookie&#125;\&quot; )?%&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes:int&#125;|-) \&quot;%&#123;DATA:referrer&#125;\&quot; \&quot;%&#123;DATA:agent&#125;\&quot; (?:(%&#123;IP:proxy&#125;,? ?)*|-|unknown) (?:%&#123;DATA:upstream_addr&#125; |)%&#123;NUMBER:request_time:float&#125; (?:%&#123;NUMBER:upstream_time:float&#125;|-)&quot;]</span><br><span class="line">    match =&gt; [&quot;message&quot;, &quot;%&#123;IP:clientip&#125; - %&#123;USER:user&#125; \[%&#123;HTTPDATE:raw_datetime&#125;\] \&quot;(?:%&#123;WORD:verb&#125; %&#123;URI:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;)\&quot; (?:\&quot;%&#123;DATA:body&#125;\&quot; )?(?:\&quot;%&#123;DATA:cookie&#125;\&quot; )?%&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes:int&#125;|-) \&quot;%&#123;DATA:referrer&#125;\&quot; \&quot;%&#123;DATA:agent&#125;\&quot; (?:(%&#123;IP:proxy&#125;,? ?)*|-|unknown) (?:%&#123;DATA:upstream_addr&#125; |)%&#123;NUMBER:request_time:float&#125; (?:%&#123;NUMBER:upstream_time:float&#125;|-)&quot;]       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>grok 语法：%{SYNTAX:SEMANTIC}   即 %{正则:自定义字段名}</p>
<pre><code>官方提供了很多正则的grok pattern可以直接使用  :[https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns](https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns)  

grok debug工具： http://grokdebug.herokuapp.com

正则表达式调试工具： https://www.debuggex.com/

需要用到较多的正则知识，参考文档有：https://www.jb51.net/tools/zhengze.html</code></pre></li>
</ul>
<p>​         自定义模式：   (?&lt;字段名&gt;the pattern)</p>
<p>​        例如： 匹配 2018/06/27 14:00:54  </p>
<p>​     (?<datetime>\d\d\d\d/\d\d/\d\d \d\d:\d\d:\d\d)</datetime></p>
<p>​    得到结果：  “datetime”: “2018/06/27 14:00:54”</p>
<ul>
<li><p><strong>date   日期解析  解析字段中的日期，然后转存到@timestamp</strong></p>
<p>date插件对于排序事件和回填旧数据尤其重要，它可以用来转换日志记录中的时间字段，变成Logstash timestamp对象，然后转存到@timestamp字段里面。</p>
<p>为什么要使用这个插件呢？</p>
<p>　　1、一方面由于Logstash会给收集到的每条日志自动打上时间戳（即@timestamp），但是这个时间戳记录的是input接收数据的时间，而不是日志生成的时间（因为日志生成时间与input接收的时间肯定不同），这样就可能导致搜索数据时产生混乱。</p>
<p>　　2、另一方面，在上面那段rubydebug编码格式的输出中，@timestamp字段虽然已经获取了timestamp字段的时间，但是仍然比北京时间晚了8个小时，这是因为在Elasticsearch内部，对时间类型字段都是统一采用UTC时间，而日志统一采用UTC时间存储，是国际安全、运维界的一个共识。其实这并不影响什么，因为ELK已经给出了解决方案，那就是在Kibana平台上，程序会自动读取浏览器的当前时区，然后在web页面自动将UTC时间转换为当前时区的时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">        date&#123;</span><br><span class="line">                match =&gt; [&quot;timestamp&quot;,&quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&quot;, &apos;ISO8601&apos;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">        grok&#123;</span><br><span class="line">                match =&gt; &#123;&quot;message&quot; =&gt; &quot;\ -\ -\ \[%&#123;HTTPDATE:timestamp&#125;\]&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        date&#123;</span><br><span class="line">                match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#读</span><br><span class="line">input &#123;</span><br><span class="line">	file &#123;</span><br><span class="line">		path =&gt; &quot;文件全路径&quot;</span><br><span class="line">		type =&gt; &quot;任意名字最好有意义&quot;#自定义日志区分类型</span><br><span class="line">		start_position =&gt; &quot;beginning&quot; #从文件开始处读写</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">#过滤</span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">        #切割后日期名字叫logdate </span><br><span class="line">		match =&gt; [&quot;message&quot;, &quot;%&#123;TIMESTAMP_ISO8601:logdate&#125;&quot;] </span><br><span class="line">	&#125;</span><br><span class="line">	date &#123;</span><br><span class="line">        #logdate 从上面过滤后取到的字段名，yyyy-MM-dd HH:mm:ss.SSS 日期格式条件</span><br><span class="line">		match =&gt; [&quot;logdate&quot;, &quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">		#match =&gt; [&quot;logdate&quot;, &quot;yyyyMMdd&quot;,&quot;yyyy-MM-dd&quot;]</span><br><span class="line">        #赋值给那个key</span><br><span class="line">		target =&gt; &quot;@timestamp&quot;</span><br><span class="line">        #删除不需要的字段</span><br><span class="line">		remove_field =&gt; [&quot;logdate&quot;]</span><br><span class="line">	&#125;</span><br><span class="line">       #合并错误日志</span><br><span class="line">       multiline &#123;</span><br><span class="line">            pattern =&gt; &quot;^\d&#123;4&#125;-\d&#123;1,2&#125;-\d&#123;1,2&#125;\s\d&#123;1,2&#125;:\d&#123;1,2&#125;:\d&#123;1,2&#125;&quot;</span><br><span class="line">            negate =&gt; true</span><br><span class="line">            what =&gt; &quot;previous&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">#输出</span><br><span class="line">output&#123;</span><br><span class="line">    #输出到ES</span><br><span class="line">	elasticsearch&#123;</span><br><span class="line">		hosts=&gt;[&quot;127.0.0.1:9200&quot;]  </span><br><span class="line">        #es的index名字，默认就是这个，可以更改</span><br><span class="line">		index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">	&#125;</span><br><span class="line">    #输出到控制台</span><br><span class="line">	stdout&#123;codec =&gt; rubydebug&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[2018-07-04 17:43:35,503]</span><br><span class="line">grok&#123;</span><br><span class="line">      match =&gt; &#123;&quot;message&quot;=&gt;&quot;%&#123;DATA:raw_datetime&#125;&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">date&#123;</span><br><span class="line">       match =&gt; [&quot;raw_datetime&quot;,&quot;YYYY-MM-dd HH:mm:ss,SSS&quot;]</span><br><span class="line">        remove_field =&gt;[&quot;raw_datetime&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#将raw_datetime存到@timestamp 然后删除raw_datetime</span><br><span class="line"></span><br><span class="line">#24/Jul/2018:18:15:05 +0800</span><br><span class="line">date &#123;</span><br><span class="line">      match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/YYYY:HH:mm:ss Z]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>mutate  对字段做处理 重命名、删除、替换和修改字段。</strong></p>
</li>
<li><ul>
<li><p>covert </p>
<p>类型转换。类型包括：integer，float，integer_eu，float_eu，string和boolean</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">    mutate&#123;</span><br><span class="line">#     covert =&gt; [&quot;response&quot;,&quot;integer&quot;,&quot;bytes&quot;,&quot;float&quot;]  #数组的类型转换</span><br><span class="line">        convert =&gt; &#123;&quot;message&quot;=&gt;&quot;integer&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#测试-------&gt;</span><br><span class="line">&#123;</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; 123,    #没带“”,int类型</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T02:51:08.651Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>split  </p>
<p>使用分隔符把字符串分割成数组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mutate&#123;</span><br><span class="line">    split =&gt; &#123;&quot;message&quot;=&gt;&quot;,&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">#----------&gt;</span><br><span class="line">aaa,bbb</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T02:40:19.678Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; [</span><br><span class="line">        [0] &quot;aaa&quot;,</span><br><span class="line">        [1] &quot;bbb&quot;</span><br><span class="line">    ]&#125;</span><br><span class="line">192,128,1,100</span><br><span class="line">&#123;</span><br><span class="line">        &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">     &quot;message&quot; =&gt; [</span><br><span class="line">      [0] &quot;192&quot;,</span><br><span class="line">      [1] &quot;128&quot;,</span><br><span class="line">      [2] &quot;1&quot;,</span><br><span class="line">      [3] &quot;100&quot;</span><br><span class="line"> ],</span><br><span class="line">  &quot;@timestamp&quot; =&gt; 2018-06-26T02:45:17.877Z,</span><br><span class="line">    &quot;@version&quot; =&gt; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>merge</p>
<p> 合并字段  。数组和字符串 ，字符串和字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        add_field =&gt; &#123;&quot;field1&quot;=&gt;&quot;value1&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate&#123; </span><br><span class="line">          split =&gt; &#123;&quot;message&quot;=&gt;&quot;.&quot;&#125;   #把message字段按照.分割</span><br><span class="line">    &#125;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        merge =&gt; &#123;&quot;message&quot;=&gt;&quot;field1&quot;&#125;   #将filed1字段加入到message字段</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#---------------&gt;</span><br><span class="line">abc</span><br><span class="line">&#123;</span><br><span class="line">       &quot;message&quot; =&gt; [</span><br><span class="line">        [0] &quot;abc,&quot;</span><br><span class="line">        [1] &quot;value1&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T03:38:57.114Z,</span><br><span class="line">        &quot;field1&quot; =&gt; &quot;value1&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abc,.123</span><br><span class="line">&#123;</span><br><span class="line">       &quot;message&quot; =&gt; [</span><br><span class="line">        [0] &quot;abc,&quot;,</span><br><span class="line">        [1] &quot;123&quot;,</span><br><span class="line">        [2] &quot;value1&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T03:38:57.114Z,</span><br><span class="line">        &quot;field1&quot; =&gt; &quot;value1&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rename</p>
<p>  对字段重命名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        rename =&gt; &#123;&quot;message&quot;=&gt;&quot;info&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#--------&gt;</span><br><span class="line">123</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T02:56:00.189Z,</span><br><span class="line">          &quot;info&quot; =&gt; &quot;123&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>remove_field</p>
<p>   移除字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutate &#123;</span><br><span class="line">    remove_field =&gt; [&quot;message&quot;,&quot;datetime&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>join</p>
<p>用分隔符连接数组，如果不是数组则不做处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mutate&#123;</span><br><span class="line">        split =&gt; &#123;&quot;message&quot;=&gt;&quot;:&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">mutate&#123;</span><br><span class="line">        join =&gt; &#123;&quot;message&quot;=&gt;&quot;,&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">------&gt;</span><br><span class="line">abc:123</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T03:55:41.426Z,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;abc,123&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;</span><br><span class="line">&#125;</span><br><span class="line">aa:cc</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T03:55:47.501Z,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;aa,cc&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><ul>
<li><p>gsub  </p>
<p>用正则或者字符串替换字段值。仅对字符串有效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    mutate&#123;</span><br><span class="line">        gsub =&gt; [&quot;message&quot;,&quot;/&quot;,&quot;_&quot;]   #用_替换/</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">------&gt;</span><br><span class="line">a/b/c/</span><br><span class="line">&#123;</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;a_b_c_&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T06:20:10.811Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>update</p>
<p> 更新字段。如果字段不存在，则不做处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    mutate&#123;</span><br><span class="line">        add_field =&gt; &#123;&quot;field1&quot;=&gt;&quot;value1&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        update =&gt; &#123;&quot;field1&quot;=&gt;&quot;v1&quot;&#125;</span><br><span class="line">        update =&gt; &#123;&quot;field2&quot;=&gt;&quot;v2&quot;&#125;    #field2不存在 不做处理</span><br><span class="line">    &#125;</span><br><span class="line">----------------&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T06:26:28.870Z,</span><br><span class="line">        &quot;field1&quot; =&gt; &quot;v1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;a&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>replace</p>
<p>更新字段。如果字段不存在，则创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    mutate&#123;</span><br><span class="line">        add_field =&gt; &#123;&quot;field1&quot;=&gt;&quot;value1&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        replace =&gt; &#123;&quot;field1&quot;=&gt;&quot;v1&quot;&#125;</span><br><span class="line">        replace =&gt; &#123;&quot;field2&quot;=&gt;&quot;v2&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">----------------------&gt;</span><br><span class="line">&#123;</span><br><span class="line">       &quot;message&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T06:28:09.915Z,</span><br><span class="line">        &quot;field2&quot; =&gt; &quot;v2&quot;,        #field2不存在，则新建</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">        &quot;field1&quot; =&gt; &quot;v1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>geoip</strong>  </p>
<p>根据来自Maxmind GeoLite2数据库的数据添加有关IP地址的地理位置的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">geoip &#123;</span><br><span class="line">    source =&gt; &quot;clientip&quot;</span><br><span class="line">    database =&gt;&quot;/tmp/GeoLiteCity.dat&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ruby</strong>    </p>
<p>ruby插件可以执行任意Ruby代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">filter&#123;</span><br><span class="line">    urldecode&#123;</span><br><span class="line">        field =&gt; &quot;message&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ruby &#123;</span><br><span class="line">        init =&gt; &quot;@kname = [&apos;url_path&apos;,&apos;url_arg&apos;]&quot;</span><br><span class="line">        code =&gt; &quot; </span><br><span class="line">            new_event = LogStash::Event.new(Hash[@kname.zip(event.get(&apos;message&apos;).split(&apos;?&apos;))]) </span><br><span class="line">            event.append(new_event)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    if [url_arg]&#123;</span><br><span class="line">        kv&#123;</span><br><span class="line">            source =&gt; &quot;url_arg&quot;</span><br><span class="line">            field_split =&gt; &quot;&amp;&quot;</span><br><span class="line">            target =&gt; &quot;url_args&quot;</span><br><span class="line">            remove_field =&gt; [&quot;url_arg&quot;,&quot;message&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># ruby插件</span><br><span class="line"># 以？为分隔符，将request字段分成url_path和url_arg</span><br><span class="line">--------------------&gt;</span><br><span class="line">www.test.com?test</span><br><span class="line">&#123;</span><br><span class="line">       &quot;url_arg&quot; =&gt; &quot;test&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">      &quot;url_path&quot; =&gt; &quot;www.test.com&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;www.test.com?test&quot;,  </span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt;  2018-06-26T07:31:04.887Z</span><br><span class="line">&#125;</span><br><span class="line">www.test.com?title=elk&amp;content=学习elk</span><br><span class="line">&#123;</span><br><span class="line">      &quot;url_args&quot; =&gt; &#123;</span><br><span class="line">          &quot;title&quot; =&gt; &quot;elk&quot;,</span><br><span class="line">        &quot;content&quot; =&gt; &quot;学习elk&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">      &quot;url_path&quot; =&gt; &quot;www.test.com&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt;  2018-06-26T07:33:54.507Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>urldecode</strong>    </p>
<p>用于解码被编码的字段,可以解决URL中 中文乱码的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    urldecode&#123;</span><br><span class="line">        field =&gt; &quot;message&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"># field :指定urldecode过滤器要转码的字段,默认值是&quot;message&quot;</span><br><span class="line"># charset(缺省): 指定过滤器使用的编码.默认UTF-8</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>kv</strong>   </p>
<p>通过指定分隔符将字符串分割成key/value</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kv&#123;</span><br><span class="line">        prefix =&gt; &quot;url_&quot;   #给分割后的key加前缀</span><br><span class="line">        target =&gt; &quot;url_ags&quot;    #将分割后的key-value放入指定字段</span><br><span class="line">        source =&gt; &quot;message&quot;   #要分割的字段</span><br><span class="line">        field_split =&gt; &quot;&amp;&quot;    #指定分隔符</span><br><span class="line">        remove_field =&gt; &quot;message&quot;</span><br><span class="line">    &#125;</span><br><span class="line">--------------------------&gt;</span><br><span class="line">a=1&amp;b=2&amp;c=3</span><br><span class="line">&#123;</span><br><span class="line">            &quot;host&quot; =&gt; &quot;localhost&quot;,</span><br><span class="line">       &quot;url_ags&quot; =&gt; &#123;</span><br><span class="line">          &quot;url_c&quot; =&gt; &quot;3&quot;,</span><br><span class="line">          &quot;url_a&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;url_b&quot; =&gt; &quot;2&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2018-06-26T07:07:24.557Z</span><br></pre></td></tr></table></figure>
</li>
<li><p>useragent</p>
<p>添加有关用户代理(如系列,操作系统,版本和设备)的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [agent] != &quot;-&quot; &#123;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    source =&gt; &quot;agent&quot;</span><br><span class="line">    target =&gt; &quot;ua&quot;</span><br><span class="line">    remove_field =&gt; &quot;agent&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># if语句，只有在agent字段不为空时才会使用该插件</span><br><span class="line">#source 为必填设置,目标字段</span><br><span class="line">#target 将useragent信息配置到ua字段中。如果不指定将存储在根目录中</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>output plugin  输出插件，将事件发送到特定目标</strong></p>
<ul>
<li><p>stdout  标准输出。将事件输出到屏幕上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output&#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>file   将事件写入文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">file &#123;</span><br><span class="line">   path =&gt; &quot;/data/logstash/%&#123;host&#125;/&#123;application&#125;</span><br><span class="line">   codec =&gt; line &#123; format =&gt; &quot;%&#123;message&#125;&quot;&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka  将事件发送到kafka</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kafka&#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;localhost:9092&quot;</span><br><span class="line">    topic_id =&gt; &quot;test_topic&quot;  #必需的设置。生成消息的主题</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>elasticseach  在es中存储日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; &quot;localhost:9200&quot;</span><br><span class="line">        index =&gt; &quot;nginx-access-log-%&#123;+YYYY.MM.dd&#125;&quot;  </span><br><span class="line">    &#125;</span><br><span class="line">#index 事件写入的索引。可以按照日志来创建索引，以便于删旧数据和按时间来搜索日志</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>补充一个codec plugin 编解码器插件</strong></p>
<p>codec 本质上是流过滤器，可以作为input 或output 插件的一部分运行。例如上面output的stdout插件里有用到。</p>
<ul>
<li><p>multiline codec plugin  多行合并, 处理堆栈日志或者其他带有换行符日志需要用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  stdin &#123;</span><br><span class="line">    codec =&gt; multiline &#123;</span><br><span class="line">      pattern =&gt; &quot;pattern, a regexp&quot;    #正则匹配规则，匹配到的内容按照下面两个参数处理</span><br><span class="line">      negate =&gt; &quot;true&quot; or &quot;false&quot;     # 默认为false。处理匹配符合正则规则的行。如果为true，处理不匹配符合正则规则的行。</span><br><span class="line">      what =&gt; &quot;previous&quot; or &quot;next&quot;    #指定上下文。将指定的行是合并到上一行或者下一行。</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">codec =&gt; multiline &#123;</span><br><span class="line">    pattern =&gt; &quot;^\s&quot;  </span><br><span class="line">    what =&gt; &quot;previous&quot;  </span><br><span class="line">&#125;</span><br><span class="line"># 以空格开头的行都合并到上一行</span><br><span class="line"></span><br><span class="line">codec =&gt; multiline &#123;</span><br><span class="line">    # Grok pattern names are valid! :)</span><br><span class="line">    pattern =&gt; &quot;^%&#123;TIMESTAMP_ISO8601&#125; &quot;</span><br><span class="line">    negate =&gt; true</span><br><span class="line">    what =&gt; &quot;previous&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 任何不以这个时间戳格式开头的行都与上一行合并</span><br><span class="line"></span><br><span class="line">codec =&gt; multiline &#123;</span><br><span class="line">   pattern =&gt; &quot;\\$&quot;</span><br><span class="line">   what =&gt; &quot;next&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 以反斜杠结尾的行都与下一行合并</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>logstash配置语法中的条件判断</strong></p>
<p>Logstash中的条件查看和行为与编程语言中的条件相同。</p>
<p>条件语支持if，else if和else语句并且可以嵌套。</p>
<p>条件语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if EXPRESSION &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125; else if EXPRESSION &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>比较操作</strong>：</p>
<ul>
<li>相等: <code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code></li>
<li>正则: <code>=~</code>(匹配正则), <code>!~</code>(不匹配正则)</li>
<li>包含: <code>in</code>(包含), <code>not in</code>(不包含)</li>
</ul>
<p><strong>布尔操作</strong>： - <code>and</code>(与), <code>or</code>(或), <code>nand</code>(非与), <code>xor</code>(非或)</p>
<p><strong>一元运算符</strong>： 表达式可能很长且很复杂。表达式可以包含其他表达式，您可以使用！来取消表达式，并且可以使用括号（…）对它们进行分组。 - <code>!</code>(取反) - <code>()</code>(复合表达式), <code>!()</code>(对复合表达式结果取反)</p>
<p>如若action是login则mutate filter删除secret字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [action] == &quot;login&quot; &#123;</span><br><span class="line">    mutate &#123; remove_field =&gt; &quot;secret&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若是正则匹配，成功后添加自定义字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    if [message] =~ /\w+\s+\/\w+(\/learner\/course\/)/ &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; &quot;learner_type&quot; =&gt; &quot;course&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在一个条件里指定多个表达式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  # Send production errors to pagerduty</span><br><span class="line">  if [loglevel] == &quot;ERROR&quot; and [deployment] == &quot;production&quot; &#123;</span><br><span class="line">    pagerduty &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在in条件，可以比较字段值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [foo] in [foobar] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in &quot;foo&quot; &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in string&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if &quot;hello&quot; in [greeting] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;string in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in [&quot;hello&quot;, &quot;world&quot;, &quot;foo&quot;] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in list&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [missing] in [alsomissing] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldnotexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if !(&quot;foo&quot; in [&quot;hello&quot;, &quot;world&quot;]) &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>not in示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  if &quot;_grokparsefailure&quot; not in [tags] &#123;</span><br><span class="line">    elasticsearch &#123; ... &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>@metadata field</strong></p>
<p>在logstash1.5版本开始，有一个特殊的字段，叫做@metadata。@metadata包含的内容不会作为事件的一部分输出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;show&quot; =&gt; &quot;This data will be in the output&quot; &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;[@metadata][test]&quot; =&gt; &quot;Hello&quot; &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;[@metadata][no_show]&quot; =&gt; &quot;This data will not be in the output&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [@metadata][test] == &quot;Hello&quot; &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:42:51.496Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;windcoder.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>“asdf”变成message字段内容。条件与@metadata内嵌的test字段内容判断成功，但是输出并没有展示@metadata字段和其内容。</p>
<p>不过，如果指定了metadata =&gt; true，rubydebug codec允许显示@metadata字段的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:46:48.565Z,</span><br><span class="line">     &quot;@metadata字段及其子字段内容。&quot; =&gt; &#123;</span><br><span class="line">           &quot;test&quot; =&gt; &quot;Hello&quot;,</span><br><span class="line">        &quot;no_show&quot; =&gt; &quot;This data will not be in the output&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;windcoder.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在就可以见到@metadata字段及其子字段内容。</p>
<p>只有rubydebug codec允许显示@metadata字段的内容。</p>
<p>只要您需要临时字段但不希望它在最终输出中，就可以使用@metadata字段。</p>
<p>最常见的情景是filter的时间字段，需要一临时的时间戳。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123; match =&gt; [ &quot;message&quot;, &quot;%&#123;HTTPDATE:[@metadata][timestamp]&#125;&quot; ] &#125;</span><br><span class="line">  date &#123; match =&gt; [ &quot;[@metadata][timestamp]&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ] &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">02/Mar/2014:15:36:43 +0100</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2014-03-02T14:36:43.000Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;windcoder.com&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;02/Mar/2014:15:36:43 +0100&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理匹配失败的日志"><a href="#处理匹配失败的日志" class="headerlink" title="处理匹配失败的日志"></a>处理匹配失败的日志</h3><p>忽略过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">	grok &#123; match =&gt; [ &quot;message&quot;, &quot;something&quot; ] &#125;</span><br><span class="line">	if &quot;_grokparsefailure&quot; in [tags] &#123;</span><br><span class="line">        drop&#123; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Grok插件了解"><a href="#Grok插件了解" class="headerlink" title="Grok插件了解"></a>Grok插件了解</h3><p><strong>原文链接</strong>：<a href="https://www.elastic.co/cn/blog/do-you-grok-grok" target="_blank" rel="noopener">https://www.elastic.co/cn/blog/do-you-grok-grok</a></p>
<p>在日志处理的过程中，有一项非常常见的任务就是把原始的单行日志转换成结构化的日志。如果你使用了ELK，那么你可以利用ES对数据进行聚合，使用Kibana来进行数据可视化从日志中来发现一些有价值的信息。</p>
<p>在LogStash中，这项工作是由logstash-filter-grok来完成的，它有超过200个可用的，大家都认为是比较有用的Grok模式，例如IPv6地址、UNIX路径等等。</p>
<p>下面是一个示例日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016-09-19T18:19:00 [8.8.8.8:prd] DEBUG this is an example log message</span><br></pre></td></tr></table></figure>

<p>使用Grok库，我们可以很容易的就完成日志格式化提取的任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;TIMESTAMP_ISO8601:timestamp&#125; \[%&#123;IPV4:ip&#125;;%&#123;WORD:environment&#125;\] %&#123;LOGLEVEL:log_level&#125; %&#123;GREEDYDATA:message&#125;</span><br></pre></td></tr></table></figure>

<p>提取后的数据格式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;timestamp&quot;: &quot;2016-09-19T18:19:00&quot;,</span><br><span class="line">  &quot;ip&quot;: &quot;8.8.8.8&quot;,</span><br><span class="line">  &quot;environment&quot;: &quot;prd&quot;,</span><br><span class="line">  &quot;log_level&quot;: &quot;DEBUG&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;this is an example log message&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来这是一件非常简单的事情，好吧。。那这篇文章就这样写完了么，当然不是。。</p>
<p><strong>为什么我的Grok使用起来非常的慢</strong></p>
<p>这是一个非常常见的问题。性能这个问题通常都是要被拿出来讨论的，用户通常会发现使用了Grok表达式之后，LogStash处理日志的速度变得很慢。就像前面所说的一样，Grok模式是基于正则表达式的，所以这个插件在性能上已经对正则做了非常多的性能优化的了。接下来的章节，我们会讨论在使用Grok模式中需要注意的点</p>
<p><strong>多做些性能测试</strong></p>
<p>在设计Grok表达式的时候，我们需要一些方法来测试究竟哪种写法性能表现更好。出于这个原因，我些了个很小的jruby脚步用于测试Grok插件处理我所写的Grok模式的性能，你可以在这里获取到这个<a href="https://link.jianshu.com/?t=https://gist.github.com/jsvd/a2613ea1ba00f02926a302781ca62f7b" target="_blank" rel="noopener">脚本</a></p>
<p><strong>留意grok匹配失败的时候对性能的影响</strong></p>
<p>尽管Grok匹配的性能是非常重要的，但是匹配失败的时候对性能的影响也是我们需要留意的。当grok匹配失败的时候，插件会为这个事件打个tag，默认是_grokparsefailure。LogStash允许你把这些处理失败的事件路由到其他地方做后续的处理，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">input &#123; # ... &#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; \[%&#123;IPV4:ip&#125;;%&#123;WORD:environment&#125;\] %&#123;LOGLEVEL:log_level&#125; %&#123;GREEDYDATA:message&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  if &quot;_grokparsefailure&quot; in [tags] &#123;</span><br><span class="line">    # write events that didn&apos;t match to a file</span><br><span class="line">    file &#123; &quot;path&quot; =&gt; &quot;/tmp/grok_failures.txt&quot; &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">     elasticsearch &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话我们就可以对这些处理失败的事件做性能基准测试了。</p>
<p>现在，我们要开始对Apache的日志进行格式化处理了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">220.181.108.96 - - [13/Jun/2015:21:14:28 +0000] &quot;GET /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&quot;</span><br></pre></td></tr></table></figure>

<p>然后我们使用下面的Grok模式去进行格式化提取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;%&#123;WORD:verb&#125; %&#123;DATA:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;&quot; %&#123;NUMBER:response:int&#125; (?:-|%&#123;NUMBER:bytes:int&#125;) %&#123;QS:referrer&#125; %&#123;QS:agent&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们使用三种示例日志去测试这个Grok的性能，和Grok不匹配的日志分别出现在开始，中间和结束的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># beginning mismatch - doesn&apos;t start with an IPORHOST</span><br><span class="line">&apos;tash-scale11x/css/fonts/Roboto-Regular.ttf HTTP/1.1&quot; 200 41820 &quot;http://semicomplete.com/presentations/logs&apos;</span><br><span class="line"></span><br><span class="line"># middle mismatch - instead of an HTTP verb like GET or PUT there&apos;s the number 111</span><br><span class="line">&apos;220.181.108.96 - - [13/Jun/2015:21:14:28 +0000] &quot;111 /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&quot;&apos;</span><br><span class="line"></span><br><span class="line"># end mismatch - the last element isn&apos;t a quoted string, but a number</span><br><span class="line">&apos;220.181.108.96 - - [13/Jun/2015:21:14:28 +0000] &quot;GET /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; 1&apos;</span><br></pre></td></tr></table></figure>

<p>下面是性能测试的结果</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1713288-576df433afd79aad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p>
<p>Paste_Image.png</p>
<p>基于上面这个测试结果，我们可以发现，Grok的性能和不匹配的日志所出现的位置有关，最快与最慢的性能差了差不多6倍。这就能解释为什么有用户提出当Grok匹配日志失败的时候CPU会被吃满的原因了，例如这个issues<br><a href="https://link.jianshu.com/?t=https://github.com/logstash-plugins/logstash-filter-grok/issues/37" target="_blank" rel="noopener">https://github.com/logstash-plugins/logstash-filter-grok/issues/37</a>.</p>
<p>我们能做些什么呢</p>
<p><strong>快速失败，设置锚点</strong></p>
<p>我们已经知道了处理失败对grok的性能影响是非常大的，所以我们需要解决这个问题。对于正则引擎来说，你需要做的最合适的事情就是减少正则表达式所需要的猜测。这就是为什么贪婪匹配最好少用的原因，那回到这个问题，有没一种更好的方法来调整这个Grok模式呢，让我们重新来看看这行Apache的日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">220.181.108.96 - - [13/Jun/2015:21:14:28 +0000] &quot;GET /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&quot;</span><br></pre></td></tr></table></figure>

<p>刚才我们使用的Grok模式是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;%&#123;WORD:verb&#125; %&#123;DATA:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;&quot; %&#123;NUMBER:response:int&#125; (?:-|%&#123;NUMBER:bytes:int&#125;) %&#123;QS:referrer&#125; %&#123;QS:agent&#125;</span><br></pre></td></tr></table></figure>

<p>由于用户以为Grok表达式只会从开头匹配到结束，所以导致了在一些普通的场景下也会出现性能问题。但是实际上，Grok只是被告知“在这段文本中寻找匹配的内容”，这就意味着下面这种示例也会被Grok所匹配。。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OMG OMG OMG EXTRA INFORMATION 220.181.108.96 - - [13/Jun/2015:21:14:28 +0000] &quot;GET /blog/geekery/xvfb-firefox.html HTTP/1.1&quot; 200 10975 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)&quot; OH LOOK EVEN MORE STUFF</span><br></pre></td></tr></table></figure>

<p>呃。。这都行，不过解决这个问题还是很简单的，我们加一些锚点就搞定了。锚点可以让你再一个指定的位置处理字符串。加入了开始和结束的锚点之后(^和$)，Grok就会从开头处理日志到结束了。这对处理那些不能匹配的日志有非常重要的作用。假如我们没有假如锚点，当正则无法匹配这行日志的时候，它就会开始从子字符串中进行匹配，然后性能就会下降，接下来我们把锚点加上，然后再做一次测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^%&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;%&#123;WORD:verb&#125; %&#123;DATA:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;&quot; %&#123;NUMBER:response:int&#125; (?:-|%&#123;NUMBER:bytes:int&#125;) %&#123;QS:referrer&#125; %&#123;QS:agent&#125;$</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1713288-68fb389cf57d907a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p>
<p>Paste_Image.png</p>
<p>可以看到性能有了很大的提升，在一开始就匹配失败的场景中，性能提升了将近10倍</p>
<p><strong>留意匹配了两次的表达式</strong></p>
<p>你可能会说，“好吧，我的日志都是能匹配通过的，没有上面的问题”，但是事情可能并不是这样的</p>
<p>我们看到过非常多的grok模式在处理同一个网关发出的多种应用日志时候所出现的问题，例如syslog。想象一下这样一个场景，我们使用了“common_header: payload“这种日志格式来记录了三种应用日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Application 1: &apos;8.8.8.8 process-name[666]: a b 1 2 a lot of text at the end&apos;</span><br><span class="line">Application 2: &apos;8.8.8.8 process-name[667]: a 1 2 3 a lot of text near the end;4&apos;</span><br><span class="line">Application 3: &apos;8.8.8.8 process-name[421]: a completely different format | 1111&apos;</span><br></pre></td></tr></table></figure>

<p>通常我们会在一个Grok里面就把三种日志都处理掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">grok &#123;</span><br><span class="line">  &quot;match&quot; =&gt; &#123; &quot;message =&gt; [</span><br><span class="line">    &apos;%&#123;IPORHOST:clientip&#125; %&#123;DATA:process_name&#125;\[%&#123;NUMBER:process_id&#125;\]: %&#123;WORD:word_1&#125; %&#123;WORD:word_2&#125; %&#123;NUMBER:number_1&#125; %&#123;NUMBER:number_2&#125; %&#123;DATA:data&#125;&apos;,</span><br><span class="line">    &apos;%&#123;IPORHOST:clientip&#125; %&#123;DATA:process_name&#125;\[%&#123;NUMBER:process_id&#125;\]: %&#123;WORD:word_1&#125; %&#123;NUMBER:number_1&#125; %&#123;NUMBER:number_2&#125; %&#123;NUMBER:number_3&#125; %&#123;DATA:data&#125;;%&#123;NUMBER:number_4&#125;&apos;,</span><br><span class="line">    &apos;%&#123;IPORHOST:clientip&#125; %&#123;DATA:process_name&#125;\[%&#123;NUMBER:process_id&#125;\]: %&#123;DATA:data&#125; | %&#123;NUMBER:number&#125;&apos;</span><br><span class="line">    ] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>值得留意的是即使你的日志是能正常匹配的，Grok还是会按照顺序许匹配送进来的日志，当碰到第一个匹配成功的日志就break掉这个循环。这就要我们自己去判断一下，怎么放是最合适的了，不然的话会一个一个往下进行尝试，毕竟是多种不同的格式。<br>一种常用的优化方案是使用分层匹配来对这个Grok进行优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    &quot;match&quot; =&gt; &#123; &quot;message&quot; =&gt; &apos;%&#123;IPORHOST:clientip&#125; %&#123;DATA:process_name&#125;\[%&#123;NUMBER:process_id&#125;\]: %&#123;GREEDYDATA:message&#125;&apos; &#125;,</span><br><span class="line">    &quot;overwrite&quot; =&gt; &quot;message&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  grok &#123;</span><br><span class="line">    &quot;match&quot; =&gt; &#123; &quot;message&quot; =&gt; [</span><br><span class="line">      &apos;%&#123;WORD:word_1&#125; %&#123;WORD:word_2&#125; %&#123;NUMBER:number_1&#125; %&#123;NUMBER:number_2&#125; %&#123;GREEDYDATA:data&#125;&apos;,</span><br><span class="line">      &apos;%&#123;WORD:word_1&#125; %&#123;NUMBER:number_1&#125; %&#123;NUMBER:number_2&#125; %&#123;NUMBER:number_3&#125; %&#123;DATA:data&#125;;%&#123;NUMBER:number_4&#125;&apos;,</span><br><span class="line">      &apos;%&#123;DATA:data&#125; | %&#123;NUMBER:number&#125;&apos;</span><br><span class="line">    ] &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是两种匹配方案的性能测试结果</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1713288-ee26aebbb743e752.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p>
<p>Paste_Image.png</p>
<p>看起来真有意思。。使用锚点的话，无论哪种方案性能都是一样的。不用锚点的情况下分层Grok的方案比不分层的又快很多</p>
<p><strong>那我们怎么知道我们所创建的Grok是合适的</strong></p>
<p>我们已经得出了对_grokparsefaiure进行处理的必要性了，那么我们还能做什么呢？<br>从3.2.0这个Grok插件开始，它有一些参数可以帮助你了解为什么一个事件会被处理那么久了。使用<code>timeout_millis</code>和<code>tag_on_timeout</code>可以设置Grok匹配的最大处理时长。如果超时了，这个事件会被打上<code>_groktimeout</code>的tag，然后我们就可以把他们送到一个Grok处理失败的ES索引里面去做后续的分析了</p>
<p>另外一个很棒的方法是LogStash5.0带了插件性能统计的功能，我们可以通过API来查看插件处理日志的性能了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:9600/_node/stats/pipeline?pretty | jq &quot;.pipeline.plugins.filters&quot;</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;grok_b61938f3833f9f89360b5fba6472be0ad51c3606-2&quot;,</span><br><span class="line">    &quot;events&quot;: &#123;</span><br><span class="line">      &quot;duration_in_millis&quot;: 7,</span><br><span class="line">      &quot;in&quot;: 24,</span><br><span class="line">      &quot;out&quot;: 24</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;failures&quot;: 24,</span><br><span class="line">    &quot;patterns_per_field&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot;: &quot;grok&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;kv_b61938f3833f9f89360b5fba6472be0ad51c3606-3&quot;,</span><br><span class="line">    &quot;events&quot;: &#123;</span><br><span class="line">      &quot;duration_in_millis&quot;: 2,</span><br><span class="line">      &quot;in&quot;: 24,</span><br><span class="line">      &quot;out&quot;: 24</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot;: &quot;kv&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>然后我们就可以通过<code>duration_in_millis</code>来判断一个插件的性能了</p>
<p><strong>总结</strong></p>
<p>希望这篇文章能帮你了解为什么Grok的性能会变得慢和如何去提升他的性能。下面是对这篇文字的总结：</p>
<ul>
<li>Grok在匹配失败的时候性能可能并不那么好</li>
<li>多留意<code>_grokparsefailures</code>出现的频率和出现时候的性能</li>
<li>写正则的时候记得打锚点</li>
<li>不使用锚点的时候分层Grok处理的性能会比不分层的性能好，不过打了锚点的话两个都一样</li>
<li>多使用LogStash的性能监控功能，后续还可以拿来分析用</li>
</ul>
<h3 id="Yaml-File-1"><a href="#Yaml-File-1" class="headerlink" title="Yaml File"></a>Yaml File</h3><p>logstash-kubernetes.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">logstash.conf:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">input</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">beats</span> <span class="string">&#123;</span></span><br><span class="line">         <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">5044</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">redis</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">"192.168.0.95"</span></span><br><span class="line">          <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">6379</span></span><br><span class="line">          <span class="string">db</span> <span class="string">=&gt;</span> <span class="string">"2"</span></span><br><span class="line">          <span class="string">data_type</span> <span class="string">=&gt;</span> <span class="string">"list"</span></span><br><span class="line">          <span class="string">batch_count</span> <span class="string">=&gt;</span> <span class="number">1</span></span><br><span class="line">          <span class="string">key</span> <span class="string">=&gt;</span> <span class="string">"ecs"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">redis</span> <span class="string">&#123;</span></span><br><span class="line">          <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">"192.168.0.95"</span></span><br><span class="line">          <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">6379</span></span><br><span class="line">          <span class="string">db</span> <span class="string">=&gt;</span> <span class="string">"3"</span></span><br><span class="line">          <span class="string">data_type</span> <span class="string">=&gt;</span> <span class="string">"list"</span></span><br><span class="line">          <span class="string">batch_count</span> <span class="string">=&gt;</span> <span class="number">1</span></span><br><span class="line">          <span class="string">key</span> <span class="string">=&gt;</span> <span class="string">"k8s"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">filter</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="comment">#server01 Logs</span></span><br><span class="line">        <span class="string">if</span> <span class="string">"server01_logs"</span> <span class="string">in</span> <span class="string">[tags]&#123;</span></span><br><span class="line">            <span class="string">grok</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> <span class="string">&#123;</span> <span class="string">"message"</span> <span class="string">=&gt;</span> <span class="string">"^\[<span class="template-variable">%&#123;TIMESTAMP_ISO8601:body_date&#125;</span>\s\w&#123;3&#125;\]\s<span class="template-variable">%&#123;DATA:level&#125;</span>\s<span class="template-variable">%&#123;DATA:bundle&#125;</span>\s<span class="template-variable">%&#123;DATA:device&#125;</span>\s<span class="template-variable">%&#123;GREEDYDATA:body&#125;</span>$"</span><span class="string">&#125;</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">date</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> <span class="string">["body_date","yyyy-MM-dd</span> <span class="attr">HH:mm:ss.SSS"]</span></span><br><span class="line">                <span class="string">target</span> <span class="string">=&gt;</span> <span class="string">"@timestamp"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">mutate</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">remove_field</span> <span class="string">=&gt;</span> <span class="string">["message"]</span> </span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#server02 Logs</span></span><br><span class="line">        <span class="string">if</span> <span class="string">[kubernetes][namespace]</span> <span class="string">==</span> <span class="string">"server02-test"</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="comment">#admin-ui</span></span><br><span class="line">            <span class="comment">#if [kubernetes][container][name] == "admin-ui" or [kubernetes][container][name] == "monitoring" &#123;</span></span><br><span class="line">            <span class="comment">#&#125;</span></span><br><span class="line">            <span class="string">grok</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> <span class="string">&#123;</span> </span><br><span class="line">                    <span class="string">"message"</span> <span class="string">=&gt;</span> <span class="string">[</span></span><br><span class="line">                        <span class="string">"^(?&lt;body_date&gt;<span class="template-variable">%&#123;MONTHDAY&#125;</span>-<span class="template-variable">%&#123;MONTH&#125;</span>-<span class="template-variable">%&#123;YEAR&#125;</span>\s<span class="template-variable">%&#123;TIME&#125;</span>)\s*(?&lt;level&gt;\w+)\s*(?&lt;thread&gt;\[\S+\])\s*<span class="template-variable">%&#123;GREEDYDATA:body&#125;</span>$"</span><span class="string">,</span></span><br><span class="line">                        <span class="string">"^<span class="template-variable">%&#123;TIMESTAMP_ISO8601:body_date&#125;</span>\s*(?&lt;thread&gt;\[\S+\])\s*(?&lt;level&gt;\w+)\s*<span class="template-variable">%&#123;GREEDYDATA:body&#125;</span>$"</span></span><br><span class="line">                    <span class="string">]</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="comment">#drop failuer</span></span><br><span class="line">            <span class="string">if</span> <span class="string">"_grokparsefailure"</span> <span class="string">in</span> <span class="string">[tags]</span> <span class="string">&#123;</span> </span><br><span class="line">               <span class="string">drop</span> <span class="string">&#123;</span> <span class="string">&#125;</span> </span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">date</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> <span class="string">["body_date","yyyy-MM-dd'T'HH:mm:ss,SSSZ","dd-MMM-yyyy</span> <span class="attr">HH:mm:ss.SSS"]</span></span><br><span class="line">                <span class="string">target</span> <span class="string">=&gt;</span> <span class="string">"@timestamp"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">mutate</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">remove_field</span> <span class="string">=&gt;</span> <span class="string">["message","MONTHDAY","MONTHNUM","MONTH","YEAR","TIME","HOUR","MINUTE","SECOND","ISO8601_TIMEZONE"]</span> </span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">output</span> <span class="string">&#123;</span></span><br><span class="line">         <span class="comment">#server01</span></span><br><span class="line">         <span class="string">if</span> <span class="string">"server01_logs"</span> <span class="string">in</span> <span class="string">[tags]&#123;</span></span><br><span class="line">         <span class="string">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">             <span class="comment">#hosts  =&gt; ["192.168.0.92:31200"]</span></span><br><span class="line">             <span class="string">hosts</span>  <span class="string">=&gt;</span> <span class="string">["elasticsearch-service:9200"]</span></span><br><span class="line">             <span class="string">index</span>  <span class="string">=&gt;</span> <span class="string">"server01_logs-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>"</span></span><br><span class="line">         <span class="string">&#125;</span></span><br><span class="line">         <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#server02</span></span><br><span class="line">         <span class="string">if</span> <span class="string">[kubernetes][namespace]</span> <span class="string">==</span> <span class="string">"server02-test"</span> <span class="string">&#123;</span></span><br><span class="line">             <span class="string">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">                 <span class="string">hosts</span>  <span class="string">=&gt;</span> <span class="string">["elasticsearch-service:9200"]</span></span><br><span class="line">                 <span class="string">index</span>  <span class="string">=&gt;</span> <span class="string">"server02-test-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>"</span></span><br><span class="line">             <span class="string">&#125;</span></span><br><span class="line">         <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash-yml</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">logstash.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">path.config:</span> <span class="string">/usr/share/logstash/config/config.d</span></span><br><span class="line">    <span class="string">config.reload.automatic:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">config.reload.interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">5044</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">9600</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">elk-test</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        elastic-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">docker.elastic.co/logstash/logstash:6.8.1</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"1000m"</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"500m"</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">REQUESTS_MEMORY</span></span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              resourceFieldRef:</span></span><br><span class="line"><span class="attr">                resource:</span> <span class="string">requests.memory</span></span><br><span class="line"><span class="attr">                divisor:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">LS_JAVA_OPTS</span></span><br><span class="line"><span class="attr">            value:</span> <span class="string">"-Xms$(REQUESTS_MEMORY)m -Xmx$(REQUESTS_MEMORY)m"</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">5044</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9600</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        volumeMounts:</span> </span><br><span class="line"><span class="attr">          - mountPath:</span> <span class="string">/usr/share/logstash/config/logstash.yml</span></span><br><span class="line"><span class="attr">            subPath:</span> <span class="string">logstash.yml</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">logstash-yml</span></span><br><span class="line"><span class="attr">          - mountPath:</span> <span class="string">/usr/share/logstash/config/config.d</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">      volumes:</span> </span><br><span class="line"><span class="attr">        - name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">          configMap:</span> </span><br><span class="line"><span class="attr">            name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">logstash-yml</span></span><br><span class="line"><span class="attr">          configMap:</span> </span><br><span class="line"><span class="attr">            name:</span> <span class="string">logstash-yml</span></span><br></pre></td></tr></table></figure>

<h3 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f logstash-kubernetes.yaml</span><br></pre></td></tr></table></figure>

<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><p>官方网站：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html</a></p>
<p>GitHub：<a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">https://github.com/elastic/elasticsearch</a></p>
<p>elasticsearch-head：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a></p>
<h3 id="入门elastocsearch"><a href="#入门elastocsearch" class="headerlink" title="入门elastocsearch"></a>入门elastocsearch</h3><p><a href="http://www.ruanyifeng.com/blog/2017/08/elasticsearch.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2017/08/elasticsearch.html</a></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><h4 id="为何要搭建-Elasticsearch-集群"><a href="#为何要搭建-Elasticsearch-集群" class="headerlink" title="为何要搭建 Elasticsearch 集群"></a>为何要搭建 Elasticsearch 集群</h4><p>凡事都要讲究个为什么。在搭建集群之前，我们首先先问一句，为什么我们需要搭建集群？它有什么优势呢？</p>
<h4 id="高可用性"><a href="#高可用性" class="headerlink" title="高可用性"></a>高可用性</h4><p>Elasticsearch 作为一个搜索引擎，我们对它的基本要求就是存储海量数据并且可以在非常短的时间内查询到我们想要的信息。所以第一步我们需要保证的就是 Elasticsearch 的高可用性，什么是高可用性呢？它通常是指，通过设计减少系统不能提供服务的时间。假设系统一直能够提供服务，我们说系统的可用性是 100%。如果系统在某个时刻宕掉了，比如某个网站在某个时间挂掉了，那么就可以它临时是不可用的。所以，为了保证 Elasticsearch 的高可用性，我们就应该尽量减少 Elasticsearch 的不可用时间。</p>
<p>那么怎样提高 Elasticsearch 的高可用性呢？这时集群的作用就体现出来了。假如 Elasticsearch 只放在一台服务器上，即单机运行，假如这台主机突然断网了或者被攻击了，那么整个 Elasticsearch 的服务就不可用了。但如果改成 Elasticsearch 集群的话，有一台主机宕机了，还有其他的主机可以支撑，这样就仍然可以保证服务是可用的。</p>
<p>那可能有的小伙伴就会说了，那假如一台主机宕机了，那么不就无法访问这台主机的数据了吗？那假如我要访问的数据正好存在这台主机上，那不就获取不到了吗？难道其他的主机里面也存了一份一模一样的数据？那这岂不是很浪费吗？</p>
<p>为了解答这个问题，这里就引出了 Elasticsearch 的信息存储机制了。首先解答上面的问题，一台主机宕机了，这台主机里面存的数据依然是可以被访问到的，因为在其他的主机上也有备份，但备份的时候也不是整台主机备份，是分片备份的，那这里就又引出了一个概念——分片。</p>
<p>分片，英文叫做 Shard，顾名思义，分片就是对数据切分成了多个部分。我们知道 Elasticsearch 中一个索引（Index）相当于是一个数据库，如存某网站的用户信息，我们就建一个名为 user 的索引。但索引存储的时候并不是整个存一起的，它是被分片存储的，Elasticsearch 默认会把一个索引分成五个分片，当然这个数字是可以自定义的。分片是数据的容器，数据保存在分片内，分片又被分配到集群内的各个节点里。当你的集群规模扩大或者缩小时， Elasticsearch 会自动的在各节点中迁移分片，使得数据仍然均匀分布在集群里，所以相当于一份数据被分成了多份并保存在不同的主机上。</p>
<p>那这还是没解决问题啊，如果一台主机挂掉了，那么这个分片里面的数据不就无法访问了？别的主机都是存储的其他的分片。其实是可以访问的，因为其他主机存储了这个分片的备份，叫做副本，这里就引出了另外一个概念——副本。</p>
<p>副本，英文叫做 Replica，同样顾名思义，副本就是对原分片的复制，和原分片的内容是一样的，Elasticsearch 默认会生成一份副本，所以相当于是五个原分片和五个分片副本，相当于一份数据存了两份，并分了十个分片，当然副本的数量也是可以自定义的。这时我们只需要将某个分片的副本存在另外一台主机上，这样当某台主机宕机了，我们依然还可以从另外一台主机的副本中找到对应的数据。所以从外部来看，数据结果是没有任何区别的。</p>
<p>一般来说，Elasticsearch 会尽量把一个索引的不同分片存储在不同的主机上，分片的副本也尽可能存在不同的主机上，这样可以提高容错率，从而提高高可用性。</p>
<p>但这时假如你只有一台主机，那不就没办法了吗？分片和副本其实是没意义的，一台主机挂掉了，就全挂掉了。</p>
<h4 id="健康状态"><a href="#健康状态" class="headerlink" title="健康状态"></a>健康状态</h4><p>针对一个索引，Elasticsearch 中其实有专门的衡量索引健康状况的标志，分为三个等级：</p>
<ul>
<li>green，绿色。这代表所有的主分片和副本分片都已分配。你的集群是 100% 可用的。</li>
<li>yellow，黄色。所有的主分片已经分片了，但至少还有一个副本是缺失的。不会有数据丢失，所以搜索结果依然是完整的。不过，你的高可用性在某种程度上被弱化。如果更多的分片消失，你就会丢数据了。所以可把 yellow 想象成一个需要及时调查的警告。</li>
<li>red，红色。至少一个主分片以及它的全部副本都在缺失中。这意味着你在缺少数据：搜索只能返回部分数据，而分配到这个分片上的写入请求会返回一个异常。</li>
</ul>
<p>如果你只有一台主机的话，其实索引的健康状况也是 yellow，因为一台主机，集群没有其他的主机可以防止副本，所以说，这就是一个不健康的状态，因此集群也是十分有必要的。</p>
<h4 id="存储空间"><a href="#存储空间" class="headerlink" title="存储空间"></a>存储空间</h4><p>另外，既然是群集，那么存储空间肯定也是联合起来的，假如一台主机的存储空间是固定的，那么集群它相对于单个主机也有更多的存储空间，可存储的数据量也更大。</p>
<p>所以综上所述，我们需要一个集群！</p>
<h4 id="详细了解-Elasticsearch-集群"><a href="#详细了解-Elasticsearch-集群" class="headerlink" title="详细了解 Elasticsearch 集群"></a>详细了解 Elasticsearch 集群</h4><p>接下来我们再来了解下集群的结构是怎样的。</p>
<p>首先我们应该清楚多台主机构成了一个集群，每台主机称作一个节点（Node）。</p>
<p>如图就是一个三节点的集群：</p>
<p><img src="https://gongzhao-1256784911.cos.ap-shanghai.myqcloud.com/hexo/images/elk/es01.png" alt="img"></p>
<p>在图中，每个 Node 都有三个分片，其中 P 开头的代表 Primary 分片，即主分片，R 开头的代表 Replica 分片，即副本分片。所以图中主分片 1、2，副本分片 0 储存在 1 号节点，副本分片 0、1、2 储存在 2 号节点，主分片 0 和副本分片 1、2 储存在 3 号节点，一共是 3 个主分片和 6 个副本分片。同时我们还注意到 1 号节点还有个 MASTER 的标识，这代表它是一个主节点，它相比其他的节点更加特殊，它有权限控制整个集群，比如资源的分配、节点的修改等等。</p>
<p>这里就引出了一个概念就是节点的类型，我们可以将节点分为这么四个类型：</p>
<ul>
<li>主节点：即 Master 节点。主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的。默认情况下任何一个集群中的节点都有可能被选为主节点。索引数据和搜索查询等操作会占用大量的cpu，内存，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。虽然主节点也可以协调节点，路由搜索和从客户端新增数据到数据节点，但最好不要使用这些专用的主节点。一个重要的原则是，尽可能做尽量少的工作。</li>
<li>数据节点：即 Data 节点。数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等。数据节点对 CPU、内存、IO 要求较高，在优化的时候需要监控数据节点的状态，当资源不够的时候，需要在集群中添加新的节点。</li>
<li><a href="https://cloud.tencent.com/product/clb?from=10680" target="_blank" rel="noopener">负载均衡</a>节点：也称作 Client 节点，也称作客户端节点。当一个节点既不配置为主节点，也不配置为数据节点时，该节点只能处理路由请求，处理搜索，分发索引操作等，从本质上来说该客户节点表现为智能负载平衡器。独立的客户端节点在一个比较大的集群中是非常有用的，他协调主节点和数据节点，客户端节点加入集群可以得到集群的状态，根据集群的状态可以直接路由请求。</li>
<li>预处理节点：也称作 Ingest 节点，在索引数据之前可以先对数据做预处理操作，所有节点其实默认都是支持 Ingest 操作的，也可以专门将某个节点配置为 Ingest 节点。</li>
</ul>
<p>以上就是节点几种类型，一个节点其实可以对应不同的类型，如一个节点可以同时成为主节点和数据节点和预处理节点，但如果一个节点既不是主节点也不是数据节点，那么它就是负载均衡节点。具体的类型可以通过具体的配置文件来设置。</p>
<h4 id="Elasticsearch配置文件详解"><a href="#Elasticsearch配置文件详解" class="headerlink" title="Elasticsearch配置文件详解"></a>Elasticsearch配置文件详解</h4><p>elasticsearch的config文件夹里面有两个配置文 件：elasticsearch.yml和logging.yml，第一个是es的基本配置文件，第二个是日志配置文件，es也是使用log4j来记录日志的，所以logging.yml里的设置按普通log4j配置文件来设置就行了。下面主要讲解下elasticsearch.yml这个文件中可配置的东西。</p>
<ul>
<li>只是挑些重要的配置选项进行注释,别的可以参考官方文档！！！</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"> ################################### Cluster ###################################   </span><br><span class="line"></span><br><span class="line"># 代表一个集群,集群中有多个节点,其中有一个为主节点,这个主节点是可以通过选举产生的,主从节点是对于集群内部来说的.   </span><br><span class="line"></span><br><span class="line"># es的一个概念就是去中心化,字面上理解就是无中心节点,这是对于集群外部来说的,</span><br><span class="line"># 因为从外部来看es集群,在逻辑上是个整体,你与任何一个节点的通信和与整个es集群通信是等价的</span><br><span class="line"></span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line"></span><br><span class="line">配置es的集群名称，默认是elasticsearch，es会自动发现在同一网段下的es，</span><br><span class="line">如果在同一网段下有多个集群，就可以用这个属性来区分不同的集群，cluster.name就成为同一个集群的标识。</span><br><span class="line"></span><br><span class="line">node.name: &quot;Franz Kafka&quot;</span><br><span class="line"></span><br><span class="line">节点名，默认随机指定一个name列表中名字，该列表在es的jar包中config文件夹里name.txt文件中，</span><br><span class="line">其中有很多作者添加的有趣名字，节点名称同理,可自动生成也可手动配置。</span><br><span class="line"></span><br><span class="line">node.master: true</span><br><span class="line"></span><br><span class="line">指定该节点是否有资格被选举成为node，默认是true，es是默认集群中的第一台机器为master，</span><br><span class="line">如果这台机挂了就会重新选举master。</span><br><span class="line"></span><br><span class="line">node.data: true</span><br><span class="line"></span><br><span class="line">指定该节点是否存储索引数据，默认为true。</span><br><span class="line"></span><br><span class="line">1. # 配置文件中给出了三种配置高性能集群拓扑结构的模式,如下：   </span><br><span class="line"></span><br><span class="line">2. # 1. 如果你想让节点从不选举为主节点,只用来存储数据,可作为负载器   </span><br><span class="line"></span><br><span class="line">3. # node.master: **false**   </span><br><span class="line"></span><br><span class="line">4. # node.data: **true**   </span><br><span class="line"></span><br><span class="line">5. # node.ingest: **false**  </span><br><span class="line"></span><br><span class="line">6.   </span><br><span class="line"></span><br><span class="line">7. # 2. 如果想让节点成为主节点,且不存储任何数据,并保有空闲资源,可作为协调器   </span><br><span class="line"></span><br><span class="line">8. # node.master: **true**   </span><br><span class="line"></span><br><span class="line">9. # node.data: **false**  </span><br><span class="line"></span><br><span class="line">10. # node.ingest: **false**   </span><br><span class="line"></span><br><span class="line">11.   </span><br><span class="line"></span><br><span class="line">12. # 3. 如果想让节点既不称为主节点,又不成为数据节点,那么可将他作为搜索器,从节点中获取数据,生成搜索结果等   </span><br><span class="line"></span><br><span class="line">13. # node.master: **false**   </span><br><span class="line"></span><br><span class="line">14. # node.data: **false**   </span><br><span class="line"></span><br><span class="line">15. # node.ingest: **true** (可不指定默认开启)  </span><br><span class="line"></span><br><span class="line">16.   </span><br><span class="line"></span><br><span class="line">17. # 4. 仅作为协调器   </span><br><span class="line"></span><br><span class="line">18. # node.master: **false**   </span><br><span class="line"></span><br><span class="line">19. # node.data: **false**  </span><br><span class="line"></span><br><span class="line">20. # node.ingest: **false**  </span><br><span class="line"></span><br><span class="line">index.number_of_shards: 5</span><br><span class="line"></span><br><span class="line">设置默认索引分片个数，默认为5片。</span><br><span class="line"></span><br><span class="line">index.number_of_replicas: 1</span><br><span class="line"></span><br><span class="line">设置默认索引副本个数，默认为1个副本。</span><br><span class="line"></span><br><span class="line">1. # 配置文件中提到的最佳实践是,如果服务器够多,可以将分片提高,尽量将数据平均分布到大集群中去  </span><br><span class="line"></span><br><span class="line">2. # 同时,如果增加副本数量可以有效的提高搜索性能   </span><br><span class="line"></span><br><span class="line">3. # 需要注意的是,&quot;number_of_shards&quot; 是索引创建后一次生成的,后续不可更改设置   </span><br><span class="line"></span><br><span class="line">4. # &quot;number_of_replicas&quot; 是可以通过API去实时修改设置的 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path.conf: /path/to/conf</span><br><span class="line"></span><br><span class="line">设置配置文件的存储路径，默认是es根目录下的config文件夹。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path.data: /path/to/data</span><br><span class="line"></span><br><span class="line">设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开，例：</span><br><span class="line"></span><br><span class="line">path.data: /path/to/data1,/path/to/data2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path.work: /path/to/work</span><br><span class="line"></span><br><span class="line">设置临时文件的存储路径，默认是es根目录下的work文件夹。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line"></span><br><span class="line">设置日志文件的存储路径，默认是es根目录下的logs文件夹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">path.plugins: /path/to/plugins</span><br><span class="line"></span><br><span class="line">设置插件的存放路径，默认是es根目录下的plugins文件夹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bootstrap.memory_lock：</span><br><span class="line"></span><br><span class="line">服务器发生系统swapping的时候ES节点的性能会非常差，也会影响节点的稳定性。</span><br><span class="line">所以要不惜一切代价来避免swapping。swapping会导致Java GC的周期延迟从毫秒级恶化到分钟，</span><br><span class="line">更严重的是会引起节点响应延迟甚至脱离集群。</span><br><span class="line"></span><br><span class="line">这个参数的目的是当你无法关闭系统的swap的时候，建议把这个参数设为true。</span><br><span class="line">防止在内存不够用的时候，elasticsearch的内存被交换至交换区，导致性能骤降。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bootstrap.mlockall: true</span><br><span class="line"></span><br><span class="line">设置为true来锁住内存。因为当jvm开始swapping时es的效率会降低，所以要保证它不swap，</span><br><span class="line">可以把ES_MIN_MEM和 ES_MAX_MEM两个环境变量设置成同一个值，并且保证机器有足够的内存分配给es。</span><br><span class="line">同时也要允许elasticsearch的进程可以锁住内存，linux下可以通过`ulimit -l unlimited`命令。</span><br><span class="line"></span><br><span class="line">network.bind_host: 192.168.0.1</span><br><span class="line"></span><br><span class="line">设置绑定的ip地址，可以是ipv4或ipv6的，默认为0.0.0.0。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">network.publish_host: 192.168.0.1</span><br><span class="line"></span><br><span class="line">设置其它节点和该节点交互的ip地址，如果不设置它会自动判断，值必须是个真实的ip地址。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">network.host: 192.168.0.1</span><br><span class="line"></span><br><span class="line">这个参数是用来同时设置bind_host和publish_host上面两个参数。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"></span><br><span class="line">设置节点间交互的tcp端口，默认是9300。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">transport.tcp.compress: true</span><br><span class="line"></span><br><span class="line">设置是否压缩tcp传输时的数据，默认为false，不压缩。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.port: 9200</span><br><span class="line"></span><br><span class="line">设置对外服务的http端口，默认为9200。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.max_content_length: 100mb</span><br><span class="line"></span><br><span class="line">设置内容的最大容量，默认100mb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.enabled: false</span><br><span class="line"></span><br><span class="line">是否使用http协议对外提供服务，默认为true，开启。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. ###################### 使用head等插件监控集群信息，需要打开以下配置项 ###########  </span><br><span class="line"></span><br><span class="line">2. # http.cors.enabled: **true**  </span><br><span class="line"></span><br><span class="line">3. # http.cors.allow-origin: &quot;*&quot;  </span><br><span class="line"></span><br><span class="line">4. # http.cors.allow-credentials: **true** </span><br><span class="line"></span><br><span class="line">1. # 下面的配置控制怎样以及何时启动一整个集群重启的初始化恢复过程   </span><br><span class="line"></span><br><span class="line">2. # (当使用shard gateway时,是为了尽可能的重用local data(本地数据))  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gateway.type: local</span><br><span class="line"></span><br><span class="line">gateway的类型，默认为local即为本地文件系统，可以设置为本地文件系统，分布式文件系统，Hadoop的HDFS，和amazon的s3服务器。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gateway.recover_after_nodes: 1</span><br><span class="line"></span><br><span class="line">集群中N个节点启动后进行数据恢复，默认为1。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gateway.recover_after_time: 5m</span><br><span class="line"></span><br><span class="line">设置初始化恢复过程的超时时间,超时时间从上一个配置中配置的N个节点启动后算起，默认是5分钟。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gateway.expected_nodes: 2</span><br><span class="line"></span><br><span class="line">设置这个集群中节点的数量，默认为2，一旦这N个节点启动，就会立即进行数据恢复。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. # 下面这些配置允许在初始化恢复,副本分配,再平衡,或者添加和删除节点时控制节点间的分片分配   </span><br><span class="line"></span><br><span class="line">2. # 设置一个节点的并行恢复数 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries: 4</span><br><span class="line"></span><br><span class="line">初始化数据恢复时，并发恢复线程的个数，默认为4。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries: 2</span><br><span class="line"></span><br><span class="line">添加删除节点或负载均衡时并发恢复线程的个数，默认为4。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">indices.recovery.max_size_per_sec: 0</span><br><span class="line"></span><br><span class="line">设置数据恢复时限制的带宽，如入100mb，默认为0，即无限制。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">indices.recovery.concurrent_streams: 5</span><br><span class="line"></span><br><span class="line">设置这个参数来限制从其它分片恢复数据时最大同时打开并发流的个数，默认为5。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.minimum_master_nodes: 1</span><br><span class="line"></span><br><span class="line">设置这个参数来保证集群中的节点可以知道其它N个有master资格的节点。默认为1，对于大的集群来说，可以设置大一点的值（2-4）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.ping.timeout: 3s</span><br><span class="line"></span><br><span class="line">设置集群中自动发现其它节点时ping连接超时时间，默认为3秒，对于比较差的网络环境可以高点的值来防止自动发现时出错。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.ping.multicast.enabled: false</span><br><span class="line"></span><br><span class="line">设置是否打开多播发现节点，默认是true。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;, &quot;host3[portX-portY]&quot;]</span><br><span class="line"></span><br><span class="line">设置集群中master节点的初始列表，可以通过这些节点来自动发现新加入集群的节点。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###节点ping设置，更多等待时间设置discovery.zen.fd.ping_interval：该属性默认为1s（1秒钟），指定了节点互相ping的时间间隔。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.fd.ping_timeout：该属性默认为30s（30秒钟），指定了节点发送ping信息后等待响应的时间，超过此时间则认为对方节点无响应。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.fd.ping_retries：该属性默认为3，指定了重试次数，超过此次数则认为对方节点已停止工作。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. # 官方插件 相关设置请查看此处  </span><br><span class="line"></span><br><span class="line">2. # https://www.elastic.co/guide/en/x-pack/current/xpack-settings.html</span><br><span class="line"></span><br><span class="line">下面是一些查询时的慢日志参数设置</span><br><span class="line"></span><br><span class="line">index.search.slowlog.level: TRACE</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.query.warn: 10s</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.query.info: 5s</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.query.debug: 2s</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.query.trace: 500ms</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.fetch.warn: 1s</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.fetch.info: 800ms</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.fetch.debug:500ms</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.fetch.trace: 200ms</span><br></pre></td></tr></table></figure>

<p><strong>jvm配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">##JVM configuration</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## IMPORTANT: JVM heap size</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## You should always set the min and max JVM heap</span><br><span class="line">## size to the same value. For example, to set</span><br><span class="line">## the heap to 4 GB, set:</span><br><span class="line">##</span><br><span class="line">## -Xms4g</span><br><span class="line">## -Xmx4g</span><br><span class="line">##</span><br><span class="line">## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span><br><span class="line">## for more information</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"># Xms represents the initial size of total heap space</span><br><span class="line"># Xmx represents the maximum size of total heap space</span><br><span class="line"></span><br><span class="line">-Xms32g</span><br><span class="line">-Xmx32g</span><br><span class="line">#-Xms4g</span><br><span class="line">#-Xmx4g</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## Expert settings</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## All settings below this section are considered</span><br><span class="line">## expert settings. Don&apos;t tamper with them unless</span><br><span class="line">## you understand what you are doing</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line">## GC configuration</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=75</span><br><span class="line">-XX:+UseCMSInitiatingOccupancyOnly</span><br><span class="line"></span><br><span class="line">## optimizations</span><br><span class="line"></span><br><span class="line"># pre-touch memory pages used by the JVM during initialization</span><br><span class="line">-XX:+AlwaysPreTouch</span><br><span class="line"></span><br><span class="line">## basic</span><br><span class="line"></span><br><span class="line"># force the server VM (remove on 32-bit client JVMs)</span><br><span class="line">-server</span><br><span class="line"></span><br><span class="line"># explicitly set the stack size (reduce to 320k on 32-bit client JVMs)</span><br><span class="line">-Xss1m</span><br><span class="line"></span><br><span class="line"># set to headless, just in case</span><br><span class="line">-Djava.awt.headless=true</span><br><span class="line"></span><br><span class="line"># ensure UTF-8 encoding by default (e.g. filenames)</span><br><span class="line">-Dfile.encoding=UTF-8</span><br><span class="line"></span><br><span class="line"># use our provided JNA always versus the system one</span><br><span class="line">-Djna.nosys=true</span><br><span class="line"></span><br><span class="line"># use old-style file permissions on JDK9</span><br><span class="line">-Djdk.io.permissionsUseCanonicalPath=true</span><br><span class="line"></span><br><span class="line"># flags to configure Netty</span><br><span class="line">-Dio.netty.noUnsafe=true</span><br><span class="line">-Dio.netty.noKeySetOptimization=true</span><br><span class="line">-Dio.netty.recycler.maxCapacityPerThread=0</span><br><span class="line"></span><br><span class="line"># log4j 2</span><br><span class="line">-Dlog4j.shutdownHookEnabled=false</span><br><span class="line">-Dlog4j2.disable.jmx=true</span><br><span class="line">-Dlog4j.skipJansi=true</span><br><span class="line"></span><br><span class="line">## heap dumps</span><br><span class="line"></span><br><span class="line"># generate a heap dump when an allocation from the Java heap fails</span><br><span class="line"># heap dumps are created in the working directory of the JVM</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line"></span><br><span class="line"># specify an alternative path for heap dumps</span><br><span class="line"># ensure the directory exists and has sufficient space</span><br><span class="line">#-XX:HeapDumpPath=$&#123;heap.dump.path&#125;</span><br><span class="line"></span><br><span class="line">## GC logging</span><br><span class="line"></span><br><span class="line">#-XX:+PrintGCDetails</span><br><span class="line">#-XX:+PrintGCTimeStamps</span><br><span class="line">#-XX:+PrintGCDateStamps</span><br><span class="line">#-XX:+PrintClassHistogram</span><br><span class="line">#-XX:+PrintTenuringDistribution</span><br><span class="line">#-XX:+PrintGCApplicationStoppedTime</span><br><span class="line"></span><br><span class="line"># log GC status to a file with time stamps</span><br><span class="line"># ensure the directory exists</span><br><span class="line">#-Xloggc:$&#123;loggc&#125;</span><br><span class="line"></span><br><span class="line"># By default, the GC log file will not rotate.</span><br><span class="line"># By uncommenting the lines below, the GC log file</span><br><span class="line"># will be rotated every 128MB at most 32 times.</span><br><span class="line">#-XX:+UseGCLogFileRotation</span><br><span class="line">#-XX:NumberOfGCLogFiles=32</span><br><span class="line">#-XX:GCLogFileSize=128M</span><br><span class="line"></span><br><span class="line"># Elasticsearch 5.0.0 will throw an exception on unquoted field names in JSON.</span><br><span class="line"># If documents were already indexed with unquoted fields in a previous version</span><br><span class="line"># of Elasticsearch, some operations may throw errors.</span><br><span class="line">#</span><br><span class="line"># WARNING: This option will be removed in Elasticsearch 6.0.0 and is provided</span><br><span class="line"># only for migration purposes.</span><br><span class="line">#-Delasticsearch.json.allow_unquoted_field_names=true</span><br></pre></td></tr></table></figure>

<h4 id="Elasticsearch最佳优化"><a href="#Elasticsearch最佳优化" class="headerlink" title="Elasticsearch最佳优化"></a>Elasticsearch最佳优化</h4><p><strong>角色划分</strong></p>
<ul>
<li><strong>es分为三种角色：</strong> master、client、data，三种角色根据elasticsearch.yml配置中node.master、node.data区分，分别为true false、false false、true true</li>
<li><strong>master：</strong> 该节点不和应用创建连接，主要用于元数据(metadata)的处理，比如索引的新增、删除、分片分配等，master节点不占用io和cpu，内存使用量一般</li>
<li><strong>client：</strong> 该节点和检索应用创建连接、接受检索请求，但其本身不负责存储数据，可当成负载均衡节点，client节点不占用io、cpu、内存</li>
<li><strong>data：</strong> 该节点和索引应用创建连接、接受索引请求，该节点真正存储数据，es集群的性能取决于该节点个数（每个节点最优配置情况下），data节点会占用大量的cpu、io、内存</li>
<li><strong>各节点间关系：</strong> master节点具备主节点的选举权，主节点控制整个集群元数据。client节点接受检索请求后将请求转发到与查询条件相关的的data节点的分片上，data节点的分片执行查询语句获得查询结果后将结果反馈至client，在client对数据进行聚合、排序等操作将最终结果返回给上层请求</li>
</ul>
<p><strong>资源规划</strong></p>
<ul>
<li><strong>master节点：</strong> 只需部署三个节点，每个节点jvm分配2-10G，根据集群大小决定</li>
<li><strong>client节点：</strong> 增加client节点可增加检索并发,但检索的速度还是取决于查询所命中的分片个数以及分片中的数据量。如果不清楚检索并发，初始节点数可设置和data节点数一致，每个节点jvm分配2-10</li>
<li><strong>data节点：</strong> ①单个索引在一个data节点上分片数保持在3个以内；②每1GB堆内存对应集群的分片保持在20个以内；③每个分片不要超过30G。</li>
<li>data节点经验：<ul>
<li>如果单索引每个节点可支撑90G数据，依此可计算出所需data节点数 。</li>
<li>如果是多索引按照单个data节点jvm内存最大30G来计算，一个节点的分片保持在600个以内，存储保持在18T以内。</li>
<li>主机的cpu、io固定，建议一台主机只部署一个data节点，不同角色节点独立部署，方便扩容</li>
<li>每条数据保持在2k以下索引性能大约3000-5000条/s/data节点，增加data节点数可大幅度增加索引速率，节点数与索引效率的增长关系呈抛物线形状</li>
</ul>
</li>
</ul>
<p><strong>优秀的插件与工具</strong></p>
<ul>
<li><p><strong>ik分词器：</strong> es默认分词器只支持英文分词，ik分词器支持中文分词</p>
</li>
<li><p><strong>head数据查询工具：</strong> 类似于mysql的Navicat</p>
</li>
<li><p><strong>logstash：</strong> 数据处理管。采样各种样式、大小的数据来源，实时解析和转换数据，选择众多输出目标导出数据</p>
</li>
<li><p><strong>x-pack性能监控：</strong> 获取进程运行时资源与状态信息并存储至es中。可通过kibana查看es、logstash性能指标，试用版包括集群状态、延迟、索引速率、检索速率、内存、cpu、io、磁盘、文件量等还可以看到集群数据负载均衡时的情况。商用版还支持安全、告警等功能</p>
</li>
<li><p><strong>kibana可视化工具：</strong> es的可视化工具可制作各种图表，可在该工具上执行dsl语句灵活操作es</p>
</li>
<li><p><strong>es-sql：</strong> 用sql查询elasticsearch的工具，将封装复杂的dsl语句封装成sql</p>
</li>
<li><p><strong>beats：</strong> 轻量级的数据采集工具，可监控网络流量、日志数据、进程信息（负载、内存、磁盘等），支持docker镜像的file采集</p>
</li>
<li><p><strong>repository-hdfs：</strong> 该插件支持将es中离线数据转存至hdfs中长期存储</p>
<p>​</p>
</li>
</ul>
<h4 id="Elasticsearch优化经验"><a href="#Elasticsearch优化经验" class="headerlink" title="Elasticsearch优化经验"></a>Elasticsearch优化经验</h4><ul>
<li><p>参数调优</p>
<ul>
<li><p>开启内存锁，禁止swapping</p>
<p>执行linux命令(临时生效)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -l unlimited</span><br></pre></td></tr></table></figure>

<p>修改主机配置：/etc/security/limits.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br></pre></td></tr></table></figure>

<p>修改es配置：config/elasticsearch.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock : true</span><br></pre></td></tr></table></figure>
</li>
<li><p>调大文件描述符数量</p>
<p>执行linux命令(临时生效)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 65535</span><br></pre></td></tr></table></figure>

<p>修改linux配置文件：/etc/security/limits.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>
</li>
<li><p>调大最大映射数</p>
<p>执行linux命令(临时生效)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<p>修改linux配置文件：/etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>索引配置</p>
<ul>
<li><p>settings:{efresh_interval}：数据写入刷新间隔，默认1s，调整增加该值可以减少写入压力、增加写入速度，如设为60</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">  &quot;refresh_interval&quot;: &quot;60s&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mappings:{dynamic}： 禁止es自动创建字段，仅允许预先设定好的字段存入es，防止索引结构混乱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;: &#123;</span><br><span class="line">   &quot;mytype&quot;: &#123;</span><br><span class="line">     &quot;dynamic&quot;: false</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>_all：建议禁用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;_all&quot;: &#123;</span><br><span class="line">   &quot;enable&quot;: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>keyword字段属性: ingore_above超过多少字符不写入，keyword一般用于精确查询，不能写入太长。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">    &quot;ingore_above&quot;: 1000</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>index属性：将 不作为查询字段的index值设为false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;index&quot;: &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>JVM内存溢出处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">防止es节点内存溢出后处于僵死状态且无法恢复，影响整个集群，在进程出现OOM时让进程宕掉，退出ES集群并引发告警，然后重启。</span><br><span class="line"></span><br><span class="line">在config/jvm.options中增加JVM启动参数：</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+ExitOnOutOfMemoryError</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该参数在jdk 1.8.0_92版本上线</p>
</blockquote>
</li>
<li><p>数据生命周期</p>
<p> es中的开启状态的索引都会占用堆内存来存储倒排索引，过多的索引会导致集群整体内存使用率多大，甚至引起内存溢出。所以需要根据自身业务管理历史数据的生命周期，如近3个月的数据开启用于快速查询；过去3-6月的数据索引关闭以释放内存，需要时再开启；超过6个月的可以生成快照保存至hdfs并删除索引，需要的时候从hdfs选择需要的索引恢复至集群中进行查询</p>
<p> 生产上常常使用logstash+索引模板的方式按照一定时间创建新的索引，例如按天创建索引，索引的命名可能是index-yyyy-mm-dd，每天生产不同的索引，清除历史数据时可直接关闭或删除</p>
<p> 需要注意的是：如何按照logstash默认的时间分割索引会有8个小时的误差，所以需要在logstash中将真实数据中的时间字段作为分割条件，保障按照业务时间分割索引</p>
</li>
<li><p>路由查询</p>
<p> 在将数据写入es时，指定一个字段作为路由字段，es会将该字段进行hash计算写入到对应的分片上；查询时根据查询条件中的路由值，直接查找所在的分片，大幅度提高查询速度。</p>
<p> 需要注意的是：路由字段必须是随机分布，否则会导致分片数据不平均引发的主机存储使用不平均，可以作为路由字段的：如业务流水、省份、系统编码等。</p>
</li>
<li><p>过滤器</p>
<p> ES中的查询操作分为2种：查询（query）和过滤（filter），查询默认会计算每个返回文档的得分，然后根据得分排序；而过滤（filter）只会筛选出符合的文档，并不计算得分，且它可以缓存文档。单从性能考虑，过滤比查询更快而且更节省io资源。过滤适合在大范围筛选数据，而查询则适合精确匹配数据。开发时应先使用过滤操作过滤数据，然后使用查询匹配数据</p>
</li>
<li><p>查询限制</p>
<p> 限制是为了保证es集群的稳定性。限制的内容包括：查询范围、单次查询数量等，过大的查询范围不仅会导致查询效率低，而且会是es集群资源耗费急剧增加，甚至引起es集群崩溃；单次查询数量限制是为了保证内存不会被查询内存大量占用，就是分页原理，es默认可以查询10000条数据</p>
</li>
<li><p>批量导入</p>
<p> 如果你在做大批量导入，考虑通过设置 <code>index.number_of_replicas: 0</code>关闭副本。把每个索引的 <code>index.refresh_interval</code> 改到 -1关闭刷新。导入完毕后再开启副本和刷新</p>
</li>
</ul>
<h3 id="YAML"><a href="#YAML" class="headerlink" title="YAML"></a>YAML</h3><p><strong>elasticsearch cluster(2client+3master+2data)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">  name: elasticsearch-admin</span><br><span class="line">  namespace: elk-test</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-admin</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: elasticsearch-admin</span><br><span class="line">    namespace: elk-test</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">  name: elasticsearch-discovery</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9300</span><br><span class="line">      targetPort: 9300</span><br><span class="line">  selector:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">    role: master</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch-service</span><br><span class="line">  name: elasticsearch-service</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9200</span><br><span class="line">      targetPort: 9200</span><br><span class="line">  selector:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">    role: client</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">    role: client</span><br><span class="line">  name: elasticsearch-client</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      elastic-app: elasticsearch</span><br><span class="line">      role: client</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        elastic-app: elasticsearch</span><br><span class="line">        role: client</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: elasticsearch-client</span><br><span class="line">          image: docker.elastic.co/elasticsearch/elasticsearch:6.8.1</span><br><span class="line">          lifecycle:</span><br><span class="line">            postStart:</span><br><span class="line">              exec:</span><br><span class="line">                command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;sysctl -w vm.max_map_count=262144; ulimit -l unlimited;&quot;]</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 9200</span><br><span class="line">              protocol: TCP</span><br><span class="line">            - containerPort: 9300</span><br><span class="line">              protocol: TCP</span><br><span class="line">          env:</span><br><span class="line">            - name: &quot;node.name&quot;</span><br><span class="line">              value: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line">            - name: &quot;cluster.name&quot;</span><br><span class="line">              value: &quot;elasticsearch-cluster&quot;</span><br><span class="line">            - name: &quot;discovery.zen.ping.unicast.hosts&quot;</span><br><span class="line">              value: &quot;elasticsearch-discovery&quot;</span><br><span class="line">            - name: &quot;node.master&quot;</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            - name: &quot;node.data&quot;</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            - name: &quot;ES_JAVA_OPTS&quot;</span><br><span class="line">              value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class="line">            - name: &quot;http.cors.enabled&quot;</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">            - name: &quot;http.cors.allow-origin&quot;</span><br><span class="line">              value: &quot;*&quot;</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.3Gi</span><br><span class="line">              cpu: 0.2</span><br><span class="line">            limits:</span><br><span class="line">              memory: 1.0Gi</span><br><span class="line">              cpu: 0.5</span><br><span class="line">      serviceAccountName: elasticsearch-admin</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">    role: master</span><br><span class="line">  name: elasticsearch-master</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      elastic-app: elasticsearch</span><br><span class="line">      role: master</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        elastic-app: elasticsearch</span><br><span class="line">        role: master</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: elasticsearch-master</span><br><span class="line">          image: docker.elastic.co/elasticsearch/elasticsearch:6.8.1</span><br><span class="line">          lifecycle:</span><br><span class="line">            postStart:</span><br><span class="line">              exec:</span><br><span class="line">                command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;sysctl -w vm.max_map_count=262144; ulimit -l unlimited;&quot;]</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 9300</span><br><span class="line">              protocol: TCP</span><br><span class="line">          env:</span><br><span class="line">            - name: &quot;node.name&quot;</span><br><span class="line">              value: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line">            - name: &quot;cluster.name&quot;</span><br><span class="line">              value: &quot;elasticsearch-cluster&quot;</span><br><span class="line">            - name: &quot;discovery.zen.ping.unicast.hosts&quot;</span><br><span class="line">              value: &quot;elasticsearch-discovery&quot;</span><br><span class="line">            - name: &quot;discovery.zen.minimum_master_nodes&quot;</span><br><span class="line">              value: &quot;2&quot;</span><br><span class="line">            - name: &quot;discovery.zen.ping_timeout&quot;</span><br><span class="line">              value: &quot;5s&quot;</span><br><span class="line">            - name: &quot;node.master&quot;</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">            - name: &quot;node.data&quot;</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            - name: &quot;node.ingest&quot;</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            - name: &quot;ES_JAVA_OPTS&quot;</span><br><span class="line">              value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.3Gi</span><br><span class="line">              cpu: 0.3</span><br><span class="line">            limits:</span><br><span class="line">              memory: 1.0Gi</span><br><span class="line">              cpu: 0.5</span><br><span class="line">      serviceAccountName: elasticsearch-admin</span><br><span class="line">---</span><br><span class="line">kind: StatefulSet</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: elasticsearch</span><br><span class="line">    role: data</span><br><span class="line">  name: elasticsearch-data</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      elastic-app: elasticsearch</span><br><span class="line">      role: data</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        elastic-app: elasticsearch</span><br><span class="line">        role: data</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: elasticsearch-data</span><br><span class="line">          image: docker.elastic.co/elasticsearch/elasticsearch:6.8.1</span><br><span class="line">          lifecycle:</span><br><span class="line">            postStart:</span><br><span class="line">              exec:</span><br><span class="line">                command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;sysctl -w vm.max_map_count=262144; ulimit -l unlimited;&quot;]</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 9300</span><br><span class="line">              protocol: TCP</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: es-data</span><br><span class="line">              mountPath: /usr/share/elasticsearch/data</span><br><span class="line">          env:</span><br><span class="line">            - name: &quot;node.name&quot;</span><br><span class="line">              value: &quot;$&#123;HOSTNAME&#125;&quot;</span><br><span class="line">            - name: &quot;cluster.name&quot;</span><br><span class="line">              value: &quot;elasticsearch-cluster&quot;</span><br><span class="line">            - name: &quot;discovery.zen.ping.unicast.hosts&quot;</span><br><span class="line">              value: &quot;elasticsearch-discovery&quot;</span><br><span class="line">            - name: &quot;node.master&quot;</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            - name: &quot;node.data&quot;</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">            - name: &quot;ES_JAVA_OPTS&quot;</span><br><span class="line">              value: &quot;-Xms1024m -Xmx1024m&quot;</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              memory: 1.0Gi</span><br><span class="line">              cpu: 1</span><br><span class="line">            limits:</span><br><span class="line">              memory: 2.0Gi</span><br><span class="line">              cpu: 2</span><br><span class="line">      serviceAccountName: elasticsearch-admin</span><br><span class="line">  serviceName: elasticsearch-data</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: es-data</span><br><span class="line">        creationTimestamp: null</span><br><span class="line">        annotations:</span><br><span class="line">          volume.beta.kubernetes.io/storage-class: nfs-rw</span><br><span class="line">          volume.beta.kubernetes.io/storage-provisioner: flexvolume-huawei.com/fuxinfs</span><br><span class="line">        enable: true</span><br><span class="line">      spec:</span><br><span class="line">        accessModes:</span><br><span class="line">          - ReadWriteOnce</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 100Gi</span><br></pre></td></tr></table></figure>

<p> <strong>elasticsearch(3data node statefulset)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: es-cluster</span><br><span class="line">  namespace: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: elasticsearch</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: &quot;app&quot;</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                    - elasticsearch</span><br><span class="line">              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: registry-secret</span><br><span class="line">      containers:</span><br><span class="line">      - name: elasticsearch</span><br><span class="line">        image: registry.cn-beijing.aliyuncs.com/rj-bai/elasticsearch:6.5.4 </span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9200</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9200</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: &quot;1000m&quot;</span><br><span class="line">              memory: &quot;2Gi&quot;</span><br><span class="line">            requests:</span><br><span class="line">              cpu: &quot;500m&quot;</span><br><span class="line">              memory: &quot;1Gi&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: es-http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: cluster-port</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - mountPath: /usr/share/elasticsearch/data</span><br><span class="line">            name: data-elasticsearch</span><br><span class="line">        env:</span><br><span class="line">          - name: REQUESTS_MEMORY</span><br><span class="line">            valueFrom:</span><br><span class="line">              resourceFieldRef:</span><br><span class="line">                resource: requests.memory</span><br><span class="line">                divisor: 1Mi</span><br><span class="line">          - name: cluster.name</span><br><span class="line">            value: es-cluster</span><br><span class="line">          - name: node.name</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">          - name: http.cors.enabled</span><br><span class="line">            value: &quot;true&quot;</span><br><span class="line">          - name: http.cors.allow-origin</span><br><span class="line">            value: &quot;*&quot;</span><br><span class="line">          - name: discovery.zen.minimum_master_nodes</span><br><span class="line">            value: &quot;2&quot;</span><br><span class="line">          - name: discovery.zen.fd.ping_timeout</span><br><span class="line">            value: &quot;120s&quot;</span><br><span class="line">          - name: discovery.zen.fd.ping_retries</span><br><span class="line">            value: &quot;6&quot;</span><br><span class="line">          - name: discovery.zen.fd.ping_interval </span><br><span class="line">            value: &quot;30s&quot;</span><br><span class="line">          - name: ES_JAVA_OPTS</span><br><span class="line">            value: &quot;-Xms$(REQUESTS_MEMORY)m -Xmx$(REQUESTS_MEMORY)m&quot;</span><br><span class="line">          - name: discovery.zen.ping.unicast.hosts</span><br><span class="line">            value: &quot;es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch&quot;</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: vm-max-map</span><br><span class="line">        image: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">      - name: fd-ulimit</span><br><span class="line">        image: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;ulimit -n 65535&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: data-elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 5Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch</span><br><span class="line">  namespace: elasticsearch</span><br><span class="line">  labels:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9200</span><br><span class="line">      name: es-http</span><br><span class="line">      nodePort: 39200</span><br></pre></td></tr></table></figure>

<p><strong>crobjob定期清理历史数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1beta1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line"> name: elasticsearch</span><br><span class="line"> labels:</span><br><span class="line">   app.kubernetes.io/name: elasticsearch</span><br><span class="line">   helm.sh/chart: elasticsearch-0.1.0</span><br><span class="line">   app.kubernetes.io/instance: elasticsearch</span><br><span class="line">   app.kubernetes.io/managed-by: Tiller</span><br><span class="line">spec:</span><br><span class="line"> schedule: &quot;0 1 * * *&quot;</span><br><span class="line"> concurrencyPolicy: Forbid</span><br><span class="line"> jobTemplate:</span><br><span class="line">   spec:</span><br><span class="line">     template:</span><br><span class="line">       spec:</span><br><span class="line">         containers:</span><br><span class="line">           - name: hello</span><br><span class="line">             image: &quot;192.168.101.88:5000/busybox:1.29.3&quot;</span><br><span class="line">             imagePullPolicy: IfNotPresent</span><br><span class="line">             command:</span><br><span class="line">               - &quot;sh&quot;</span><br><span class="line">               - &quot;-c&quot;</span><br><span class="line">               - &gt;</span><br><span class="line">                 history=$(date -D &apos;%s&apos; +&quot;%Y.%m.%d&quot; -d &quot;$(( `date +%s`-60*60*24*6 ))&quot;);</span><br><span class="line">                 echo $&#123;history&#125;;</span><br><span class="line">                 hostname=elasticsearch.ns-monitor;</span><br><span class="line">                 echo $&#123;hostname&#125;;</span><br><span class="line">                 echo -ne &quot;DELETE /*$&#123;history&#125;* HTTP/1.1\r\nHost: $&#123;hostname&#125;\r\n\r\n&quot; | nc -v -i 1 $&#123;hostname&#125; 9200</span><br><span class="line">         restartPolicy: OnFailure</span><br></pre></td></tr></table></figure>

<p><strong>脚本定期清理历史数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line">#set -x</span><br><span class="line"></span><br><span class="line">LAST_DATE=`date -d &quot;-7 days&quot; &quot;+%Y-%m-%d&quot;`</span><br><span class="line">LAST_TIMESTAMP=`date -d &quot;$LAST_DATE&quot; +%s`</span><br><span class="line"></span><br><span class="line">indexs=`curl http://192.168.0.250:31191/_cat/indices|awk &apos;$3~/server01|server02/ &#123;print $3&#125;&apos;`</span><br><span class="line"></span><br><span class="line">for index in $indexs;do</span><br><span class="line">    index_time=`echo $index|awk -F - &apos;&#123;print $NF&#125;&apos;|tr &apos;.&apos; &apos;-&apos;`</span><br><span class="line">    index_timestamp=`date -d &quot;$index_time&quot; +%s`</span><br><span class="line">    if [ $index_timestamp -lt $LAST_TIMESTAMP ];then</span><br><span class="line">        curl -XDELETE &quot;http://192.168.0.250:31191/$index&quot; &amp;&gt; /dev/null</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="部署-2"><a href="#部署-2" class="headerlink" title="部署"></a>部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f es-kubernetes.yaml</span><br></pre></td></tr></table></figure>

<h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h2><p>官方文档：<a href="https://www.elastic.co/guide/en/kibana/current/" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/current/</a></p>
<p>GitHub：<a href="https://github.com/elastic/kibana" target="_blank" rel="noopener">https://github.com/elastic/kibana</a></p>
<h3 id="YAML-1"><a href="#YAML-1" class="headerlink" title="YAML"></a>YAML</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: kibana</span><br><span class="line">  name: kibana-service</span><br><span class="line">  namespace: elk-test</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 5601</span><br><span class="line">      targetPort: 5601</span><br><span class="line">  selector:</span><br><span class="line">    elastic-app: kibana</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: elk-test</span><br><span class="line">  labels:</span><br><span class="line">    elastic-app: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      elastic-app: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: kibana</span><br><span class="line">      labels:</span><br><span class="line">        elastic-app: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: kibana</span><br><span class="line">          image: &apos;docker.elastic.co/kibana/kibana:6.8.1&apos;</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 5601</span><br><span class="line">              protocol: TCP</span><br><span class="line">          env:</span><br><span class="line">            - name: ELASTICSEARCH_URL</span><br><span class="line">              value: &apos;http://elasticsearch-service:9200&apos;</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 500m</span><br><span class="line">              memory: 1Gi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 256Mi</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<h3 id="部署-3"><a href="#部署-3" class="headerlink" title="部署"></a>部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kibana-kubernetes.yaml</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1189282" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1189282</a></p>
<p><a href="https://blog.csdn.net/chenleiking/article/details/79453460" target="_blank" rel="noopener">https://blog.csdn.net/chenleiking/article/details/79453460</a></p>
<p><a href="https://blog.csdn.net/miss1181248983/article/details/89492918" target="_blank" rel="noopener">https://blog.csdn.net/miss1181248983/article/details/89492918</a></p>
<p><a href="https://blog.rj-bai.com/post/157.html" target="_blank" rel="noopener">https://blog.rj-bai.com/post/157.html</a></p>
<p><a href="https://www.jianshu.com/p/b264b6cf9340" target="_blank" rel="noopener">https://www.jianshu.com/p/b264b6cf9340</a></p>
</blockquote>

      
    </div>
    
    
    
	
	<div>
	  
		<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">--------------------本文结束，感谢您的阅读--------------------</div>
    
</div>
	  
	</div>
	
	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/Kubernetes集群日志收集-Filebeat-ELK/">Kubernetes集群日志收集 Filebeat+ELK</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 弓昭 的个人博客">弓昭</a></p>
  <p><span>发布时间:</span>2019年07月22日 - 23:06</p>
  <p><span>最后更新:</span>2020年04月08日 - 22:20</p>
  <p><span>原始链接:</span><a href="/Kubernetes集群日志收集-Filebeat-ELK/" title="Kubernetes集群日志收集 Filebeat+ELK">https://gongzhao1.coding.me/Kubernetes集群日志收集-Filebeat-ELK/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://gongzhao1.coding.me/Kubernetes集群日志收集-Filebeat-ELK/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>联系邮箱:</span>gongzhao1@foxmail.com</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
	});
    });  
</script>

      
	</div>
	


    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.jpg" alt="弓昭 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/ali.jpg" alt="弓昭 Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i>kubernetes</a>
          
            <a href="/tags/elk/" rel="tag"><i class="fa fa-tag"></i>elk</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/terraform创建华为云 AWS资源/" rel="next" title="terraform创建华为云、AWS资源">
                <i class="fa fa-chevron-left"></i> terraform创建华为云、AWS资源
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/正则表达式REGEX/" rel="prev" title="正则表达式REGEX">
                正则表达式REGEX <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MTcyNy8xODI3Mw=="></div>
    
  </div>



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/panda.jpg" alt="弓昭">
          <p class="site-author-name" itemprop="name">弓昭</p>
           
              <p class="site-description motion-element" itemprop="description">弓昭的个人主页，主要涉及网络、运维、前端、Python等等知识</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">85</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">74</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gongzhao1" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://blog.csdn.net/zhao12795969" target="_blank" title="csdn">
                  
                    <i class="fa fa-fw fa-crosshairs"></i>
                  
                    
                      csdn
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.jianshu.com/u/1dbca13c6043" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-heartbeat"></i>
                  
                    
                      简书
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://ccieh3c.com/" title="网络之路" target="_blank">网络之路</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://jm.taobao.org/" title="阿里云中间件" target="_blank">阿里云中间件</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志采集方式"><span class="nav-number">2.</span> <span class="nav-text">日志采集方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#方式1：-Node级别日志代理"><span class="nav-number">2.1.</span> <span class="nav-text">方式1： Node级别日志代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方式2：伴生容器（sidecar-container）作为日志代理"><span class="nav-number">2.2.</span> <span class="nav-text">方式2：伴生容器（sidecar container）作为日志代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方式3：应用直接上传日志"><span class="nav-number">2.3.</span> <span class="nav-text">方式3：应用直接上传日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对比"><span class="nav-number">2.4.</span> <span class="nav-text">对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志采集部署"><span class="nav-number">3.</span> <span class="nav-text">日志采集部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat"><span class="nav-number">3.1.</span> <span class="nav-text">filebeat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#filebeat处理多行日志"><span class="nav-number">3.1.1.</span> <span class="nav-text">filebeat处理多行日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Yaml-File"><span class="nav-number">3.1.2.</span> <span class="nav-text">Yaml File</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署"><span class="nav-number">3.1.3.</span> <span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Kafka"><span class="nav-number">3.2.</span> <span class="nav-text">Redis/Kafka</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Logstash"><span class="nav-number">3.3.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Logstash配置文件详解"><span class="nav-number">3.3.1.</span> <span class="nav-text">Logstash配置文件详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置参数"><span class="nav-number">3.3.2.</span> <span class="nav-text">配置参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理匹配失败的日志"><span class="nav-number">3.3.3.</span> <span class="nav-text">处理匹配失败的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grok插件了解"><span class="nav-number">3.3.4.</span> <span class="nav-text">Grok插件了解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Yaml-File-1"><span class="nav-number">3.3.5.</span> <span class="nav-text">Yaml File</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署-1"><span class="nav-number">3.3.6.</span> <span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch"><span class="nav-number">3.4.</span> <span class="nav-text">Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#入门elastocsearch"><span class="nav-number">3.4.1.</span> <span class="nav-text">入门elastocsearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#介绍"><span class="nav-number">3.4.2.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为何要搭建-Elasticsearch-集群"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">为何要搭建 Elasticsearch 集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用性"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">高可用性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#健康状态"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">健康状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#存储空间"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">存储空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#详细了解-Elasticsearch-集群"><span class="nav-number">3.4.2.5.</span> <span class="nav-text">详细了解 Elasticsearch 集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch配置文件详解"><span class="nav-number">3.4.2.6.</span> <span class="nav-text">Elasticsearch配置文件详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch最佳优化"><span class="nav-number">3.4.2.7.</span> <span class="nav-text">Elasticsearch最佳优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch优化经验"><span class="nav-number">3.4.2.8.</span> <span class="nav-text">Elasticsearch优化经验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML"><span class="nav-number">3.4.3.</span> <span class="nav-text">YAML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署-2"><span class="nav-number">3.4.4.</span> <span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kibana"><span class="nav-number">3.5.</span> <span class="nav-text">Kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML-1"><span class="nav-number">3.5.1.</span> <span class="nav-text">YAML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署-3"><span class="nav-number">3.5.2.</span> <span class="nav-text">部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy;  2018 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">弓昭</span>
</div>


<div class="powered-by">
	<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
	  本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
</div>


<div class="theme-info">

  <span class="post-count">博客全站共258.5k字</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
